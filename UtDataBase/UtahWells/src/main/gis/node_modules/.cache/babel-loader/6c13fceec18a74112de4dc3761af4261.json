{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../../chunks/tslib.es6.js\";\nimport t from \"../../../../core/Error.js\";\nimport o from \"../../../../core/Logger.js\";\nimport { isSome as r, isNone as s } from \"../../../../core/maybe.js\";\nimport { after as n, createResolver as c } from \"../../../../core/promiseUtils.js\";\nimport { addQueryParameters as i } from \"../../../../core/urlUtils.js\";\nimport { property as a } from \"../../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../../core/arrayUtils.js\";\nimport \"../../../../core/has.js\";\nimport \"../../../../core/accessorSupport/ensureType.js\";\nimport { subclass as l } from \"../../../../core/accessorSupport/decorators/subclass.js\";\nimport { getGeometryZScaler as d } from \"../../../../geometry/support/zscale.js\";\nimport h from \"./StreamConnection.js\";\nconst p = o.getLogger(\"esri.layers.graphics.sources.connections.WebSocketConnection\");\nvar u;\n!function (e) {\n  e[e.CONNECTING = 0] = \"CONNECTING\", e[e.OPEN = 1] = \"OPEN\", e[e.CLOSING = 2] = \"CLOSING\", e[e.CLOSED = 3] = \"CLOSED\";\n}(u || (u = {}));\nlet m = class extends h {\n  constructor(e) {\n    super(), this.errorString = null;\n    const {\n      geometryType: t,\n      spatialReference: o,\n      sourceSpatialReference: r\n    } = e;\n    this._config = e, this._featureZScaler = d(t, r, o), this._open();\n  }\n\n  async _open() {\n    await this._tryCreateWebSocket(), this.destroyed || (await this._handshake());\n  }\n\n  destroy() {\n    r(this._websocket) && (this._websocket.onopen = null, this._websocket.onclose = null, this._websocket.onerror = null, this._websocket.onmessage = null, this._websocket.close()), this._websocket = null;\n  }\n\n  get connectionStatus() {\n    if (s(this._websocket)) return \"disconnected\";\n\n    switch (this._websocket.readyState) {\n      case u.CONNECTING:\n      case u.OPEN:\n        return \"connected\";\n\n      case u.CLOSING:\n      case u.CLOSED:\n        return \"disconnected\";\n    }\n  }\n\n  async _tryCreateWebSocket() {\n    let e = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : this._config.source.path;\n    let o = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 1e3;\n    let r = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 0;\n\n    try {\n      if (this.destroyed) return;\n      const t = i(e, this._config.customParameters);\n      this._websocket = await this._createWebSocket(t), this.notifyChange(\"connectionStatus\");\n    } catch (s) {\n      const c = o / 1e3;\n      return this._config.maxReconnectionAttempts && r >= this._config.maxReconnectionAttempts ? (p.error(new t(\"websocket-connection\", \"Exceeded maxReconnectionAttempts attempts. No further attempts will be made\")), void this.destroy()) : (p.error(new t(\"websocket-connection\", `Failed to connect. Attempting to reconnect in ${c}s`, s)), await n(o), this._tryCreateWebSocket(e, Math.min(1.5 * o, 1e3 * this._config.maxReconnectionInterval), r + 1));\n    }\n  }\n\n  _createWebSocket(e) {\n    return new Promise((t, o) => {\n      const r = new WebSocket(e);\n      r.onopen = () => {\n        if (r.onopen = null, this.destroyed) return r.onclose = null, void r.close();\n        r.onclose = e => this._onClose(e), r.onerror = e => this._onError(e), r.onmessage = e => this._onMessage(e), t(r);\n      }, r.onclose = e => {\n        r.onopen = r.onclose = null, o(e);\n      };\n    });\n  }\n\n  async _handshake() {\n    let e = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 1e4;\n    const o = this._websocket;\n    if (s(o)) return;\n    const r = c(),\n          n = o.onmessage,\n          {\n      filter: i,\n      outFields: a,\n      spatialReference: l\n    } = this._config;\n    return r.timeout(e), o.onmessage = e => {\n      var s;\n      let c = null;\n\n      try {\n        c = JSON.parse(e.data);\n      } catch (d) {}\n\n      c && \"object\" == typeof c || (p.error(new t(\"websocket-connection\", \"Protocol violation. Handshake failed - malformed message\", e.data)), r.reject(), this.destroy()), (null == (s = c.spatialReference) ? void 0 : s.wkid) !== (null == l ? void 0 : l.wkid) && (p.error(new t(\"websocket-connection\", `Protocol violation. Handshake failed - expected wkid of ${l.wkid}`, e.data)), r.reject(), this.destroy()), \"json\" !== c.format && (p.error(new t(\"websocket-connection\", \"Protocol violation. Handshake failed - format is not set\", e.data)), r.reject(), this.destroy()), i && c.filter !== i && p.error(new t(\"websocket-connection\", \"Tried to set filter, but server doesn't support it\")), a && c.outFields !== a && p.error(new t(\"websocket-connection\", \"Tried to set outFields, but server doesn't support it\")), o.onmessage = n, r.resolve();\n    }, o.send(JSON.stringify({\n      filter: i,\n      outFields: a,\n      format: \"json\",\n      spatialReference: {\n        wkid: l.wkid\n      }\n    })), r.promise;\n  }\n\n  _onMessage(e) {\n    try {\n      const o = JSON.parse(e.data);\n      if (\"featureResult\" !== o.type) throw new t(\"websocket-connection\", \"Protocol violation - Expected to find message of type 'featureResult'\", o);\n\n      for (const e of o.features) r(this._featureZScaler) && this._featureZScaler(e.geometry), this.onFeature(e);\n    } catch (o) {\n      return p.error(new t(\"websocket-connection\", \"Failed to parse message\", o)), void this.destroy();\n    }\n  }\n\n  _onError(e) {\n    const t = \"Encountered an error over WebSocket connection\";\n    this._set(\"errorString\", t), p.error(\"websocket-connection\", t);\n  }\n\n  _onClose(e) {\n    this._websocket = null, this.notifyChange(\"connectionStatus\"), 1e3 !== e.code && p.error(\"websocket-connection\", `WebSocket closed unexpectedly with error code ${e.code}`), this.destroyed || this._open();\n  }\n\n};\ne([a()], m.prototype, \"connectionStatus\", null), e([a()], m.prototype, \"errorString\", void 0), m = e([l(\"esri.layers.graphics.sources.connections.WebSocketConnection\")], m);\nexport { u as ReadyState, m as WebSocketConnection };","map":{"version":3,"sources":["D:/Github/CUSP_DataBase/CUSP_DB/src/main/gis/node_modules/@arcgis/core/layers/graphics/sources/connections/WebSocketConnection.js"],"names":["_","e","t","o","isSome","r","isNone","s","after","n","createResolver","c","addQueryParameters","i","property","a","subclass","l","getGeometryZScaler","d","h","p","getLogger","u","CONNECTING","OPEN","CLOSING","CLOSED","m","constructor","errorString","geometryType","spatialReference","sourceSpatialReference","_config","_featureZScaler","_open","_tryCreateWebSocket","destroyed","_handshake","destroy","_websocket","onopen","onclose","onerror","onmessage","close","connectionStatus","readyState","source","path","customParameters","_createWebSocket","notifyChange","maxReconnectionAttempts","error","Math","min","maxReconnectionInterval","Promise","WebSocket","_onClose","_onError","_onMessage","filter","outFields","timeout","JSON","parse","data","reject","wkid","format","resolve","send","stringify","promise","type","features","geometry","onFeature","_set","code","prototype","ReadyState","WebSocketConnection"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../../chunks/tslib.es6.js\";import t from\"../../../../core/Error.js\";import o from\"../../../../core/Logger.js\";import{isSome as r,isNone as s}from\"../../../../core/maybe.js\";import{after as n,createResolver as c}from\"../../../../core/promiseUtils.js\";import{addQueryParameters as i}from\"../../../../core/urlUtils.js\";import{property as a}from\"../../../../core/accessorSupport/decorators/property.js\";import\"../../../../core/arrayUtils.js\";import\"../../../../core/has.js\";import\"../../../../core/accessorSupport/ensureType.js\";import{subclass as l}from\"../../../../core/accessorSupport/decorators/subclass.js\";import{getGeometryZScaler as d}from\"../../../../geometry/support/zscale.js\";import h from\"./StreamConnection.js\";const p=o.getLogger(\"esri.layers.graphics.sources.connections.WebSocketConnection\");var u;!function(e){e[e.CONNECTING=0]=\"CONNECTING\",e[e.OPEN=1]=\"OPEN\",e[e.CLOSING=2]=\"CLOSING\",e[e.CLOSED=3]=\"CLOSED\"}(u||(u={}));let m=class extends h{constructor(e){super(),this.errorString=null;const{geometryType:t,spatialReference:o,sourceSpatialReference:r}=e;this._config=e,this._featureZScaler=d(t,r,o),this._open()}async _open(){await this._tryCreateWebSocket(),this.destroyed||await this._handshake()}destroy(){r(this._websocket)&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null}get connectionStatus(){if(s(this._websocket))return\"disconnected\";switch(this._websocket.readyState){case u.CONNECTING:case u.OPEN:return\"connected\";case u.CLOSING:case u.CLOSED:return\"disconnected\"}}async _tryCreateWebSocket(e=this._config.source.path,o=1e3,r=0){try{if(this.destroyed)return;const t=i(e,this._config.customParameters);this._websocket=await this._createWebSocket(t),this.notifyChange(\"connectionStatus\")}catch(s){const c=o/1e3;return this._config.maxReconnectionAttempts&&r>=this._config.maxReconnectionAttempts?(p.error(new t(\"websocket-connection\",\"Exceeded maxReconnectionAttempts attempts. No further attempts will be made\")),void this.destroy()):(p.error(new t(\"websocket-connection\",`Failed to connect. Attempting to reconnect in ${c}s`,s)),await n(o),this._tryCreateWebSocket(e,Math.min(1.5*o,1e3*this._config.maxReconnectionInterval),r+1))}}_createWebSocket(e){return new Promise(((t,o)=>{const r=new WebSocket(e);r.onopen=()=>{if(r.onopen=null,this.destroyed)return r.onclose=null,void r.close();r.onclose=e=>this._onClose(e),r.onerror=e=>this._onError(e),r.onmessage=e=>this._onMessage(e),t(r)},r.onclose=e=>{r.onopen=r.onclose=null,o(e)}}))}async _handshake(e=1e4){const o=this._websocket;if(s(o))return;const r=c(),n=o.onmessage,{filter:i,outFields:a,spatialReference:l}=this._config;return r.timeout(e),o.onmessage=e=>{var s;let c=null;try{c=JSON.parse(e.data)}catch(d){}c&&\"object\"==typeof c||(p.error(new t(\"websocket-connection\",\"Protocol violation. Handshake failed - malformed message\",e.data)),r.reject(),this.destroy()),(null==(s=c.spatialReference)?void 0:s.wkid)!==(null==l?void 0:l.wkid)&&(p.error(new t(\"websocket-connection\",`Protocol violation. Handshake failed - expected wkid of ${l.wkid}`,e.data)),r.reject(),this.destroy()),\"json\"!==c.format&&(p.error(new t(\"websocket-connection\",\"Protocol violation. Handshake failed - format is not set\",e.data)),r.reject(),this.destroy()),i&&c.filter!==i&&p.error(new t(\"websocket-connection\",\"Tried to set filter, but server doesn't support it\")),a&&c.outFields!==a&&p.error(new t(\"websocket-connection\",\"Tried to set outFields, but server doesn't support it\")),o.onmessage=n,r.resolve()},o.send(JSON.stringify({filter:i,outFields:a,format:\"json\",spatialReference:{wkid:l.wkid}})),r.promise}_onMessage(e){try{const o=JSON.parse(e.data);if(\"featureResult\"!==o.type)throw new t(\"websocket-connection\",\"Protocol violation - Expected to find message of type 'featureResult'\",o);for(const e of o.features)r(this._featureZScaler)&&this._featureZScaler(e.geometry),this.onFeature(e)}catch(o){return p.error(new t(\"websocket-connection\",\"Failed to parse message\",o)),void this.destroy()}}_onError(e){const t=\"Encountered an error over WebSocket connection\";this._set(\"errorString\",t),p.error(\"websocket-connection\",t)}_onClose(e){this._websocket=null,this.notifyChange(\"connectionStatus\"),1e3!==e.code&&p.error(\"websocket-connection\",`WebSocket closed unexpectedly with error code ${e.code}`),this.destroyed||this._open()}};e([a()],m.prototype,\"connectionStatus\",null),e([a()],m.prototype,\"errorString\",void 0),m=e([l(\"esri.layers.graphics.sources.connections.WebSocketConnection\")],m);export{u as ReadyState,m as WebSocketConnection};\n"]},"metadata":{},"sourceType":"module"}