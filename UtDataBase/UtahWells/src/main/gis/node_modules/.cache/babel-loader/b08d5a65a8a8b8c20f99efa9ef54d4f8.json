{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport t from \"../../../../core/CircularArray.js\";\nimport e from \"../../../../core/Evented.js\";\nimport \"../../../../core/has.js\";\nimport { isNone as s, isSome as a, unwrap as r } from \"../../../../core/maybe.js\";\nimport { r as n } from \"../../../../chunks/rbush.js\";\nimport { fromRect as i } from \"../../../../geometry/support/aaBoundingBox.js\";\nimport { Store2D as o } from \"./Store2D.js\";\nimport { FeatureSetReaderIndirect as d } from \"./support/FeatureSetReaderPBFIndirect.js\";\n\nfunction h(t, e) {\n  return t << 16 | e;\n}\n\nfunction c(t) {\n  return (4294901760 & t) >>> 16;\n}\n\nfunction I(t) {\n  return 65535 & t;\n}\n\nconst u = {\n  getObjectId: t => t.getObjectId(),\n  getAttributes: t => t.readAttributes(),\n  getAttribute: (t, e) => t.readAttribute(e),\n  cloneWithGeometry: (t, e) => t,\n  getGeometry: t => t.readHydratedGeometry(),\n  getCentroid: (t, e) => t.readCentroid()\n};\n\nclass l extends o {\n  constructor(s, a, r) {\n    super(s, a), this.featureAdapter = u, this.events = new e(), this._featureSetsByInstance = new Map(), this._objectIdToDisplayId = new Map(), this._spatialIndexInvalid = !0, this._indexSearchCache = new t(50), this._index = n(9, t => ({\n      minX: this._storage.getXMin(t),\n      minY: this._storage.getYMin(t),\n      maxX: this._storage.getXMax(t),\n      maxY: this._storage.getYMax(t)\n    })), this._storage = a, this.mode = r;\n  }\n\n  get storage() {\n    return this._storage;\n  }\n\n  get storeStatistics() {\n    let t = 0,\n        e = 0,\n        s = 0;\n    return this.forEach(a => {\n      const r = a.readGeometry();\n      r && (e += r.isPoint ? 1 : r.lengths.reduce((t, e) => t + e, 0), s += r.isPoint ? 1 : r.lengths.length, t += 1);\n    }), {\n      featureCount: t,\n      vertexCount: e,\n      ringCount: s\n    };\n  }\n\n  hasInstance(t) {\n    return this._featureSetsByInstance.has(t);\n  }\n\n  onTileData(t, e) {\n    if (s(e.addOrUpdate)) return e;\n\n    if (e.addOrUpdate.attachStorage(this._storage), \"snapshot\" === this.mode) {\n      const s = e.addOrUpdate.getCursor();\n\n      for (; s.next();) {\n        const e = s.getDisplayId();\n        this.setComputedAttributes(this._storage, s, e, t.scale);\n      }\n\n      return e;\n    }\n\n    this._featureSetsByInstance.set(e.addOrUpdate.instance, e.addOrUpdate);\n\n    const a = e.addOrUpdate.getCursor();\n\n    for (; a.next();) this._insertFeature(a, t.scale);\n\n    return this._spatialIndexInvalid = !0, this.events.emit(\"changed\"), e;\n  }\n\n  search(t) {\n    this._rebuildIndex();\n\n    const e = t.id,\n          s = this._indexSearchCache.find(t => t.tileId === e);\n\n    if (a(s)) return s.readers;\n\n    const r = new Map(),\n          n = this._searchIndex(t.bounds),\n          i = [];\n\n    for (const a of n) {\n      const t = this._storage.getInstanceId(a),\n            e = c(t),\n            s = I(t);\n\n      r.has(e) || r.set(e, []);\n      r.get(e).push(s);\n    }\n\n    return r.forEach((t, e) => {\n      const s = this._featureSetsByInstance.get(e);\n\n      i.push(d.from(s, t));\n    }), this._indexSearchCache.enqueue({\n      tileId: e,\n      readers: i\n    }), i;\n  }\n\n  insert(t) {\n    const e = t.getCursor(),\n          s = this._storage;\n\n    for (; e.next();) {\n      var a;\n      const t = h(e.instance, e.getIndex()),\n            r = e.getObjectId(),\n            n = null != (a = this._objectIdToDisplayId.get(r)) ? a : this._storage.createDisplayId();\n      e.setDisplayId(n), s.setInstanceId(n, t), this._objectIdToDisplayId.set(r, n);\n    }\n\n    this._featureSetsByInstance.set(t.instance, t), this._spatialIndexInvalid = !0;\n  }\n\n  remove(t) {\n    const e = this._objectIdToDisplayId.get(t);\n\n    if (!e) return;\n\n    const s = this._storage.getInstanceId(e),\n          a = I(s),\n          r = c(s),\n          n = this._featureSetsByInstance.get(r);\n\n    this._objectIdToDisplayId.delete(t), this._storage.releaseDisplayId(e), n.removeAtIndex(a), n.isEmpty && this._featureSetsByInstance.delete(r), this._spatialIndexInvalid = !0;\n  }\n\n  forEach(t) {\n    this._objectIdToDisplayId.forEach(e => {\n      const s = this._storage.getInstanceId(e),\n            a = this._lookupFeature(s);\n\n      t(a);\n    });\n  }\n\n  forEachUnsafe(t) {\n    this._objectIdToDisplayId.forEach(e => {\n      const s = this._storage.getInstanceId(e),\n            a = c(s),\n            r = I(s),\n            n = this._getFeatureSet(a);\n\n      n.setIndex(r), t(n);\n    });\n  }\n\n  forEachInBounds(t, e) {\n    const s = this._searchIndex(t);\n\n    for (const a of s) {\n      const t = this.lookupFeatureByDisplayId(a, this._storage);\n      e(r(t));\n    }\n  }\n\n  forEachBounds(t, e, s) {\n    this._rebuildIndex();\n\n    const a = [0, 0, 0, 0];\n\n    for (const r of t) {\n      if (!r.readGeometry()) continue;\n      const t = r.getDisplayId();\n      a[0] = this._storage.getXMin(t), a[1] = this._storage.getYMin(t), a[2] = this._storage.getXMax(t), a[3] = this._storage.getYMax(t), e(i(s, a));\n    }\n  }\n\n  sweepFeatures(t, e, s) {\n    this._spatialIndexInvalid = !0, this._objectIdToDisplayId.forEach((a, r) => {\n      t.has(a) || (e.releaseDisplayId(a), s && s.unsetAttributeData(a), this._objectIdToDisplayId.delete(r));\n    }), this.events.emit(\"changed\");\n  }\n\n  sweepFeatureSets(t) {\n    this._spatialIndexInvalid = !0, this._featureSetsByInstance.forEach((e, s) => {\n      t.has(s) || this._featureSetsByInstance.delete(s);\n    });\n  }\n\n  lookupObjectId(t, e) {\n    const a = this.lookupFeatureByDisplayId(t, e);\n    return s(a) ? null : a.getObjectId();\n  }\n\n  lookupDisplayId(t) {\n    return this._objectIdToDisplayId.get(t);\n  }\n\n  lookupFeatureByDisplayId(t, e) {\n    const s = e.getInstanceId(t);\n    return this._lookupFeature(s);\n  }\n\n  lookupByDisplayIdUnsafe(t) {\n    const e = this._storage.getInstanceId(t),\n          s = c(e),\n          a = I(e),\n          r = this._getFeatureSet(s);\n\n    return r ? (r.setIndex(a), r) : null;\n  }\n\n  _insertFeature(t, e) {\n    const s = this._storage,\n          a = t.getObjectId(),\n          r = h(t.instance, t.getIndex());\n    s.getInstanceId(t.getDisplayId());\n\n    let n = this._objectIdToDisplayId.get(a);\n\n    n || (n = s.createDisplayId(), this._objectIdToDisplayId.set(a, n), this._spatialIndexInvalid = !0), t.setDisplayId(n), s.setInstanceId(n, r), this.setComputedAttributes(s, t, n, e);\n  }\n\n  _searchIndex(t) {\n    this._rebuildIndex();\n\n    const e = {\n      minX: t[0],\n      minY: t[1],\n      maxX: t[2],\n      maxY: t[3]\n    };\n    return this._index.search(e);\n  }\n\n  _rebuildIndex() {\n    if (!this._spatialIndexInvalid) return;\n    const t = [];\n    \"snapshot\" === this.mode ? this._featureSetsByInstance.forEach(e => {\n      const s = e.getCursor();\n\n      for (; s.next();) {\n        const e = s.getDisplayId();\n        this._storage.setBounds(e, s) && t.push(e);\n      }\n    }) : this._objectIdToDisplayId.forEach(e => {\n      const s = this._storage.getInstanceId(e);\n\n      this._storage.setBounds(e, this._lookupFeature(s)) && t.push(e);\n    }), this._index.clear(), this._index.load(t), this._indexSearchCache.clear(), this._spatialIndexInvalid = !1;\n  }\n\n  _lookupFeature(t) {\n    const e = c(t),\n          s = I(t),\n          a = this._getFeatureSet(e);\n\n    if (!a) return null;\n    const r = a.getCursor();\n    return r.setIndex(s), r;\n  }\n\n  _getFeatureSet(t) {\n    return this._featureSetsByInstance.get(t);\n  }\n\n}\n\nexport { l as FeatureStore2D, u as featureAdapter };","map":{"version":3,"sources":["D:/Github/CUSP_DataBase/CUSP_DB/src/main/gis/node_modules/@arcgis/core/views/2d/layers/features/FeatureStore2D.js"],"names":["t","e","isNone","s","isSome","a","unwrap","r","n","fromRect","i","Store2D","o","FeatureSetReaderIndirect","d","h","c","I","u","getObjectId","getAttributes","readAttributes","getAttribute","readAttribute","cloneWithGeometry","getGeometry","readHydratedGeometry","getCentroid","readCentroid","l","constructor","featureAdapter","events","_featureSetsByInstance","Map","_objectIdToDisplayId","_spatialIndexInvalid","_indexSearchCache","_index","minX","_storage","getXMin","minY","getYMin","maxX","getXMax","maxY","getYMax","mode","storage","storeStatistics","forEach","readGeometry","isPoint","lengths","reduce","length","featureCount","vertexCount","ringCount","hasInstance","has","onTileData","addOrUpdate","attachStorage","getCursor","next","getDisplayId","setComputedAttributes","scale","set","instance","_insertFeature","emit","search","_rebuildIndex","id","find","tileId","readers","_searchIndex","bounds","getInstanceId","get","push","from","enqueue","insert","getIndex","createDisplayId","setDisplayId","setInstanceId","remove","delete","releaseDisplayId","removeAtIndex","isEmpty","_lookupFeature","forEachUnsafe","_getFeatureSet","setIndex","forEachInBounds","lookupFeatureByDisplayId","forEachBounds","sweepFeatures","unsetAttributeData","sweepFeatureSets","lookupObjectId","lookupDisplayId","lookupByDisplayIdUnsafe","setBounds","clear","load","FeatureStore2D"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport t from\"../../../../core/CircularArray.js\";import e from\"../../../../core/Evented.js\";import\"../../../../core/has.js\";import{isNone as s,isSome as a,unwrap as r}from\"../../../../core/maybe.js\";import{r as n}from\"../../../../chunks/rbush.js\";import{fromRect as i}from\"../../../../geometry/support/aaBoundingBox.js\";import{Store2D as o}from\"./Store2D.js\";import{FeatureSetReaderIndirect as d}from\"./support/FeatureSetReaderPBFIndirect.js\";function h(t,e){return t<<16|e}function c(t){return(4294901760&t)>>>16}function I(t){return 65535&t}const u={getObjectId:t=>t.getObjectId(),getAttributes:t=>t.readAttributes(),getAttribute:(t,e)=>t.readAttribute(e),cloneWithGeometry:(t,e)=>t,getGeometry:t=>t.readHydratedGeometry(),getCentroid:(t,e)=>t.readCentroid()};class l extends o{constructor(s,a,r){super(s,a),this.featureAdapter=u,this.events=new e,this._featureSetsByInstance=new Map,this._objectIdToDisplayId=new Map,this._spatialIndexInvalid=!0,this._indexSearchCache=new t(50),this._index=n(9,(t=>({minX:this._storage.getXMin(t),minY:this._storage.getYMin(t),maxX:this._storage.getXMax(t),maxY:this._storage.getYMax(t)}))),this._storage=a,this.mode=r}get storage(){return this._storage}get storeStatistics(){let t=0,e=0,s=0;return this.forEach((a=>{const r=a.readGeometry();r&&(e+=r.isPoint?1:r.lengths.reduce(((t,e)=>t+e),0),s+=r.isPoint?1:r.lengths.length,t+=1)})),{featureCount:t,vertexCount:e,ringCount:s}}hasInstance(t){return this._featureSetsByInstance.has(t)}onTileData(t,e){if(s(e.addOrUpdate))return e;if(e.addOrUpdate.attachStorage(this._storage),\"snapshot\"===this.mode){const s=e.addOrUpdate.getCursor();for(;s.next();){const e=s.getDisplayId();this.setComputedAttributes(this._storage,s,e,t.scale)}return e}this._featureSetsByInstance.set(e.addOrUpdate.instance,e.addOrUpdate);const a=e.addOrUpdate.getCursor();for(;a.next();)this._insertFeature(a,t.scale);return this._spatialIndexInvalid=!0,this.events.emit(\"changed\"),e}search(t){this._rebuildIndex();const e=t.id,s=this._indexSearchCache.find((t=>t.tileId===e));if(a(s))return s.readers;const r=new Map,n=this._searchIndex(t.bounds),i=[];for(const a of n){const t=this._storage.getInstanceId(a),e=c(t),s=I(t);r.has(e)||r.set(e,[]);r.get(e).push(s)}return r.forEach(((t,e)=>{const s=this._featureSetsByInstance.get(e);i.push(d.from(s,t))})),this._indexSearchCache.enqueue({tileId:e,readers:i}),i}insert(t){const e=t.getCursor(),s=this._storage;for(;e.next();){var a;const t=h(e.instance,e.getIndex()),r=e.getObjectId(),n=null!=(a=this._objectIdToDisplayId.get(r))?a:this._storage.createDisplayId();e.setDisplayId(n),s.setInstanceId(n,t),this._objectIdToDisplayId.set(r,n)}this._featureSetsByInstance.set(t.instance,t),this._spatialIndexInvalid=!0}remove(t){const e=this._objectIdToDisplayId.get(t);if(!e)return;const s=this._storage.getInstanceId(e),a=I(s),r=c(s),n=this._featureSetsByInstance.get(r);this._objectIdToDisplayId.delete(t),this._storage.releaseDisplayId(e),n.removeAtIndex(a),n.isEmpty&&this._featureSetsByInstance.delete(r),this._spatialIndexInvalid=!0}forEach(t){this._objectIdToDisplayId.forEach((e=>{const s=this._storage.getInstanceId(e),a=this._lookupFeature(s);t(a)}))}forEachUnsafe(t){this._objectIdToDisplayId.forEach((e=>{const s=this._storage.getInstanceId(e),a=c(s),r=I(s),n=this._getFeatureSet(a);n.setIndex(r),t(n)}))}forEachInBounds(t,e){const s=this._searchIndex(t);for(const a of s){const t=this.lookupFeatureByDisplayId(a,this._storage);e(r(t))}}forEachBounds(t,e,s){this._rebuildIndex();const a=[0,0,0,0];for(const r of t){if(!r.readGeometry())continue;const t=r.getDisplayId();a[0]=this._storage.getXMin(t),a[1]=this._storage.getYMin(t),a[2]=this._storage.getXMax(t),a[3]=this._storage.getYMax(t),e(i(s,a))}}sweepFeatures(t,e,s){this._spatialIndexInvalid=!0,this._objectIdToDisplayId.forEach(((a,r)=>{t.has(a)||(e.releaseDisplayId(a),s&&s.unsetAttributeData(a),this._objectIdToDisplayId.delete(r))})),this.events.emit(\"changed\")}sweepFeatureSets(t){this._spatialIndexInvalid=!0,this._featureSetsByInstance.forEach(((e,s)=>{t.has(s)||this._featureSetsByInstance.delete(s)}))}lookupObjectId(t,e){const a=this.lookupFeatureByDisplayId(t,e);return s(a)?null:a.getObjectId()}lookupDisplayId(t){return this._objectIdToDisplayId.get(t)}lookupFeatureByDisplayId(t,e){const s=e.getInstanceId(t);return this._lookupFeature(s)}lookupByDisplayIdUnsafe(t){const e=this._storage.getInstanceId(t),s=c(e),a=I(e),r=this._getFeatureSet(s);return r?(r.setIndex(a),r):null}_insertFeature(t,e){const s=this._storage,a=t.getObjectId(),r=h(t.instance,t.getIndex());s.getInstanceId(t.getDisplayId());let n=this._objectIdToDisplayId.get(a);n||(n=s.createDisplayId(),this._objectIdToDisplayId.set(a,n),this._spatialIndexInvalid=!0),t.setDisplayId(n),s.setInstanceId(n,r),this.setComputedAttributes(s,t,n,e)}_searchIndex(t){this._rebuildIndex();const e={minX:t[0],minY:t[1],maxX:t[2],maxY:t[3]};return this._index.search(e)}_rebuildIndex(){if(!this._spatialIndexInvalid)return;const t=[];\"snapshot\"===this.mode?this._featureSetsByInstance.forEach((e=>{const s=e.getCursor();for(;s.next();){const e=s.getDisplayId();this._storage.setBounds(e,s)&&t.push(e)}})):this._objectIdToDisplayId.forEach((e=>{const s=this._storage.getInstanceId(e);this._storage.setBounds(e,this._lookupFeature(s))&&t.push(e)})),this._index.clear(),this._index.load(t),this._indexSearchCache.clear(),this._spatialIndexInvalid=!1}_lookupFeature(t){const e=c(t),s=I(t),a=this._getFeatureSet(e);if(!a)return null;const r=a.getCursor();return r.setIndex(s),r}_getFeatureSet(t){return this._featureSetsByInstance.get(t)}}export{l as FeatureStore2D,u as featureAdapter};\n"]},"metadata":{},"sourceType":"module"}