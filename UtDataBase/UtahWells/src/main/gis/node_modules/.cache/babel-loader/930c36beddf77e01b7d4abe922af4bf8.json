{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport e from \"../../Color.js\";\nimport t from \"../../request.js\";\nimport s from \"../../core/Error.js\";\nimport o from \"../../core/Logger.js\";\nimport i from \"../../core/LRUCache.js\";\nimport { isSome as r } from \"../../core/maybe.js\";\nimport { isAbortError as n } from \"../../core/promiseUtils.js\";\nimport { numericHash as l } from \"../../core/string.js\";\nimport { loadArcade as a, createDictionaryExpression as c } from \"../../support/arcadeOnDemand.js\";\nimport m from \"../../symbols/CIMSymbol.js\";\nconst f = o.getLogger(\"esri.renderers.support.DictionaryLoader\"),\n      h = {\n  type: \"CIMSimpleLineCallout\",\n  lineSymbol: {\n    type: \"CIMLineSymbol\",\n    symbolLayers: [{\n      type: \"CIMSolidStroke\",\n      width: .5,\n      color: [0, 0, 0, 255]\n    }]\n  }\n};\n\nclass y {\n  constructor(e, t, s) {\n    this.config = null, this.fieldMap = null, this.url = null, this._ongoingRequests = new Map(), this._symbolCache = new i(100), this.url = e, this.config = t, this.fieldMap = s;\n  }\n\n  getSymbolFields() {\n    return this._symbolFields;\n  }\n\n  async getSymbolAsync(t, s) {\n    let o;\n    this._dictionaryPromise || (this._dictionaryPromise = this.fetchResources(s));\n\n    try {\n      o = await this._dictionaryPromise;\n    } catch (b) {\n      if (n(b)) return this._dictionaryPromise = null, null;\n    }\n\n    const i = {};\n    if (this.fieldMap) for (const e of this._symbolFields) {\n      const s = this.fieldMap[e];\n\n      if (s && null != t.attributes[s]) {\n        const o = \"\" + t.attributes[s];\n        i[e] = o;\n      } else i[e] = \"\";\n    }\n    const a = o(i, s);\n    if (!a || \"string\" != typeof a) return null;\n\n    const c = l(a).toString(),\n          m = this._symbolCache.get(c);\n\n    if (m) return m.catch(() => {\n      this._symbolCache.pop(c);\n    }), m;\n    const f = a.split(\";\"),\n          h = [],\n          y = [];\n\n    for (const r of f) if (r) if (r.includes(\"po:\")) {\n      const t = r.substr(3).split(\"|\");\n\n      if (3 === t.length) {\n        const s = t[0],\n              o = t[1];\n        let i = t[2];\n        if (\"DashTemplate\" === o) i = i.split(\" \").map(e => Number(e));else if (\"Color\" === o) {\n          const t = new e(i).toRgba();\n          i = [t[0], t[1], t[2], 255 * t[3]];\n        } else i = Number(i);\n        y.push({\n          primitiveName: s,\n          propertyName: o,\n          value: i\n        });\n      }\n    } else if (r.includes(\"|\")) {\n      for (const e of r.split(\"|\")) if (this._itemNames.has(e)) {\n        h.push(e);\n        break;\n      }\n    } else this._itemNames.has(r) && h.push(r);\n\n    const u = !r(t.geometry) || !t.geometry.hasZ && \"point\" === t.geometry.type,\n          p = this._cimPartsToCIMSymbol(h, y, u, s);\n\n    return this._symbolCache.put(c, p, 1), p;\n  }\n\n  async fetchResources(e) {\n    if (this._dictionaryPromise) return this._dictionaryPromise;\n    if (!this.url) return void f.error(\"no valid URL!\");\n    const o = r(e) ? e.abortOptions : null,\n          i = t(this.url + \"/resources/styles/dictionary-info.json\", {\n      responseType: \"json\",\n      query: {\n        f: \"json\"\n      },\n      ...o\n    }),\n          [{\n      data: n\n    }] = await Promise.all([i, a()]);\n    if (!n) throw this._dictionaryPromise = null, new s(\"esri.renderers.DictionaryRenderer\", \"Bad dictionary data!\");\n    const l = n.expression,\n          m = n.authoringInfo;\n    this._refSymbolUrlTemplate = this.url + \"/\" + n.cimRefTemplateUrl, this._itemNames = new Set(n.itemsNames), this._symbolFields = m.symbol;\n    const h = {};\n\n    if (this.config) {\n      const e = this.config;\n\n      for (const t in e) h[t] = e[t];\n    }\n\n    if (m.configuration) for (const t of m.configuration) h.hasOwnProperty(t.name) || (h[t.name] = t.value);\n    const y = [];\n    if (r(e) && e.fields && this.fieldMap) for (const t of this._symbolFields) {\n      const s = this.fieldMap[t],\n            o = e.fields.filter(e => e.name === s);\n      o.length > 0 && y.push({ ...o[0],\n        name: t\n      });\n    }\n    return this._dictionaryPromise = c(l, r(e) ? e.spatialReference : null, y, h).then(e => {\n      const t = {\n        scale: 0\n      };\n      return (s, o) => {\n        const i = e.repurposeFeature({\n          geometry: null,\n          attributes: s\n        });\n        return t.scale = r(o) ? o.scale : void 0, e.evaluate({\n          $feature: i,\n          $view: t\n        });\n      };\n    }).catch(e => (f.error(\"Creating dictinoary expression failed:\", e), null)), this._dictionaryPromise;\n  }\n\n  async _cimPartsToCIMSymbol(e, t, s, o) {\n    const i = new Array(e.length);\n\n    for (let l = 0; l < e.length; l++) i[l] = this._getSymbolPart(e[l], o);\n\n    const r = await Promise.all(i),\n          n = this.fieldMap;\n\n    for (const l of r) u(l, n);\n\n    return new m({\n      data: this._combineSymbolParts(r, t, s)\n    });\n  }\n\n  async _getSymbolPart(e, s) {\n    if (this._ongoingRequests.has(e)) return this._ongoingRequests.get(e).then(e => e.data);\n\n    const o = this._refSymbolUrlTemplate.replace(/\\{itemName\\}/gi, e),\n          i = t(o, {\n      responseType: \"json\",\n      query: {\n        f: \"json\"\n      },\n      ...s\n    });\n\n    this._ongoingRequests.set(e, i);\n\n    try {\n      return (await i).data;\n    } catch (r) {\n      return this._ongoingRequests.delete(e), Promise.reject(r);\n    }\n  }\n\n  _combineSymbolParts(e, t, s) {\n    if (!e || 0 === e.length) return null;\n    const o = { ...e[0]\n    };\n\n    if (e.length > 1) {\n      o.symbolLayers = [];\n\n      for (const t of e) {\n        const e = t;\n        o.symbolLayers.unshift(...e.symbolLayers);\n      }\n    }\n\n    return s && (o.callout = h), {\n      type: \"CIMSymbolReference\",\n      symbol: o,\n      primitiveOverrides: t\n    };\n  }\n\n}\n\nfunction u(e, t) {\n  if (!e) return;\n  const s = e.symbolLayers;\n  if (!s) return;\n  let o = s.length;\n\n  for (; o--;) {\n    const e = s[o];\n    if (e && !1 !== e.enable && \"CIMVectorMarker\" === e.type) p(e, t);\n  }\n}\n\nfunction p(e, t) {\n  const s = e.markerGraphics;\n  if (s) for (const o of s) {\n    if (!o) continue;\n    const e = o.symbol;\n    if (e) switch (e.type) {\n      case \"CIMPointSymbol\":\n      case \"CIMLineSymbol\":\n      case \"CIMPolygonSymbol\":\n        u(e, t);\n        break;\n\n      case \"CIMTextSymbol\":\n        e.fieldMap = t;\n    }\n  }\n}\n\nexport { y as DictionaryLoader };","map":{"version":3,"sources":["D:/Github/CUSP_DataBase/CUSP_DB/src/main/gis/node_modules/@arcgis/core/renderers/support/DictionaryLoader.js"],"names":["e","t","s","o","i","isSome","r","isAbortError","n","numericHash","l","loadArcade","a","createDictionaryExpression","c","m","f","getLogger","h","type","lineSymbol","symbolLayers","width","color","y","constructor","config","fieldMap","url","_ongoingRequests","Map","_symbolCache","getSymbolFields","_symbolFields","getSymbolAsync","_dictionaryPromise","fetchResources","b","attributes","toString","get","catch","pop","split","includes","substr","length","map","Number","toRgba","push","primitiveName","propertyName","value","_itemNames","has","u","geometry","hasZ","p","_cimPartsToCIMSymbol","put","error","abortOptions","responseType","query","data","Promise","all","expression","authoringInfo","_refSymbolUrlTemplate","cimRefTemplateUrl","Set","itemsNames","symbol","configuration","hasOwnProperty","name","fields","filter","spatialReference","then","scale","repurposeFeature","evaluate","$feature","$view","Array","_getSymbolPart","_combineSymbolParts","replace","set","delete","reject","unshift","callout","primitiveOverrides","enable","markerGraphics","DictionaryLoader"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport e from\"../../Color.js\";import t from\"../../request.js\";import s from\"../../core/Error.js\";import o from\"../../core/Logger.js\";import i from\"../../core/LRUCache.js\";import{isSome as r}from\"../../core/maybe.js\";import{isAbortError as n}from\"../../core/promiseUtils.js\";import{numericHash as l}from\"../../core/string.js\";import{loadArcade as a,createDictionaryExpression as c}from\"../../support/arcadeOnDemand.js\";import m from\"../../symbols/CIMSymbol.js\";const f=o.getLogger(\"esri.renderers.support.DictionaryLoader\"),h={type:\"CIMSimpleLineCallout\",lineSymbol:{type:\"CIMLineSymbol\",symbolLayers:[{type:\"CIMSolidStroke\",width:.5,color:[0,0,0,255]}]}};class y{constructor(e,t,s){this.config=null,this.fieldMap=null,this.url=null,this._ongoingRequests=new Map,this._symbolCache=new i(100),this.url=e,this.config=t,this.fieldMap=s}getSymbolFields(){return this._symbolFields}async getSymbolAsync(t,s){let o;this._dictionaryPromise||(this._dictionaryPromise=this.fetchResources(s));try{o=await this._dictionaryPromise}catch(b){if(n(b))return this._dictionaryPromise=null,null}const i={};if(this.fieldMap)for(const e of this._symbolFields){const s=this.fieldMap[e];if(s&&null!=t.attributes[s]){const o=\"\"+t.attributes[s];i[e]=o}else i[e]=\"\"}const a=o(i,s);if(!a||\"string\"!=typeof a)return null;const c=l(a).toString(),m=this._symbolCache.get(c);if(m)return m.catch((()=>{this._symbolCache.pop(c)})),m;const f=a.split(\";\"),h=[],y=[];for(const r of f)if(r)if(r.includes(\"po:\")){const t=r.substr(3).split(\"|\");if(3===t.length){const s=t[0],o=t[1];let i=t[2];if(\"DashTemplate\"===o)i=i.split(\" \").map((e=>Number(e)));else if(\"Color\"===o){const t=new e(i).toRgba();i=[t[0],t[1],t[2],255*t[3]]}else i=Number(i);y.push({primitiveName:s,propertyName:o,value:i})}}else if(r.includes(\"|\")){for(const e of r.split(\"|\"))if(this._itemNames.has(e)){h.push(e);break}}else this._itemNames.has(r)&&h.push(r);const u=!r(t.geometry)||!t.geometry.hasZ&&\"point\"===t.geometry.type,p=this._cimPartsToCIMSymbol(h,y,u,s);return this._symbolCache.put(c,p,1),p}async fetchResources(e){if(this._dictionaryPromise)return this._dictionaryPromise;if(!this.url)return void f.error(\"no valid URL!\");const o=r(e)?e.abortOptions:null,i=t(this.url+\"/resources/styles/dictionary-info.json\",{responseType:\"json\",query:{f:\"json\"},...o}),[{data:n}]=await Promise.all([i,a()]);if(!n)throw this._dictionaryPromise=null,new s(\"esri.renderers.DictionaryRenderer\",\"Bad dictionary data!\");const l=n.expression,m=n.authoringInfo;this._refSymbolUrlTemplate=this.url+\"/\"+n.cimRefTemplateUrl,this._itemNames=new Set(n.itemsNames),this._symbolFields=m.symbol;const h={};if(this.config){const e=this.config;for(const t in e)h[t]=e[t]}if(m.configuration)for(const t of m.configuration)h.hasOwnProperty(t.name)||(h[t.name]=t.value);const y=[];if(r(e)&&e.fields&&this.fieldMap)for(const t of this._symbolFields){const s=this.fieldMap[t],o=e.fields.filter((e=>e.name===s));o.length>0&&y.push({...o[0],name:t})}return this._dictionaryPromise=c(l,r(e)?e.spatialReference:null,y,h).then((e=>{const t={scale:0};return(s,o)=>{const i=e.repurposeFeature({geometry:null,attributes:s});return t.scale=r(o)?o.scale:void 0,e.evaluate({$feature:i,$view:t})}})).catch((e=>(f.error(\"Creating dictinoary expression failed:\",e),null))),this._dictionaryPromise}async _cimPartsToCIMSymbol(e,t,s,o){const i=new Array(e.length);for(let l=0;l<e.length;l++)i[l]=this._getSymbolPart(e[l],o);const r=await Promise.all(i),n=this.fieldMap;for(const l of r)u(l,n);return new m({data:this._combineSymbolParts(r,t,s)})}async _getSymbolPart(e,s){if(this._ongoingRequests.has(e))return this._ongoingRequests.get(e).then((e=>e.data));const o=this._refSymbolUrlTemplate.replace(/\\{itemName\\}/gi,e),i=t(o,{responseType:\"json\",query:{f:\"json\"},...s});this._ongoingRequests.set(e,i);try{return(await i).data}catch(r){return this._ongoingRequests.delete(e),Promise.reject(r)}}_combineSymbolParts(e,t,s){if(!e||0===e.length)return null;const o={...e[0]};if(e.length>1){o.symbolLayers=[];for(const t of e){const e=t;o.symbolLayers.unshift(...e.symbolLayers)}}return s&&(o.callout=h),{type:\"CIMSymbolReference\",symbol:o,primitiveOverrides:t}}}function u(e,t){if(!e)return;const s=e.symbolLayers;if(!s)return;let o=s.length;for(;o--;){const e=s[o];if(e&&!1!==e.enable&&\"CIMVectorMarker\"===e.type)p(e,t)}}function p(e,t){const s=e.markerGraphics;if(s)for(const o of s){if(!o)continue;const e=o.symbol;if(e)switch(e.type){case\"CIMPointSymbol\":case\"CIMLineSymbol\":case\"CIMPolygonSymbol\":u(e,t);break;case\"CIMTextSymbol\":e.fieldMap=t}}}export{y as DictionaryLoader};\n"]},"metadata":{},"sourceType":"module"}