{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../../../chunks/tslib.es6.js\";\nimport { equals as t } from \"../../../../../core/arrayUtils.js\";\nimport { AsyncSequence as i } from \"../../../../../core/AsyncSequence.js\";\nimport { HandleOwner as s } from \"../../../../../core/HandleOwner.js\";\nimport { makeHandle as r } from \"../../../../../core/handleUtils.js\";\nimport o from \"../../../../../core/Logger.js\";\nimport { isSome as n, isNone as a, unwrap as l } from \"../../../../../core/maybe.js\";\nimport { createTask as u, throwIfAbortError as c } from \"../../../../../core/promiseUtils.js\";\nimport { sync as d } from \"../../../../../core/reactiveUtils.js\";\nimport { property as h } from \"../../../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../../../core/has.js\";\nimport \"../../../../../core/accessorSupport/ensureType.js\";\nimport { subclass as p } from \"../../../../../core/accessorSupport/decorators/subclass.js\";\nimport f from \"../../../../../geometry/Extent.js\";\nimport { toExtent as y } from \"../../../../../geometry/support/aaBoundingRect.js\";\nimport { unquantizeOptimizedFeatureSet as g, convertFromFeatureSet as m } from \"../../../../../layers/graphics/featureConversionUtils.js\";\nimport { OptimizedFeatureSetParserContext as _ } from \"../../../../../rest/query/operations/pbfOptimizedFeatureSet.js\";\nimport { executeQueryForExtent as F, executeQueryPBF as b, executeQuery as T } from \"../../../../../rest/query/operations/query.js\";\nimport v from \"../../../../../rest/support/Query.js\";\nimport { StateType as P, PendingFeatureTile as I } from \"./PendingFeatureTile.js\";\nconst O = o.getLogger(\"esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTiledFetcher\");\nlet S = class extends s {\n  constructor(e) {\n    super(e), this.tilesOfInterest = [], this.availability = 0, this.pendingTiles = new Map(), this.pendingEdits = new i(), this.pendingEditsAbortController = new AbortController();\n  }\n\n  get minimumVerticesPerFeature() {\n    var e;\n\n    switch (null == (e = this.store) ? void 0 : e.featureStore.geometryType) {\n      case \"esriGeometryPoint\":\n      case \"esriGeometryMultipoint\":\n        return 1;\n\n      case \"esriGeometryPolygon\":\n        return 4;\n\n      case \"esriGeometryPolyline\":\n        return 2;\n    }\n  }\n\n  set filter(e) {\n    const t = this._get(\"filter\"),\n          i = this._filterProperties(e);\n\n    JSON.stringify(t) !== JSON.stringify(i) && this._set(\"filter\", i);\n  }\n\n  set customParameters(e) {\n    const t = this._get(\"customParameters\");\n\n    JSON.stringify(t) !== JSON.stringify(e) && this._set(\"customParameters\", e);\n  }\n\n  get configuration() {\n    return {\n      filter: this.filter,\n      customParameters: this.customParameters,\n      tileInfo: this.tileInfo,\n      tileSize: this.tileSize\n    };\n  }\n\n  set tileInfo(e) {\n    const t = this._get(\"tileInfo\");\n\n    t !== e && (n(e) && n(t) && JSON.stringify(e) === JSON.stringify(t) || (this._set(\"tileInfo\", e), this.store.tileInfo = e));\n  }\n\n  set tileSize(e) {\n    this._get(\"tileSize\") !== e && this._set(\"tileSize\", e);\n  }\n\n  get updating() {\n    return this.updatingHandles.updating || this.pendingEdits.updating;\n  }\n\n  initialize() {\n    this._initializeFetchExtent(), this.updatingHandles.add(() => this.configuration, () => this.refresh()), this.updatingHandles.add(() => this.tilesOfInterest, (e, i) => {\n      t(e, i, (_ref, _ref2) => {\n        let {\n          id: e\n        } = _ref;\n        let {\n          id: t\n        } = _ref2;\n        return e === t;\n      }) || this._process();\n    }, d);\n  }\n\n  destroy() {\n    this.pendingTiles.forEach(e => this._deletePendingTile(e)), this.pendingTiles.clear(), this.store.destroy(), this.tilesOfInterest.length = 0, this.pendingEditsAbortController.abort(), this.pendingEditsAbortController = null;\n  }\n\n  refresh() {\n    this.store.refresh(), this.pendingTiles.forEach(e => this._deletePendingTile(e)), this._process();\n  }\n\n  applyEdits(e) {\n    this.pendingEdits.push(e, async e => {\n      if (0 === e.addedFeatures.length && 0 === e.updatedFeatures.length && 0 === e.deletedFeatures.length) return;\n\n      for (const [, i] of this.pendingTiles) i.reset();\n\n      const t = { ...e,\n        deletedFeatures: e.deletedFeatures.map(_ref3 => {\n          let {\n            objectId: e,\n            globalId: t\n          } = _ref3;\n          return e && -1 !== e ? e : this._lookupObjectIdByGlobalId(t);\n        })\n      };\n      await this.updatingHandles.addPromise(this.store.processEdits(t, (e, t) => this._queryFeaturesById(e, t), this.pendingEditsAbortController.signal)), this._processPendingTiles();\n    });\n  }\n\n  _initializeFetchExtent() {\n    if (!this.capabilities.query.supportsExtent) return;\n    const e = u(async e => {\n      try {\n        var t;\n        const i = await F(this.url, new v({\n          where: \"1=1\",\n          outSpatialReference: this.spatialReference,\n          cacheHint: !!this.capabilities.query.supportsCacheHint || void 0\n        }), {\n          query: this.configuration.customParameters,\n          signal: e\n        });\n        this.store.extent = f.fromJSON(null == (t = i.data) ? void 0 : t.extent);\n      } catch (i) {\n        c(i), O.warn(\"Failed to fetch data extent\", i);\n      }\n    });\n    this.updatingHandles.addPromise(e.promise.then(() => this._process())), this.handles.add(r(() => e.abort()));\n  }\n\n  get debugInfo() {\n    return {\n      numberOfFeatures: this.store.featureStore.numFeatures,\n      tilesOfInterest: this.tilesOfInterest,\n      pendingTiles: Array.from(this.pendingTiles.values()).map(e => e.debugInfo),\n      storedTiles: this.store.debugInfo\n    };\n  }\n\n  _process() {\n    this._markTilesNotAlive(), this._createPendingTiles(), this._deletePendingTiles(), this._processPendingTiles();\n  }\n\n  _markTilesNotAlive() {\n    for (const [, e] of this.pendingTiles) e.alive = !1;\n  }\n\n  _createPendingTiles() {\n    const e = this._collectMissingTilesInfo();\n\n    if (this._setAvailability(a(e) ? 1 : e.coveredArea / e.fullArea), !a(e)) for (const {\n      data: t,\n      resolution: i\n    } of e.missingTiles) {\n      const e = this.pendingTiles.get(t.id);\n      e ? (e.resolution = i, e.alive = !0) : this._createPendingTile(t, i);\n    }\n  }\n\n  _collectMissingTilesInfo() {\n    let e = null;\n\n    for (let t = this.tilesOfInterest.length - 1; t >= 0; t--) {\n      const i = this.tilesOfInterest[t],\n            s = this.store.process(i, (e, t) => this._verifyTileComplexity(e, t));\n      a(e) ? e = s : e.prepend(s);\n    }\n\n    return e;\n  }\n\n  _deletePendingTiles() {\n    for (const [, e] of this.pendingTiles) e.alive || this._deletePendingTile(e);\n  }\n\n  _processPendingTiles() {\n    const e = {\n      fetchCount: (e, t) => this._fetchCount(e, t),\n      fetchFeatures: (e, t, i) => this._fetchFeatures(e, t, i),\n      finish: (e, t) => this._finishPendingTile(e, t),\n      resume: () => this._processPendingTiles()\n    };\n    if (this._ensureFetchAllCounts(e)) for (const [, t] of this.pendingTiles) this._verifyTileComplexity(this.store.getFeatureCount(t.data), t.resolution) && this.updatingHandles.addPromise(t.process(e));\n  }\n\n  _verifyTileComplexity(e, t) {\n    return this._verifyVertexComplexity(e) && this._verifyFeatureDensity(e, t);\n  }\n\n  _verifyVertexComplexity(e) {\n    return e * this.minimumVerticesPerFeature < x;\n  }\n\n  _verifyFeatureDensity(e, t) {\n    if (a(this.tileInfo)) return !1;\n    const i = this.tileSize * t;\n    return e * (E / (i * i)) < w;\n  }\n\n  _ensureFetchAllCounts(e) {\n    let t = !0;\n\n    for (const [, i] of this.pendingTiles) i.state.type < P.FETCHED_COUNT && this.updatingHandles.addPromise(i.process(e)), i.state.type <= P.FETCH_COUNT && (t = !1);\n\n    return t;\n  }\n\n  _finishPendingTile(e, t) {\n    this.store.add(e.data, t), this._deletePendingTile(e), this._updateAvailability();\n  }\n\n  _updateAvailability() {\n    const e = this._collectMissingTilesInfo();\n\n    this._setAvailability(a(e) ? 1 : e.coveredArea / e.fullArea);\n  }\n\n  _setAvailability(e) {\n    this._set(\"availability\", e);\n  }\n\n  _createPendingTile(e, t) {\n    const i = new I(e, t);\n    return this.pendingTiles.set(e.id, i), i;\n  }\n\n  _deletePendingTile(e) {\n    e.reset(), this.pendingTiles.delete(e.data.id);\n  }\n\n  async _fetchCount(e, t) {\n    return this.store.fetchCount(e.data, this.url, this._createCountQuery(e), {\n      query: this.customParameters,\n      timeout: j,\n      signal: t\n    });\n  }\n\n  async _fetchFeatures(e, t, i) {\n    let s,\n        r = 0,\n        o = 0,\n        n = t;\n\n    for (;;) {\n      const a = this._createFeaturesQuery(e),\n            u = this._setPagingParameters(a, r, n),\n            {\n        features: c,\n        exceededTransferLimit: d\n      } = await this._queryFeatures(a, i);\n\n      if (u && (r += l(a.num)), o += c.length, s = s ? s.concat(c) : c, n = t - o, !u || !d || n <= 0) return s;\n    }\n  }\n\n  _filterProperties(e) {\n    return a(e) ? {\n      where: \"1=1\",\n      gdbVersion: void 0,\n      timeExtent: void 0\n    } : {\n      where: e.where || \"1=1\",\n      timeExtent: e.timeExtent,\n      gdbVersion: e.gdbVersion\n    };\n  }\n\n  _lookupObjectIdByGlobalId(e) {\n    const t = this.globalIdField,\n          i = this.objectIdField;\n    if (a(t)) throw new Error(\"Expected globalIdField to be defined\");\n    let s = null;\n    if (this.store.featureStore.forEach(r => {\n      var o;\n      e === r.attributes[t] && (s = null != (o = r.objectId) ? o : r.attributes[i]);\n    }), a(s)) throw new Error(`Expected to find a feature with globalId ${e}`);\n    return s;\n  }\n\n  _queryFeaturesById(e, t) {\n    const i = this._createFeaturesQuery(null);\n\n    return i.objectIds = e, this._queryFeatures(i, t);\n  }\n\n  _queryFeatures(e, t) {\n    return this.capabilities.query.supportsFormatPBF ? this._queryFeaturesPBF(e, t) : this._queryFeaturesJSON(e, t);\n  }\n\n  async _queryFeaturesPBF(e, t) {\n    const {\n      sourceSpatialReference: i\n    } = this,\n          {\n      data: s\n    } = await b(this.url, e, new _({\n      sourceSpatialReference: i\n    }), {\n      query: this.configuration.customParameters,\n      timeout: j,\n      signal: t\n    });\n    return g(s);\n  }\n\n  async _queryFeaturesJSON(e, t) {\n    const {\n      sourceSpatialReference: i\n    } = this,\n          {\n      data: s\n    } = await T(this.url, e, i, {\n      query: this.configuration.customParameters,\n      timeout: j,\n      signal: t\n    });\n    return m(s, this.objectIdField);\n  }\n\n  _createCountQuery(e) {\n    const t = this._createBaseQuery(e);\n\n    return this.capabilities.query.supportsCacheHint && (t.cacheHint = !0), t;\n  }\n\n  _createFeaturesQuery(e) {\n    const t = this._createBaseQuery(e);\n\n    return t.outFields = this.globalIdField ? [this.globalIdField, this.objectIdField] : [this.objectIdField], t.returnGeometry = !0, n(e) && (this.capabilities.query.supportsResultType ? t.resultType = \"tile\" : this.capabilities.query.supportsCacheHint && (t.cacheHint = !0)), t;\n  }\n\n  _createBaseQuery(e) {\n    const t = new v({\n      returnZ: !1,\n      returnM: !1,\n      geometry: n(this.tileInfo) && n(e) ? y(e.data.extent, this.tileInfo.spatialReference) : void 0\n    }),\n          i = this.configuration.filter;\n    return n(i) && (t.where = i.where, t.gdbVersion = i.gdbVersion, t.timeExtent = i.timeExtent), t.outSpatialReference = this.spatialReference, t;\n  }\n\n  _setPagingParameters(e, t, i) {\n    if (!this.capabilities.query.supportsPagination) return !1;\n    const {\n      supportsMaxRecordCountFactor: s,\n      supportsCacheHint: r,\n      tileMaxRecordCount: o,\n      maxRecordCount: n,\n      supportsResultType: a\n    } = this.capabilities.query,\n          l = s ? v.MAX_MAX_RECORD_COUNT_FACTOR : 1,\n          u = l * ((a || r) && o ? o : n || C);\n    return e.start = t, s ? (e.maxRecordCountFactor = Math.min(l, Math.ceil(i / u)), e.num = Math.min(i, e.maxRecordCountFactor * u)) : e.num = Math.min(i, u), !0;\n  }\n\n};\ne([h({\n  constructOnly: !0\n})], S.prototype, \"url\", void 0), e([h({\n  constructOnly: !0\n})], S.prototype, \"objectIdField\", void 0), e([h({\n  constructOnly: !0\n})], S.prototype, \"globalIdField\", void 0), e([h({\n  constructOnly: !0\n})], S.prototype, \"capabilities\", void 0), e([h({\n  constructOnly: !0\n})], S.prototype, \"sourceSpatialReference\", void 0), e([h({\n  constructOnly: !0\n})], S.prototype, \"spatialReference\", void 0), e([h({\n  constructOnly: !0\n})], S.prototype, \"store\", void 0), e([h({\n  readOnly: !0\n})], S.prototype, \"minimumVerticesPerFeature\", null), e([h()], S.prototype, \"filter\", null), e([h()], S.prototype, \"customParameters\", null), e([h({\n  readOnly: !0\n})], S.prototype, \"configuration\", null), e([h()], S.prototype, \"tileInfo\", null), e([h()], S.prototype, \"tileSize\", null), e([h()], S.prototype, \"tilesOfInterest\", void 0), e([h({\n  readOnly: !0\n})], S.prototype, \"updating\", null), e([h({\n  readOnly: !0\n})], S.prototype, \"availability\", void 0), S = e([p(\"esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTiledFetcher\")], S);\nconst C = 2e3,\n      j = 6e5,\n      x = 1e6,\n      E = 25,\n      w = 1;\nexport { S as FeatureServiceTiledFetcher };","map":{"version":3,"sources":["D:/Github/CUSP_DataBase/CUSP_DB/src/main/gis/node_modules/@arcgis/core/views/interactive/snapping/featureSources/featureServiceSource/FeatureServiceTiledFetcher.js"],"names":["_","e","equals","t","AsyncSequence","i","HandleOwner","s","makeHandle","r","o","isSome","n","isNone","a","unwrap","l","createTask","u","throwIfAbortError","c","sync","d","property","h","subclass","p","f","toExtent","y","unquantizeOptimizedFeatureSet","g","convertFromFeatureSet","m","OptimizedFeatureSetParserContext","executeQueryForExtent","F","executeQueryPBF","b","executeQuery","T","v","StateType","P","PendingFeatureTile","I","O","getLogger","S","constructor","tilesOfInterest","availability","pendingTiles","Map","pendingEdits","pendingEditsAbortController","AbortController","minimumVerticesPerFeature","store","featureStore","geometryType","filter","_get","_filterProperties","JSON","stringify","_set","customParameters","configuration","tileInfo","tileSize","updating","updatingHandles","initialize","_initializeFetchExtent","add","refresh","id","_process","destroy","forEach","_deletePendingTile","clear","length","abort","applyEdits","push","addedFeatures","updatedFeatures","deletedFeatures","reset","map","objectId","globalId","_lookupObjectIdByGlobalId","addPromise","processEdits","_queryFeaturesById","signal","_processPendingTiles","capabilities","query","supportsExtent","url","where","outSpatialReference","spatialReference","cacheHint","supportsCacheHint","extent","fromJSON","data","warn","promise","then","handles","debugInfo","numberOfFeatures","numFeatures","Array","from","values","storedTiles","_markTilesNotAlive","_createPendingTiles","_deletePendingTiles","alive","_collectMissingTilesInfo","_setAvailability","coveredArea","fullArea","resolution","missingTiles","get","_createPendingTile","process","_verifyTileComplexity","prepend","fetchCount","_fetchCount","fetchFeatures","_fetchFeatures","finish","_finishPendingTile","resume","_ensureFetchAllCounts","getFeatureCount","_verifyVertexComplexity","_verifyFeatureDensity","x","E","w","state","type","FETCHED_COUNT","FETCH_COUNT","_updateAvailability","set","delete","_createCountQuery","timeout","j","_createFeaturesQuery","_setPagingParameters","features","exceededTransferLimit","_queryFeatures","num","concat","gdbVersion","timeExtent","globalIdField","objectIdField","Error","attributes","objectIds","supportsFormatPBF","_queryFeaturesPBF","_queryFeaturesJSON","sourceSpatialReference","_createBaseQuery","outFields","returnGeometry","supportsResultType","resultType","returnZ","returnM","geometry","supportsPagination","supportsMaxRecordCountFactor","tileMaxRecordCount","maxRecordCount","MAX_MAX_RECORD_COUNT_FACTOR","C","start","maxRecordCountFactor","Math","min","ceil","constructOnly","prototype","readOnly","FeatureServiceTiledFetcher"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../../../chunks/tslib.es6.js\";import{equals as t}from\"../../../../../core/arrayUtils.js\";import{AsyncSequence as i}from\"../../../../../core/AsyncSequence.js\";import{HandleOwner as s}from\"../../../../../core/HandleOwner.js\";import{makeHandle as r}from\"../../../../../core/handleUtils.js\";import o from\"../../../../../core/Logger.js\";import{isSome as n,isNone as a,unwrap as l}from\"../../../../../core/maybe.js\";import{createTask as u,throwIfAbortError as c}from\"../../../../../core/promiseUtils.js\";import{sync as d}from\"../../../../../core/reactiveUtils.js\";import{property as h}from\"../../../../../core/accessorSupport/decorators/property.js\";import\"../../../../../core/has.js\";import\"../../../../../core/accessorSupport/ensureType.js\";import{subclass as p}from\"../../../../../core/accessorSupport/decorators/subclass.js\";import f from\"../../../../../geometry/Extent.js\";import{toExtent as y}from\"../../../../../geometry/support/aaBoundingRect.js\";import{unquantizeOptimizedFeatureSet as g,convertFromFeatureSet as m}from\"../../../../../layers/graphics/featureConversionUtils.js\";import{OptimizedFeatureSetParserContext as _}from\"../../../../../rest/query/operations/pbfOptimizedFeatureSet.js\";import{executeQueryForExtent as F,executeQueryPBF as b,executeQuery as T}from\"../../../../../rest/query/operations/query.js\";import v from\"../../../../../rest/support/Query.js\";import{StateType as P,PendingFeatureTile as I}from\"./PendingFeatureTile.js\";const O=o.getLogger(\"esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTiledFetcher\");let S=class extends s{constructor(e){super(e),this.tilesOfInterest=[],this.availability=0,this.pendingTiles=new Map,this.pendingEdits=new i,this.pendingEditsAbortController=new AbortController}get minimumVerticesPerFeature(){var e;switch(null==(e=this.store)?void 0:e.featureStore.geometryType){case\"esriGeometryPoint\":case\"esriGeometryMultipoint\":return 1;case\"esriGeometryPolygon\":return 4;case\"esriGeometryPolyline\":return 2}}set filter(e){const t=this._get(\"filter\"),i=this._filterProperties(e);JSON.stringify(t)!==JSON.stringify(i)&&this._set(\"filter\",i)}set customParameters(e){const t=this._get(\"customParameters\");JSON.stringify(t)!==JSON.stringify(e)&&this._set(\"customParameters\",e)}get configuration(){return{filter:this.filter,customParameters:this.customParameters,tileInfo:this.tileInfo,tileSize:this.tileSize}}set tileInfo(e){const t=this._get(\"tileInfo\");t!==e&&(n(e)&&n(t)&&JSON.stringify(e)===JSON.stringify(t)||(this._set(\"tileInfo\",e),this.store.tileInfo=e))}set tileSize(e){this._get(\"tileSize\")!==e&&this._set(\"tileSize\",e)}get updating(){return this.updatingHandles.updating||this.pendingEdits.updating}initialize(){this._initializeFetchExtent(),this.updatingHandles.add((()=>this.configuration),(()=>this.refresh())),this.updatingHandles.add((()=>this.tilesOfInterest),((e,i)=>{t(e,i,(({id:e},{id:t})=>e===t))||this._process()}),d)}destroy(){this.pendingTiles.forEach((e=>this._deletePendingTile(e))),this.pendingTiles.clear(),this.store.destroy(),this.tilesOfInterest.length=0,this.pendingEditsAbortController.abort(),this.pendingEditsAbortController=null}refresh(){this.store.refresh(),this.pendingTiles.forEach((e=>this._deletePendingTile(e))),this._process()}applyEdits(e){this.pendingEdits.push(e,(async e=>{if(0===e.addedFeatures.length&&0===e.updatedFeatures.length&&0===e.deletedFeatures.length)return;for(const[,i]of this.pendingTiles)i.reset();const t={...e,deletedFeatures:e.deletedFeatures.map((({objectId:e,globalId:t})=>e&&-1!==e?e:this._lookupObjectIdByGlobalId(t)))};await this.updatingHandles.addPromise(this.store.processEdits(t,((e,t)=>this._queryFeaturesById(e,t)),this.pendingEditsAbortController.signal)),this._processPendingTiles()}))}_initializeFetchExtent(){if(!this.capabilities.query.supportsExtent)return;const e=u((async e=>{try{var t;const i=await F(this.url,new v({where:\"1=1\",outSpatialReference:this.spatialReference,cacheHint:!!this.capabilities.query.supportsCacheHint||void 0}),{query:this.configuration.customParameters,signal:e});this.store.extent=f.fromJSON(null==(t=i.data)?void 0:t.extent)}catch(i){c(i),O.warn(\"Failed to fetch data extent\",i)}}));this.updatingHandles.addPromise(e.promise.then((()=>this._process()))),this.handles.add(r((()=>e.abort())))}get debugInfo(){return{numberOfFeatures:this.store.featureStore.numFeatures,tilesOfInterest:this.tilesOfInterest,pendingTiles:Array.from(this.pendingTiles.values()).map((e=>e.debugInfo)),storedTiles:this.store.debugInfo}}_process(){this._markTilesNotAlive(),this._createPendingTiles(),this._deletePendingTiles(),this._processPendingTiles()}_markTilesNotAlive(){for(const[,e]of this.pendingTiles)e.alive=!1}_createPendingTiles(){const e=this._collectMissingTilesInfo();if(this._setAvailability(a(e)?1:e.coveredArea/e.fullArea),!a(e))for(const{data:t,resolution:i}of e.missingTiles){const e=this.pendingTiles.get(t.id);e?(e.resolution=i,e.alive=!0):this._createPendingTile(t,i)}}_collectMissingTilesInfo(){let e=null;for(let t=this.tilesOfInterest.length-1;t>=0;t--){const i=this.tilesOfInterest[t],s=this.store.process(i,((e,t)=>this._verifyTileComplexity(e,t)));a(e)?e=s:e.prepend(s)}return e}_deletePendingTiles(){for(const[,e]of this.pendingTiles)e.alive||this._deletePendingTile(e)}_processPendingTiles(){const e={fetchCount:(e,t)=>this._fetchCount(e,t),fetchFeatures:(e,t,i)=>this._fetchFeatures(e,t,i),finish:(e,t)=>this._finishPendingTile(e,t),resume:()=>this._processPendingTiles()};if(this._ensureFetchAllCounts(e))for(const[,t]of this.pendingTiles)this._verifyTileComplexity(this.store.getFeatureCount(t.data),t.resolution)&&this.updatingHandles.addPromise(t.process(e))}_verifyTileComplexity(e,t){return this._verifyVertexComplexity(e)&&this._verifyFeatureDensity(e,t)}_verifyVertexComplexity(e){return e*this.minimumVerticesPerFeature<x}_verifyFeatureDensity(e,t){if(a(this.tileInfo))return!1;const i=this.tileSize*t;return e*(E/(i*i))<w}_ensureFetchAllCounts(e){let t=!0;for(const[,i]of this.pendingTiles)i.state.type<P.FETCHED_COUNT&&this.updatingHandles.addPromise(i.process(e)),i.state.type<=P.FETCH_COUNT&&(t=!1);return t}_finishPendingTile(e,t){this.store.add(e.data,t),this._deletePendingTile(e),this._updateAvailability()}_updateAvailability(){const e=this._collectMissingTilesInfo();this._setAvailability(a(e)?1:e.coveredArea/e.fullArea)}_setAvailability(e){this._set(\"availability\",e)}_createPendingTile(e,t){const i=new I(e,t);return this.pendingTiles.set(e.id,i),i}_deletePendingTile(e){e.reset(),this.pendingTiles.delete(e.data.id)}async _fetchCount(e,t){return this.store.fetchCount(e.data,this.url,this._createCountQuery(e),{query:this.customParameters,timeout:j,signal:t})}async _fetchFeatures(e,t,i){let s,r=0,o=0,n=t;for(;;){const a=this._createFeaturesQuery(e),u=this._setPagingParameters(a,r,n),{features:c,exceededTransferLimit:d}=await this._queryFeatures(a,i);if(u&&(r+=l(a.num)),o+=c.length,s=s?s.concat(c):c,n=t-o,!u||!d||n<=0)return s}}_filterProperties(e){return a(e)?{where:\"1=1\",gdbVersion:void 0,timeExtent:void 0}:{where:e.where||\"1=1\",timeExtent:e.timeExtent,gdbVersion:e.gdbVersion}}_lookupObjectIdByGlobalId(e){const t=this.globalIdField,i=this.objectIdField;if(a(t))throw new Error(\"Expected globalIdField to be defined\");let s=null;if(this.store.featureStore.forEach((r=>{var o;e===r.attributes[t]&&(s=null!=(o=r.objectId)?o:r.attributes[i])})),a(s))throw new Error(`Expected to find a feature with globalId ${e}`);return s}_queryFeaturesById(e,t){const i=this._createFeaturesQuery(null);return i.objectIds=e,this._queryFeatures(i,t)}_queryFeatures(e,t){return this.capabilities.query.supportsFormatPBF?this._queryFeaturesPBF(e,t):this._queryFeaturesJSON(e,t)}async _queryFeaturesPBF(e,t){const{sourceSpatialReference:i}=this,{data:s}=await b(this.url,e,new _({sourceSpatialReference:i}),{query:this.configuration.customParameters,timeout:j,signal:t});return g(s)}async _queryFeaturesJSON(e,t){const{sourceSpatialReference:i}=this,{data:s}=await T(this.url,e,i,{query:this.configuration.customParameters,timeout:j,signal:t});return m(s,this.objectIdField)}_createCountQuery(e){const t=this._createBaseQuery(e);return this.capabilities.query.supportsCacheHint&&(t.cacheHint=!0),t}_createFeaturesQuery(e){const t=this._createBaseQuery(e);return t.outFields=this.globalIdField?[this.globalIdField,this.objectIdField]:[this.objectIdField],t.returnGeometry=!0,n(e)&&(this.capabilities.query.supportsResultType?t.resultType=\"tile\":this.capabilities.query.supportsCacheHint&&(t.cacheHint=!0)),t}_createBaseQuery(e){const t=new v({returnZ:!1,returnM:!1,geometry:n(this.tileInfo)&&n(e)?y(e.data.extent,this.tileInfo.spatialReference):void 0}),i=this.configuration.filter;return n(i)&&(t.where=i.where,t.gdbVersion=i.gdbVersion,t.timeExtent=i.timeExtent),t.outSpatialReference=this.spatialReference,t}_setPagingParameters(e,t,i){if(!this.capabilities.query.supportsPagination)return!1;const{supportsMaxRecordCountFactor:s,supportsCacheHint:r,tileMaxRecordCount:o,maxRecordCount:n,supportsResultType:a}=this.capabilities.query,l=s?v.MAX_MAX_RECORD_COUNT_FACTOR:1,u=l*((a||r)&&o?o:n||C);return e.start=t,s?(e.maxRecordCountFactor=Math.min(l,Math.ceil(i/u)),e.num=Math.min(i,e.maxRecordCountFactor*u)):e.num=Math.min(i,u),!0}};e([h({constructOnly:!0})],S.prototype,\"url\",void 0),e([h({constructOnly:!0})],S.prototype,\"objectIdField\",void 0),e([h({constructOnly:!0})],S.prototype,\"globalIdField\",void 0),e([h({constructOnly:!0})],S.prototype,\"capabilities\",void 0),e([h({constructOnly:!0})],S.prototype,\"sourceSpatialReference\",void 0),e([h({constructOnly:!0})],S.prototype,\"spatialReference\",void 0),e([h({constructOnly:!0})],S.prototype,\"store\",void 0),e([h({readOnly:!0})],S.prototype,\"minimumVerticesPerFeature\",null),e([h()],S.prototype,\"filter\",null),e([h()],S.prototype,\"customParameters\",null),e([h({readOnly:!0})],S.prototype,\"configuration\",null),e([h()],S.prototype,\"tileInfo\",null),e([h()],S.prototype,\"tileSize\",null),e([h()],S.prototype,\"tilesOfInterest\",void 0),e([h({readOnly:!0})],S.prototype,\"updating\",null),e([h({readOnly:!0})],S.prototype,\"availability\",void 0),S=e([p(\"esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTiledFetcher\")],S);const C=2e3,j=6e5,x=1e6,E=25,w=1;export{S as FeatureServiceTiledFetcher};\n"]},"metadata":{},"sourceType":"module"}