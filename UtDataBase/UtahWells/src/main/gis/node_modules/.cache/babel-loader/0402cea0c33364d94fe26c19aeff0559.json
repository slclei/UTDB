{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport { create as e, contains as i } from \"../../../geometry/support/aaBoundingRect.js\";\nimport t from \"./TileCache.js\";\nimport s from \"./TileCoverage.js\";\nimport l from \"./TileKey.js\";\nconst a = new l(0, 0, 0, 0),\n      h = new Map(),\n      o = [],\n      c = [];\n\nclass r {\n  constructor(e) {\n    this._previousScale = Number.POSITIVE_INFINITY, this.cachePolicy = \"keep\", this.coveragePolicy = \"closest\", this.resampling = !0, this.tileIndex = new Map(), this.tiles = [], this.buffer = 192, this.acquireTile = e.acquireTile, this.releaseTile = e.releaseTile, this.tileInfoView = e.tileInfoView, this.resampling = null == e.resampling || !!e.resampling, e.cachePolicy && (this.cachePolicy = e.cachePolicy), e.coveragePolicy && (this.coveragePolicy = e.coveragePolicy), null != e.buffer && (this.buffer = e.buffer), e.cacheSize && (this._tileCache = new t(e.cacheSize, this.tileInfoView, e => {\n      this.releaseTile(e);\n    }));\n  }\n\n  destroy() {\n    this.tileIndex.clear();\n  }\n\n  update(e) {\n    const {\n      resampling: i,\n      tileIndex: t\n    } = this,\n          l = this.tileInfoView.getTileCoverage(e.state, this.buffer, this.coveragePolicy);\n    if (c.length = 0, o.length = 0, h.clear(), !l) return;\n    const {\n      minScale: r,\n      maxScale: n\n    } = this.tileInfoView.tileInfo,\n          {\n      spans: f,\n      lodInfo: d\n    } = l,\n          {\n      level: u\n    } = d,\n          {\n      scale: p,\n      center: g,\n      resolution: y\n    } = e.state,\n          I = !e.stationary && p > this._previousScale;\n    if (this._previousScale = p, this.tiles.length = 0, !i && (p > r || p < n)) return this.tiles.length = 0, h.clear(), t.forEach(e => {\n      this.releaseTile(e);\n    }), t.clear(), c.length = 0, o.length = 0, h.clear(), s.pool.release(l), !0;\n    t.forEach(e => e.visible = !0);\n    let T = 0,\n        _ = 0;\n    if (f.length > 0) for (const {\n      row: s,\n      colFrom: o,\n      colTo: c\n    } of f) for (let e = o; e <= c; e++) {\n      T++;\n      const i = a.set(u, s, d.normalizeCol(e), d.getWorldForColumn(e)).id;\n\n      if (t.has(i)) {\n        const e = t.get(i);\n        e.isReady ? (h.set(i, e), _++) : I || this._addParentTile(i, h);\n      } else {\n        let e;\n\n        if (this._tileCache && this._tileCache.has(i)) {\n          if (e = this._tileCache.pop(i), this.tileIndex.set(i, e), e.isReady) {\n            h.set(i, e), _++;\n            continue;\n          }\n        } else e = this.acquireTile(a), this.tileIndex.set(i, e);\n\n        I || this._addParentTile(i, h);\n      }\n    }\n    const m = _ === T;\n    t.forEach((e, i) => {\n      if (a.set(i), h.has(i)) return;\n      const t = this.tileInfoView.intersects(l, a),\n            s = \"purge\" === this.cachePolicy ? a.level !== u : a.level > u;\n      !t || !I && m ? !s && t || o.push(i) : e.isReady ? s && \"purge\" === this.cachePolicy && this._hasReadyAncestor(a, u) ? o.push(i) : c.push(i) : s && o.push(i);\n    });\n\n    for (const s of c) {\n      const e = t.get(s);\n      e && e.isReady && h.set(s, e);\n    }\n\n    for (const s of o) {\n      const e = t.get(s);\n      this._tileCache ? this._tileCache.add(e) : this.releaseTile(e), t.delete(s);\n    }\n\n    return h.forEach(e => this.tiles.push(e)), t.forEach(e => {\n      h.has(e.key.id) || (e.visible = !1);\n    }), this._tileCache && this._tileCache.prune(u, g, y), s.pool.release(l), h.clear(), m;\n  }\n\n  clear() {\n    let e = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : !0;\n    const {\n      tileIndex: i\n    } = this;\n    e && i.forEach(e => {\n      this.releaseTile(e);\n    }), i.clear();\n  }\n\n  updateCacheSize(e) {\n    this._tileCache && (this._tileCache.maxSize = e);\n  }\n\n  _addParentTile(e, i) {\n    let t = e,\n        s = null;\n\n    for (; t = this.tileInfoView.getTileParentId(t), t;) if (this.tileIndex.has(t)) {\n      if (s = this.tileIndex.get(t), s && s.isReady) {\n        i.has(s.key.id) || i.set(s.key.id, s);\n        break;\n      }\n    } else if (this._tileCache && this._tileCache.has(t) && (s = this._tileCache.pop(t), this.tileIndex.set(t, s), s && s.isReady)) {\n      i.has(s.key.id) || i.set(s.key.id, s);\n      break;\n    }\n  }\n\n  _hasReadyAncestor(t, s) {\n    const l = e();\n    this.tileInfoView.getTileBounds(l, t, !0);\n\n    for (const a of this.tileIndex.values()) if (a.isReady && a.key.level >= s && a.key.level < t.level) {\n      const t = e();\n      if (this.tileInfoView.getTileBounds(t, a.key, !0), i(t, l)) return !0;\n    }\n\n    return !1;\n  }\n\n}\n\nexport { r as default };","map":{"version":3,"sources":["D:/Github/CUSP_DataBase/CUSP_DB/src/main/gis/node_modules/@arcgis/core/views/2d/tiling/TileStrategy.js"],"names":["create","e","contains","i","t","s","l","a","h","Map","o","c","r","constructor","_previousScale","Number","POSITIVE_INFINITY","cachePolicy","coveragePolicy","resampling","tileIndex","tiles","buffer","acquireTile","releaseTile","tileInfoView","cacheSize","_tileCache","destroy","clear","update","getTileCoverage","state","length","minScale","maxScale","n","tileInfo","spans","f","lodInfo","d","level","u","scale","p","center","g","resolution","y","I","stationary","forEach","pool","release","visible","T","_","row","colFrom","colTo","set","normalizeCol","getWorldForColumn","id","has","get","isReady","_addParentTile","pop","m","intersects","push","_hasReadyAncestor","add","delete","key","prune","updateCacheSize","maxSize","getTileParentId","getTileBounds","values","default"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport{create as e,contains as i}from\"../../../geometry/support/aaBoundingRect.js\";import t from\"./TileCache.js\";import s from\"./TileCoverage.js\";import l from\"./TileKey.js\";const a=new l(0,0,0,0),h=new Map,o=[],c=[];class r{constructor(e){this._previousScale=Number.POSITIVE_INFINITY,this.cachePolicy=\"keep\",this.coveragePolicy=\"closest\",this.resampling=!0,this.tileIndex=new Map,this.tiles=[],this.buffer=192,this.acquireTile=e.acquireTile,this.releaseTile=e.releaseTile,this.tileInfoView=e.tileInfoView,this.resampling=null==e.resampling||!!e.resampling,e.cachePolicy&&(this.cachePolicy=e.cachePolicy),e.coveragePolicy&&(this.coveragePolicy=e.coveragePolicy),null!=e.buffer&&(this.buffer=e.buffer),e.cacheSize&&(this._tileCache=new t(e.cacheSize,this.tileInfoView,(e=>{this.releaseTile(e)})))}destroy(){this.tileIndex.clear()}update(e){const{resampling:i,tileIndex:t}=this,l=this.tileInfoView.getTileCoverage(e.state,this.buffer,this.coveragePolicy);if(c.length=0,o.length=0,h.clear(),!l)return;const{minScale:r,maxScale:n}=this.tileInfoView.tileInfo,{spans:f,lodInfo:d}=l,{level:u}=d,{scale:p,center:g,resolution:y}=e.state,I=!e.stationary&&p>this._previousScale;if(this._previousScale=p,this.tiles.length=0,!i&&(p>r||p<n))return this.tiles.length=0,h.clear(),t.forEach((e=>{this.releaseTile(e)})),t.clear(),c.length=0,o.length=0,h.clear(),s.pool.release(l),!0;t.forEach((e=>e.visible=!0));let T=0,_=0;if(f.length>0)for(const{row:s,colFrom:o,colTo:c}of f)for(let e=o;e<=c;e++){T++;const i=a.set(u,s,d.normalizeCol(e),d.getWorldForColumn(e)).id;if(t.has(i)){const e=t.get(i);e.isReady?(h.set(i,e),_++):I||this._addParentTile(i,h)}else{let e;if(this._tileCache&&this._tileCache.has(i)){if(e=this._tileCache.pop(i),this.tileIndex.set(i,e),e.isReady){h.set(i,e),_++;continue}}else e=this.acquireTile(a),this.tileIndex.set(i,e);I||this._addParentTile(i,h)}}const m=_===T;t.forEach(((e,i)=>{if(a.set(i),h.has(i))return;const t=this.tileInfoView.intersects(l,a),s=\"purge\"===this.cachePolicy?a.level!==u:a.level>u;!t||!I&&m?!s&&t||o.push(i):e.isReady?s&&\"purge\"===this.cachePolicy&&this._hasReadyAncestor(a,u)?o.push(i):c.push(i):s&&o.push(i)}));for(const s of c){const e=t.get(s);e&&e.isReady&&h.set(s,e)}for(const s of o){const e=t.get(s);this._tileCache?this._tileCache.add(e):this.releaseTile(e),t.delete(s)}return h.forEach((e=>this.tiles.push(e))),t.forEach((e=>{h.has(e.key.id)||(e.visible=!1)})),this._tileCache&&this._tileCache.prune(u,g,y),s.pool.release(l),h.clear(),m}clear(e=!0){const{tileIndex:i}=this;e&&i.forEach((e=>{this.releaseTile(e)})),i.clear()}updateCacheSize(e){this._tileCache&&(this._tileCache.maxSize=e)}_addParentTile(e,i){let t=e,s=null;for(;t=this.tileInfoView.getTileParentId(t),t;)if(this.tileIndex.has(t)){if(s=this.tileIndex.get(t),s&&s.isReady){i.has(s.key.id)||i.set(s.key.id,s);break}}else if(this._tileCache&&this._tileCache.has(t)&&(s=this._tileCache.pop(t),this.tileIndex.set(t,s),s&&s.isReady)){i.has(s.key.id)||i.set(s.key.id,s);break}}_hasReadyAncestor(t,s){const l=e();this.tileInfoView.getTileBounds(l,t,!0);for(const a of this.tileIndex.values())if(a.isReady&&a.key.level>=s&&a.key.level<t.level){const t=e();if(this.tileInfoView.getTileBounds(t,a.key,!0),i(t,l))return!0}return!1}}export{r as default};\n"]},"metadata":{},"sourceType":"module"}