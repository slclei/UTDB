{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport { isNone as e } from \"../../../../../core/maybe.js\";\nimport { c as t, f as a } from \"../../../../../chunks/vec2f32.js\";\nimport { FADE_DURATION as i } from \"../../vectorTiles/decluttering/config.js\";\nimport { RotationAlignment as r, SymbolPlacement as s, TranslateAnchor as n } from \"../../vectorTiles/style/StyleDefinition.js\";\nimport { VTL_TEXTURE_BINDING_UNIT_SPRITES as o, VTL_TEXTURE_BINDING_UNIT_GLYPHS as l } from \"../definitions.js\";\nimport { WGLDrawPhase as f } from \"../enums.js\";\nimport { degToByte as c } from \"../GeometryUtils.js\";\nimport { u32to4Xu8 as m } from \"../number.js\";\nimport p from \"./WGLBrush.js\";\nimport { TextureSamplingMode as u, CompareFunction as g, PrimitiveType as y, DataType as d } from \"../../../../webgl/enums.js\";\n\nconst _ = 1 / 65536;\n\nclass h extends p {\n  constructor() {\n    super(...arguments), this._iconProgramOptions = {\n      id: !1,\n      sdf: !1\n    }, this._sdfProgramOptions = {\n      id: !1\n    }, this._spritesTextureSize = t();\n  }\n\n  dispose() {}\n\n  drawMany(e, t) {\n    const {\n      drawPhase: a,\n      styleLayerUID: i\n    } = e,\n          r = e.styleLayer;\n    let s;\n    a === f.HITTEST && (s = m(i + 1)), this._drawIcons(e, r, t, s), this._drawText(e, r, t, s);\n  }\n\n  _drawIcons(t, a, l, m) {\n    const {\n      context: p,\n      displayLevel: u,\n      drawPhase: g,\n      painter: y,\n      spriteMosaic: d,\n      state: _,\n      styleLayerUID: h\n    } = t,\n          M = a.iconMaterial,\n          P = y.vectorTilesMaterialManager;\n    let T,\n        U = !1;\n\n    for (const e of l) if (e.layerData.has(h) && (T = e.layerData.get(h), T.iconPerPageElementsMap.size > 0)) {\n      U = !0;\n      break;\n    }\n\n    if (!U) return;\n    const E = a.getPaintValue(\"icon-translate\", u),\n          x = a.getPaintValue(\"icon-translate-anchor\", u);\n    let v = a.getLayoutValue(\"icon-rotation-alignment\", u);\n    v === r.AUTO && (v = a.getLayoutValue(\"symbol-placement\", u) === s.POINT ? r.VIEWPORT : r.MAP);\n    const I = v === r.MAP,\n          S = a.getLayoutValue(\"icon-keep-upright\", u) && I,\n          D = T.isIconSDF,\n          V = g === f.HITTEST,\n          R = this._iconProgramOptions;\n    R.id = V, R.sdf = D;\n    const w = P.getMaterialProgram(p, M, R);\n    p.useProgram(w), w.setUniformMatrix3fv(\"u_displayViewMat3\", v === r.MAP ? _.displayViewMat3 : _.displayMat3), w.setUniformMatrix3fv(\"u_displayMat3\", x === n.VIEWPORT ? _.displayMat3 : _.displayViewMat3), w.setUniform2fv(\"u_iconTranslation\", E), w.setUniform1f(\"u_depth\", a.z), w.setUniform1f(\"u_mapRotation\", c(_.rotation)), w.setUniform1f(\"u_keepUpright\", S ? 1 : 0), w.setUniform1f(\"u_level\", 10 * u), w.setUniform1i(\"u_texture\", o), w.setUniform1f(\"u_fadeDuration\", i / 1e3), V && w.setUniform4fv(\"u_id\", m);\n    let A = -1;\n\n    for (const i of l) {\n      if (!i.layerData.has(h)) continue;\n      if (i.key.level !== A && (A = i.key.level, M.setDataUniforms(w, u, a, A, d)), T = i.layerData.get(h), 0 === T.iconPerPageElementsMap.size) continue;\n      T.prepareForRendering(p), T.updateOpacityInfo();\n      const r = T.iconVertexArrayObject;\n\n      if (!e(r)) {\n        p.bindVAO(r), w.setUniformMatrix3fv(\"u_dvsMat3\", i.transforms.dvs), w.setUniform1f(\"u_time\", (performance.now() - T.lastOpacityUpdate) / 1e3);\n\n        for (const [e, a] of T.iconPerPageElementsMap) this._renderIconRange(t, w, a, e, i);\n      }\n    }\n  }\n\n  _renderIconRange(e, t, a, i, r) {\n    const {\n      context: s,\n      spriteMosaic: n\n    } = e;\n    this._spritesTextureSize[0] = n.getWidth(i) / 4, this._spritesTextureSize[1] = n.getHeight(i) / 4, t.setUniform2fv(\"u_mosaicSize\", this._spritesTextureSize), n.bind(s, u.LINEAR, i, o), s.setStencilTestEnabled(!0), s.setStencilFunction(g.GREATER, 255, 255), s.setStencilWriteMask(0), s.drawElements(y.TRIANGLES, a[1], d.UNSIGNED_INT, Uint32Array.BYTES_PER_ELEMENT * a[0]), r.triangleCount += a[1] / 3;\n  }\n\n  _drawText(t, o, m, p) {\n    const {\n      context: u,\n      displayLevel: y,\n      drawPhase: d,\n      glyphMosaic: h,\n      painter: M,\n      pixelRatio: P,\n      spriteMosaic: T,\n      state: U,\n      styleLayerUID: E\n    } = t,\n          x = o.textMaterial,\n          v = M.vectorTilesMaterialManager;\n    let I,\n        S = !1;\n\n    for (const e of m) if (e.layerData.has(E) && (I = e.layerData.get(E), I.glyphPerPageElementsMap.size > 0)) {\n      S = !0;\n      break;\n    }\n\n    if (!S) return;\n    const D = o.getPaintProperty(\"text-opacity\");\n    if (D && !D.isDataDriven && 0 === D.getValue(y)) return;\n    const V = o.getPaintProperty(\"text-color\"),\n          R = !V || V.isDataDriven || V.getValue(y)[3] > 0,\n          w = o.getPaintProperty(\"text-halo-width\"),\n          A = o.getPaintProperty(\"text-halo-color\"),\n          L = (!w || w.isDataDriven || w.getValue(y) > 0) && (!A || A.isDataDriven || A.getValue(y)[3] > 0);\n    if (!R && !L) return;\n    const O = 24 / 8;\n    let N = o.getLayoutValue(\"text-rotation-alignment\", y);\n    N === r.AUTO && (N = o.getLayoutValue(\"symbol-placement\", y) === s.POINT ? r.VIEWPORT : r.MAP);\n    const b = N === r.MAP,\n          z = o.getLayoutValue(\"text-keep-upright\", y) && b,\n          k = d === f.HITTEST,\n          j = .8 * O / P;\n    this._glyphTextureSize || (this._glyphTextureSize = a(h.width / 4, h.height / 4));\n    const G = o.getPaintValue(\"text-translate\", y),\n          W = o.getPaintValue(\"text-translate-anchor\", y),\n          F = this._sdfProgramOptions;\n    F.id = k;\n    const B = v.getMaterialProgram(u, x, F);\n    u.useProgram(B), B.setUniformMatrix3fv(\"u_displayViewMat3\", N === r.MAP ? U.displayViewMat3 : U.displayMat3), B.setUniformMatrix3fv(\"u_displayMat3\", W === n.VIEWPORT ? U.displayMat3 : U.displayViewMat3), B.setUniform2fv(\"u_textTranslation\", G), B.setUniform1f(\"u_depth\", o.z + _), B.setUniform2fv(\"u_mosaicSize\", this._glyphTextureSize), B.setUniform1f(\"u_mapRotation\", c(U.rotation)), B.setUniform1f(\"u_keepUpright\", z ? 1 : 0), B.setUniform1f(\"u_level\", 10 * y), B.setUniform1i(\"u_texture\", l), B.setUniform1f(\"u_antialiasingWidth\", j), B.setUniform1f(\"u_fadeDuration\", i / 1e3), k && B.setUniform4fv(\"u_id\", p);\n    let H = -1;\n\n    for (const a of m) {\n      if (!a.layerData.has(E)) continue;\n      if (a.key.level !== H && (H = a.key.level, x.setDataUniforms(B, y, o, H, T)), I = a.layerData.get(E), 0 === I.glyphPerPageElementsMap.size) continue;\n      I.prepareForRendering(u), I.updateOpacityInfo();\n      const t = I.textVertexArrayObject;\n      if (e(t)) continue;\n      u.bindVAO(t), B.setUniformMatrix3fv(\"u_dvsMat3\", a.transforms.dvs), u.setStencilTestEnabled(!0), u.setStencilFunction(g.GREATER, 255, 255), u.setStencilWriteMask(0);\n      const i = (performance.now() - I.lastOpacityUpdate) / 1e3;\n      B.setUniform1f(\"u_time\", i), I.glyphPerPageElementsMap.forEach((e, t) => {\n        this._renderGlyphRange(u, e, t, h, B, L, R, a);\n      });\n    }\n  }\n\n  _renderGlyphRange(e, t, a, i, r, s, n, o) {\n    i.bind(e, u.LINEAR, a, l), s && (r.setUniform1f(\"u_halo\", 1), e.drawElements(y.TRIANGLES, t[1], d.UNSIGNED_INT, Uint32Array.BYTES_PER_ELEMENT * t[0]), o.triangleCount += t[1] / 3), n && (r.setUniform1f(\"u_halo\", 0), e.drawElements(y.TRIANGLES, t[1], d.UNSIGNED_INT, Uint32Array.BYTES_PER_ELEMENT * t[0]), o.triangleCount += t[1] / 3);\n  }\n\n}\n\nexport { h as WGLBrushVTLSymbol };","map":{"version":3,"sources":["D:/Github/CUSP_DataBase/CUSP_DB/src/main/gis/node_modules/@arcgis/core/views/2d/engine/webgl/brushes/WGLBrushVTLSymbol.js"],"names":["isNone","e","c","t","f","a","FADE_DURATION","i","RotationAlignment","r","SymbolPlacement","s","TranslateAnchor","n","VTL_TEXTURE_BINDING_UNIT_SPRITES","o","VTL_TEXTURE_BINDING_UNIT_GLYPHS","l","WGLDrawPhase","degToByte","u32to4Xu8","m","p","TextureSamplingMode","u","CompareFunction","g","PrimitiveType","y","DataType","d","_","h","constructor","arguments","_iconProgramOptions","id","sdf","_sdfProgramOptions","_spritesTextureSize","dispose","drawMany","drawPhase","styleLayerUID","styleLayer","HITTEST","_drawIcons","_drawText","context","displayLevel","painter","spriteMosaic","state","M","iconMaterial","P","vectorTilesMaterialManager","T","U","layerData","has","get","iconPerPageElementsMap","size","E","getPaintValue","x","v","getLayoutValue","AUTO","POINT","VIEWPORT","MAP","I","S","D","isIconSDF","V","R","w","getMaterialProgram","useProgram","setUniformMatrix3fv","displayViewMat3","displayMat3","setUniform2fv","setUniform1f","z","rotation","setUniform1i","setUniform4fv","A","key","level","setDataUniforms","prepareForRendering","updateOpacityInfo","iconVertexArrayObject","bindVAO","transforms","dvs","performance","now","lastOpacityUpdate","_renderIconRange","getWidth","getHeight","bind","LINEAR","setStencilTestEnabled","setStencilFunction","GREATER","setStencilWriteMask","drawElements","TRIANGLES","UNSIGNED_INT","Uint32Array","BYTES_PER_ELEMENT","triangleCount","glyphMosaic","pixelRatio","textMaterial","glyphPerPageElementsMap","getPaintProperty","isDataDriven","getValue","L","O","N","b","k","j","_glyphTextureSize","width","height","G","W","F","B","H","textVertexArrayObject","forEach","_renderGlyphRange","WGLBrushVTLSymbol"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport{isNone as e}from\"../../../../../core/maybe.js\";import{c as t,f as a}from\"../../../../../chunks/vec2f32.js\";import{FADE_DURATION as i}from\"../../vectorTiles/decluttering/config.js\";import{RotationAlignment as r,SymbolPlacement as s,TranslateAnchor as n}from\"../../vectorTiles/style/StyleDefinition.js\";import{VTL_TEXTURE_BINDING_UNIT_SPRITES as o,VTL_TEXTURE_BINDING_UNIT_GLYPHS as l}from\"../definitions.js\";import{WGLDrawPhase as f}from\"../enums.js\";import{degToByte as c}from\"../GeometryUtils.js\";import{u32to4Xu8 as m}from\"../number.js\";import p from\"./WGLBrush.js\";import{TextureSamplingMode as u,CompareFunction as g,PrimitiveType as y,DataType as d}from\"../../../../webgl/enums.js\";const _=1/65536;class h extends p{constructor(){super(...arguments),this._iconProgramOptions={id:!1,sdf:!1},this._sdfProgramOptions={id:!1},this._spritesTextureSize=t()}dispose(){}drawMany(e,t){const{drawPhase:a,styleLayerUID:i}=e,r=e.styleLayer;let s;a===f.HITTEST&&(s=m(i+1)),this._drawIcons(e,r,t,s),this._drawText(e,r,t,s)}_drawIcons(t,a,l,m){const{context:p,displayLevel:u,drawPhase:g,painter:y,spriteMosaic:d,state:_,styleLayerUID:h}=t,M=a.iconMaterial,P=y.vectorTilesMaterialManager;let T,U=!1;for(const e of l)if(e.layerData.has(h)&&(T=e.layerData.get(h),T.iconPerPageElementsMap.size>0)){U=!0;break}if(!U)return;const E=a.getPaintValue(\"icon-translate\",u),x=a.getPaintValue(\"icon-translate-anchor\",u);let v=a.getLayoutValue(\"icon-rotation-alignment\",u);v===r.AUTO&&(v=a.getLayoutValue(\"symbol-placement\",u)===s.POINT?r.VIEWPORT:r.MAP);const I=v===r.MAP,S=a.getLayoutValue(\"icon-keep-upright\",u)&&I,D=T.isIconSDF,V=g===f.HITTEST,R=this._iconProgramOptions;R.id=V,R.sdf=D;const w=P.getMaterialProgram(p,M,R);p.useProgram(w),w.setUniformMatrix3fv(\"u_displayViewMat3\",v===r.MAP?_.displayViewMat3:_.displayMat3),w.setUniformMatrix3fv(\"u_displayMat3\",x===n.VIEWPORT?_.displayMat3:_.displayViewMat3),w.setUniform2fv(\"u_iconTranslation\",E),w.setUniform1f(\"u_depth\",a.z),w.setUniform1f(\"u_mapRotation\",c(_.rotation)),w.setUniform1f(\"u_keepUpright\",S?1:0),w.setUniform1f(\"u_level\",10*u),w.setUniform1i(\"u_texture\",o),w.setUniform1f(\"u_fadeDuration\",i/1e3),V&&w.setUniform4fv(\"u_id\",m);let A=-1;for(const i of l){if(!i.layerData.has(h))continue;if(i.key.level!==A&&(A=i.key.level,M.setDataUniforms(w,u,a,A,d)),T=i.layerData.get(h),0===T.iconPerPageElementsMap.size)continue;T.prepareForRendering(p),T.updateOpacityInfo();const r=T.iconVertexArrayObject;if(!e(r)){p.bindVAO(r),w.setUniformMatrix3fv(\"u_dvsMat3\",i.transforms.dvs),w.setUniform1f(\"u_time\",(performance.now()-T.lastOpacityUpdate)/1e3);for(const[e,a]of T.iconPerPageElementsMap)this._renderIconRange(t,w,a,e,i)}}}_renderIconRange(e,t,a,i,r){const{context:s,spriteMosaic:n}=e;this._spritesTextureSize[0]=n.getWidth(i)/4,this._spritesTextureSize[1]=n.getHeight(i)/4,t.setUniform2fv(\"u_mosaicSize\",this._spritesTextureSize),n.bind(s,u.LINEAR,i,o),s.setStencilTestEnabled(!0),s.setStencilFunction(g.GREATER,255,255),s.setStencilWriteMask(0),s.drawElements(y.TRIANGLES,a[1],d.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*a[0]),r.triangleCount+=a[1]/3}_drawText(t,o,m,p){const{context:u,displayLevel:y,drawPhase:d,glyphMosaic:h,painter:M,pixelRatio:P,spriteMosaic:T,state:U,styleLayerUID:E}=t,x=o.textMaterial,v=M.vectorTilesMaterialManager;let I,S=!1;for(const e of m)if(e.layerData.has(E)&&(I=e.layerData.get(E),I.glyphPerPageElementsMap.size>0)){S=!0;break}if(!S)return;const D=o.getPaintProperty(\"text-opacity\");if(D&&!D.isDataDriven&&0===D.getValue(y))return;const V=o.getPaintProperty(\"text-color\"),R=!V||V.isDataDriven||V.getValue(y)[3]>0,w=o.getPaintProperty(\"text-halo-width\"),A=o.getPaintProperty(\"text-halo-color\"),L=(!w||w.isDataDriven||w.getValue(y)>0)&&(!A||A.isDataDriven||A.getValue(y)[3]>0);if(!R&&!L)return;const O=24/8;let N=o.getLayoutValue(\"text-rotation-alignment\",y);N===r.AUTO&&(N=o.getLayoutValue(\"symbol-placement\",y)===s.POINT?r.VIEWPORT:r.MAP);const b=N===r.MAP,z=o.getLayoutValue(\"text-keep-upright\",y)&&b,k=d===f.HITTEST,j=.8*O/P;this._glyphTextureSize||(this._glyphTextureSize=a(h.width/4,h.height/4));const G=o.getPaintValue(\"text-translate\",y),W=o.getPaintValue(\"text-translate-anchor\",y),F=this._sdfProgramOptions;F.id=k;const B=v.getMaterialProgram(u,x,F);u.useProgram(B),B.setUniformMatrix3fv(\"u_displayViewMat3\",N===r.MAP?U.displayViewMat3:U.displayMat3),B.setUniformMatrix3fv(\"u_displayMat3\",W===n.VIEWPORT?U.displayMat3:U.displayViewMat3),B.setUniform2fv(\"u_textTranslation\",G),B.setUniform1f(\"u_depth\",o.z+_),B.setUniform2fv(\"u_mosaicSize\",this._glyphTextureSize),B.setUniform1f(\"u_mapRotation\",c(U.rotation)),B.setUniform1f(\"u_keepUpright\",z?1:0),B.setUniform1f(\"u_level\",10*y),B.setUniform1i(\"u_texture\",l),B.setUniform1f(\"u_antialiasingWidth\",j),B.setUniform1f(\"u_fadeDuration\",i/1e3),k&&B.setUniform4fv(\"u_id\",p);let H=-1;for(const a of m){if(!a.layerData.has(E))continue;if(a.key.level!==H&&(H=a.key.level,x.setDataUniforms(B,y,o,H,T)),I=a.layerData.get(E),0===I.glyphPerPageElementsMap.size)continue;I.prepareForRendering(u),I.updateOpacityInfo();const t=I.textVertexArrayObject;if(e(t))continue;u.bindVAO(t),B.setUniformMatrix3fv(\"u_dvsMat3\",a.transforms.dvs),u.setStencilTestEnabled(!0),u.setStencilFunction(g.GREATER,255,255),u.setStencilWriteMask(0);const i=(performance.now()-I.lastOpacityUpdate)/1e3;B.setUniform1f(\"u_time\",i),I.glyphPerPageElementsMap.forEach(((e,t)=>{this._renderGlyphRange(u,e,t,h,B,L,R,a)}))}}_renderGlyphRange(e,t,a,i,r,s,n,o){i.bind(e,u.LINEAR,a,l),s&&(r.setUniform1f(\"u_halo\",1),e.drawElements(y.TRIANGLES,t[1],d.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),o.triangleCount+=t[1]/3),n&&(r.setUniform1f(\"u_halo\",0),e.drawElements(y.TRIANGLES,t[1],d.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),o.triangleCount+=t[1]/3)}}export{h as WGLBrushVTLSymbol};\n"]},"metadata":{},"sourceType":"module"}