{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport { isSome as e, destroyMaybe as t, unwrapOrThrow as r, isNone as s, applySome as i } from \"../../../../../core/maybe.js\";\nimport { FeatureDisplayList as f } from \"../FeatureDisplayList.js\";\nimport { Buffer as n } from \"./Buffer.js\";\nimport { DisplayRecordReader as o } from \"./DisplayRecordReader.js\";\nimport { VertexArrayObject as d } from \"../../../../webgl/VertexArrayObject.js\";\nconst h = 0,\n      u = 1;\n\nclass c {\n  constructor(e, t) {\n    this._vaos = new Map(), this._indicesInvalid = !1, this.geometryType = e;\n  }\n\n  destroy() {\n    for (const [t, r] of this._vaos) e(r) && r.dispose(!1);\n\n    this._indexBuffer = t(this._indexBuffer), this._vertexBuffer = t(this._vertexBuffer);\n  }\n\n  insert(e, t, s) {\n    if (!e.records.byteLength) return;\n    const i = e.stride;\n\n    if (this._vertexBuffer && this._indexBuffer) {\n      const s = e.indices.byteLength / 4,\n            f = e.vertices.byteLength / i;\n      this._indexBuffer.ensure(s), this._vertexBuffer.ensure(f);\n\n      const {\n        vertices: n,\n        indices: d\n      } = e,\n            h = o.from(e.records),\n            u = this._vertexBuffer.insert(n, 0, n.byteLength / i, 0),\n            c = this._indexBuffer.insert(d, 0, d.byteLength / 4, u);\n\n      if (h.forEach(e => {\n        e.indexFrom += c, e.vertexFrom += u;\n      }), r(this._records, \"Expected records to be defined\").link(h), t) this._indicesInvalid = !0;else if (this._displayList) {\n        const e = h.getCursor();\n\n        for (; e.next();) this._displayList.addRecord(e);\n      }\n    } else {\n      const r = e.indices.byteLength / 4,\n            s = e.vertices.byteLength / i,\n            f = i / Uint32Array.BYTES_PER_ELEMENT;\n      this._records = o.from(e.records), this._indexBuffer = new n(\"index\", r, 1), this._vertexBuffer = new n(\"vertex\", s, f), this._indexBuffer.insert(e.indices, 0, e.indices.byteLength / 4, 0), this._vertexBuffer.insert(e.vertices, 0, e.vertices.byteLength / i, 0), t && (this._indicesInvalid = !0);\n    }\n  }\n\n  remove(e) {\n    if (!s(this._records)) for (const t of e) {\n      const e = this._records.getCursor();\n\n      if (!e.lookup(t)) continue;\n      const r = e.indexFrom,\n            s = e.vertexFrom;\n      let i = e.indexCount,\n          f = e.vertexCount;\n\n      for (; e.next() && e.id === t;) i += e.indexCount, f += e.vertexCount;\n\n      this._indexBuffer.free(r, i), this._vertexBuffer.free(s, f, !0), this._records.delete(t);\n    }\n  }\n\n  getVAO(e, t, r, f) {\n    if (!this._vertexBuffer || !this._indexBuffer || s(this._records) || !this._vertexBuffer.bufferSize) return null;\n    const n = f ? u : h;\n\n    let o = this._vaos.get(n);\n\n    (this._vertexBuffer.invalidated || this._indexBuffer.invalidated) && (i(o, e => e.dispose(!1)), o = null), this._vertexBuffer.upload(), this._indexBuffer.upload();\n\n    const c = this._indexBuffer.getGPUBuffer(e, 1 === n),\n          _ = this._vertexBuffer.getGPUBuffer(e);\n\n    return o || (o = new d(e, r, t, {\n      geometry: _\n    }, c), this._vaos.set(n, o)), o;\n  }\n\n  forEachCommand(e) {\n    if (!s(this._records)) {\n      if (this._sortIndices(this._records), !this._displayList) {\n        const e = this._cursorIndexOrder;\n        this._displayList = f.from(this, this.geometryType, this._records.getCursor(), e);\n      }\n\n      this._displayList.forEach(e);\n    }\n  }\n\n  _sortIndices(e) {\n    const t = !!this._indexBuffer.bufferSize;\n    if (!this._indicesInvalid) return;\n    this._indicesInvalid = !1;\n    let r = 0;\n    const s = e.getCursor(),\n          i = [],\n          f = [],\n          n = [];\n\n    for (; s.next();) f.push(s.index), n.push(s.sortKey), i.push(s.id);\n\n    f.sort((e, t) => {\n      const r = n[t],\n            s = n[e];\n      return s === r ? i[t] - i[e] : r - s;\n    });\n    const o = e.getCursor(),\n          d = t ? this._indexBuffer.getCPUBuffer() : this._vertexBuffer.getCPUBuffer();\n\n    for (const h of f) {\n      if (!o.seekIndex(h)) throw new Error(\"Expected to find index\");\n\n      if (t) {\n        const {\n          indexFrom: e,\n          indexCount: t\n        } = o;\n        o.indexFrom = r;\n\n        for (let s = 0; s < t; s++) this._indexBuffer.set(r++, d.array[e + s]);\n      } else {\n        const {\n          vertexFrom: e,\n          vertexCount: t\n        } = o,\n              s = this._vertexBuffer.strideInt,\n              i = e * s,\n              f = i + t * s;\n        o.vertexFrom = r / s;\n\n        for (let n = i; n < f; n++) this._vertexBuffer.set(r++, d.array[n]);\n      }\n    }\n\n    this._cursorIndexOrder = f, this._displayList = null;\n  }\n\n}\n\nexport { c as Geometry };","map":{"version":3,"sources":["D:/Github/CUSP_DataBase/CUSP_DB/src/main/gis/node_modules/@arcgis/core/views/2d/engine/webgl/cpuMapped/Geometry.js"],"names":["isSome","e","destroyMaybe","t","unwrapOrThrow","r","isNone","s","applySome","i","FeatureDisplayList","f","Buffer","n","DisplayRecordReader","o","VertexArrayObject","d","h","u","c","constructor","_vaos","Map","_indicesInvalid","geometryType","destroy","dispose","_indexBuffer","_vertexBuffer","insert","records","byteLength","stride","indices","vertices","ensure","from","forEach","indexFrom","vertexFrom","_records","link","_displayList","getCursor","next","addRecord","Uint32Array","BYTES_PER_ELEMENT","remove","lookup","indexCount","vertexCount","id","free","delete","getVAO","bufferSize","get","invalidated","upload","getGPUBuffer","_","geometry","set","forEachCommand","_sortIndices","_cursorIndexOrder","push","index","sortKey","sort","getCPUBuffer","seekIndex","Error","array","strideInt","Geometry"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport{isSome as e,destroyMaybe as t,unwrapOrThrow as r,isNone as s,applySome as i}from\"../../../../../core/maybe.js\";import{FeatureDisplayList as f}from\"../FeatureDisplayList.js\";import{Buffer as n}from\"./Buffer.js\";import{DisplayRecordReader as o}from\"./DisplayRecordReader.js\";import{VertexArrayObject as d}from\"../../../../webgl/VertexArrayObject.js\";const h=0,u=1;class c{constructor(e,t){this._vaos=new Map,this._indicesInvalid=!1,this.geometryType=e}destroy(){for(const[t,r]of this._vaos)e(r)&&r.dispose(!1);this._indexBuffer=t(this._indexBuffer),this._vertexBuffer=t(this._vertexBuffer)}insert(e,t,s){if(!e.records.byteLength)return;const i=e.stride;if(this._vertexBuffer&&this._indexBuffer){const s=e.indices.byteLength/4,f=e.vertices.byteLength/i;this._indexBuffer.ensure(s),this._vertexBuffer.ensure(f);const{vertices:n,indices:d}=e,h=o.from(e.records),u=this._vertexBuffer.insert(n,0,n.byteLength/i,0),c=this._indexBuffer.insert(d,0,d.byteLength/4,u);if(h.forEach((e=>{e.indexFrom+=c,e.vertexFrom+=u})),r(this._records,\"Expected records to be defined\").link(h),t)this._indicesInvalid=!0;else if(this._displayList){const e=h.getCursor();for(;e.next();)this._displayList.addRecord(e)}}else{const r=e.indices.byteLength/4,s=e.vertices.byteLength/i,f=i/Uint32Array.BYTES_PER_ELEMENT;this._records=o.from(e.records),this._indexBuffer=new n(\"index\",r,1),this._vertexBuffer=new n(\"vertex\",s,f),this._indexBuffer.insert(e.indices,0,e.indices.byteLength/4,0),this._vertexBuffer.insert(e.vertices,0,e.vertices.byteLength/i,0),t&&(this._indicesInvalid=!0)}}remove(e){if(!s(this._records))for(const t of e){const e=this._records.getCursor();if(!e.lookup(t))continue;const r=e.indexFrom,s=e.vertexFrom;let i=e.indexCount,f=e.vertexCount;for(;e.next()&&e.id===t;)i+=e.indexCount,f+=e.vertexCount;this._indexBuffer.free(r,i),this._vertexBuffer.free(s,f,!0),this._records.delete(t)}}getVAO(e,t,r,f){if(!this._vertexBuffer||!this._indexBuffer||s(this._records)||!this._vertexBuffer.bufferSize)return null;const n=f?u:h;let o=this._vaos.get(n);(this._vertexBuffer.invalidated||this._indexBuffer.invalidated)&&(i(o,(e=>e.dispose(!1))),o=null),this._vertexBuffer.upload(),this._indexBuffer.upload();const c=this._indexBuffer.getGPUBuffer(e,1===n),_=this._vertexBuffer.getGPUBuffer(e);return o||(o=new d(e,r,t,{geometry:_},c),this._vaos.set(n,o)),o}forEachCommand(e){if(!s(this._records)){if(this._sortIndices(this._records),!this._displayList){const e=this._cursorIndexOrder;this._displayList=f.from(this,this.geometryType,this._records.getCursor(),e)}this._displayList.forEach(e)}}_sortIndices(e){const t=!!this._indexBuffer.bufferSize;if(!this._indicesInvalid)return;this._indicesInvalid=!1;let r=0;const s=e.getCursor(),i=[],f=[],n=[];for(;s.next();)f.push(s.index),n.push(s.sortKey),i.push(s.id);f.sort(((e,t)=>{const r=n[t],s=n[e];return s===r?i[t]-i[e]:r-s}));const o=e.getCursor(),d=t?this._indexBuffer.getCPUBuffer():this._vertexBuffer.getCPUBuffer();for(const h of f){if(!o.seekIndex(h))throw new Error(\"Expected to find index\");if(t){const{indexFrom:e,indexCount:t}=o;o.indexFrom=r;for(let s=0;s<t;s++)this._indexBuffer.set(r++,d.array[e+s])}else{const{vertexFrom:e,vertexCount:t}=o,s=this._vertexBuffer.strideInt,i=e*s,f=i+t*s;o.vertexFrom=r/s;for(let n=i;n<f;n++)this._vertexBuffer.set(r++,d.array[n])}}this._cursorIndexOrder=f,this._displayList=null}}export{c as Geometry};\n"]},"metadata":{},"sourceType":"module"}