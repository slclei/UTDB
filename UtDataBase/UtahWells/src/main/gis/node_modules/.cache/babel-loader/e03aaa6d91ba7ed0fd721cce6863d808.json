{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport e from \"../request.js\";\nimport t from \"../core/has.js\";\nimport i from \"../core/Logger.js\";\nimport { isSome as s, removeMaybe as r } from \"../core/maybe.js\";\nimport { isAbortError as n } from \"../core/promiseUtils.js\";\nimport { watch as a } from \"../core/reactiveUtils.js\";\nimport { WasmCullMode as o, VoxelRequestType as l, UpdateFlags as h } from \"../libs/vxl/enums.js\";\nimport { loadVoxelWASM as _ } from \"../libs/vxl/VxlModule.js\";\nimport { RenderPass as d } from \"../views/3d/webgl-engine/lib/RenderPass.js\";\nimport { RenderSlot as c } from \"../views/3d/webgl-engine/lib/RenderSlot.js\";\nimport { ContextType as u } from \"../views/webgl/context-util.js\";\nimport { CompareFunction as g, Face as x, StencilOperation as m } from \"../views/webgl/enums.js\";\nconst v = i.getLogger(\"esri.layers.VoxelWasmPerScene\");\nvar p;\n!function (e) {\n  e[e.Lifetime = 1] = \"Lifetime\", e[e.RequestResponse = 2] = \"RequestResponse\", e[e.Rendering = 3] = \"Rendering\", e[e.Error = 4] = \"Error\";\n}(p || (p = {}));\n\nclass y {\n  constructor(e) {\n    this._halfIntTexturesAvailable = !1, this._havePreparedWithAllLayers = !1, this._renderPluginContext = null, this._vxl = null, this._pluginIsActive = !1, this._moreToLoad = !1, this._viewportWidth = -1, this._viewportHeight = -1, this._newLayers = [], this._layers = new Map(), this._renderPass = d.MATERIAL, this._renderSlot = c.VOXEL, this._rctx = null, this._renderTargetToRestore = null, this._lastFrameWasStationary = !1, this._wasmMemBlockSizes = [512, 1024, 2048, 4096, 8192, 16384, 32768, 65536], this._wasmMemBlocks = new Map(), this._dbgFlags = new Set(), this._view = e, this._initialize();\n  }\n\n  get canRender() {\n    return !!this._vxl && \"local\" === this._view.viewingMode;\n  }\n\n  _dbg(e, t) {\n    this._dbgFlags.has(e) && (e === p.Error ? v.error(t) : v.warn(t));\n  }\n\n  _removeRenderPlugin() {\n    this._pluginIsActive && this._view._stage && (this._dbg(p.Lifetime, \"--removeRenderPlugin--\"), this._view._stage.removeRenderPlugin(this)), this._pluginIsActive = !1;\n  }\n\n  _initialize() {\n    this._dbg(p.Lifetime, \"--initialize--\");\n\n    for (const e of this._wasmMemBlockSizes) this._wasmMemBlocks.set(e, 0);\n\n    this._readyWatchHandle = a(() => this._view.ready, e => {\n      e && \"local\" === this._view.viewingMode ? (this._dbg(p.Lifetime, \"view ready status changed to ready on a local view, calling addRenderPlugin\"), this._view._stage.addRenderPlugin([this._renderSlot], this), this._pluginIsActive = !0) : (this._dbg(p.Lifetime, \"view ready status changed, not ready or not a local view!\"), this._removeRenderPlugin());\n    }, {\n      initial: !0\n    }), this._qualityWatchHandle = a(() => {\n      var e;\n      return null == (e = this._view) ? void 0 : e.qualityProfile;\n    }, e => {\n      this._dbg(p.Rendering, \"qualityProfile changed to \" + e), this._vxl && this._vxl.set_quality(this._toWasmQuality(e));\n    }, {\n      initial: !0\n    }), this._timeExtentWatchHandle = a(() => {\n      var e;\n      return null == (e = this._view) ? void 0 : e.timeExtent;\n    }, () => {\n      if (this._vxl) {\n        var e;\n\n        const t = this._getTimeArgs(null == (e = this._view) ? void 0 : e.timeExtent);\n\n        this._dbg(p.Rendering, \"sceneView timeExtent changed to useTime=\" + t.useTime + \" st=\" + t.startTime + \" et=\" + t.endTime), this._vxl.set_scene_time_extent(t.startTime, t.endTime, t.useTime), this._renderPluginContext.requestRender();\n      }\n    }, {\n      initial: !0\n    }), this._stationaryWatchHandle = a(() => {\n      var e;\n      return null == (e = this._view) ? void 0 : e.stationary;\n    }, e => {\n      this._vxl && e && !this._lastFrameWasStationary && this._renderPluginContext.requestRender();\n    });\n  }\n\n  initializeRenderContext(e) {\n    this._dbg(p.Lifetime, \"--initializeRenderContext--\");\n\n    const t = e.renderContext.rctx;\n    t.type === u.WEBGL2 ? (this._renderPluginContext = e, this._rctx = e.renderContext.rctx, this._halfIntTexturesAvailable = !!this._rctx.capabilities.textureNorm16, this._initializeWasm(t.gl)) : this._dbg(p.Error, \"WebGL 1 context only!\");\n  }\n\n  uninitializeRenderContext() {\n    this._renderPluginContext = null, this._rctx = null, this._dbg(p.Lifetime, \"--uninitializeRenderContext--\");\n  }\n\n  _restoreFramebuffer() {\n    if (!this._renderTargetToRestore) return;\n    const e = this._renderTargetToRestore.fbo;\n    if (!!!this._rctx) return void this._dbg(p.Error, \"no context in restoreFramebuffer!\");\n\n    this._rctx.bindFramebuffer(e, !0);\n\n    const t = this._renderTargetToRestore.viewport;\n\n    this._rctx.setViewport(t.x, t.y, t.width, t.height);\n  }\n\n  _bindPreviousDepthToSlot(e, t) {\n    const i = !!this._rctx,\n          s = !!this._renderTargetToRestore;\n    if (!i || !s) return 0;\n    const r = this._renderTargetToRestore.fbo.depthStencilTexture;\n    return r ? (0 === t ? this._rctx.bindTexture(null, e, !0) : this._rctx.bindTexture(r, e, !0), 1) : (this._dbg(p.Error, \"no depth/stencil texture exists!\"), 0);\n  }\n\n  _modifyResourceCount(e, t, i) {\n    if (!this._rctx) return void this._dbg(p.Error, \"modifyAllocation callback has no rendering context!\");\n    const s = e;\n    1 === i ? this._rctx.instanceCounter.increment(s, t) : this._rctx.instanceCounter.decrement(s, t);\n  }\n\n  _setBlendState(e, t, i, s) {\n    this._rctx ? (this._rctx.setBlendingEnabled(1 === e), this._rctx.setBlendFunction(t, i), this._rctx.setBlendEquation(s)) : this._dbg(p.Error, \"setBlendState callback has no rendering context!\");\n  }\n\n  _setFrontFace(e) {\n    this._rctx ? this._rctx.setFrontFace(e) : this._dbg(p.Error, \"setFrontFace callback has no rendering context!\");\n  }\n\n  _setDepthStencilStateFunction(e, t, i) {\n    this._rctx ? (this._rctx.setDepthFunction(i), this._rctx.setDepthTestEnabled(1 === e), this._rctx.setDepthWriteEnabled(1 === t), this._rctx.setStencilTestEnabled(!1), this._rctx.setStencilFunction(g.ALWAYS, 0, 255), this._rctx.setStencilOpSeparate(x.FRONT, m.KEEP, m.INCR, m.KEEP), this._rctx.setStencilOpSeparate(x.BACK, m.KEEP, m.DECR, m.KEEP)) : this._dbg(p.Error, \"setDepthStencilStateFunction callback has no rendering context!\");\n  }\n\n  _setRasterizerState(e) {\n    if (this._rctx) switch (e) {\n      case o.None:\n        this._rctx.setFaceCullingEnabled(!1);\n\n        break;\n\n      case o.Back:\n        this._rctx.setCullFace(x.BACK), this._rctx.setFaceCullingEnabled(!0);\n        break;\n\n      case o.Front:\n        this._rctx.setCullFace(x.FRONT), this._rctx.setFaceCullingEnabled(!0);\n    } else this._dbg(p.Error, \"setRasterizerState callback has no rendering context!\");\n  }\n\n  _setViewport(e, t, i, s) {\n    this._rctx ? this._rctx.setViewport(e, t, i, s) : this._dbg(p.Error, \"setViewport callback has no rendering context!\");\n  }\n\n  _updateMemoryUsage() {\n    this._layers.forEach((e, t) => {\n      if (e.needMemoryUsageUpdate) {\n        const i = this._vxl.estimate_memory_usage(t);\n\n        i >= 0 && (e.needMemoryUsageUpdate = !1, e.layerView.setUsedMemory(i));\n      }\n    });\n  }\n\n  _syncRequestsResponses() {\n    this._layers.forEach((t, i) => {\n      const s = [];\n      t.responses.forEach((e, r) => {\n        s.push(r), this._dbg(p.RequestResponse, \"responding for requestID:\" + r + \" size:\" + e.size), this._vxl.respond(i, r, e), e.requestType !== l.TreeIndex && e.requestType !== l.Section || (t.needMemoryUsageUpdate = !0);\n      });\n      const r = t.responses;\n\n      for (const e of s) r.delete(e);\n\n      const a = this._vxl.get_new_requests(i),\n            o = t.abortController.signal;\n\n      for (const l in a) {\n        t.outstandingRequestCount += 1, 1 === t.outstandingRequestCount && t.layerView.updatingFlagChanged();\n        const i = a[l],\n              s = {\n          responseType: \"array-buffer\",\n          signal: o\n        };\n        this._dbg(p.RequestResponse, \"making requestID:\" + l + \" url:\" + i.url), e(i.url, s).then(e => {\n          t.outstandingRequestCount -= 1, 0 === t.outstandingRequestCount && t.layerView.updatingFlagChanged(), this._dbg(p.RequestResponse, \"have response for requestID:\" + l);\n          let s = 0;\n\n          if (e.data.byteLength > 0) {\n            s = this._vxl._malloc(e.data.byteLength);\n            const t = new Uint8Array(this._vxl.HEAPU8.buffer, s, e.data.byteLength),\n                  i = new Uint8Array(e.data);\n\n            for (let s = 0; s < e.data.byteLength; ++s) t[s] = i[s];\n          }\n\n          r.set(+l, {\n            responseType: i.responseType,\n            ptr: s,\n            size: e.data.byteLength,\n            success: !0,\n            requestType: i.requestType\n          });\n        }).catch(e => {\n          t.outstandingRequestCount -= 1, 0 === t.outstandingRequestCount && t.layerView.updatingFlagChanged(), n(e) || (this._dbg(p.Error, `requestID:${l} failed, error=${e.toString()}`), r.set(+l, {\n            responseType: i.responseType,\n            ptr: 0,\n            size: 0,\n            success: !1,\n            requestType: i.requestType\n          }));\n        });\n      }\n    });\n  }\n\n  updateWasmCamera(e) {\n    this._vxl.set_projection_matrix.apply(this._vxl, e.projectionMatrix), this._vxl.set_view_matrix.apply(this._vxl, e.viewMatrix), this._vxl.set_near_far(e.near, e.far);\n  }\n\n  isUpdating(e) {\n    return !(this._vxl || !this._vxlPromise) || !!this._layers.has(e) && this._layers.get(e).outstandingRequestCount > 0;\n  }\n\n  setEnabled(e, t) {\n    this._layers.forEach((i, s) => {\n      i.layerView === e && (this._vxl.set_enabled(s, t), this._renderPluginContext.requestRender());\n    });\n  }\n\n  setSlices(e, t) {\n    const i = {\n      mask: h.Slices,\n      slices: {\n        planes: t,\n        currentEditPlane: -1\n      }\n    };\n    return this._doMaskedUIUpdate(e, i, !0);\n  }\n\n  setDynamicSections(e, t) {\n    const i = {\n      mask: h.DynamicSections,\n      dynamicSections: {\n        planes: t,\n        currentEditPlane: -1\n      }\n    };\n    return this._doMaskedUIUpdate(e, i, !0);\n  }\n\n  setStaticSections(e, t) {\n    const i = {\n      mask: h.StaticSections,\n      staticSections: t\n    };\n    return this._doMaskedUIUpdate(e, i, !0);\n  }\n\n  setCurrentVariable(e, t) {\n    const i = {\n      mask: h.CurrentVariable,\n      currentVariable: t\n    };\n    return this._doMaskedUIUpdate(e, i, !0);\n  }\n\n  setRenderMode(e, t) {\n    const i = {\n      mask: h.RenderMode,\n      renderMode: t\n    };\n    return this._doMaskedUIUpdate(e, i, !0);\n  }\n\n  _doMaskedUIUpdate(e, t, i) {\n    if (!this._vxl) return !1;\n    let s = !1;\n    return this._layers.forEach((i, r) => {\n      if (i.layerView === e) {\n        const e = {\n          str: JSON.stringify(t),\n          byteCount: 0,\n          ptr: 0,\n          isReusable: !1\n        };\n        this._allocateBlock(e) && (s = 1 === this._vxl.handle_masked_ui_update(r, e.ptr, e.byteCount), e.isReusable || this._vxl._free(e.ptr));\n      }\n    }), s && i && this._renderPluginContext.requestRender(), s;\n  }\n\n  addVoxelLayer(e) {\n    if (!this._vxl) {\n      const t = {\n        layerView: e,\n        resolveCallback: null,\n        rejectCallback: null\n      },\n            i = new Promise((e, i) => {\n        t.resolveCallback = e, t.rejectCallback = i;\n      });\n      return this._newLayers.push(t), i;\n    }\n\n    const t = this._addVoxelLayer(e);\n\n    return t < 0 ? Promise.reject(-1) : Promise.resolve(t);\n  }\n\n  removeVoxelLayer(e) {\n    if (!this._vxl) {\n      const t = this._newLayers.findIndex(t => e === t.layerView);\n\n      t >= 0 && (this._newLayers[t].resolveCallback(-1), this._newLayers.splice(t, 1));\n      const i = this._newLayers.length;\n      return 0 === i && (this._dbg(p.Lifetime, \" no voxel layers left after removing a layer, removing RenderPlugin and destroying\"), this.destroy()), i;\n    }\n\n    let t = -1;\n    this._layers.forEach((i, s) => {\n      i.layerView === e && (t = s, i.abortController.abort(), this._vxl.remove_layer(t));\n    }), t >= 0 && this._layers.delete(t);\n    const i = this._layers.size;\n    return 0 === i && (this._dbg(p.Lifetime, \" no voxel layers left after removing a layer, removing RenderPlugin and destroying\"), this.destroy()), i;\n  }\n\n  _getBlockSize(e) {\n    for (const t of this._wasmMemBlockSizes) if (e < t) return t;\n\n    return -1;\n  }\n\n  _allocateBlock(e) {\n    e.byteCount = this._vxl.lengthBytesUTF8(e.str) + 1;\n\n    const t = this._getBlockSize(e.byteCount);\n\n    return t < 0 ? (e.isReusable = !1, e.ptr = this._vxl._malloc(e.byteCount)) : (e.isReusable = !0, e.ptr = this._wasmMemBlocks.get(t), 0 === e.ptr && (e.ptr = this._vxl._malloc(t), this._wasmMemBlocks.set(t, e.ptr))), 0 !== e.ptr && (this._vxl.stringToUTF8(e.str, e.ptr, e.byteCount), !0);\n  }\n\n  _getTimeArgs(e) {\n    let t = -Number.MAX_VALUE,\n        i = Number.MAX_VALUE,\n        r = !1;\n    return s(e) && (e.isAllTime ? r = !0 : (s(e.start) && (r = !0, t = e.start.getTime() / 1e3), s(e.end) && (r = !0, i = e.end.getTime() / 1e3))), {\n      startTime: t,\n      endTime: i,\n      useTime: r\n    };\n  }\n\n  _addVoxelLayer(e) {\n    var i;\n    const s = e.layer;\n    let r = -1;\n    const n = s.getConfiguration();\n    if (n.length < 1) return -1;\n    const a = {\n      str: n,\n      byteCount: 0,\n      ptr: 0,\n      isReusable: !1\n    };\n    if (!this._allocateBlock(a)) return -1;\n\n    const o = this._getTimeArgs(null == (i = this._view) ? void 0 : i.timeExtent),\n          l = this._view.spatialReference.isWGS84 && s.spatialReference.isWGS84 ? 111319.49079327357 : 1;\n\n    if (r = this._vxl.add_layer(s.serviceRoot, a.ptr, a.byteCount, l, l, o.startTime, o.endTime, o.useTime, this._toWasmQuality(this._view.qualityProfile)), a.isReusable || this._vxl._free(a.ptr), r >= 0) {\n      const i = new AbortController();\n\n      if (this._layers.set(r, {\n        layerView: e,\n        responses: new Map(),\n        outstandingRequestCount: 0,\n        abortController: i,\n        needMemoryUsageUpdate: !1\n      }), !this._halfIntTexturesAvailable || t(\"mac\")) {\n        const t = [];\n        let i = \"\";\n\n        for (const s of e.layer.variables) \"Int16\" !== s.renderingFormat.type && \"UInt16\" !== s.renderingFormat.type || (t.push(s.name), s.id === e.layer.style.currentVariableId && (i = s.name));\n\n        \"\" !== i && v.error(\"#addVoxelLayer_error()\", e.layer, `The voxel layer '${e.layer.title}' cannot render the current variable '${i}' in this browser`), t.length > 0 && v.warn(\"#addVoxelLayer_warning()\", e.layer, `The voxel layer '${e.layer.title}' cannot render the variables '${t.toString()}' in this browser`);\n      }\n\n      return t(\"esri-mobile\") && v.warnOnce(\"Mobile support differs across devices. Voxel layer might not display as expected.\"), r;\n    }\n\n    return -1;\n  }\n\n  prepareRender(e) {\n    if (!this._vxl) return;\n    const t = e.viewForward,\n          i = e.eye;\n\n    this._vxl.update_camera_pos_and_direction(i[0], i[1], i[2], t[0], t[1], t[2]);\n\n    const s = this._vxl.cull();\n\n    this._dbg(p.RequestResponse, \"missingResourceCount=\" + s), this._moreToLoad = s > 0, this._havePreparedWithAllLayers = 0 === this._newLayers.length, this._updateMemoryUsage();\n  }\n\n  render(e) {\n    if (!this._vxl || e.pass !== this._renderPass || e.slot !== this._renderSlot) return;\n\n    for (const i of this._newLayers) {\n      const e = this._addVoxelLayer(i.layerView);\n\n      -1 === e ? i.rejectCallback(-1) : i.resolveCallback(e);\n    }\n\n    if (this._newLayers = [], 0 === this._layers.size) return void this._dbg(p.Error, \"No voxel layers but RenderPlugin instance is being asked to render!\");\n    this._renderTargetToRestore = {\n      fbo: this._rctx.getBoundFramebufferObject(),\n      viewport: this._rctx.getViewport()\n    }, this._syncRequestsResponses(), this._lastFrameWasStationary = this._view.stationary, this._rctx.setPolygonOffsetFillEnabled(!1), this._rctx.setScissorTestEnabled(!1), this._rctx.setColorMask(!0, !0, !0, !0), this._vxl.begin_color_frame(!this._view.stationary || this._moreToLoad, e.scenelightingData.lightingMainDirection[0], e.scenelightingData.lightingMainDirection[1], e.scenelightingData.lightingMainDirection[2]);\n    const t = this._renderTargetToRestore.viewport;\n    t.width === this._viewportWidth && t.height === this._viewportHeight || (this._viewportWidth = t.width, this._viewportHeight = t.height, this._vxl.set_viewport(t.width, t.height), this._layers.forEach(e => {\n      e.needMemoryUsageUpdate = !0;\n    })), 0 === t.x && 0 === t.y || this._dbg(p.Error, \"Unsupported viewport parameters detected!\"), this.updateWasmCamera(e.camera), this._vxl.draw(), this._renderTargetToRestore.fbo = null, e.rctx.externalTextureUnitUpdate(this._vxl.get_texture_units_bound_in_frame(), this._vxl.get_active_texture_unit()), e.rctx.externalVertexArrayObjectUpdate(), e.rctx.externalVertexBufferUpdate(), this._rctx.externalProgramUpdate(), (this._moreToLoad || !this._havePreparedWithAllLayers && this._layers.size > 0) && this._renderPluginContext.requestRender();\n  }\n\n  destroy() {\n    this._dbg(p.Lifetime, \"--destroy--\"), this._removeRenderPlugin(), this._readyWatchHandle = r(this._readyWatchHandle), this._qualityWatchHandle = r(this._qualityWatchHandle), this._timeExtentWatchHandle = r(this._timeExtentWatchHandle), this._stationaryWatchHandle = r(this._stationaryWatchHandle), this._vxl && (this._layers.forEach(e => {\n      e.abortController.abort();\n    }), this._wasmMemBlocks.forEach(e => {\n      0 !== e && this._vxl._free(e);\n    }), this._vxl.uninitialize_voxel_wasm(), this._vxl = null);\n  }\n\n  _initializeWasm(e) {\n    return this._vxl ? Promise.resolve() : (this._vxlPromise || (this._vxlPromise = _(e).then(e => {\n      var i;\n      if (this._vxl = e, this._vxlPromise = null, this._newLayers.length <= 0) return this._dbg(p.Lifetime, \" no voxel layers left after WASM downloaded, removing RenderPlugin and destroying\"), void this.destroy();\n\n      const s = this._getTimeArgs(null == (i = this._view) ? void 0 : i.timeExtent),\n            r = this._vxl.addFunction(this._restoreFramebuffer.bind(this), \"v\"),\n            n = this._vxl.addFunction(this._setBlendState.bind(this), \"viiii\"),\n            a = this._vxl.addFunction(this._setFrontFace.bind(this), \"vi\"),\n            o = this._vxl.addFunction(this._setRasterizerState.bind(this), \"vi\"),\n            l = this._vxl.addFunction(this._setDepthStencilStateFunction.bind(this), \"viii\"),\n            h = this._vxl.addFunction(this._setViewport.bind(this), \"viiii\"),\n            _ = this._vxl.addFunction(this._bindPreviousDepthToSlot.bind(this), \"iii\"),\n            d = this._vxl.addFunction(this._modifyResourceCount.bind(this), \"viii\"),\n            c = this._halfIntTexturesAvailable && !t(\"mac\");\n\n      this._vxl.initialize_voxel_wasm(r, n, a, o, l, h, _, d, s.startTime, s.endTime, s.useTime, c), this._renderPluginContext && this._renderPluginContext.requestRender();\n    }).catch(() => {\n      for (const e of this._newLayers) e.rejectCallback(-2);\n\n      this._dbg(p.Error, \" WASM failed to download, removing RenderPlugin and destroying\"), this.destroy();\n    })), this._vxlPromise);\n  }\n\n  pickDepth(e, t, i) {\n    if (!this._vxl || !this._rctx || 0 === this._layers.size) return null;\n    const s = i.viewport[3] - t;\n    if (e < 0 || e > i.viewport[2] || t < 0 || t > i.viewport[3]) return this._dbg(p.Error, `pickDepth: outOfRange, screenXY=[${e}, ${s}], vp=[${i.viewport.toString()}]`), null;\n    this._renderTargetToRestore = {\n      fbo: this._rctx.getBoundFramebufferObject(),\n      viewport: this._rctx.getViewport()\n    };\n    const r = i.viewForward,\n          n = i.eye;\n    this._vxl.update_camera_pos_and_direction(n[0], n[1], n[2], r[0], r[1], r[2]), this.updateWasmCamera(i), this._vxl.begin_frame();\n\n    const a = this._vxl.pick_depth(e, s);\n\n    if (this._renderTargetToRestore.fbo = null, this._rctx.externalTextureUnitUpdate(this._vxl.get_texture_units_bound_in_frame(), this._vxl.get_active_texture_unit()), this._rctx.externalVertexArrayObjectUpdate(), this._rctx.externalVertexBufferUpdate(), this._rctx.externalProgramUpdate(), a.success) {\n      return a.distanceToCamera;\n    }\n\n    return null;\n  }\n\n  _toWasmQuality(e) {\n    switch (e) {\n      case \"low\":\n        return 0;\n\n      case \"medium\":\n        return 1;\n\n      case \"high\":\n        return 2;\n    }\n  }\n\n}\n\nexport { y as default };","map":{"version":3,"sources":["D:/Github/CUSP_DataBase/CUSP_DB/src/main/gis/node_modules/@arcgis/core/layers/VoxelWasmPerScene.js"],"names":["e","t","i","isSome","s","removeMaybe","r","isAbortError","n","watch","a","WasmCullMode","o","VoxelRequestType","l","UpdateFlags","h","loadVoxelWASM","_","RenderPass","d","RenderSlot","c","ContextType","u","CompareFunction","g","Face","x","StencilOperation","m","v","getLogger","p","Lifetime","RequestResponse","Rendering","Error","y","constructor","_halfIntTexturesAvailable","_havePreparedWithAllLayers","_renderPluginContext","_vxl","_pluginIsActive","_moreToLoad","_viewportWidth","_viewportHeight","_newLayers","_layers","Map","_renderPass","MATERIAL","_renderSlot","VOXEL","_rctx","_renderTargetToRestore","_lastFrameWasStationary","_wasmMemBlockSizes","_wasmMemBlocks","_dbgFlags","Set","_view","_initialize","canRender","viewingMode","_dbg","has","error","warn","_removeRenderPlugin","_stage","removeRenderPlugin","set","_readyWatchHandle","ready","addRenderPlugin","initial","_qualityWatchHandle","qualityProfile","set_quality","_toWasmQuality","_timeExtentWatchHandle","timeExtent","_getTimeArgs","useTime","startTime","endTime","set_scene_time_extent","requestRender","_stationaryWatchHandle","stationary","initializeRenderContext","renderContext","rctx","type","WEBGL2","capabilities","textureNorm16","_initializeWasm","gl","uninitializeRenderContext","_restoreFramebuffer","fbo","bindFramebuffer","viewport","setViewport","width","height","_bindPreviousDepthToSlot","depthStencilTexture","bindTexture","_modifyResourceCount","instanceCounter","increment","decrement","_setBlendState","setBlendingEnabled","setBlendFunction","setBlendEquation","_setFrontFace","setFrontFace","_setDepthStencilStateFunction","setDepthFunction","setDepthTestEnabled","setDepthWriteEnabled","setStencilTestEnabled","setStencilFunction","ALWAYS","setStencilOpSeparate","FRONT","KEEP","INCR","BACK","DECR","_setRasterizerState","None","setFaceCullingEnabled","Back","setCullFace","Front","_setViewport","_updateMemoryUsage","forEach","needMemoryUsageUpdate","estimate_memory_usage","layerView","setUsedMemory","_syncRequestsResponses","responses","push","size","respond","requestType","TreeIndex","Section","delete","get_new_requests","abortController","signal","outstandingRequestCount","updatingFlagChanged","responseType","url","then","data","byteLength","_malloc","Uint8Array","HEAPU8","buffer","ptr","success","catch","toString","updateWasmCamera","set_projection_matrix","apply","projectionMatrix","set_view_matrix","viewMatrix","set_near_far","near","far","isUpdating","_vxlPromise","get","setEnabled","set_enabled","setSlices","mask","Slices","slices","planes","currentEditPlane","_doMaskedUIUpdate","setDynamicSections","DynamicSections","dynamicSections","setStaticSections","StaticSections","staticSections","setCurrentVariable","CurrentVariable","currentVariable","setRenderMode","RenderMode","renderMode","str","JSON","stringify","byteCount","isReusable","_allocateBlock","handle_masked_ui_update","_free","addVoxelLayer","resolveCallback","rejectCallback","Promise","_addVoxelLayer","reject","resolve","removeVoxelLayer","findIndex","splice","length","destroy","abort","remove_layer","_getBlockSize","lengthBytesUTF8","stringToUTF8","Number","MAX_VALUE","isAllTime","start","getTime","end","layer","getConfiguration","spatialReference","isWGS84","add_layer","serviceRoot","AbortController","variables","renderingFormat","name","id","style","currentVariableId","title","warnOnce","prepareRender","viewForward","eye","update_camera_pos_and_direction","cull","render","pass","slot","getBoundFramebufferObject","getViewport","setPolygonOffsetFillEnabled","setScissorTestEnabled","setColorMask","begin_color_frame","scenelightingData","lightingMainDirection","set_viewport","camera","draw","externalTextureUnitUpdate","get_texture_units_bound_in_frame","get_active_texture_unit","externalVertexArrayObjectUpdate","externalVertexBufferUpdate","externalProgramUpdate","uninitialize_voxel_wasm","addFunction","bind","initialize_voxel_wasm","pickDepth","begin_frame","pick_depth","distanceToCamera","default"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport e from\"../request.js\";import t from\"../core/has.js\";import i from\"../core/Logger.js\";import{isSome as s,removeMaybe as r}from\"../core/maybe.js\";import{isAbortError as n}from\"../core/promiseUtils.js\";import{watch as a}from\"../core/reactiveUtils.js\";import{WasmCullMode as o,VoxelRequestType as l,UpdateFlags as h}from\"../libs/vxl/enums.js\";import{loadVoxelWASM as _}from\"../libs/vxl/VxlModule.js\";import{RenderPass as d}from\"../views/3d/webgl-engine/lib/RenderPass.js\";import{RenderSlot as c}from\"../views/3d/webgl-engine/lib/RenderSlot.js\";import{ContextType as u}from\"../views/webgl/context-util.js\";import{CompareFunction as g,Face as x,StencilOperation as m}from\"../views/webgl/enums.js\";const v=i.getLogger(\"esri.layers.VoxelWasmPerScene\");var p;!function(e){e[e.Lifetime=1]=\"Lifetime\",e[e.RequestResponse=2]=\"RequestResponse\",e[e.Rendering=3]=\"Rendering\",e[e.Error=4]=\"Error\"}(p||(p={}));class y{constructor(e){this._halfIntTexturesAvailable=!1,this._havePreparedWithAllLayers=!1,this._renderPluginContext=null,this._vxl=null,this._pluginIsActive=!1,this._moreToLoad=!1,this._viewportWidth=-1,this._viewportHeight=-1,this._newLayers=[],this._layers=new Map,this._renderPass=d.MATERIAL,this._renderSlot=c.VOXEL,this._rctx=null,this._renderTargetToRestore=null,this._lastFrameWasStationary=!1,this._wasmMemBlockSizes=[512,1024,2048,4096,8192,16384,32768,65536],this._wasmMemBlocks=new Map,this._dbgFlags=new Set,this._view=e,this._initialize()}get canRender(){return!!this._vxl&&\"local\"===this._view.viewingMode}_dbg(e,t){this._dbgFlags.has(e)&&(e===p.Error?v.error(t):v.warn(t))}_removeRenderPlugin(){this._pluginIsActive&&this._view._stage&&(this._dbg(p.Lifetime,\"--removeRenderPlugin--\"),this._view._stage.removeRenderPlugin(this)),this._pluginIsActive=!1}_initialize(){this._dbg(p.Lifetime,\"--initialize--\");for(const e of this._wasmMemBlockSizes)this._wasmMemBlocks.set(e,0);this._readyWatchHandle=a((()=>this._view.ready),(e=>{e&&\"local\"===this._view.viewingMode?(this._dbg(p.Lifetime,\"view ready status changed to ready on a local view, calling addRenderPlugin\"),this._view._stage.addRenderPlugin([this._renderSlot],this),this._pluginIsActive=!0):(this._dbg(p.Lifetime,\"view ready status changed, not ready or not a local view!\"),this._removeRenderPlugin())}),{initial:!0}),this._qualityWatchHandle=a((()=>{var e;return null==(e=this._view)?void 0:e.qualityProfile}),(e=>{this._dbg(p.Rendering,\"qualityProfile changed to \"+e),this._vxl&&this._vxl.set_quality(this._toWasmQuality(e))}),{initial:!0}),this._timeExtentWatchHandle=a((()=>{var e;return null==(e=this._view)?void 0:e.timeExtent}),(()=>{if(this._vxl){var e;const t=this._getTimeArgs(null==(e=this._view)?void 0:e.timeExtent);this._dbg(p.Rendering,\"sceneView timeExtent changed to useTime=\"+t.useTime+\" st=\"+t.startTime+\" et=\"+t.endTime),this._vxl.set_scene_time_extent(t.startTime,t.endTime,t.useTime),this._renderPluginContext.requestRender()}}),{initial:!0}),this._stationaryWatchHandle=a((()=>{var e;return null==(e=this._view)?void 0:e.stationary}),(e=>{this._vxl&&e&&!this._lastFrameWasStationary&&this._renderPluginContext.requestRender()}))}initializeRenderContext(e){this._dbg(p.Lifetime,\"--initializeRenderContext--\");const t=e.renderContext.rctx;t.type===u.WEBGL2?(this._renderPluginContext=e,this._rctx=e.renderContext.rctx,this._halfIntTexturesAvailable=!!this._rctx.capabilities.textureNorm16,this._initializeWasm(t.gl)):this._dbg(p.Error,\"WebGL 1 context only!\")}uninitializeRenderContext(){this._renderPluginContext=null,this._rctx=null,this._dbg(p.Lifetime,\"--uninitializeRenderContext--\")}_restoreFramebuffer(){if(!this._renderTargetToRestore)return;const e=this._renderTargetToRestore.fbo;if(!!!this._rctx)return void this._dbg(p.Error,\"no context in restoreFramebuffer!\");this._rctx.bindFramebuffer(e,!0);const t=this._renderTargetToRestore.viewport;this._rctx.setViewport(t.x,t.y,t.width,t.height)}_bindPreviousDepthToSlot(e,t){const i=!!this._rctx,s=!!this._renderTargetToRestore;if(!i||!s)return 0;const r=this._renderTargetToRestore.fbo.depthStencilTexture;return r?(0===t?this._rctx.bindTexture(null,e,!0):this._rctx.bindTexture(r,e,!0),1):(this._dbg(p.Error,\"no depth/stencil texture exists!\"),0)}_modifyResourceCount(e,t,i){if(!this._rctx)return void this._dbg(p.Error,\"modifyAllocation callback has no rendering context!\");const s=e;1===i?this._rctx.instanceCounter.increment(s,t):this._rctx.instanceCounter.decrement(s,t)}_setBlendState(e,t,i,s){this._rctx?(this._rctx.setBlendingEnabled(1===e),this._rctx.setBlendFunction(t,i),this._rctx.setBlendEquation(s)):this._dbg(p.Error,\"setBlendState callback has no rendering context!\")}_setFrontFace(e){this._rctx?this._rctx.setFrontFace(e):this._dbg(p.Error,\"setFrontFace callback has no rendering context!\")}_setDepthStencilStateFunction(e,t,i){this._rctx?(this._rctx.setDepthFunction(i),this._rctx.setDepthTestEnabled(1===e),this._rctx.setDepthWriteEnabled(1===t),this._rctx.setStencilTestEnabled(!1),this._rctx.setStencilFunction(g.ALWAYS,0,255),this._rctx.setStencilOpSeparate(x.FRONT,m.KEEP,m.INCR,m.KEEP),this._rctx.setStencilOpSeparate(x.BACK,m.KEEP,m.DECR,m.KEEP)):this._dbg(p.Error,\"setDepthStencilStateFunction callback has no rendering context!\")}_setRasterizerState(e){if(this._rctx)switch(e){case o.None:this._rctx.setFaceCullingEnabled(!1);break;case o.Back:this._rctx.setCullFace(x.BACK),this._rctx.setFaceCullingEnabled(!0);break;case o.Front:this._rctx.setCullFace(x.FRONT),this._rctx.setFaceCullingEnabled(!0)}else this._dbg(p.Error,\"setRasterizerState callback has no rendering context!\")}_setViewport(e,t,i,s){this._rctx?this._rctx.setViewport(e,t,i,s):this._dbg(p.Error,\"setViewport callback has no rendering context!\")}_updateMemoryUsage(){this._layers.forEach(((e,t)=>{if(e.needMemoryUsageUpdate){const i=this._vxl.estimate_memory_usage(t);i>=0&&(e.needMemoryUsageUpdate=!1,e.layerView.setUsedMemory(i))}}))}_syncRequestsResponses(){this._layers.forEach(((t,i)=>{const s=[];t.responses.forEach(((e,r)=>{s.push(r),this._dbg(p.RequestResponse,\"responding for requestID:\"+r+\" size:\"+e.size),this._vxl.respond(i,r,e),e.requestType!==l.TreeIndex&&e.requestType!==l.Section||(t.needMemoryUsageUpdate=!0)}));const r=t.responses;for(const e of s)r.delete(e);const a=this._vxl.get_new_requests(i),o=t.abortController.signal;for(const l in a){t.outstandingRequestCount+=1,1===t.outstandingRequestCount&&t.layerView.updatingFlagChanged();const i=a[l],s={responseType:\"array-buffer\",signal:o};this._dbg(p.RequestResponse,\"making requestID:\"+l+\" url:\"+i.url),e(i.url,s).then((e=>{t.outstandingRequestCount-=1,0===t.outstandingRequestCount&&t.layerView.updatingFlagChanged(),this._dbg(p.RequestResponse,\"have response for requestID:\"+l);let s=0;if(e.data.byteLength>0){s=this._vxl._malloc(e.data.byteLength);const t=new Uint8Array(this._vxl.HEAPU8.buffer,s,e.data.byteLength),i=new Uint8Array(e.data);for(let s=0;s<e.data.byteLength;++s)t[s]=i[s]}r.set(+l,{responseType:i.responseType,ptr:s,size:e.data.byteLength,success:!0,requestType:i.requestType})})).catch((e=>{t.outstandingRequestCount-=1,0===t.outstandingRequestCount&&t.layerView.updatingFlagChanged(),n(e)||(this._dbg(p.Error,`requestID:${l} failed, error=${e.toString()}`),r.set(+l,{responseType:i.responseType,ptr:0,size:0,success:!1,requestType:i.requestType}))}))}}))}updateWasmCamera(e){this._vxl.set_projection_matrix.apply(this._vxl,e.projectionMatrix),this._vxl.set_view_matrix.apply(this._vxl,e.viewMatrix),this._vxl.set_near_far(e.near,e.far)}isUpdating(e){return!(this._vxl||!this._vxlPromise)||!!this._layers.has(e)&&this._layers.get(e).outstandingRequestCount>0}setEnabled(e,t){this._layers.forEach(((i,s)=>{i.layerView===e&&(this._vxl.set_enabled(s,t),this._renderPluginContext.requestRender())}))}setSlices(e,t){const i={mask:h.Slices,slices:{planes:t,currentEditPlane:-1}};return this._doMaskedUIUpdate(e,i,!0)}setDynamicSections(e,t){const i={mask:h.DynamicSections,dynamicSections:{planes:t,currentEditPlane:-1}};return this._doMaskedUIUpdate(e,i,!0)}setStaticSections(e,t){const i={mask:h.StaticSections,staticSections:t};return this._doMaskedUIUpdate(e,i,!0)}setCurrentVariable(e,t){const i={mask:h.CurrentVariable,currentVariable:t};return this._doMaskedUIUpdate(e,i,!0)}setRenderMode(e,t){const i={mask:h.RenderMode,renderMode:t};return this._doMaskedUIUpdate(e,i,!0)}_doMaskedUIUpdate(e,t,i){if(!this._vxl)return!1;let s=!1;return this._layers.forEach(((i,r)=>{if(i.layerView===e){const e={str:JSON.stringify(t),byteCount:0,ptr:0,isReusable:!1};this._allocateBlock(e)&&(s=1===this._vxl.handle_masked_ui_update(r,e.ptr,e.byteCount),e.isReusable||this._vxl._free(e.ptr))}})),s&&i&&this._renderPluginContext.requestRender(),s}addVoxelLayer(e){if(!this._vxl){const t={layerView:e,resolveCallback:null,rejectCallback:null},i=new Promise(((e,i)=>{t.resolveCallback=e,t.rejectCallback=i}));return this._newLayers.push(t),i}const t=this._addVoxelLayer(e);return t<0?Promise.reject(-1):Promise.resolve(t)}removeVoxelLayer(e){if(!this._vxl){const t=this._newLayers.findIndex((t=>e===t.layerView));t>=0&&(this._newLayers[t].resolveCallback(-1),this._newLayers.splice(t,1));const i=this._newLayers.length;return 0===i&&(this._dbg(p.Lifetime,\" no voxel layers left after removing a layer, removing RenderPlugin and destroying\"),this.destroy()),i}let t=-1;this._layers.forEach(((i,s)=>{i.layerView===e&&(t=s,i.abortController.abort(),this._vxl.remove_layer(t))})),t>=0&&this._layers.delete(t);const i=this._layers.size;return 0===i&&(this._dbg(p.Lifetime,\" no voxel layers left after removing a layer, removing RenderPlugin and destroying\"),this.destroy()),i}_getBlockSize(e){for(const t of this._wasmMemBlockSizes)if(e<t)return t;return-1}_allocateBlock(e){e.byteCount=this._vxl.lengthBytesUTF8(e.str)+1;const t=this._getBlockSize(e.byteCount);return t<0?(e.isReusable=!1,e.ptr=this._vxl._malloc(e.byteCount)):(e.isReusable=!0,e.ptr=this._wasmMemBlocks.get(t),0===e.ptr&&(e.ptr=this._vxl._malloc(t),this._wasmMemBlocks.set(t,e.ptr))),0!==e.ptr&&(this._vxl.stringToUTF8(e.str,e.ptr,e.byteCount),!0)}_getTimeArgs(e){let t=-Number.MAX_VALUE,i=Number.MAX_VALUE,r=!1;return s(e)&&(e.isAllTime?r=!0:(s(e.start)&&(r=!0,t=e.start.getTime()/1e3),s(e.end)&&(r=!0,i=e.end.getTime()/1e3))),{startTime:t,endTime:i,useTime:r}}_addVoxelLayer(e){var i;const s=e.layer;let r=-1;const n=s.getConfiguration();if(n.length<1)return-1;const a={str:n,byteCount:0,ptr:0,isReusable:!1};if(!this._allocateBlock(a))return-1;const o=this._getTimeArgs(null==(i=this._view)?void 0:i.timeExtent),l=this._view.spatialReference.isWGS84&&s.spatialReference.isWGS84?111319.49079327357:1;if(r=this._vxl.add_layer(s.serviceRoot,a.ptr,a.byteCount,l,l,o.startTime,o.endTime,o.useTime,this._toWasmQuality(this._view.qualityProfile)),a.isReusable||this._vxl._free(a.ptr),r>=0){const i=new AbortController;if(this._layers.set(r,{layerView:e,responses:new Map,outstandingRequestCount:0,abortController:i,needMemoryUsageUpdate:!1}),!this._halfIntTexturesAvailable||t(\"mac\")){const t=[];let i=\"\";for(const s of e.layer.variables)\"Int16\"!==s.renderingFormat.type&&\"UInt16\"!==s.renderingFormat.type||(t.push(s.name),s.id===e.layer.style.currentVariableId&&(i=s.name));\"\"!==i&&v.error(\"#addVoxelLayer_error()\",e.layer,`The voxel layer '${e.layer.title}' cannot render the current variable '${i}' in this browser`),t.length>0&&v.warn(\"#addVoxelLayer_warning()\",e.layer,`The voxel layer '${e.layer.title}' cannot render the variables '${t.toString()}' in this browser`)}return t(\"esri-mobile\")&&v.warnOnce(\"Mobile support differs across devices. Voxel layer might not display as expected.\"),r}return-1}prepareRender(e){if(!this._vxl)return;const t=e.viewForward,i=e.eye;this._vxl.update_camera_pos_and_direction(i[0],i[1],i[2],t[0],t[1],t[2]);const s=this._vxl.cull();this._dbg(p.RequestResponse,\"missingResourceCount=\"+s),this._moreToLoad=s>0,this._havePreparedWithAllLayers=0===this._newLayers.length,this._updateMemoryUsage()}render(e){if(!this._vxl||e.pass!==this._renderPass||e.slot!==this._renderSlot)return;for(const i of this._newLayers){const e=this._addVoxelLayer(i.layerView);-1===e?i.rejectCallback(-1):i.resolveCallback(e)}if(this._newLayers=[],0===this._layers.size)return void this._dbg(p.Error,\"No voxel layers but RenderPlugin instance is being asked to render!\");this._renderTargetToRestore={fbo:this._rctx.getBoundFramebufferObject(),viewport:this._rctx.getViewport()},this._syncRequestsResponses(),this._lastFrameWasStationary=this._view.stationary,this._rctx.setPolygonOffsetFillEnabled(!1),this._rctx.setScissorTestEnabled(!1),this._rctx.setColorMask(!0,!0,!0,!0),this._vxl.begin_color_frame(!this._view.stationary||this._moreToLoad,e.scenelightingData.lightingMainDirection[0],e.scenelightingData.lightingMainDirection[1],e.scenelightingData.lightingMainDirection[2]);const t=this._renderTargetToRestore.viewport;t.width===this._viewportWidth&&t.height===this._viewportHeight||(this._viewportWidth=t.width,this._viewportHeight=t.height,this._vxl.set_viewport(t.width,t.height),this._layers.forEach((e=>{e.needMemoryUsageUpdate=!0}))),0===t.x&&0===t.y||this._dbg(p.Error,\"Unsupported viewport parameters detected!\"),this.updateWasmCamera(e.camera),this._vxl.draw(),this._renderTargetToRestore.fbo=null,e.rctx.externalTextureUnitUpdate(this._vxl.get_texture_units_bound_in_frame(),this._vxl.get_active_texture_unit()),e.rctx.externalVertexArrayObjectUpdate(),e.rctx.externalVertexBufferUpdate(),this._rctx.externalProgramUpdate(),(this._moreToLoad||!this._havePreparedWithAllLayers&&this._layers.size>0)&&this._renderPluginContext.requestRender()}destroy(){this._dbg(p.Lifetime,\"--destroy--\"),this._removeRenderPlugin(),this._readyWatchHandle=r(this._readyWatchHandle),this._qualityWatchHandle=r(this._qualityWatchHandle),this._timeExtentWatchHandle=r(this._timeExtentWatchHandle),this._stationaryWatchHandle=r(this._stationaryWatchHandle),this._vxl&&(this._layers.forEach((e=>{e.abortController.abort()})),this._wasmMemBlocks.forEach((e=>{0!==e&&this._vxl._free(e)})),this._vxl.uninitialize_voxel_wasm(),this._vxl=null)}_initializeWasm(e){return this._vxl?Promise.resolve():(this._vxlPromise||(this._vxlPromise=_(e).then((e=>{var i;if(this._vxl=e,this._vxlPromise=null,this._newLayers.length<=0)return this._dbg(p.Lifetime,\" no voxel layers left after WASM downloaded, removing RenderPlugin and destroying\"),void this.destroy();const s=this._getTimeArgs(null==(i=this._view)?void 0:i.timeExtent),r=this._vxl.addFunction(this._restoreFramebuffer.bind(this),\"v\"),n=this._vxl.addFunction(this._setBlendState.bind(this),\"viiii\"),a=this._vxl.addFunction(this._setFrontFace.bind(this),\"vi\"),o=this._vxl.addFunction(this._setRasterizerState.bind(this),\"vi\"),l=this._vxl.addFunction(this._setDepthStencilStateFunction.bind(this),\"viii\"),h=this._vxl.addFunction(this._setViewport.bind(this),\"viiii\"),_=this._vxl.addFunction(this._bindPreviousDepthToSlot.bind(this),\"iii\"),d=this._vxl.addFunction(this._modifyResourceCount.bind(this),\"viii\"),c=this._halfIntTexturesAvailable&&!t(\"mac\");this._vxl.initialize_voxel_wasm(r,n,a,o,l,h,_,d,s.startTime,s.endTime,s.useTime,c),this._renderPluginContext&&this._renderPluginContext.requestRender()})).catch((()=>{for(const e of this._newLayers)e.rejectCallback(-2);this._dbg(p.Error,\" WASM failed to download, removing RenderPlugin and destroying\"),this.destroy()}))),this._vxlPromise)}pickDepth(e,t,i){if(!this._vxl||!this._rctx||0===this._layers.size)return null;const s=i.viewport[3]-t;if(e<0||e>i.viewport[2]||t<0||t>i.viewport[3])return this._dbg(p.Error,`pickDepth: outOfRange, screenXY=[${e}, ${s}], vp=[${i.viewport.toString()}]`),null;this._renderTargetToRestore={fbo:this._rctx.getBoundFramebufferObject(),viewport:this._rctx.getViewport()};const r=i.viewForward,n=i.eye;this._vxl.update_camera_pos_and_direction(n[0],n[1],n[2],r[0],r[1],r[2]),this.updateWasmCamera(i),this._vxl.begin_frame();const a=this._vxl.pick_depth(e,s);if(this._renderTargetToRestore.fbo=null,this._rctx.externalTextureUnitUpdate(this._vxl.get_texture_units_bound_in_frame(),this._vxl.get_active_texture_unit()),this._rctx.externalVertexArrayObjectUpdate(),this._rctx.externalVertexBufferUpdate(),this._rctx.externalProgramUpdate(),a.success){return a.distanceToCamera}return null}_toWasmQuality(e){switch(e){case\"low\":return 0;case\"medium\":return 1;case\"high\":return 2}}}export{y as default};\n"]},"metadata":{},"sourceType":"module"}