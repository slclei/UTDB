{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport e from \"../../../../core/LRUCache.js\";\nimport { isNone as i, isSome as t } from \"../../../../core/maybe.js\";\nimport s from \"../../tiling/TileCoverage.js\";\nimport l from \"../../tiling/TileKey.js\";\n\nconst r = 512,\n      o = 1e-6,\n      n = (e, i) => e + 1 / (1 << 2 * i);\n\nclass a {\n  constructor(i, t) {\n    this._tiles = new Map(), this._tileCache = new e(40, e => e.dispose()), this._viewSize = [0, 0], this._visibleTiles = new Map(), this.acquireTile = i.acquireTile, this.releaseTile = i.releaseTile, this.tileInfoView = i.tileInfoView, this._container = t;\n  }\n\n  destroy() {\n    for (const [e, i] of this._tiles) i.dispose();\n\n    this._tiles = null, this._tileCache.clear(), this._tileCache = null;\n  }\n\n  update(e) {\n    this._updateCacheSize(e);\n\n    const i = this.tileInfoView,\n          t = i.getTileCoverage(e.state, 0, \"smallest\"),\n          {\n      spans: r,\n      lodInfo: o\n    } = t,\n          {\n      level: n\n    } = o,\n          a = this._tiles,\n          c = new Set(),\n          h = new Set();\n\n    for (const {\n      row: s,\n      colFrom: _,\n      colTo: f\n    } of r) for (let e = _; e <= f; e++) {\n      const i = l.getId(n, s, o.normalizeCol(e), o.getWorldForColumn(e)),\n            t = this._getOrAcquireTile(i);\n\n      c.add(i), t.processed() ? this._addToContainer(t) : h.add(new l(i));\n    }\n\n    for (const [s, l] of a) l.isCoverage = c.has(s);\n\n    for (const s of h) this._findPlaceholdersForMissingTiles(s, c);\n\n    let d = !1;\n\n    for (const [s, l] of a) l.neededForCoverage = c.has(s), l.neededForCoverage || l.isHoldingForFade && i.intersects(t, l.key) && c.add(s), l.isFading && (d = !0);\n\n    for (const [s, l] of this._tiles) c.has(s) || this._releaseTile(s);\n\n    return s.pool.release(t), !d;\n  }\n\n  clear() {\n    this._tiles.clear(), this._tileCache.clear(), this._visibleTiles.clear();\n  }\n\n  clearCache() {\n    this._tileCache.clear();\n  }\n\n  _findPlaceholdersForMissingTiles(e, i) {\n    const t = [];\n\n    for (const [l, r] of this._tiles) this._addPlaceholderChild(t, r, e, i);\n\n    const s = t.reduce(n, 0);\n    Math.abs(1 - s) < o || this._addPlaceholderParent(e.id, i);\n  }\n\n  _addPlaceholderChild(e, i, t, s) {\n    i.key.level <= t.level || !i.hasData() || h(t, i.key) && (this._addToContainer(i), s.add(i.id), e.push(i.key.level - t.level));\n  }\n\n  _addPlaceholderParent(e, i) {\n    const t = this._tiles;\n    let s = e;\n\n    for (;;) {\n      if (s = c(s), !s || i.has(s)) return;\n      const e = t.get(s);\n      if (e && e.hasData()) return this._addToContainer(e), void i.add(e.id);\n    }\n  }\n\n  _getOrAcquireTile(e) {\n    let i = this._tiles.get(e);\n\n    return i || (i = this._tileCache.pop(e), i || (i = this.acquireTile(new l(e))), this._tiles.set(e, i), i);\n  }\n\n  _releaseTile(e) {\n    const i = this._tiles.get(e);\n\n    this.releaseTile(i), this._removeFromContainer(i), this._tiles.delete(e), i.hasData() ? this._tileCache.put(e, i, 1) : i.dispose();\n  }\n\n  _addToContainer(e) {\n    let s;\n    const l = [],\n          r = this._container;\n    if (r.contains(e)) return;\n    const o = this._visibleTiles;\n\n    for (const [t, n] of o) this._canConnectDirectly(e, n) && l.push(n), i(s) && this._canConnectDirectly(n, e) && (s = n);\n\n    if (t(s)) {\n      for (const i of l) s.childrenTiles.delete(i), e.childrenTiles.add(i), i.parentTile = e;\n\n      s.childrenTiles.add(e), e.parentTile = s;\n    } else for (const i of l) e.childrenTiles.add(i), i.parentTile = e;\n\n    o.set(e.id, e), r.addChild(e);\n  }\n\n  _removeFromContainer(e) {\n    if (this._visibleTiles.delete(e.id), this._container.removeChild(e), t(e.parentTile)) {\n      e.parentTile.childrenTiles.delete(e);\n\n      for (const i of e.childrenTiles) t(e.parentTile) && e.parentTile.childrenTiles.add(i);\n    }\n\n    for (const i of e.childrenTiles) i.parentTile = e.parentTile;\n\n    e.parentTile = null, e.childrenTiles.clear();\n  }\n\n  _canConnectDirectly(e, i) {\n    const t = e.key;\n    let {\n      level: s,\n      row: l,\n      col: r,\n      world: o\n    } = i.key;\n    const n = this._visibleTiles;\n\n    for (; s > 0;) {\n      if (s--, l >>= 1, r >>= 1, t.level === s && t.row === l && t.col === r && t.world === o) return !0;\n      if (n.has(`${s}/${l}/${r}/${o}`)) return !1;\n    }\n\n    return !1;\n  }\n\n  _updateCacheSize(e) {\n    const i = e.state.size;\n    if (i[0] === this._viewSize[0] && i[1] === this._viewSize[1]) return;\n    const t = Math.ceil(i[0] / r) + 1,\n          s = Math.ceil(i[1] / r) + 1;\n    this._viewSize[0] = i[0], this._viewSize[1] = i[1], this._tileCache.maxSize = 5 * t * s;\n  }\n\n}\n\nfunction c(e) {\n  const [i, t, s, l] = e.split(\"/\"),\n        r = parseInt(i, 10);\n  return 0 === r ? null : `${r - 1}/${parseInt(t, 10) >> 1}/${parseInt(s, 10) >> 1}/${parseInt(l, 10)}`;\n}\n\nfunction h(e, i) {\n  const t = i.level - e.level;\n  return e.row === i.row >> t && e.col === i.col >> t && e.world === i.world;\n}\n\nexport { a as TileManager };","map":{"version":3,"sources":["D:/Github/CUSP_DataBase/CUSP_DB/src/main/gis/node_modules/@arcgis/core/views/2d/engine/vectorTiles/TileManager.js"],"names":["e","isNone","i","isSome","t","s","l","r","o","n","a","constructor","_tiles","Map","_tileCache","dispose","_viewSize","_visibleTiles","acquireTile","releaseTile","tileInfoView","_container","destroy","clear","update","_updateCacheSize","getTileCoverage","state","spans","lodInfo","level","c","Set","h","row","colFrom","_","colTo","f","getId","normalizeCol","getWorldForColumn","_getOrAcquireTile","add","processed","_addToContainer","isCoverage","has","_findPlaceholdersForMissingTiles","d","neededForCoverage","isHoldingForFade","intersects","key","isFading","_releaseTile","pool","release","clearCache","_addPlaceholderChild","reduce","Math","abs","_addPlaceholderParent","id","hasData","push","get","pop","set","_removeFromContainer","delete","put","contains","_canConnectDirectly","childrenTiles","parentTile","addChild","removeChild","col","world","size","ceil","maxSize","split","parseInt","TileManager"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport e from\"../../../../core/LRUCache.js\";import{isNone as i,isSome as t}from\"../../../../core/maybe.js\";import s from\"../../tiling/TileCoverage.js\";import l from\"../../tiling/TileKey.js\";const r=512,o=1e-6,n=(e,i)=>e+1/(1<<2*i);class a{constructor(i,t){this._tiles=new Map,this._tileCache=new e(40,(e=>e.dispose())),this._viewSize=[0,0],this._visibleTiles=new Map,this.acquireTile=i.acquireTile,this.releaseTile=i.releaseTile,this.tileInfoView=i.tileInfoView,this._container=t}destroy(){for(const[e,i]of this._tiles)i.dispose();this._tiles=null,this._tileCache.clear(),this._tileCache=null}update(e){this._updateCacheSize(e);const i=this.tileInfoView,t=i.getTileCoverage(e.state,0,\"smallest\"),{spans:r,lodInfo:o}=t,{level:n}=o,a=this._tiles,c=new Set,h=new Set;for(const{row:s,colFrom:_,colTo:f}of r)for(let e=_;e<=f;e++){const i=l.getId(n,s,o.normalizeCol(e),o.getWorldForColumn(e)),t=this._getOrAcquireTile(i);c.add(i),t.processed()?this._addToContainer(t):h.add(new l(i))}for(const[s,l]of a)l.isCoverage=c.has(s);for(const s of h)this._findPlaceholdersForMissingTiles(s,c);let d=!1;for(const[s,l]of a)l.neededForCoverage=c.has(s),l.neededForCoverage||l.isHoldingForFade&&i.intersects(t,l.key)&&c.add(s),l.isFading&&(d=!0);for(const[s,l]of this._tiles)c.has(s)||this._releaseTile(s);return s.pool.release(t),!d}clear(){this._tiles.clear(),this._tileCache.clear(),this._visibleTiles.clear()}clearCache(){this._tileCache.clear()}_findPlaceholdersForMissingTiles(e,i){const t=[];for(const[l,r]of this._tiles)this._addPlaceholderChild(t,r,e,i);const s=t.reduce(n,0);Math.abs(1-s)<o||this._addPlaceholderParent(e.id,i)}_addPlaceholderChild(e,i,t,s){i.key.level<=t.level||!i.hasData()||h(t,i.key)&&(this._addToContainer(i),s.add(i.id),e.push(i.key.level-t.level))}_addPlaceholderParent(e,i){const t=this._tiles;let s=e;for(;;){if(s=c(s),!s||i.has(s))return;const e=t.get(s);if(e&&e.hasData())return this._addToContainer(e),void i.add(e.id)}}_getOrAcquireTile(e){let i=this._tiles.get(e);return i||(i=this._tileCache.pop(e),i||(i=this.acquireTile(new l(e))),this._tiles.set(e,i),i)}_releaseTile(e){const i=this._tiles.get(e);this.releaseTile(i),this._removeFromContainer(i),this._tiles.delete(e),i.hasData()?this._tileCache.put(e,i,1):i.dispose()}_addToContainer(e){let s;const l=[],r=this._container;if(r.contains(e))return;const o=this._visibleTiles;for(const[t,n]of o)this._canConnectDirectly(e,n)&&l.push(n),i(s)&&this._canConnectDirectly(n,e)&&(s=n);if(t(s)){for(const i of l)s.childrenTiles.delete(i),e.childrenTiles.add(i),i.parentTile=e;s.childrenTiles.add(e),e.parentTile=s}else for(const i of l)e.childrenTiles.add(i),i.parentTile=e;o.set(e.id,e),r.addChild(e)}_removeFromContainer(e){if(this._visibleTiles.delete(e.id),this._container.removeChild(e),t(e.parentTile)){e.parentTile.childrenTiles.delete(e);for(const i of e.childrenTiles)t(e.parentTile)&&e.parentTile.childrenTiles.add(i)}for(const i of e.childrenTiles)i.parentTile=e.parentTile;e.parentTile=null,e.childrenTiles.clear()}_canConnectDirectly(e,i){const t=e.key;let{level:s,row:l,col:r,world:o}=i.key;const n=this._visibleTiles;for(;s>0;){if(s--,l>>=1,r>>=1,t.level===s&&t.row===l&&t.col===r&&t.world===o)return!0;if(n.has(`${s}/${l}/${r}/${o}`))return!1}return!1}_updateCacheSize(e){const i=e.state.size;if(i[0]===this._viewSize[0]&&i[1]===this._viewSize[1])return;const t=Math.ceil(i[0]/r)+1,s=Math.ceil(i[1]/r)+1;this._viewSize[0]=i[0],this._viewSize[1]=i[1],this._tileCache.maxSize=5*t*s}}function c(e){const[i,t,s,l]=e.split(\"/\"),r=parseInt(i,10);return 0===r?null:`${r-1}/${parseInt(t,10)>>1}/${parseInt(s,10)>>1}/${parseInt(l,10)}`}function h(e,i){const t=i.level-e.level;return e.row===i.row>>t&&e.col===i.col>>t&&e.world===i.world}export{a as TileManager};\n"]},"metadata":{},"sourceType":"module"}