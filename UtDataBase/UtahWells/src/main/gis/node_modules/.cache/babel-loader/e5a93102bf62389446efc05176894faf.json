{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../chunks/tslib.es6.js\";\nimport t from \"../../../core/Logger.js\";\nimport { isAbortError as i } from \"../../../core/promiseUtils.js\";\nimport { watch as s } from \"../../../core/reactiveUtils.js\";\nimport { property as r } from \"../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../core/arrayUtils.js\";\nimport \"../../../core/has.js\";\nimport \"../../../core/accessorSupport/ensureType.js\";\nimport { subclass as l } from \"../../../core/accessorSupport/decorators/subclass.js\";\nimport { equals as a } from \"../../../geometry/support/spatialReferenceUtils.js\";\nimport { BitmapTileLayerView2D as o } from \"./BitmapTileLayerView2D.js\";\nimport { LayerView2DMixin as h } from \"./LayerView2D.js\";\nimport { createBlankImage as n, resampleImage as c } from \"./support/imageUtils.js\";\nimport u from \"../tiling/TileInfoView.js\";\nimport p from \"../tiling/TileKey.js\";\nimport f from \"../tiling/TileQueue.js\";\nimport m from \"../tiling/TileStrategy.js\";\nimport y from \"../../layers/LayerView.js\";\nimport { RefreshableLayerView as d } from \"../../layers/RefreshableLayerView.js\";\nimport { TileLayerView as g } from \"../../layers/TileLayerView.js\";\nimport { createQueryGeometry as w } from \"../../support/drapedUtils.js\";\nconst _ = [0, 0];\nlet I = class extends g(d(o(h(y)))) {\n  constructor() {\n    super(...arguments), this._tileStrategy = null, this._fetchQueue = null, this.layer = null;\n  }\n\n  get resampling() {\n    return !(\"resampling\" in this.layer) || !1 !== this.layer.resampling;\n  }\n\n  update(e) {\n    this._fetchQueue.pause(), this._fetchQueue.state = e.state, this._tileStrategy.update(e), this._fetchQueue.resume();\n  }\n\n  attach() {\n    const e = \"tileServers\" in this.layer ? this.layer.tileServers : null;\n    this._tileInfoView = new u(this.layer.tileInfo, this.layer.fullExtent), this._fetchQueue = new f({\n      tileInfoView: this._tileInfoView,\n      concurrency: e && 10 * e.length || 10,\n      process: (e, t) => this.fetchTile(e, t)\n    }), this._tileStrategy = new m({\n      cachePolicy: \"keep\",\n      resampling: this.resampling,\n      acquireTile: e => this.acquireTile(e),\n      releaseTile: e => this.releaseTile(e),\n      tileInfoView: this._tileInfoView\n    }), this.requestUpdate(), this.handles.add(s(() => this.resampling, () => {\n      this.doRefresh();\n    })), super.attach();\n  }\n\n  detach() {\n    super.detach(), this._tileStrategy.destroy(), this._fetchQueue.clear(), this.container.removeAllChildren(), this._fetchQueue = this._tileStrategy = this._tileInfoView = null;\n  }\n\n  moveStart() {\n    this.requestUpdate();\n  }\n\n  viewChange() {\n    this.requestUpdate();\n  }\n\n  moveEnd() {\n    this.requestUpdate();\n  }\n\n  supportsSpatialReference(e) {\n    var t;\n    return a(null == (t = this.layer.tileInfo) ? void 0 : t.spatialReference, e);\n  }\n\n  createFetchPopupFeaturesQueryGeometry(e, t) {\n    return w(e, t, this.view);\n  }\n\n  async doRefresh() {\n    this.updateRequested || this.suspended || (this._fetchQueue.reset(), this._tileStrategy.tiles.forEach(e => this._enqueueTileFetch(e)));\n  }\n\n  isUpdating() {\n    var e, t;\n    return null != (e = null == (t = this._fetchQueue) ? void 0 : t.updating) && e;\n  }\n\n  acquireTile(e) {\n    const t = this._bitmapView.createTile(e),\n          i = t.bitmap;\n\n    return [i.x, i.y] = this._tileInfoView.getTileCoords(_, t.key), i.resolution = this._tileInfoView.getTileResolution(t.key), [i.width, i.height] = this._tileInfoView.tileInfo.size, this._enqueueTileFetch(t), this._bitmapView.addChild(t), this.requestUpdate(), t;\n  }\n\n  releaseTile(e) {\n    this._fetchQueue.abort(e.key.id), this._bitmapView.removeChild(e), e.once(\"detach\", () => e.destroy()), this.requestUpdate();\n  }\n\n  async fetchTile(e) {\n    let t = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n    const s = \"tilemapCache\" in this.layer ? this.layer.tilemapCache : null,\n          {\n      signal: r,\n      resamplingLevel: l = 0\n    } = t;\n    if (!s) try {\n      return await this._fetchImage(e, r);\n    } catch (h) {\n      if (!i(h) && !this.resampling) return n(this._tileInfoView.tileInfo.size);\n\n      if (l < 3) {\n        const i = this._tileInfoView.getTileParentId(e.id);\n\n        if (i) {\n          const s = new p(i),\n                r = await this.fetchTile(s, { ...t,\n            resamplingLevel: l + 1\n          });\n          return c(this._tileInfoView, r, s, e);\n        }\n      }\n\n      throw h;\n    }\n    const a = new p(0, 0, 0, 0);\n    let o;\n\n    try {\n      if (await s.fetchAvailabilityUpsample(e.level, e.row, e.col, a, {\n        signal: r\n      }), a.level !== e.level && !this.resampling) return n(this._tileInfoView.tileInfo.size);\n      o = await this._fetchImage(a, r);\n    } catch (h) {\n      if (i(h)) throw h;\n      o = await this._fetchImage(e, r);\n    }\n\n    return this.resampling ? c(this._tileInfoView, o, a, e) : o;\n  }\n\n  async _enqueueTileFetch(e) {\n    if (!this._fetchQueue.has(e.key.id)) {\n      try {\n        const t = await this._fetchQueue.push(e.key);\n        e.bitmap.source = t, e.bitmap.width = this._tileInfoView.tileInfo.size[0], e.bitmap.height = this._tileInfoView.tileInfo.size[1], e.once(\"attach\", () => this.requestUpdate());\n      } catch (s) {\n        i(s) || t.getLogger(this.declaredClass).error(s);\n      }\n\n      this.requestUpdate();\n    }\n  }\n\n  async _fetchImage(e, t) {\n    return this.layer.fetchTile(e.level, e.row, e.col, {\n      signal: t\n    });\n  }\n\n};\ne([r()], I.prototype, \"_fetchQueue\", void 0), e([r()], I.prototype, \"resampling\", null), I = e([l(\"esri.views.2d.layers.TileLayerView2D\")], I);\nconst V = I;\nexport { V as default };","map":{"version":3,"sources":["D:/Github/CUSP_DataBase/CUSP_DB/src/main/gis/node_modules/@arcgis/core/views/2d/layers/TileLayerView2D.js"],"names":["_","e","t","isAbortError","i","watch","s","property","r","subclass","l","equals","a","BitmapTileLayerView2D","o","LayerView2DMixin","h","createBlankImage","n","resampleImage","c","u","p","f","m","y","RefreshableLayerView","d","TileLayerView","g","createQueryGeometry","w","I","constructor","arguments","_tileStrategy","_fetchQueue","layer","resampling","update","pause","state","resume","attach","tileServers","_tileInfoView","tileInfo","fullExtent","tileInfoView","concurrency","length","process","fetchTile","cachePolicy","acquireTile","releaseTile","requestUpdate","handles","add","doRefresh","detach","destroy","clear","container","removeAllChildren","moveStart","viewChange","moveEnd","supportsSpatialReference","spatialReference","createFetchPopupFeaturesQueryGeometry","view","updateRequested","suspended","reset","tiles","forEach","_enqueueTileFetch","isUpdating","updating","_bitmapView","createTile","bitmap","x","getTileCoords","key","resolution","getTileResolution","width","height","size","addChild","abort","id","removeChild","once","tilemapCache","signal","resamplingLevel","_fetchImage","getTileParentId","fetchAvailabilityUpsample","level","row","col","has","push","source","getLogger","declaredClass","error","prototype","V","default"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../chunks/tslib.es6.js\";import t from\"../../../core/Logger.js\";import{isAbortError as i}from\"../../../core/promiseUtils.js\";import{watch as s}from\"../../../core/reactiveUtils.js\";import{property as r}from\"../../../core/accessorSupport/decorators/property.js\";import\"../../../core/arrayUtils.js\";import\"../../../core/has.js\";import\"../../../core/accessorSupport/ensureType.js\";import{subclass as l}from\"../../../core/accessorSupport/decorators/subclass.js\";import{equals as a}from\"../../../geometry/support/spatialReferenceUtils.js\";import{BitmapTileLayerView2D as o}from\"./BitmapTileLayerView2D.js\";import{LayerView2DMixin as h}from\"./LayerView2D.js\";import{createBlankImage as n,resampleImage as c}from\"./support/imageUtils.js\";import u from\"../tiling/TileInfoView.js\";import p from\"../tiling/TileKey.js\";import f from\"../tiling/TileQueue.js\";import m from\"../tiling/TileStrategy.js\";import y from\"../../layers/LayerView.js\";import{RefreshableLayerView as d}from\"../../layers/RefreshableLayerView.js\";import{TileLayerView as g}from\"../../layers/TileLayerView.js\";import{createQueryGeometry as w}from\"../../support/drapedUtils.js\";const _=[0,0];let I=class extends(g(d(o(h(y))))){constructor(){super(...arguments),this._tileStrategy=null,this._fetchQueue=null,this.layer=null}get resampling(){return!(\"resampling\"in this.layer)||!1!==this.layer.resampling}update(e){this._fetchQueue.pause(),this._fetchQueue.state=e.state,this._tileStrategy.update(e),this._fetchQueue.resume()}attach(){const e=\"tileServers\"in this.layer?this.layer.tileServers:null;this._tileInfoView=new u(this.layer.tileInfo,this.layer.fullExtent),this._fetchQueue=new f({tileInfoView:this._tileInfoView,concurrency:e&&10*e.length||10,process:(e,t)=>this.fetchTile(e,t)}),this._tileStrategy=new m({cachePolicy:\"keep\",resampling:this.resampling,acquireTile:e=>this.acquireTile(e),releaseTile:e=>this.releaseTile(e),tileInfoView:this._tileInfoView}),this.requestUpdate(),this.handles.add(s((()=>this.resampling),(()=>{this.doRefresh()}))),super.attach()}detach(){super.detach(),this._tileStrategy.destroy(),this._fetchQueue.clear(),this.container.removeAllChildren(),this._fetchQueue=this._tileStrategy=this._tileInfoView=null}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}supportsSpatialReference(e){var t;return a(null==(t=this.layer.tileInfo)?void 0:t.spatialReference,e)}createFetchPopupFeaturesQueryGeometry(e,t){return w(e,t,this.view)}async doRefresh(){this.updateRequested||this.suspended||(this._fetchQueue.reset(),this._tileStrategy.tiles.forEach((e=>this._enqueueTileFetch(e))))}isUpdating(){var e,t;return null!=(e=null==(t=this._fetchQueue)?void 0:t.updating)&&e}acquireTile(e){const t=this._bitmapView.createTile(e),i=t.bitmap;return[i.x,i.y]=this._tileInfoView.getTileCoords(_,t.key),i.resolution=this._tileInfoView.getTileResolution(t.key),[i.width,i.height]=this._tileInfoView.tileInfo.size,this._enqueueTileFetch(t),this._bitmapView.addChild(t),this.requestUpdate(),t}releaseTile(e){this._fetchQueue.abort(e.key.id),this._bitmapView.removeChild(e),e.once(\"detach\",(()=>e.destroy())),this.requestUpdate()}async fetchTile(e,t={}){const s=\"tilemapCache\"in this.layer?this.layer.tilemapCache:null,{signal:r,resamplingLevel:l=0}=t;if(!s)try{return await this._fetchImage(e,r)}catch(h){if(!i(h)&&!this.resampling)return n(this._tileInfoView.tileInfo.size);if(l<3){const i=this._tileInfoView.getTileParentId(e.id);if(i){const s=new p(i),r=await this.fetchTile(s,{...t,resamplingLevel:l+1});return c(this._tileInfoView,r,s,e)}}throw h}const a=new p(0,0,0,0);let o;try{if(await s.fetchAvailabilityUpsample(e.level,e.row,e.col,a,{signal:r}),a.level!==e.level&&!this.resampling)return n(this._tileInfoView.tileInfo.size);o=await this._fetchImage(a,r)}catch(h){if(i(h))throw h;o=await this._fetchImage(e,r)}return this.resampling?c(this._tileInfoView,o,a,e):o}async _enqueueTileFetch(e){if(!this._fetchQueue.has(e.key.id)){try{const t=await this._fetchQueue.push(e.key);e.bitmap.source=t,e.bitmap.width=this._tileInfoView.tileInfo.size[0],e.bitmap.height=this._tileInfoView.tileInfo.size[1],e.once(\"attach\",(()=>this.requestUpdate()))}catch(s){i(s)||t.getLogger(this.declaredClass).error(s)}this.requestUpdate()}}async _fetchImage(e,t){return this.layer.fetchTile(e.level,e.row,e.col,{signal:t})}};e([r()],I.prototype,\"_fetchQueue\",void 0),e([r()],I.prototype,\"resampling\",null),I=e([l(\"esri.views.2d.layers.TileLayerView2D\")],I);const V=I;export{V as default};\n"]},"metadata":{},"sourceType":"module"}