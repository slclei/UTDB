{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../chunks/tslib.es6.js\";\nimport { version as i } from \"../../../kernel.js\";\nimport t from \"../../../request.js\";\nimport s from \"../../../core/Collection.js\";\nimport a from \"../../../core/Handles.js\";\nimport { isSome as o, isNone as l } from \"../../../core/maybe.js\";\nimport { watch as r } from \"../../../core/reactiveUtils.js\";\nimport { queryToObject as n, objectToQuery as h } from \"../../../core/urlUtils.js\";\nimport { property as p } from \"../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../core/arrayUtils.js\";\nimport \"../../../core/has.js\";\nimport \"../../../core/accessorSupport/ensureType.js\";\nimport { subclass as m } from \"../../../core/accessorSupport/decorators/subclass.js\";\nimport c from \"../../../geometry/Extent.js\";\nimport { load as d, project as y } from \"../../../geometry/projection.js\";\nimport w from \"../../../geometry/SpatialReference.js\";\nimport { canProject as u, project as g } from \"../../../geometry/support/webMercatorUtils.js\";\nimport { getGraphics as _, fetchService as V, parseKML as b } from \"../../../layers/support/kmlUtils.js\";\nimport { parseUrl as f } from \"../../../rest/utils.js\";\nimport { GraphicsCollection as v } from \"../../../support/GraphicsCollection.js\";\nimport { Bitmap as S } from \"../engine/Bitmap.js\";\nimport { BitmapContainer as I } from \"../engine/BitmapContainer.js\";\nimport { LayerView2DMixin as C } from \"./LayerView2D.js\";\nimport x from \"./graphics/GraphicContainer.js\";\nimport k from \"./graphics/GraphicsView2D.js\";\nimport j from \"../../layers/LayerView.js\";\n\nclass P {\n  constructor() {\n    this.allSublayers = new Map(), this.allPoints = [], this.allPolylines = [], this.allPolygons = [], this.allMapImages = [];\n  }\n\n}\n\nlet M = class extends C(j) {\n  constructor() {\n    super(...arguments), this._handles = new a(), this._bitmapIndex = new Map(), this._mapImageContainer = new I(), this._kmlVisualData = new P(), this.allVisiblePoints = new v(), this.allVisiblePolylines = new v(), this.allVisiblePolygons = new v(), this.allVisibleMapImages = new s();\n  }\n\n  async hitTest(e, i) {\n    var t, s, a;\n    return (await Promise.all([null == (t = this._pointsView) ? void 0 : t.hitTest(e), null == (s = this._polylinesView) ? void 0 : s.hitTest(e), null == (a = this._polygonsView) ? void 0 : a.hitTest(e)])).flat().filter(e => !!e && (e.layer = this.layer, e.sourceLayer = this.layer, !0));\n  }\n\n  update(e) {\n    this._polygonsView && this._polygonsView.processUpdate(e), this._polylinesView && this._polylinesView.processUpdate(e), this._pointsView && this._pointsView.processUpdate(e);\n  }\n\n  attach() {\n    this._fetchController = new AbortController(), this.container.addChild(this._mapImageContainer), this._polygonsView = new k({\n      view: this.view,\n      graphics: this.allVisiblePolygons,\n      requestUpdateCallback: () => this.requestUpdate(),\n      container: new x(this.view.featuresTilingScheme)\n    }), this.container.addChild(this._polygonsView.container), this._polylinesView = new k({\n      view: this.view,\n      graphics: this.allVisiblePolylines,\n      requestUpdateCallback: () => this.requestUpdate(),\n      container: new x(this.view.featuresTilingScheme)\n    }), this.container.addChild(this._polylinesView.container), this._pointsView = new k({\n      view: this.view,\n      graphics: this.allVisiblePoints,\n      requestUpdateCallback: () => this.requestUpdate(),\n      container: new x(this.view.featuresTilingScheme)\n    }), this.container.addChild(this._pointsView.container), this.handles.add([this.allVisibleMapImages.on(\"change\", e => {\n      e.added.forEach(e => this._addMapImage(e)), e.removed.forEach(e => this._removeMapImage(e));\n    }), r(() => this.layer.visibleSublayers, e => {\n      for (const [i, t] of this._kmlVisualData.allSublayers) t.visibility = 0;\n\n      for (const i of e) {\n        const e = this._kmlVisualData.allSublayers.get(i.id);\n\n        e && (e.visibility = 1);\n      }\n\n      this._refreshCollections();\n    })]), this.updatingHandles.addPromise(this._fetchService(this._fetchController.signal));\n  }\n\n  detach() {\n    this._fetchController.abort(), this._fetchController = null, this._handles.removeAll(), this._mapImageContainer.removeAllChildren(), this.container.removeAllChildren(), this._bitmapIndex.clear(), this._polygonsView && (this._polygonsView.destroy(), this._polygonsView = null), this._polylinesView && (this._polylinesView.destroy(), this._polylinesView = null), this._pointsView && (this._pointsView.destroy(), this._pointsView = null);\n  }\n\n  moveStart() {}\n\n  viewChange() {\n    this._polygonsView.viewChange(), this._polylinesView.viewChange(), this._pointsView.viewChange();\n  }\n\n  moveEnd() {}\n\n  isUpdating() {\n    return this._pointsView.updating || this._polygonsView.updating || this._polylinesView.updating;\n  }\n\n  _addMapImage(e) {\n    (this.view.spatialReference.isWGS84 || this.view.spatialReference.isWebMercator) && t(e.href, {\n      responseType: \"image\"\n    }).then(_ref => {\n      let {\n        data: i\n      } = _ref;\n      let t = c.fromJSON(e.extent);\n      u(t, this.view.spatialReference) && (t = g(t, this.view.spatialReference));\n      const s = new S(i, \"standard\");\n      s.x = t.xmin, s.y = t.ymax, s.resolution = t.width / i.naturalWidth, s.rotation = e.rotation, this._mapImageContainer.addChild(s), this._bitmapIndex.set(e, s);\n    });\n  }\n\n  async _getViewDependentUrl(e, t) {\n    const {\n      viewFormat: s,\n      viewBoundScale: a,\n      httpQuery: r\n    } = e;\n\n    if (o(s)) {\n      if (l(t)) throw new Error(\"Loading this network link requires a view state.\");\n      let p;\n\n      if (await d(), o(a) && 1 !== a) {\n        const e = new c(t.extent);\n        e.expand(a), p = e;\n      } else p = t.extent;\n\n      p = y(p, w.WGS84);\n\n      const m = y(p, w.WebMercator),\n            u = p.xmin,\n            g = p.xmax,\n            _ = p.ymin,\n            V = p.ymax,\n            b = t.size[0] * t.pixelRatio,\n            v = t.size[1] * t.pixelRatio,\n            S = Math.max(m.width, m.height),\n            I = {\n        \"[bboxWest]\": u.toString(),\n        \"[bboxEast]\": g.toString(),\n        \"[bboxSouth]\": _.toString(),\n        \"[bboxNorth]\": V.toString(),\n        \"[lookatLon]\": p.center.x.toString(),\n        \"[lookatLat]\": p.center.y.toString(),\n        \"[lookatRange]\": S.toString(),\n        \"[lookatTilt]\": \"0\",\n        \"[lookatHeading]\": t.rotation.toString(),\n        \"[lookatTerrainLon]\": p.center.x.toString(),\n        \"[lookatTerrainLat]\": p.center.y.toString(),\n        \"[lookatTerrainAlt]\": \"0\",\n        \"[cameraLon]\": p.center.x.toString(),\n        \"[cameraLat]\": p.center.y.toString(),\n        \"[cameraAlt]\": S.toString(),\n        \"[horizFov]\": \"60\",\n        \"[vertFov]\": \"60\",\n        \"[horizPixels]\": b.toString(),\n        \"[vertPixels]\": v.toString(),\n        \"[terrainEnabled]\": \"0\",\n        \"[clientVersion]\": i,\n        \"[kmlVersion]\": \"2.2\",\n        \"[clientName]\": \"ArcGIS API for JavaScript\",\n        \"[language]\": \"en-US\"\n      },\n            C = e => {\n        for (const i in e) for (const t in I) e[i] = e[i].replace(t, I[t]);\n      },\n            x = n(s);\n\n      C(x);\n      let k = {};\n      o(r) && (k = n(r), C(k));\n      const j = f(e.href);\n      j.query = { ...j.query,\n        ...x,\n        ...k\n      };\n      return `${j.path}?${h(x)}`;\n    }\n\n    return e.href;\n  }\n\n  async _fetchService(e) {\n    const i = new P();\n    await this._loadVisualData(this.layer.url, i, e), this._kmlVisualData = i, this._refreshCollections();\n  }\n\n  _refreshCollections() {\n    this.allVisiblePoints.removeAll(), this.allVisiblePolylines.removeAll(), this.allVisiblePolygons.removeAll(), this.allVisibleMapImages.removeAll(), this.allVisiblePoints.addMany(this._kmlVisualData.allPoints.filter(e => this._isSublayerVisible(e.sublayerId)).map(_ref2 => {\n      let {\n        item: e\n      } = _ref2;\n      return e;\n    })), this.allVisiblePolylines.addMany(this._kmlVisualData.allPolylines.filter(e => this._isSublayerVisible(e.sublayerId)).map(_ref3 => {\n      let {\n        item: e\n      } = _ref3;\n      return e;\n    })), this.allVisiblePolygons.addMany(this._kmlVisualData.allPolygons.filter(e => this._isSublayerVisible(e.sublayerId)).map(_ref4 => {\n      let {\n        item: e\n      } = _ref4;\n      return e;\n    })), this.allVisibleMapImages.addMany(this._kmlVisualData.allMapImages.filter(e => this._isSublayerVisible(e.sublayerId)).map(_ref5 => {\n      let {\n        item: e\n      } = _ref5;\n      return e;\n    }));\n  }\n\n  _isSublayerVisible(e) {\n    const i = this._kmlVisualData.allSublayers.get(e);\n\n    return !!i.visibility && (-1 === i.parentFolderId || this._isSublayerVisible(i.parentFolderId));\n  }\n\n  _loadVisualData(e, i, t) {\n    return this._fetchParsedKML(e, t).then(async e => {\n      for (const s of e.sublayers) {\n        i.allSublayers.set(s.id, s);\n        const e = s.points ? await _(s.points) : [],\n              a = s.polylines ? await _(s.polylines) : [],\n              o = s.polygons ? await _(s.polygons) : [],\n              l = s.mapImages || [];\n\n        if (i.allPoints.push(...e.map(e => ({\n          item: e,\n          sublayerId: s.id\n        }))), i.allPolylines.push(...a.map(e => ({\n          item: e,\n          sublayerId: s.id\n        }))), i.allPolygons.push(...o.map(e => ({\n          item: e,\n          sublayerId: s.id\n        }))), i.allMapImages.push(...l.map(e => ({\n          item: e,\n          sublayerId: s.id\n        }))), s.networkLink) {\n          const e = await this._getViewDependentUrl(s.networkLink, this.view.state);\n          await this._loadVisualData(e, i, t);\n        }\n      }\n    });\n  }\n\n  _fetchParsedKML(e, i) {\n    return V(e, this.view.spatialReference, this.layer.refreshInterval, i).then(e => b(e.data));\n  }\n\n  _removeMapImage(e) {\n    const i = this._bitmapIndex.get(e);\n\n    i && (this._mapImageContainer.removeChild(i), this._bitmapIndex.delete(e));\n  }\n\n};\ne([p()], M.prototype, \"_pointsView\", void 0), e([p()], M.prototype, \"_polylinesView\", void 0), e([p()], M.prototype, \"_polygonsView\", void 0), e([p()], M.prototype, \"updating\", void 0), M = e([m(\"esri.views.2d.layers.KMLLayerView2D\")], M);\nconst U = M;\nexport { U as default };","map":{"version":3,"sources":["D:/Github/CUSP_DataBase/CUSP_DB/src/main/gis/node_modules/@arcgis/core/views/2d/layers/KMLLayerView2D.js"],"names":["_","e","version","i","t","s","a","isSome","o","isNone","l","watch","r","queryToObject","n","objectToQuery","h","property","p","subclass","m","c","load","d","project","y","w","canProject","u","g","getGraphics","fetchService","V","parseKML","b","parseUrl","f","GraphicsCollection","v","Bitmap","S","BitmapContainer","I","LayerView2DMixin","C","x","k","j","P","constructor","allSublayers","Map","allPoints","allPolylines","allPolygons","allMapImages","M","arguments","_handles","_bitmapIndex","_mapImageContainer","_kmlVisualData","allVisiblePoints","allVisiblePolylines","allVisiblePolygons","allVisibleMapImages","hitTest","Promise","all","_pointsView","_polylinesView","_polygonsView","flat","filter","layer","sourceLayer","update","processUpdate","attach","_fetchController","AbortController","container","addChild","view","graphics","requestUpdateCallback","requestUpdate","featuresTilingScheme","handles","add","on","added","forEach","_addMapImage","removed","_removeMapImage","visibleSublayers","visibility","get","id","_refreshCollections","updatingHandles","addPromise","_fetchService","signal","detach","abort","removeAll","removeAllChildren","clear","destroy","moveStart","viewChange","moveEnd","isUpdating","updating","spatialReference","isWGS84","isWebMercator","href","responseType","then","data","fromJSON","extent","xmin","ymax","resolution","width","naturalWidth","rotation","set","_getViewDependentUrl","viewFormat","viewBoundScale","httpQuery","Error","expand","WGS84","WebMercator","xmax","ymin","size","pixelRatio","Math","max","height","toString","center","replace","query","path","_loadVisualData","url","addMany","_isSublayerVisible","sublayerId","map","item","parentFolderId","_fetchParsedKML","sublayers","points","polylines","polygons","mapImages","push","networkLink","state","refreshInterval","removeChild","delete","prototype","U","default"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../chunks/tslib.es6.js\";import{version as i}from\"../../../kernel.js\";import t from\"../../../request.js\";import s from\"../../../core/Collection.js\";import a from\"../../../core/Handles.js\";import{isSome as o,isNone as l}from\"../../../core/maybe.js\";import{watch as r}from\"../../../core/reactiveUtils.js\";import{queryToObject as n,objectToQuery as h}from\"../../../core/urlUtils.js\";import{property as p}from\"../../../core/accessorSupport/decorators/property.js\";import\"../../../core/arrayUtils.js\";import\"../../../core/has.js\";import\"../../../core/accessorSupport/ensureType.js\";import{subclass as m}from\"../../../core/accessorSupport/decorators/subclass.js\";import c from\"../../../geometry/Extent.js\";import{load as d,project as y}from\"../../../geometry/projection.js\";import w from\"../../../geometry/SpatialReference.js\";import{canProject as u,project as g}from\"../../../geometry/support/webMercatorUtils.js\";import{getGraphics as _,fetchService as V,parseKML as b}from\"../../../layers/support/kmlUtils.js\";import{parseUrl as f}from\"../../../rest/utils.js\";import{GraphicsCollection as v}from\"../../../support/GraphicsCollection.js\";import{Bitmap as S}from\"../engine/Bitmap.js\";import{BitmapContainer as I}from\"../engine/BitmapContainer.js\";import{LayerView2DMixin as C}from\"./LayerView2D.js\";import x from\"./graphics/GraphicContainer.js\";import k from\"./graphics/GraphicsView2D.js\";import j from\"../../layers/LayerView.js\";class P{constructor(){this.allSublayers=new Map,this.allPoints=[],this.allPolylines=[],this.allPolygons=[],this.allMapImages=[]}}let M=class extends(C(j)){constructor(){super(...arguments),this._handles=new a,this._bitmapIndex=new Map,this._mapImageContainer=new I,this._kmlVisualData=new P,this.allVisiblePoints=new v,this.allVisiblePolylines=new v,this.allVisiblePolygons=new v,this.allVisibleMapImages=new s}async hitTest(e,i){var t,s,a;return(await Promise.all([null==(t=this._pointsView)?void 0:t.hitTest(e),null==(s=this._polylinesView)?void 0:s.hitTest(e),null==(a=this._polygonsView)?void 0:a.hitTest(e)])).flat().filter((e=>!!e&&(e.layer=this.layer,e.sourceLayer=this.layer,!0)))}update(e){this._polygonsView&&this._polygonsView.processUpdate(e),this._polylinesView&&this._polylinesView.processUpdate(e),this._pointsView&&this._pointsView.processUpdate(e)}attach(){this._fetchController=new AbortController,this.container.addChild(this._mapImageContainer),this._polygonsView=new k({view:this.view,graphics:this.allVisiblePolygons,requestUpdateCallback:()=>this.requestUpdate(),container:new x(this.view.featuresTilingScheme)}),this.container.addChild(this._polygonsView.container),this._polylinesView=new k({view:this.view,graphics:this.allVisiblePolylines,requestUpdateCallback:()=>this.requestUpdate(),container:new x(this.view.featuresTilingScheme)}),this.container.addChild(this._polylinesView.container),this._pointsView=new k({view:this.view,graphics:this.allVisiblePoints,requestUpdateCallback:()=>this.requestUpdate(),container:new x(this.view.featuresTilingScheme)}),this.container.addChild(this._pointsView.container),this.handles.add([this.allVisibleMapImages.on(\"change\",(e=>{e.added.forEach((e=>this._addMapImage(e))),e.removed.forEach((e=>this._removeMapImage(e)))})),r((()=>this.layer.visibleSublayers),(e=>{for(const[i,t]of this._kmlVisualData.allSublayers)t.visibility=0;for(const i of e){const e=this._kmlVisualData.allSublayers.get(i.id);e&&(e.visibility=1)}this._refreshCollections()}))]),this.updatingHandles.addPromise(this._fetchService(this._fetchController.signal))}detach(){this._fetchController.abort(),this._fetchController=null,this._handles.removeAll(),this._mapImageContainer.removeAllChildren(),this.container.removeAllChildren(),this._bitmapIndex.clear(),this._polygonsView&&(this._polygonsView.destroy(),this._polygonsView=null),this._polylinesView&&(this._polylinesView.destroy(),this._polylinesView=null),this._pointsView&&(this._pointsView.destroy(),this._pointsView=null)}moveStart(){}viewChange(){this._polygonsView.viewChange(),this._polylinesView.viewChange(),this._pointsView.viewChange()}moveEnd(){}isUpdating(){return this._pointsView.updating||this._polygonsView.updating||this._polylinesView.updating}_addMapImage(e){(this.view.spatialReference.isWGS84||this.view.spatialReference.isWebMercator)&&t(e.href,{responseType:\"image\"}).then((({data:i})=>{let t=c.fromJSON(e.extent);u(t,this.view.spatialReference)&&(t=g(t,this.view.spatialReference));const s=new S(i,\"standard\");s.x=t.xmin,s.y=t.ymax,s.resolution=t.width/i.naturalWidth,s.rotation=e.rotation,this._mapImageContainer.addChild(s),this._bitmapIndex.set(e,s)}))}async _getViewDependentUrl(e,t){const{viewFormat:s,viewBoundScale:a,httpQuery:r}=e;if(o(s)){if(l(t))throw new Error(\"Loading this network link requires a view state.\");let p;if(await d(),o(a)&&1!==a){const e=new c(t.extent);e.expand(a),p=e}else p=t.extent;p=y(p,w.WGS84);const m=y(p,w.WebMercator),u=p.xmin,g=p.xmax,_=p.ymin,V=p.ymax,b=t.size[0]*t.pixelRatio,v=t.size[1]*t.pixelRatio,S=Math.max(m.width,m.height),I={\"[bboxWest]\":u.toString(),\"[bboxEast]\":g.toString(),\"[bboxSouth]\":_.toString(),\"[bboxNorth]\":V.toString(),\"[lookatLon]\":p.center.x.toString(),\"[lookatLat]\":p.center.y.toString(),\"[lookatRange]\":S.toString(),\"[lookatTilt]\":\"0\",\"[lookatHeading]\":t.rotation.toString(),\"[lookatTerrainLon]\":p.center.x.toString(),\"[lookatTerrainLat]\":p.center.y.toString(),\"[lookatTerrainAlt]\":\"0\",\"[cameraLon]\":p.center.x.toString(),\"[cameraLat]\":p.center.y.toString(),\"[cameraAlt]\":S.toString(),\"[horizFov]\":\"60\",\"[vertFov]\":\"60\",\"[horizPixels]\":b.toString(),\"[vertPixels]\":v.toString(),\"[terrainEnabled]\":\"0\",\"[clientVersion]\":i,\"[kmlVersion]\":\"2.2\",\"[clientName]\":\"ArcGIS API for JavaScript\",\"[language]\":\"en-US\"},C=e=>{for(const i in e)for(const t in I)e[i]=e[i].replace(t,I[t])},x=n(s);C(x);let k={};o(r)&&(k=n(r),C(k));const j=f(e.href);j.query={...j.query,...x,...k};return`${j.path}?${h(x)}`}return e.href}async _fetchService(e){const i=new P;await this._loadVisualData(this.layer.url,i,e),this._kmlVisualData=i,this._refreshCollections()}_refreshCollections(){this.allVisiblePoints.removeAll(),this.allVisiblePolylines.removeAll(),this.allVisiblePolygons.removeAll(),this.allVisibleMapImages.removeAll(),this.allVisiblePoints.addMany(this._kmlVisualData.allPoints.filter((e=>this._isSublayerVisible(e.sublayerId))).map((({item:e})=>e))),this.allVisiblePolylines.addMany(this._kmlVisualData.allPolylines.filter((e=>this._isSublayerVisible(e.sublayerId))).map((({item:e})=>e))),this.allVisiblePolygons.addMany(this._kmlVisualData.allPolygons.filter((e=>this._isSublayerVisible(e.sublayerId))).map((({item:e})=>e))),this.allVisibleMapImages.addMany(this._kmlVisualData.allMapImages.filter((e=>this._isSublayerVisible(e.sublayerId))).map((({item:e})=>e)))}_isSublayerVisible(e){const i=this._kmlVisualData.allSublayers.get(e);return!!i.visibility&&(-1===i.parentFolderId||this._isSublayerVisible(i.parentFolderId))}_loadVisualData(e,i,t){return this._fetchParsedKML(e,t).then((async e=>{for(const s of e.sublayers){i.allSublayers.set(s.id,s);const e=s.points?await _(s.points):[],a=s.polylines?await _(s.polylines):[],o=s.polygons?await _(s.polygons):[],l=s.mapImages||[];if(i.allPoints.push(...e.map((e=>({item:e,sublayerId:s.id})))),i.allPolylines.push(...a.map((e=>({item:e,sublayerId:s.id})))),i.allPolygons.push(...o.map((e=>({item:e,sublayerId:s.id})))),i.allMapImages.push(...l.map((e=>({item:e,sublayerId:s.id})))),s.networkLink){const e=await this._getViewDependentUrl(s.networkLink,this.view.state);await this._loadVisualData(e,i,t)}}}))}_fetchParsedKML(e,i){return V(e,this.view.spatialReference,this.layer.refreshInterval,i).then((e=>b(e.data)))}_removeMapImage(e){const i=this._bitmapIndex.get(e);i&&(this._mapImageContainer.removeChild(i),this._bitmapIndex.delete(e))}};e([p()],M.prototype,\"_pointsView\",void 0),e([p()],M.prototype,\"_polylinesView\",void 0),e([p()],M.prototype,\"_polygonsView\",void 0),e([p()],M.prototype,\"updating\",void 0),M=e([m(\"esri.views.2d.layers.KMLLayerView2D\")],M);const U=M;export{U as default};\n"]},"metadata":{},"sourceType":"module"}