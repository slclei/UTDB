{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../../../chunks/tslib.es6.js\";\nimport t from \"../../../../../core/Accessor.js\";\nimport { ByteSizeUnit as s, estimateAttributesObjectSize as i, estimateFixedArraySize as r } from \"../../../../../core/byteSizeEstimations.js\";\nimport { isNone as o, isSome as n } from \"../../../../../core/maybe.js\";\nimport { property as l } from \"../../../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../../../core/arrayUtils.js\";\nimport \"../../../../../core/has.js\";\nimport \"../../../../../core/accessorSupport/ensureType.js\";\nimport { subclass as a } from \"../../../../../core/accessorSupport/decorators/subclass.js\";\nimport { create as c, intersects as h, fromExtent as u, area as d } from \"../../../../../geometry/support/aaBoundingRect.js\";\nimport { getBoundsOptimizedGeometry as f } from \"../../../../../layers/graphics/featureConversionUtils.js\";\nimport { BoundsStore as p } from \"../../../../../layers/graphics/data/BoundsStore.js\";\nimport m from \"../../../../../layers/support/TileInfo.js\";\nimport { executeQueryForCount as g } from \"../../../../../rest/query/operations/query.js\";\nimport { FeatureServiceTileCache as _ } from \"./FeatureServiceTileCache.js\";\nlet v = class extends t {\n  constructor(e) {\n    super(e), this.tileInfo = null, this.extent = null, this.maximumByteSize = 10 * s.MEGABYTES, this.tileBounds = new p(), this.tiles = new _(), this.refCounts = new Map(), this.tileFeatureCounts = new Map(), this.tmpBoundingRect = c();\n  }\n\n  add(e, t) {\n    const s = [];\n\n    for (const i of t) this._referenceFeature(i.objectId) === w.ADDED && s.push(i);\n\n    this._addTileStorage(e, new Set(t.map(_ref => {\n      let {\n        objectId: e\n      } = _ref;\n      return e;\n    })), y(t)), this.featureStore.addMany(s), this.tiles.applyByteSizeLimit(this.maximumByteSize, e => this._removeTileStorage(e));\n  }\n\n  destroy() {\n    this.clear(), this.tileFeatureCounts.clear();\n  }\n\n  clear() {\n    this.featureStore.clear(), this.tileBounds.clear(), this.tiles.clear(), this.refCounts.clear();\n  }\n\n  refresh() {\n    this.clear(), this.tileFeatureCounts.clear();\n  }\n\n  processEdits(e, t, s) {\n    return this._processEditsDelete(e.deletedFeatures.concat(e.updatedFeatures)), this._processEditsRefetch(e.addedFeatures.concat(e.updatedFeatures), t, s);\n  }\n\n  _addTileStorage(e, t, s) {\n    this.tiles.set(e.id, new S(e, t, s)), this.tileBounds.set(e.id, e.extent), this.tileFeatureCounts.set(e.id, t.size);\n  }\n\n  _remove(_ref2) {\n    let {\n      id: e\n    } = _ref2;\n    const t = this.tiles.get(e);\n    t && this._removeTileStorage(t);\n  }\n\n  _removeTileStorage(e) {\n    const t = [];\n\n    for (const i of e.objectIds) this._unreferenceFeature(i) === w.REMOVED && t.push(i);\n\n    this.featureStore.removeManyById(t);\n    const s = e.data.id;\n    this.tiles.delete(s), this.tileBounds.delete(s);\n  }\n\n  _processEditsDelete(e) {\n    this.featureStore.removeManyById(e);\n\n    for (const [, t] of this.tiles) {\n      for (const s of e) t.objectIds.delete(s);\n\n      this.tileFeatureCounts.set(t.data.id, t.objectIds.size);\n    }\n\n    for (const t of e) this.refCounts.delete(t);\n  }\n\n  async _processEditsRefetch(e, t, s) {\n    const i = (await t(e, s)).features,\n          {\n      hasZ: r,\n      hasM: n\n    } = this.featureStore;\n\n    for (const l of i) {\n      const e = f(this.tmpBoundingRect, l.geometry, r, n);\n      o(e) || this.tileBounds.forEachInBounds(e, e => {\n        const t = this.tiles.get(e);\n        this.featureStore.add(l), t.objectIds.has(l.objectId) || (t.objectIds.add(l.objectId), this._referenceFeature(l.objectId), this.tileFeatureCounts.set(t.data.id, t.objectIds.size));\n      });\n    }\n  }\n\n  process(e) {\n    let t = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : () => !0;\n    if (o(this.tileInfo) || !e.extent || n(this.extent) && !h(u(this.extent, this.tmpBoundingRect), e.extent)) return new I(e);\n    if (this.tiles.has(e.id)) return new I(e);\n\n    const s = this._createTileTree(e, this.tileInfo);\n\n    return this._simplify(s, t, null, 0, 1), this._collectMissingTiles(e, s, this.tileInfo);\n  }\n\n  get debugInfo() {\n    return Array.from(this.tiles.values()).map(_ref3 => {\n      let {\n        data: e\n      } = _ref3;\n      return {\n        data: e,\n        featureCount: this.tileFeatureCounts.get(e.id) || 0\n      };\n    });\n  }\n\n  getFeatureCount(e) {\n    const t = this.tileFeatureCounts.get(e.id);\n    return null != t ? t : 0;\n  }\n\n  async fetchCount(e, t, s, i) {\n    const r = this.tileFeatureCounts.get(e.id);\n    if (null != r) return r;\n    const o = await g(t, s, i);\n    return this.tileFeatureCounts.set(e.id, o.data.count), o.data.count;\n  }\n\n  _createTileTree(e, t) {\n    const s = new T(e.level, e.row, e.col);\n    return t.updateTileInfo(s, m.ExtrapolateOptions.POWER_OF_TWO), this.tileBounds.forEachInBounds(e.extent, i => {\n      const r = this.tiles.get(i).data;\n      this._tilesAreRelated(e, r) && this._populateChildren(s, r, t, this.tileFeatureCounts.get(r.id) || 0);\n    }), s;\n  }\n\n  _tilesAreRelated(e, t) {\n    if (!e || !t) return !1;\n    if (e.level === t.level) return e.row === t.row && e.col === t.col;\n    const s = e.level < t.level,\n          i = s ? e : t,\n          r = s ? t : e,\n          o = 1 << r.level - i.level;\n    return Math.floor(r.row / o) === i.row && Math.floor(r.col / o) === i.col;\n  }\n\n  _populateChildren(e, t, s, i) {\n    const r = t.level - e.level - 1;\n    if (r < 0) return void (e.isLeaf = !0);\n    const o = t.row >> r,\n          l = t.col >> r,\n          a = e.row << 1,\n          c = l - (e.col << 1) + (o - a << 1),\n          h = e.children[c];\n    if (n(h)) this._populateChildren(h, t, s, i);else {\n      const r = new T(e.level + 1, o, l);\n      s.updateTileInfo(r, m.ExtrapolateOptions.POWER_OF_TWO), e.children[c] = r, this._populateChildren(r, t, s, i);\n    }\n  }\n\n  _simplify(e, t, s, i, r) {\n    const o = r * r;\n    if (e.isLeaf) return t(this.getFeatureCount(e), r) ? 0 : (this._remove(e), n(s) && (s.children[i] = null), o);\n    const l = r / 2,\n          a = l * l;\n    let c = 0;\n\n    for (let h = 0; h < e.children.length; h++) {\n      const s = e.children[h];\n      c += n(s) ? this._simplify(s, t, e, h, l) : a;\n    }\n\n    return 0 === c ? this._mergeChildren(e) : 1 - c / o < F && (this._purge(e), n(s) && (s.children[i] = null), c = o), c;\n  }\n\n  _mergeChildren(e) {\n    const t = new Set();\n    let s = 0;\n    this._forEachLeaf(e, e => {\n      const i = this.tiles.get(e.id);\n\n      if (i) {\n        s += i.byteSize;\n\n        for (const e of i.objectIds) t.has(e) || (t.add(e), this._referenceFeature(e));\n\n        this._remove(e);\n      }\n    }), this._addTileStorage(e, t, s), e.isLeaf = !0, e.children[0] = e.children[1] = e.children[2] = e.children[3] = null, this.tileFeatureCounts.set(e.id, t.size);\n  }\n\n  _forEachLeaf(e, t) {\n    for (const s of e.children) o(s) || (s.isLeaf ? t(s) : this._forEachLeaf(s, t));\n  }\n\n  _purge(e) {\n    if (!o(e)) if (e.isLeaf) this._remove(e);else for (let t = 0; t < e.children.length; t++) {\n      const s = e.children[t];\n      this._purge(s), e.children[t] = null;\n    }\n  }\n\n  _collectMissingTiles(e, t, s) {\n    const i = new j(s, e, this.extent);\n    return this._collectMissingTilesRecurse(t, i, 1), i.info;\n  }\n\n  _collectMissingTilesRecurse(e, t, s) {\n    if (e.isLeaf) return;\n    if (!e.hasChildren) return void t.addMissing(e.level, e.row, e.col, s);\n    const i = s / 2;\n\n    for (let r = 0; r < e.children.length; r++) {\n      const s = e.children[r];\n      o(s) ? t.addMissing(e.level + 1, (e.row << 1) + ((2 & r) >> 1), (e.col << 1) + (1 & r), i) : this._collectMissingTilesRecurse(s, t, i);\n    }\n  }\n\n  _referenceFeature(e) {\n    const t = (this.refCounts.get(e) || 0) + 1;\n    return this.refCounts.set(e, t), 1 === t ? w.ADDED : w.UNCHANGED;\n  }\n\n  _unreferenceFeature(e) {\n    const t = (this.refCounts.get(e) || 0) - 1;\n    return 0 === t ? (this.refCounts.delete(e), w.REMOVED) : (t > 0 && this.refCounts.set(e, t), w.UNCHANGED);\n  }\n\n  get test() {\n    return {\n      tiles: Array.from(this.tiles.values()).map(e => `${e.data.id}:[${Array.from(e.objectIds)}]`),\n      featureReferences: Array.from(this.refCounts.keys()).map(e => `${e}:${this.refCounts.get(e)}`)\n    };\n  }\n\n};\n\nfunction y(e) {\n  return e.reduce((e, t) => e + C(t), 0);\n}\n\nfunction C(e) {\n  return 32 + E(e.geometry) + i(e.attributes);\n}\n\nfunction E(e) {\n  if (o(e)) return 0;\n  const t = r(e.lengths, 4);\n  return 32 + r(e.coords, 8) + t;\n}\n\ne([l({\n  constructOnly: !0\n})], v.prototype, \"featureStore\", void 0), e([l()], v.prototype, \"tileInfo\", void 0), e([l()], v.prototype, \"extent\", void 0), e([l()], v.prototype, \"maximumByteSize\", void 0), v = e([a(\"esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTileStore\")], v);\n\nclass S {\n  constructor(e, t, s) {\n    this.data = e, this.objectIds = t, this.byteSize = s;\n  }\n\n}\n\nclass T {\n  constructor(e, t, s) {\n    this.level = e, this.row = t, this.col = s, this.isLeaf = !1, this.extent = null, this.children = [null, null, null, null];\n  }\n\n  get hasChildren() {\n    return !this.isLeaf && (n(this.children[0]) || n(this.children[1]) || n(this.children[2]) || n(this.children[3]));\n  }\n\n}\n\nclass I {\n  constructor(e) {\n    let t = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];\n    this.missingTiles = t, this.fullArea = 0, this.coveredArea = 0, this.fullArea = d(e.extent), this.coveredArea = this.fullArea;\n  }\n\n  prepend(e) {\n    this.missingTiles = e.missingTiles.concat(this.missingTiles), this.coveredArea += e.coveredArea, this.fullArea += e.fullArea;\n  }\n\n}\n\nclass j {\n  constructor(e, t, s) {\n    this.tileInfo = e, this.extent = null, this.info = new I(t), n(s) && (this.extent = u(s));\n  }\n\n  addMissing(e, t, s, i) {\n    const r = {\n      id: null,\n      level: e,\n      row: t,\n      col: s\n    };\n    this.tileInfo.updateTileInfo(r, m.ExtrapolateOptions.POWER_OF_TWO), !n(r.extent) || n(this.extent) && !h(this.extent, r.extent) || (this.info.missingTiles.push({\n      data: r,\n      resolution: i\n    }), this.info.coveredArea -= d(r.extent));\n  }\n\n}\n\nconst F = .18751;\nvar w;\n!function (e) {\n  e[e.ADDED = 0] = \"ADDED\", e[e.REMOVED = 1] = \"REMOVED\", e[e.UNCHANGED = 2] = \"UNCHANGED\";\n}(w || (w = {}));\nexport { v as FeatureServiceTileStore, I as ProcessResult };","map":{"version":3,"sources":["D:/Github/CUSP_DataBase/CUSP_DB/src/main/gis/node_modules/@arcgis/core/views/interactive/snapping/featureSources/featureServiceSource/FeatureServiceTileStore.js"],"names":["_","e","t","ByteSizeUnit","s","estimateAttributesObjectSize","i","estimateFixedArraySize","r","isNone","o","isSome","n","property","l","subclass","a","create","c","intersects","h","fromExtent","u","area","d","getBoundsOptimizedGeometry","f","BoundsStore","p","m","executeQueryForCount","g","FeatureServiceTileCache","v","constructor","tileInfo","extent","maximumByteSize","MEGABYTES","tileBounds","tiles","refCounts","Map","tileFeatureCounts","tmpBoundingRect","add","_referenceFeature","objectId","w","ADDED","push","_addTileStorage","Set","map","y","featureStore","addMany","applyByteSizeLimit","_removeTileStorage","destroy","clear","refresh","processEdits","_processEditsDelete","deletedFeatures","concat","updatedFeatures","_processEditsRefetch","addedFeatures","set","id","S","size","_remove","get","objectIds","_unreferenceFeature","REMOVED","removeManyById","data","delete","features","hasZ","hasM","geometry","forEachInBounds","has","process","I","_createTileTree","_simplify","_collectMissingTiles","debugInfo","Array","from","values","featureCount","getFeatureCount","fetchCount","count","T","level","row","col","updateTileInfo","ExtrapolateOptions","POWER_OF_TWO","_tilesAreRelated","_populateChildren","Math","floor","isLeaf","children","length","_mergeChildren","F","_purge","_forEachLeaf","byteSize","j","_collectMissingTilesRecurse","info","hasChildren","addMissing","UNCHANGED","test","featureReferences","keys","reduce","C","E","attributes","lengths","coords","constructOnly","prototype","missingTiles","fullArea","coveredArea","prepend","resolution","FeatureServiceTileStore","ProcessResult"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../../../chunks/tslib.es6.js\";import t from\"../../../../../core/Accessor.js\";import{ByteSizeUnit as s,estimateAttributesObjectSize as i,estimateFixedArraySize as r}from\"../../../../../core/byteSizeEstimations.js\";import{isNone as o,isSome as n}from\"../../../../../core/maybe.js\";import{property as l}from\"../../../../../core/accessorSupport/decorators/property.js\";import\"../../../../../core/arrayUtils.js\";import\"../../../../../core/has.js\";import\"../../../../../core/accessorSupport/ensureType.js\";import{subclass as a}from\"../../../../../core/accessorSupport/decorators/subclass.js\";import{create as c,intersects as h,fromExtent as u,area as d}from\"../../../../../geometry/support/aaBoundingRect.js\";import{getBoundsOptimizedGeometry as f}from\"../../../../../layers/graphics/featureConversionUtils.js\";import{BoundsStore as p}from\"../../../../../layers/graphics/data/BoundsStore.js\";import m from\"../../../../../layers/support/TileInfo.js\";import{executeQueryForCount as g}from\"../../../../../rest/query/operations/query.js\";import{FeatureServiceTileCache as _}from\"./FeatureServiceTileCache.js\";let v=class extends t{constructor(e){super(e),this.tileInfo=null,this.extent=null,this.maximumByteSize=10*s.MEGABYTES,this.tileBounds=new p,this.tiles=new _,this.refCounts=new Map,this.tileFeatureCounts=new Map,this.tmpBoundingRect=c()}add(e,t){const s=[];for(const i of t)this._referenceFeature(i.objectId)===w.ADDED&&s.push(i);this._addTileStorage(e,new Set(t.map((({objectId:e})=>e))),y(t)),this.featureStore.addMany(s),this.tiles.applyByteSizeLimit(this.maximumByteSize,(e=>this._removeTileStorage(e)))}destroy(){this.clear(),this.tileFeatureCounts.clear()}clear(){this.featureStore.clear(),this.tileBounds.clear(),this.tiles.clear(),this.refCounts.clear()}refresh(){this.clear(),this.tileFeatureCounts.clear()}processEdits(e,t,s){return this._processEditsDelete(e.deletedFeatures.concat(e.updatedFeatures)),this._processEditsRefetch(e.addedFeatures.concat(e.updatedFeatures),t,s)}_addTileStorage(e,t,s){this.tiles.set(e.id,new S(e,t,s)),this.tileBounds.set(e.id,e.extent),this.tileFeatureCounts.set(e.id,t.size)}_remove({id:e}){const t=this.tiles.get(e);t&&this._removeTileStorage(t)}_removeTileStorage(e){const t=[];for(const i of e.objectIds)this._unreferenceFeature(i)===w.REMOVED&&t.push(i);this.featureStore.removeManyById(t);const s=e.data.id;this.tiles.delete(s),this.tileBounds.delete(s)}_processEditsDelete(e){this.featureStore.removeManyById(e);for(const[,t]of this.tiles){for(const s of e)t.objectIds.delete(s);this.tileFeatureCounts.set(t.data.id,t.objectIds.size)}for(const t of e)this.refCounts.delete(t)}async _processEditsRefetch(e,t,s){const i=(await t(e,s)).features,{hasZ:r,hasM:n}=this.featureStore;for(const l of i){const e=f(this.tmpBoundingRect,l.geometry,r,n);o(e)||this.tileBounds.forEachInBounds(e,(e=>{const t=this.tiles.get(e);this.featureStore.add(l),t.objectIds.has(l.objectId)||(t.objectIds.add(l.objectId),this._referenceFeature(l.objectId),this.tileFeatureCounts.set(t.data.id,t.objectIds.size))}))}}process(e,t=(()=>!0)){if(o(this.tileInfo)||!e.extent||n(this.extent)&&!h(u(this.extent,this.tmpBoundingRect),e.extent))return new I(e);if(this.tiles.has(e.id))return new I(e);const s=this._createTileTree(e,this.tileInfo);return this._simplify(s,t,null,0,1),this._collectMissingTiles(e,s,this.tileInfo)}get debugInfo(){return Array.from(this.tiles.values()).map((({data:e})=>({data:e,featureCount:this.tileFeatureCounts.get(e.id)||0})))}getFeatureCount(e){const t=this.tileFeatureCounts.get(e.id);return null!=t?t:0}async fetchCount(e,t,s,i){const r=this.tileFeatureCounts.get(e.id);if(null!=r)return r;const o=await g(t,s,i);return this.tileFeatureCounts.set(e.id,o.data.count),o.data.count}_createTileTree(e,t){const s=new T(e.level,e.row,e.col);return t.updateTileInfo(s,m.ExtrapolateOptions.POWER_OF_TWO),this.tileBounds.forEachInBounds(e.extent,(i=>{const r=this.tiles.get(i).data;this._tilesAreRelated(e,r)&&this._populateChildren(s,r,t,this.tileFeatureCounts.get(r.id)||0)})),s}_tilesAreRelated(e,t){if(!e||!t)return!1;if(e.level===t.level)return e.row===t.row&&e.col===t.col;const s=e.level<t.level,i=s?e:t,r=s?t:e,o=1<<r.level-i.level;return Math.floor(r.row/o)===i.row&&Math.floor(r.col/o)===i.col}_populateChildren(e,t,s,i){const r=t.level-e.level-1;if(r<0)return void(e.isLeaf=!0);const o=t.row>>r,l=t.col>>r,a=e.row<<1,c=l-(e.col<<1)+(o-a<<1),h=e.children[c];if(n(h))this._populateChildren(h,t,s,i);else{const r=new T(e.level+1,o,l);s.updateTileInfo(r,m.ExtrapolateOptions.POWER_OF_TWO),e.children[c]=r,this._populateChildren(r,t,s,i)}}_simplify(e,t,s,i,r){const o=r*r;if(e.isLeaf)return t(this.getFeatureCount(e),r)?0:(this._remove(e),n(s)&&(s.children[i]=null),o);const l=r/2,a=l*l;let c=0;for(let h=0;h<e.children.length;h++){const s=e.children[h];c+=n(s)?this._simplify(s,t,e,h,l):a}return 0===c?this._mergeChildren(e):1-c/o<F&&(this._purge(e),n(s)&&(s.children[i]=null),c=o),c}_mergeChildren(e){const t=new Set;let s=0;this._forEachLeaf(e,(e=>{const i=this.tiles.get(e.id);if(i){s+=i.byteSize;for(const e of i.objectIds)t.has(e)||(t.add(e),this._referenceFeature(e));this._remove(e)}})),this._addTileStorage(e,t,s),e.isLeaf=!0,e.children[0]=e.children[1]=e.children[2]=e.children[3]=null,this.tileFeatureCounts.set(e.id,t.size)}_forEachLeaf(e,t){for(const s of e.children)o(s)||(s.isLeaf?t(s):this._forEachLeaf(s,t))}_purge(e){if(!o(e))if(e.isLeaf)this._remove(e);else for(let t=0;t<e.children.length;t++){const s=e.children[t];this._purge(s),e.children[t]=null}}_collectMissingTiles(e,t,s){const i=new j(s,e,this.extent);return this._collectMissingTilesRecurse(t,i,1),i.info}_collectMissingTilesRecurse(e,t,s){if(e.isLeaf)return;if(!e.hasChildren)return void t.addMissing(e.level,e.row,e.col,s);const i=s/2;for(let r=0;r<e.children.length;r++){const s=e.children[r];o(s)?t.addMissing(e.level+1,(e.row<<1)+((2&r)>>1),(e.col<<1)+(1&r),i):this._collectMissingTilesRecurse(s,t,i)}}_referenceFeature(e){const t=(this.refCounts.get(e)||0)+1;return this.refCounts.set(e,t),1===t?w.ADDED:w.UNCHANGED}_unreferenceFeature(e){const t=(this.refCounts.get(e)||0)-1;return 0===t?(this.refCounts.delete(e),w.REMOVED):(t>0&&this.refCounts.set(e,t),w.UNCHANGED)}get test(){return{tiles:Array.from(this.tiles.values()).map((e=>`${e.data.id}:[${Array.from(e.objectIds)}]`)),featureReferences:Array.from(this.refCounts.keys()).map((e=>`${e}:${this.refCounts.get(e)}`))}}};function y(e){return e.reduce(((e,t)=>e+C(t)),0)}function C(e){return 32+E(e.geometry)+i(e.attributes)}function E(e){if(o(e))return 0;const t=r(e.lengths,4);return 32+r(e.coords,8)+t}e([l({constructOnly:!0})],v.prototype,\"featureStore\",void 0),e([l()],v.prototype,\"tileInfo\",void 0),e([l()],v.prototype,\"extent\",void 0),e([l()],v.prototype,\"maximumByteSize\",void 0),v=e([a(\"esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTileStore\")],v);class S{constructor(e,t,s){this.data=e,this.objectIds=t,this.byteSize=s}}class T{constructor(e,t,s){this.level=e,this.row=t,this.col=s,this.isLeaf=!1,this.extent=null,this.children=[null,null,null,null]}get hasChildren(){return!this.isLeaf&&(n(this.children[0])||n(this.children[1])||n(this.children[2])||n(this.children[3]))}}class I{constructor(e,t=[]){this.missingTiles=t,this.fullArea=0,this.coveredArea=0,this.fullArea=d(e.extent),this.coveredArea=this.fullArea}prepend(e){this.missingTiles=e.missingTiles.concat(this.missingTiles),this.coveredArea+=e.coveredArea,this.fullArea+=e.fullArea}}class j{constructor(e,t,s){this.tileInfo=e,this.extent=null,this.info=new I(t),n(s)&&(this.extent=u(s))}addMissing(e,t,s,i){const r={id:null,level:e,row:t,col:s};this.tileInfo.updateTileInfo(r,m.ExtrapolateOptions.POWER_OF_TWO),!n(r.extent)||n(this.extent)&&!h(this.extent,r.extent)||(this.info.missingTiles.push({data:r,resolution:i}),this.info.coveredArea-=d(r.extent))}}const F=.18751;var w;!function(e){e[e.ADDED=0]=\"ADDED\",e[e.REMOVED=1]=\"REMOVED\",e[e.UNCHANGED=2]=\"UNCHANGED\"}(w||(w={}));export{v as FeatureServiceTileStore,I as ProcessResult};\n"]},"metadata":{},"sourceType":"module"}