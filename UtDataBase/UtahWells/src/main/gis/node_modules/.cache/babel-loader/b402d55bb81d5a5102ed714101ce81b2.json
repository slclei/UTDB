{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../../chunks/tslib.es6.js\";\nimport \"../../../../geometry.js\";\nimport { HandleOwner as t } from \"../../../../core/HandleOwner.js\";\nimport i from \"../../../../core/Logger.js\";\nimport { isSome as s, isNone as r, unwrap as l } from \"../../../../core/maybe.js\";\nimport { debounce as a, isAbortError as o, eachAlways as h } from \"../../../../core/promiseUtils.js\";\nimport { property as n } from \"../../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../../core/arrayUtils.js\";\nimport \"../../../../core/has.js\";\nimport \"../../../../core/accessorSupport/ensureType.js\";\nimport { subclass as c } from \"../../../../core/accessorSupport/decorators/subclass.js\";\nimport u from \"../../../../geometry/Point.js\";\nimport p from \"../../../../layers/support/PixelBlock.js\";\nimport y from \"../../../../layers/support/TileInfo.js\";\nimport { update as d, unregister as m, register as g, getRasterId as _ } from \"../../../../layers/support/rasterDatasets/RawBlockCache.js\";\nimport { extractBands as f } from \"../../../../layers/support/rasterFunctions/pixelUtils.js\";\nimport { getWorldWidth as w, computeProjectedScales as b } from \"../../../../layers/support/rasterFunctions/rasterProjectionHelper.js\";\nimport \"../../tiling/PagedTileQueue.js\";\nimport P from \"../../tiling/TileInfoView.js\";\nimport \"../../tiling/TileKey.js\";\nimport I from \"../../tiling/TileQueue.js\";\nimport v from \"../../tiling/TileStrategy.js\";\nimport { getWebGL1Capabilities as C } from \"../../../webgl/capabilities.js\";\nimport R from \"../../../../geometry/Extent.js\";\nconst V = [0, 0],\n      T = i.getLogger(\"esri.views.2d.layers.ImageryTileLayerView2D\");\nlet S = class extends t {\n  constructor() {\n    super(...arguments), this._emptyTilePixelBlock = null, this._tileStrategy = null, this._tileInfoView = null, this._fetchQueue = null, this._blockCacheRegistryUrl = null, this._blockCacheRegistryId = null, this._srcResolutions = null, this.previousLOD = null, this._needBlockCacheUpdate = !1, this._globalSymbolizerParams = null, this._symbolizerParams = null, this._abortController = null, this._isCustomTilingScheme = !1, this._globalUpdateRequested = !1, this.attached = !1, this.container = null, this.layer = null, this.timeExtent = null, this.redrawOrRefetch = a((e, t) => !this.previousLOD || this.layerView.suspended ? Promise.resolve() : e ? this.doRefresh() : this._redrawImage(t));\n  }\n\n  get useWebGLForProcessing() {\n    var e;\n    return null == (e = this._get(\"useWebGLForProcessing\")) || e;\n  }\n\n  set useWebGLForProcessing(e) {\n    this._set(\"useWebGLForProcessing\", e);\n  }\n\n  get useProgressiveUpdate() {\n    return null == this._get(\"useProgressiveUpdate\") || this._get(\"useProgressiveUpdate\");\n  }\n\n  set useProgressiveUpdate(e) {\n    if (this._tileStrategy && this.useProgressiveUpdate !== e) {\n      this._tileStrategy.destroy(), this.container.removeAllChildren();\n\n      const t = this._getCacheSize(e);\n\n      this._tileStrategy = new v({\n        cachePolicy: \"purge\",\n        acquireTile: e => this.acquireTile(e),\n        releaseTile: e => this.releaseTile(e),\n        cacheSize: t,\n        tileInfoView: this._tileInfoView\n      }), this._set(\"useProgressiveUpdate\", e), this.layerView.requestUpdate();\n    }\n  }\n\n  update(e) {\n    this._fetchQueue.pause(), this._fetchQueue.state = e.state, this._tileStrategy.update(e), this._fetchQueue.resume();\n\n    const {\n      extent: t,\n      resolution: i,\n      scale: s\n    } = e.state,\n          r = this._tileInfoView.getClosestInfoForScale(s);\n\n    if (this.layer.raster) {\n      var l;\n\n      if (!this.useProgressiveUpdate || this._needBlockCacheUpdate) {\n        const e = this._srcResolutions[r.level],\n              s = t.toJSON ? t : R.fromJSON(t);\n        d(this._blockCacheRegistryUrl, this._blockCacheRegistryId, s, i, e, this.layer.raster.ioConfig.sampling);\n      }\n\n      this._needBlockCacheUpdate = !1, (null == (l = this.previousLOD) ? void 0 : l.level) !== r.level && (this.previousLOD = r, null == this._symbolizerParams || this.layerView.hasTilingEffects || this._updateSymbolizerParams(), this._tileStrategy.updateCacheSize(0));\n    }\n  }\n\n  moveEnd() {\n    !this.layerView.hasTilingEffects && this.useProgressiveUpdate || (this._abortController && this._abortController.abort(), this._abortController = new AbortController(), 0 === this._fetchQueue.length && this._redrawImage(this._abortController.signal).then(() => {\n      this._globalUpdateRequested = !1, this.layerView.requestUpdate();\n    }));\n\n    const e = this._getCacheSize(this.useProgressiveUpdate);\n\n    this._tileStrategy.updateCacheSize(e), this.layerView.requestUpdate();\n  }\n\n  get updating() {\n    return this._fetchQueue.updating || this._globalUpdateRequested || !(!this.updatingHandles || !this.updatingHandles.updating);\n  }\n\n  attach() {\n    C().supportsTextureFloat || (this.useWebGLForProcessing = !1), this._initializeTileInfo(), this._tileInfoView = new P(this.layerView.tileInfo, this.layerView.fullExtent);\n\n    const e = this._computeFetchConcurrency();\n\n    this._fetchQueue = new I({\n      tileInfoView: this._tileInfoView,\n      concurrency: e,\n      process: (e, t) => this._fetchTile1(e, t)\n    });\n\n    const t = this._getCacheSize(this.useProgressiveUpdate);\n\n    this._tileStrategy = new v({\n      cachePolicy: \"purge\",\n      acquireTile: e => this.acquireTile(e),\n      releaseTile: e => this.releaseTile(e),\n      cacheSize: t,\n      tileInfoView: this._tileInfoView\n    }), this._updateBlockCacheRegistry();\n  }\n\n  detach() {\n    this._tileStrategy.destroy(), this._fetchQueue.clear(), this.container.removeAllChildren(), this._fetchQueue = this._tileStrategy = this._tileInfoView = null, m(this._blockCacheRegistryUrl, this._blockCacheRegistryId), this._blockCacheRegistryUrl = this._blockCacheRegistryId = null;\n  }\n\n  acquireTile(e) {\n    const t = this.container.createTile(e);\n    return this._enqueueTileFetch(t), this.layerView.requestUpdate(), this._needBlockCacheUpdate = !0, this._globalUpdateRequested = this.layerView.hasTilingEffects || !this.useProgressiveUpdate, t;\n  }\n\n  releaseTile(e) {\n    this._fetchQueue.abort(e.key.id), this.container.removeChild(e), e.once(\"detach\", () => {\n      e.destroy(), this.layerView.requestUpdate();\n    }), this.layerView.requestUpdate();\n  }\n\n  createEmptyTilePixelBlock() {\n    let e = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : null;\n\n    const t = null == e || e.join(\",\") === this._tileInfoView.tileInfo.size.join(\",\");\n\n    if (t && s(this._emptyTilePixelBlock)) return this._emptyTilePixelBlock;\n    e = e || this._tileInfoView.tileInfo.size;\n    const [i, r] = e,\n          l = new p({\n      width: i,\n      height: r,\n      pixels: [new Uint8Array(i * r)],\n      mask: new Uint8Array(i * r),\n      pixelType: \"u8\"\n    });\n    return t && (this._emptyTilePixelBlock = l), l;\n  }\n\n  _fetchTile1(e, t) {\n    const i = !r(t) && t.signal,\n          a = this.canUseWebGLForProcessing(),\n          {\n      layerView: o\n    } = this,\n          h = !o.tileInfo.isWrappable && s(w(o.view.spatialReference)),\n          n = {\n      allowPartialFill: !0,\n      datumTransformation: o.datumTransformation,\n      interpolation: a ? \"nearest\" : this.layer.interpolation,\n      registryId: this._blockCacheRegistryId,\n      requestRawData: a,\n      signal: l(i),\n      srcResolution: this._srcResolutions[e.level],\n      timeExtent: o.timeExtent,\n      tileInfo: o.tileInfo,\n      disableWrapAround: h\n    };\n    return this.fetchTile(e, n);\n  }\n\n  _getCacheSize(e) {\n    return e ? 40 : 0;\n  }\n\n  _initializeTileInfo() {\n    const e = this.layerView.view.spatialReference,\n          t = new u({\n      x: this.layerView.fullExtent.xmin,\n      y: this.layerView.fullExtent.ymax,\n      spatialReference: e\n    }),\n          {\n      scales: i,\n      srcResolutions: s,\n      isCustomTilingScheme: r\n    } = b(this.layer.rasterInfo, e),\n          l = y.create({\n      spatialReference: e,\n      size: 512,\n      scales: i\n    });\n    (0 === l.origin.x || l.origin.x > t.x) && (l.origin = t), this._isCustomTilingScheme = r, this.layerView.set(\"tileInfo\", l), this._srcResolutions = null != s ? s : [];\n  }\n\n  _computeFetchConcurrency() {\n    const {\n      blockBoundary: e\n    } = this.layer.rasterInfo.storageInfo,\n          t = e[e.length - 1];\n    return (t.maxCol - t.minCol + 1) * (t.maxRow - t.minRow + 1) > 64 ? 2 : 10;\n  }\n\n  async _enqueueTileFetch(e, t) {\n    if (!this._fetchQueue.has(e.key.id)) {\n      try {\n        const t = await this._fetchQueue.push(e.key),\n              {\n          bandIds: s\n        } = this.layer;\n        let r = !this.useProgressiveUpdate || this.layerView.hasTilingEffects && !this._globalSymbolizerParams;\n\n        if (this._globalUpdateRequested && !this.layerView.moving && 0 === this._fetchQueue.length) {\n          r = !1;\n\n          try {\n            await this._redrawImage(this._abortController && this._abortController.signal);\n          } catch (i) {\n            o(i) && T.error(i);\n          }\n\n          this._globalUpdateRequested = !1;\n        }\n\n        !this.canUseWebGLForProcessing() && \"rasterVF\" !== this.type || this.layerView.hasTilingEffects || null != this._symbolizerParams || this._updateSymbolizerParams();\n\n        const l = this._tileInfoView.getTileCoords(V, e.key),\n              a = this._tileInfoView.getTileResolution(e.key);\n\n        await this.updateTileSource(e, {\n          source: t,\n          symbolizerParams: this._symbolizerParams,\n          globalSymbolizerParams: this._globalSymbolizerParams,\n          suspended: r,\n          bandIds: s,\n          coords: l,\n          resolution: a\n        }), e.once(\"attach\", () => this.layerView.requestUpdate()), this.container.addChild(e);\n      } catch (i) {\n        o(i) || T.error(i);\n      }\n\n      this.layerView.requestUpdate();\n    }\n  }\n\n  async _redrawImage(e) {\n    if (0 === this.container.children.length) return;\n    await this.updatingHandles.addPromise(this.layer.updateRenderer()), this.layerView.hasTilingEffects ? await this._updateGlobalSymbolizerParams(e) : (this._updateSymbolizerParams(), this._globalSymbolizerParams = null);\n    const t = this.container.children.map(async e => this.updateTileSymbolizerParameters(e, {\n      local: this._symbolizerParams,\n      global: this._globalSymbolizerParams\n    }));\n    await h(t), this.container.requestRender();\n  }\n\n  async _updateGlobalSymbolizerParams(e) {\n    const t = {\n      srcResolution: this._srcResolutions[this.previousLOD.level],\n      registryId: this._blockCacheRegistryId,\n      signal: e\n    },\n          i = await this.layer.fetchPixels(this.layerView.view.extent, this.layerView.view.width, this.layerView.view.height, t);\n    if (!i || !i.pixelBlock) return;\n    const s = this.layer.symbolizer.generateWebGLParameters({\n      pixelBlock: f(i.pixelBlock, this.layer.bandIds),\n      isGCS: this.layerView.view.spatialReference.isGeographic,\n      resolution: {\n        x: this.previousLOD.resolution,\n        y: this.previousLOD.resolution\n      },\n      bandIds: this.layer.bandIds\n    });\n    !this.canUseWebGLForProcessing() && s && \"stretch\" === s.type && this.layer.renderer && \"raster-stretch\" === this.layer.renderer.type && (s.factor = s.factor.map(e => 255 * e), s.outMin = Math.round(255 * s.outMin), s.outMax = Math.round(255 * s.outMax)), this._globalSymbolizerParams = s;\n  }\n\n  _updateSymbolizerParams() {\n    this._symbolizerParams = this.layer.symbolizer.generateWebGLParameters({\n      pixelBlock: null,\n      isGCS: this.layerView.view.spatialReference.isGeographic,\n      resolution: {\n        x: this.previousLOD.resolution,\n        y: this.previousLOD.resolution\n      },\n      bandIds: this.layer.bandIds\n    });\n  }\n\n  _updateBlockCacheRegistry() {\n    let e = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : !1;\n\n    const {\n      url: t,\n      rasterInfo: i,\n      raster: s\n    } = this.layer,\n          {\n      multidimensionalDefinition: r\n    } = this.layer.normalizeRasterFetchOptions({\n      multidimensionalDefinition: this.layer.multidimensionalDefinition,\n      timeExtent: this.layerView.timeExtent\n    }),\n          l = null != i && i.multidimensionalInfo ? s.getSliceIndex(r) : null,\n          a = _(t, l);\n\n    if (a !== this._blockCacheRegistryUrl) {\n      if (null != this._blockCacheRegistryUrl && m(this._blockCacheRegistryUrl, this._blockCacheRegistryId), this._blockCacheRegistryId = g(a, this.layer.raster.rasterInfo), e) {\n        const e = this._tileInfoView.getClosestInfoForScale(this.layerView.view.scale),\n              t = this._srcResolutions[e.level];\n\n        d(a, this._blockCacheRegistryId, this.layerView.view.extent, this.layerView.view.resolution, t, this.layer.raster.ioConfig.sampling);\n      }\n\n      this._blockCacheRegistryUrl = a;\n    }\n  }\n\n  async doRefresh() {\n    await this.updatingHandles.addPromise(this.layer.updateRenderer()), this.layerView.hasTilingEffects || this._updateSymbolizerParams(), this._updateBlockCacheRegistry(!0), this._fetchQueue.reset();\n    const e = [];\n    this._tileStrategy.tiles.forEach(t => e.push(this._enqueueTileFetch(t))), await h(e);\n  }\n\n};\ne([n()], S.prototype, \"_fetchQueue\", void 0), e([n()], S.prototype, \"_globalUpdateRequested\", void 0), e([n()], S.prototype, \"attached\", void 0), e([n()], S.prototype, \"container\", void 0), e([n()], S.prototype, \"layer\", void 0), e([n()], S.prototype, \"layerView\", void 0), e([n()], S.prototype, \"type\", void 0), e([n()], S.prototype, \"useWebGLForProcessing\", null), e([n()], S.prototype, \"useProgressiveUpdate\", null), e([n()], S.prototype, \"timeExtent\", void 0), e([n()], S.prototype, \"updating\", null), S = e([c(\"esri.views.2d.layers.imagery.BaseImageryTileSubView2D\")], S);\nexport { S as BaseImageryTileSubView2D };","map":{"version":3,"sources":["D:/Github/CUSP_DataBase/CUSP_DB/src/main/gis/node_modules/@arcgis/core/views/2d/layers/imagery/BaseImageryTileSubView2D.js"],"names":["_","e","HandleOwner","t","i","isSome","s","isNone","r","unwrap","l","debounce","a","isAbortError","o","eachAlways","h","property","n","subclass","c","u","p","y","update","d","unregister","m","register","g","getRasterId","extractBands","f","getWorldWidth","w","computeProjectedScales","b","P","I","v","getWebGL1Capabilities","C","R","V","T","getLogger","S","constructor","arguments","_emptyTilePixelBlock","_tileStrategy","_tileInfoView","_fetchQueue","_blockCacheRegistryUrl","_blockCacheRegistryId","_srcResolutions","previousLOD","_needBlockCacheUpdate","_globalSymbolizerParams","_symbolizerParams","_abortController","_isCustomTilingScheme","_globalUpdateRequested","attached","container","layer","timeExtent","redrawOrRefetch","layerView","suspended","Promise","resolve","doRefresh","_redrawImage","useWebGLForProcessing","_get","_set","useProgressiveUpdate","destroy","removeAllChildren","_getCacheSize","cachePolicy","acquireTile","releaseTile","cacheSize","tileInfoView","requestUpdate","pause","state","resume","extent","resolution","scale","getClosestInfoForScale","raster","level","toJSON","fromJSON","ioConfig","sampling","hasTilingEffects","_updateSymbolizerParams","updateCacheSize","moveEnd","abort","AbortController","length","signal","then","updating","updatingHandles","attach","supportsTextureFloat","_initializeTileInfo","tileInfo","fullExtent","_computeFetchConcurrency","concurrency","process","_fetchTile1","_updateBlockCacheRegistry","detach","clear","createTile","_enqueueTileFetch","key","id","removeChild","once","createEmptyTilePixelBlock","join","size","width","height","pixels","Uint8Array","mask","pixelType","canUseWebGLForProcessing","isWrappable","view","spatialReference","allowPartialFill","datumTransformation","interpolation","registryId","requestRawData","srcResolution","disableWrapAround","fetchTile","x","xmin","ymax","scales","srcResolutions","isCustomTilingScheme","rasterInfo","create","origin","set","blockBoundary","storageInfo","maxCol","minCol","maxRow","minRow","has","push","bandIds","moving","error","type","getTileCoords","getTileResolution","updateTileSource","source","symbolizerParams","globalSymbolizerParams","coords","addChild","children","addPromise","updateRenderer","_updateGlobalSymbolizerParams","map","updateTileSymbolizerParameters","local","global","requestRender","fetchPixels","pixelBlock","symbolizer","generateWebGLParameters","isGCS","isGeographic","renderer","factor","outMin","Math","round","outMax","url","multidimensionalDefinition","normalizeRasterFetchOptions","multidimensionalInfo","getSliceIndex","reset","tiles","forEach","prototype","BaseImageryTileSubView2D"],"mappings":"AAAA;AACA;AACA;AACA;AACA,SAAOA,CAAC,IAAIC,CAAZ,QAAkB,iCAAlB;AAAoD,OAAM,yBAAN;AAAgC,SAAOC,WAAW,IAAIC,CAAtB,QAA4B,iCAA5B;AAA8D,OAAOC,CAAP,MAAa,4BAAb;AAA0C,SAAOC,MAAM,IAAIC,CAAjB,EAAmBC,MAAM,IAAIC,CAA7B,EAA+BC,MAAM,IAAIC,CAAzC,QAA+C,2BAA/C;AAA2E,SAAOC,QAAQ,IAAIC,CAAnB,EAAqBC,YAAY,IAAIC,CAArC,EAAuCC,UAAU,IAAIC,CAArD,QAA2D,kCAA3D;AAA8F,SAAOC,QAAQ,IAAIC,CAAnB,QAAyB,yDAAzB;AAAmF,OAAM,gCAAN;AAAuC,OAAM,yBAAN;AAAgC,OAAM,gDAAN;AAAuD,SAAOC,QAAQ,IAAIC,CAAnB,QAAyB,yDAAzB;AAAmF,OAAOC,CAAP,MAAa,+BAAb;AAA6C,OAAOC,CAAP,MAAa,0CAAb;AAAwD,OAAOC,CAAP,MAAa,wCAAb;AAAsD,SAAOC,MAAM,IAAIC,CAAjB,EAAmBC,UAAU,IAAIC,CAAjC,EAAmCC,QAAQ,IAAIC,CAA/C,EAAiDC,WAAW,IAAI9B,CAAhE,QAAsE,4DAAtE;AAAmI,SAAO+B,YAAY,IAAIC,CAAvB,QAA6B,0DAA7B;AAAwF,SAAOC,aAAa,IAAIC,CAAxB,EAA0BC,sBAAsB,IAAIC,CAApD,QAA0D,sEAA1D;AAAiI,OAAM,gCAAN;AAAuC,OAAOC,CAAP,MAAa,8BAAb;AAA4C,OAAM,yBAAN;AAAgC,OAAOC,CAAP,MAAa,2BAAb;AAAyC,OAAOC,CAAP,MAAa,8BAAb;AAA4C,SAAOC,qBAAqB,IAAIC,CAAhC,QAAsC,gCAAtC;AAAuE,OAAOC,CAAP,MAAa,gCAAb;AAA8C,MAAMC,CAAC,GAAC,CAAC,CAAD,EAAG,CAAH,CAAR;AAAA,MAAcC,CAAC,GAACxC,CAAC,CAACyC,SAAF,CAAY,6CAAZ,CAAhB;AAA2E,IAAIC,CAAC,GAAC,cAAc3C,CAAd,CAAe;AAAC4C,EAAAA,WAAW,GAAE;AAAC,UAAM,GAAGC,SAAT,GAAoB,KAAKC,oBAAL,GAA0B,IAA9C,EAAmD,KAAKC,aAAL,GAAmB,IAAtE,EAA2E,KAAKC,aAAL,GAAmB,IAA9F,EAAmG,KAAKC,WAAL,GAAiB,IAApH,EAAyH,KAAKC,sBAAL,GAA4B,IAArJ,EAA0J,KAAKC,qBAAL,GAA2B,IAArL,EAA0L,KAAKC,eAAL,GAAqB,IAA/M,EAAoN,KAAKC,WAAL,GAAiB,IAArO,EAA0O,KAAKC,qBAAL,GAA2B,CAAC,CAAtQ,EAAwQ,KAAKC,uBAAL,GAA6B,IAArS,EAA0S,KAAKC,iBAAL,GAAuB,IAAjU,EAAsU,KAAKC,gBAAL,GAAsB,IAA5V,EAAiW,KAAKC,qBAAL,GAA2B,CAAC,CAA7X,EAA+X,KAAKC,sBAAL,GAA4B,CAAC,CAA5Z,EAA8Z,KAAKC,QAAL,GAAc,CAAC,CAA7a,EAA+a,KAAKC,SAAL,GAAe,IAA9b,EAAmc,KAAKC,KAAL,GAAW,IAA9c,EAAmd,KAAKC,UAAL,GAAgB,IAAne,EAAwe,KAAKC,eAAL,GAAqBvD,CAAC,CAAE,CAACX,CAAD,EAAGE,CAAH,KAAO,CAAC,KAAKqD,WAAN,IAAmB,KAAKY,SAAL,CAAeC,SAAlC,GAA4CC,OAAO,CAACC,OAAR,EAA5C,GAA8DtE,CAAC,GAAC,KAAKuE,SAAL,EAAD,GAAkB,KAAKC,YAAL,CAAkBtE,CAAlB,CAA1F,CAA9f;AAA+mB;;AAAyB,MAArBuE,qBAAqB,GAAE;AAAC,QAAIzE,CAAJ;AAAM,WAAO,SAAOA,CAAC,GAAC,KAAK0E,IAAL,CAAU,uBAAV,CAAT,KAA8C1E,CAArD;AAAuD;;AAAyB,MAArByE,qBAAqB,CAACzE,CAAD,EAAG;AAAC,SAAK2E,IAAL,CAAU,uBAAV,EAAkC3E,CAAlC;AAAqC;;AAAwB,MAApB4E,oBAAoB,GAAE;AAAC,WAAO,QAAM,KAAKF,IAAL,CAAU,sBAAV,CAAN,IAAyC,KAAKA,IAAL,CAAU,sBAAV,CAAhD;AAAkF;;AAAwB,MAApBE,oBAAoB,CAAC5E,CAAD,EAAG;AAAC,QAAG,KAAKiD,aAAL,IAAoB,KAAK2B,oBAAL,KAA4B5E,CAAnD,EAAqD;AAAC,WAAKiD,aAAL,CAAmB4B,OAAnB,IAA6B,KAAKd,SAAL,CAAee,iBAAf,EAA7B;;AAAgE,YAAM5E,CAAC,GAAC,KAAK6E,aAAL,CAAmB/E,CAAnB,CAAR;;AAA8B,WAAKiD,aAAL,GAAmB,IAAIX,CAAJ,CAAM;AAAC0C,QAAAA,WAAW,EAAC,OAAb;AAAqBC,QAAAA,WAAW,EAACjF,CAAC,IAAE,KAAKiF,WAAL,CAAiBjF,CAAjB,CAApC;AAAwDkF,QAAAA,WAAW,EAAClF,CAAC,IAAE,KAAKkF,WAAL,CAAiBlF,CAAjB,CAAvE;AAA2FmF,QAAAA,SAAS,EAACjF,CAArG;AAAuGkF,QAAAA,YAAY,EAAC,KAAKlC;AAAzH,OAAN,CAAnB,EAAkK,KAAKyB,IAAL,CAAU,sBAAV,EAAiC3E,CAAjC,CAAlK,EAAsM,KAAKmE,SAAL,CAAekB,aAAf,EAAtM;AAAqO;AAAC;;AAAA9D,EAAAA,MAAM,CAACvB,CAAD,EAAG;AAAC,SAAKmD,WAAL,CAAiBmC,KAAjB,IAAyB,KAAKnC,WAAL,CAAiBoC,KAAjB,GAAuBvF,CAAC,CAACuF,KAAlD,EAAwD,KAAKtC,aAAL,CAAmB1B,MAAnB,CAA0BvB,CAA1B,CAAxD,EAAqF,KAAKmD,WAAL,CAAiBqC,MAAjB,EAArF;;AAA+G,UAAK;AAACC,MAAAA,MAAM,EAACvF,CAAR;AAAUwF,MAAAA,UAAU,EAACvF,CAArB;AAAuBwF,MAAAA,KAAK,EAACtF;AAA7B,QAAgCL,CAAC,CAACuF,KAAvC;AAAA,UAA6ChF,CAAC,GAAC,KAAK2C,aAAL,CAAmB0C,sBAAnB,CAA0CvF,CAA1C,CAA/C;;AAA4F,QAAG,KAAK2D,KAAL,CAAW6B,MAAd,EAAqB;AAAC,UAAIpF,CAAJ;;AAAM,UAAG,CAAC,KAAKmE,oBAAN,IAA4B,KAAKpB,qBAApC,EAA0D;AAAC,cAAMxD,CAAC,GAAC,KAAKsD,eAAL,CAAqB/C,CAAC,CAACuF,KAAvB,CAAR;AAAA,cAAsCzF,CAAC,GAACH,CAAC,CAAC6F,MAAF,GAAS7F,CAAT,GAAWuC,CAAC,CAACuD,QAAF,CAAW9F,CAAX,CAAnD;AAAiEsB,QAAAA,CAAC,CAAC,KAAK4B,sBAAN,EAA6B,KAAKC,qBAAlC,EAAwDhD,CAAxD,EAA0DF,CAA1D,EAA4DH,CAA5D,EAA8D,KAAKgE,KAAL,CAAW6B,MAAX,CAAkBI,QAAlB,CAA2BC,QAAzF,CAAD;AAAoG;;AAAA,WAAK1C,qBAAL,GAA2B,CAAC,CAA5B,EAA8B,CAAC,SAAO/C,CAAC,GAAC,KAAK8C,WAAd,IAA2B,KAAK,CAAhC,GAAkC9C,CAAC,CAACqF,KAArC,MAA8CvF,CAAC,CAACuF,KAAhD,KAAwD,KAAKvC,WAAL,GAAiBhD,CAAjB,EAAmB,QAAM,KAAKmD,iBAAX,IAA8B,KAAKS,SAAL,CAAegC,gBAA7C,IAA+D,KAAKC,uBAAL,EAAlF,EAAiH,KAAKnD,aAAL,CAAmBoD,eAAnB,CAAmC,CAAnC,CAAzK,CAA9B;AAA8O;AAAC;;AAAAC,EAAAA,OAAO,GAAE;AAAC,KAAC,KAAKnC,SAAL,CAAegC,gBAAhB,IAAkC,KAAKvB,oBAAvC,KAA8D,KAAKjB,gBAAL,IAAuB,KAAKA,gBAAL,CAAsB4C,KAAtB,EAAvB,EAAqD,KAAK5C,gBAAL,GAAsB,IAAI6C,eAAJ,EAA3E,EAA+F,MAAI,KAAKrD,WAAL,CAAiBsD,MAArB,IAA6B,KAAKjC,YAAL,CAAkB,KAAKb,gBAAL,CAAsB+C,MAAxC,EAAgDC,IAAhD,CAAsD,MAAI;AAAC,WAAK9C,sBAAL,GAA4B,CAAC,CAA7B,EAA+B,KAAKM,SAAL,CAAekB,aAAf,EAA/B;AAA8D,KAAzH,CAA1L;;AAAuT,UAAMrF,CAAC,GAAC,KAAK+E,aAAL,CAAmB,KAAKH,oBAAxB,CAAR;;AAAsD,SAAK3B,aAAL,CAAmBoD,eAAnB,CAAmCrG,CAAnC,GAAsC,KAAKmE,SAAL,CAAekB,aAAf,EAAtC;AAAqE;;AAAY,MAARuB,QAAQ,GAAE;AAAC,WAAO,KAAKzD,WAAL,CAAiByD,QAAjB,IAA2B,KAAK/C,sBAAhC,IAAwD,EAAE,CAAC,KAAKgD,eAAN,IAAuB,CAAC,KAAKA,eAAL,CAAqBD,QAA/C,CAA/D;AAAwH;;AAAAE,EAAAA,MAAM,GAAE;AAACtE,IAAAA,CAAC,GAAGuE,oBAAJ,KAA2B,KAAKtC,qBAAL,GAA2B,CAAC,CAAvD,GAA0D,KAAKuC,mBAAL,EAA1D,EAAqF,KAAK9D,aAAL,GAAmB,IAAId,CAAJ,CAAM,KAAK+B,SAAL,CAAe8C,QAArB,EAA8B,KAAK9C,SAAL,CAAe+C,UAA7C,CAAxG;;AAAiK,UAAMlH,CAAC,GAAC,KAAKmH,wBAAL,EAAR;;AAAwC,SAAKhE,WAAL,GAAiB,IAAId,CAAJ,CAAM;AAAC+C,MAAAA,YAAY,EAAC,KAAKlC,aAAnB;AAAiCkE,MAAAA,WAAW,EAACpH,CAA7C;AAA+CqH,MAAAA,OAAO,EAAC,CAACrH,CAAD,EAAGE,CAAH,KAAO,KAAKoH,WAAL,CAAiBtH,CAAjB,EAAmBE,CAAnB;AAA9D,KAAN,CAAjB;;AAA6G,UAAMA,CAAC,GAAC,KAAK6E,aAAL,CAAmB,KAAKH,oBAAxB,CAAR;;AAAsD,SAAK3B,aAAL,GAAmB,IAAIX,CAAJ,CAAM;AAAC0C,MAAAA,WAAW,EAAC,OAAb;AAAqBC,MAAAA,WAAW,EAACjF,CAAC,IAAE,KAAKiF,WAAL,CAAiBjF,CAAjB,CAApC;AAAwDkF,MAAAA,WAAW,EAAClF,CAAC,IAAE,KAAKkF,WAAL,CAAiBlF,CAAjB,CAAvE;AAA2FmF,MAAAA,SAAS,EAACjF,CAArG;AAAuGkF,MAAAA,YAAY,EAAC,KAAKlC;AAAzH,KAAN,CAAnB,EAAkK,KAAKqE,yBAAL,EAAlK;AAAmM;;AAAAC,EAAAA,MAAM,GAAE;AAAC,SAAKvE,aAAL,CAAmB4B,OAAnB,IAA6B,KAAK1B,WAAL,CAAiBsE,KAAjB,EAA7B,EAAsD,KAAK1D,SAAL,CAAee,iBAAf,EAAtD,EAAyF,KAAK3B,WAAL,GAAiB,KAAKF,aAAL,GAAmB,KAAKC,aAAL,GAAmB,IAAhJ,EAAqJxB,CAAC,CAAC,KAAK0B,sBAAN,EAA6B,KAAKC,qBAAlC,CAAtJ,EAA+M,KAAKD,sBAAL,GAA4B,KAAKC,qBAAL,GAA2B,IAAtQ;AAA2Q;;AAAA4B,EAAAA,WAAW,CAACjF,CAAD,EAAG;AAAC,UAAME,CAAC,GAAC,KAAK6D,SAAL,CAAe2D,UAAf,CAA0B1H,CAA1B,CAAR;AAAqC,WAAO,KAAK2H,iBAAL,CAAuBzH,CAAvB,GAA0B,KAAKiE,SAAL,CAAekB,aAAf,EAA1B,EAAyD,KAAK7B,qBAAL,GAA2B,CAAC,CAArF,EAAuF,KAAKK,sBAAL,GAA4B,KAAKM,SAAL,CAAegC,gBAAf,IAAiC,CAAC,KAAKvB,oBAA1J,EAA+K1E,CAAtL;AAAwL;;AAAAgF,EAAAA,WAAW,CAAClF,CAAD,EAAG;AAAC,SAAKmD,WAAL,CAAiBoD,KAAjB,CAAuBvG,CAAC,CAAC4H,GAAF,CAAMC,EAA7B,GAAiC,KAAK9D,SAAL,CAAe+D,WAAf,CAA2B9H,CAA3B,CAAjC,EAA+DA,CAAC,CAAC+H,IAAF,CAAO,QAAP,EAAiB,MAAI;AAAC/H,MAAAA,CAAC,CAAC6E,OAAF,IAAY,KAAKV,SAAL,CAAekB,aAAf,EAAZ;AAA2C,KAAjE,CAA/D,EAAmI,KAAKlB,SAAL,CAAekB,aAAf,EAAnI;AAAkK;;AAAA2C,EAAAA,yBAAyB,GAAQ;AAAA,QAAPhI,CAAO,uEAAL,IAAK;;AAAC,UAAME,CAAC,GAAC,QAAMF,CAAN,IAASA,CAAC,CAACiI,IAAF,CAAO,GAAP,MAAc,KAAK/E,aAAL,CAAmB+D,QAAnB,CAA4BiB,IAA5B,CAAiCD,IAAjC,CAAsC,GAAtC,CAA/B;;AAA0E,QAAG/H,CAAC,IAAEG,CAAC,CAAC,KAAK2C,oBAAN,CAAP,EAAmC,OAAO,KAAKA,oBAAZ;AAAiChD,IAAAA,CAAC,GAACA,CAAC,IAAE,KAAKkD,aAAL,CAAmB+D,QAAnB,CAA4BiB,IAAjC;AAAsC,UAAK,CAAC/H,CAAD,EAAGI,CAAH,IAAMP,CAAX;AAAA,UAAaS,CAAC,GAAC,IAAIY,CAAJ,CAAM;AAAC8G,MAAAA,KAAK,EAAChI,CAAP;AAASiI,MAAAA,MAAM,EAAC7H,CAAhB;AAAkB8H,MAAAA,MAAM,EAAC,CAAC,IAAIC,UAAJ,CAAenI,CAAC,GAACI,CAAjB,CAAD,CAAzB;AAA+CgI,MAAAA,IAAI,EAAC,IAAID,UAAJ,CAAenI,CAAC,GAACI,CAAjB,CAApD;AAAwEiI,MAAAA,SAAS,EAAC;AAAlF,KAAN,CAAf;AAA8G,WAAOtI,CAAC,KAAG,KAAK8C,oBAAL,GAA0BvC,CAA7B,CAAD,EAAiCA,CAAxC;AAA0C;;AAAA6G,EAAAA,WAAW,CAACtH,CAAD,EAAGE,CAAH,EAAK;AAAC,UAAMC,CAAC,GAAC,CAACI,CAAC,CAACL,CAAD,CAAF,IAAOA,CAAC,CAACwG,MAAjB;AAAA,UAAwB/F,CAAC,GAAC,KAAK8H,wBAAL,EAA1B;AAAA,UAA0D;AAACtE,MAAAA,SAAS,EAACtD;AAAX,QAAc,IAAxE;AAAA,UAA6EE,CAAC,GAAC,CAACF,CAAC,CAACoG,QAAF,CAAWyB,WAAZ,IAAyBrI,CAAC,CAAC4B,CAAC,CAACpB,CAAC,CAAC8H,IAAF,CAAOC,gBAAR,CAAF,CAAzG;AAAA,UAAsI3H,CAAC,GAAC;AAAC4H,MAAAA,gBAAgB,EAAC,CAAC,CAAnB;AAAqBC,MAAAA,mBAAmB,EAACjI,CAAC,CAACiI,mBAA3C;AAA+DC,MAAAA,aAAa,EAACpI,CAAC,GAAC,SAAD,GAAW,KAAKqD,KAAL,CAAW+E,aAApG;AAAkHC,MAAAA,UAAU,EAAC,KAAK3F,qBAAlI;AAAwJ4F,MAAAA,cAAc,EAACtI,CAAvK;AAAyK+F,MAAAA,MAAM,EAACjG,CAAC,CAACN,CAAD,CAAjL;AAAqL+I,MAAAA,aAAa,EAAC,KAAK5F,eAAL,CAAqBtD,CAAC,CAAC8F,KAAvB,CAAnM;AAAiO7B,MAAAA,UAAU,EAACpD,CAAC,CAACoD,UAA9O;AAAyPgD,MAAAA,QAAQ,EAACpG,CAAC,CAACoG,QAApQ;AAA6QkC,MAAAA,iBAAiB,EAACpI;AAA/R,KAAxI;AAA0a,WAAO,KAAKqI,SAAL,CAAepJ,CAAf,EAAiBiB,CAAjB,CAAP;AAA2B;;AAAA8D,EAAAA,aAAa,CAAC/E,CAAD,EAAG;AAAC,WAAOA,CAAC,GAAC,EAAD,GAAI,CAAZ;AAAc;;AAAAgH,EAAAA,mBAAmB,GAAE;AAAC,UAAMhH,CAAC,GAAC,KAAKmE,SAAL,CAAewE,IAAf,CAAoBC,gBAA5B;AAAA,UAA6C1I,CAAC,GAAC,IAAIkB,CAAJ,CAAM;AAACiI,MAAAA,CAAC,EAAC,KAAKlF,SAAL,CAAe+C,UAAf,CAA0BoC,IAA7B;AAAkChI,MAAAA,CAAC,EAAC,KAAK6C,SAAL,CAAe+C,UAAf,CAA0BqC,IAA9D;AAAmEX,MAAAA,gBAAgB,EAAC5I;AAApF,KAAN,CAA/C;AAAA,UAA6I;AAACwJ,MAAAA,MAAM,EAACrJ,CAAR;AAAUsJ,MAAAA,cAAc,EAACpJ,CAAzB;AAA2BqJ,MAAAA,oBAAoB,EAACnJ;AAAhD,QAAmD4B,CAAC,CAAC,KAAK6B,KAAL,CAAW2F,UAAZ,EAAuB3J,CAAvB,CAAjM;AAAA,UAA2NS,CAAC,GAACa,CAAC,CAACsI,MAAF,CAAS;AAAChB,MAAAA,gBAAgB,EAAC5I,CAAlB;AAAoBkI,MAAAA,IAAI,EAAC,GAAzB;AAA6BsB,MAAAA,MAAM,EAACrJ;AAApC,KAAT,CAA7N;AAA8Q,KAAC,MAAIM,CAAC,CAACoJ,MAAF,CAASR,CAAb,IAAgB5I,CAAC,CAACoJ,MAAF,CAASR,CAAT,GAAWnJ,CAAC,CAACmJ,CAA9B,MAAmC5I,CAAC,CAACoJ,MAAF,GAAS3J,CAA5C,GAA+C,KAAK0D,qBAAL,GAA2BrD,CAA1E,EAA4E,KAAK4D,SAAL,CAAe2F,GAAf,CAAmB,UAAnB,EAA8BrJ,CAA9B,CAA5E,EAA6G,KAAK6C,eAAL,GAAqB,QAAMjD,CAAN,GAAQA,CAAR,GAAU,EAA5I;AAA+I;;AAAA8G,EAAAA,wBAAwB,GAAE;AAAC,UAAK;AAAC4C,MAAAA,aAAa,EAAC/J;AAAf,QAAkB,KAAKgE,KAAL,CAAW2F,UAAX,CAAsBK,WAA7C;AAAA,UAAyD9J,CAAC,GAACF,CAAC,CAACA,CAAC,CAACyG,MAAF,GAAS,CAAV,CAA5D;AAAyE,WAAM,CAACvG,CAAC,CAAC+J,MAAF,GAAS/J,CAAC,CAACgK,MAAX,GAAkB,CAAnB,KAAuBhK,CAAC,CAACiK,MAAF,GAASjK,CAAC,CAACkK,MAAX,GAAkB,CAAzC,IAA4C,EAA5C,GAA+C,CAA/C,GAAiD,EAAvD;AAA0D;;AAAuB,QAAjBzC,iBAAiB,CAAC3H,CAAD,EAAGE,CAAH,EAAK;AAAC,QAAG,CAAC,KAAKiD,WAAL,CAAiBkH,GAAjB,CAAqBrK,CAAC,CAAC4H,GAAF,CAAMC,EAA3B,CAAJ,EAAmC;AAAC,UAAG;AAAC,cAAM3H,CAAC,GAAC,MAAM,KAAKiD,WAAL,CAAiBmH,IAAjB,CAAsBtK,CAAC,CAAC4H,GAAxB,CAAd;AAAA,cAA2C;AAAC2C,UAAAA,OAAO,EAAClK;AAAT,YAAY,KAAK2D,KAA5D;AAAkE,YAAIzD,CAAC,GAAC,CAAC,KAAKqE,oBAAN,IAA4B,KAAKT,SAAL,CAAegC,gBAAf,IAAiC,CAAC,KAAK1C,uBAAzE;;AAAiG,YAAG,KAAKI,sBAAL,IAA6B,CAAC,KAAKM,SAAL,CAAeqG,MAA7C,IAAqD,MAAI,KAAKrH,WAAL,CAAiBsD,MAA7E,EAAoF;AAAClG,UAAAA,CAAC,GAAC,CAAC,CAAH;;AAAK,cAAG;AAAC,kBAAM,KAAKiE,YAAL,CAAkB,KAAKb,gBAAL,IAAuB,KAAKA,gBAAL,CAAsB+C,MAA/D,CAAN;AAA6E,WAAjF,CAAiF,OAAMvG,CAAN,EAAQ;AAACU,YAAAA,CAAC,CAACV,CAAD,CAAD,IAAMwC,CAAC,CAAC8H,KAAF,CAAQtK,CAAR,CAAN;AAAiB;;AAAA,eAAK0D,sBAAL,GAA4B,CAAC,CAA7B;AAA+B;;AAAA,SAAC,KAAK4E,wBAAL,EAAD,IAAkC,eAAa,KAAKiC,IAApD,IAA0D,KAAKvG,SAAL,CAAegC,gBAAzE,IAA2F,QAAM,KAAKzC,iBAAtG,IAAyH,KAAK0C,uBAAL,EAAzH;;AAAwJ,cAAM3F,CAAC,GAAC,KAAKyC,aAAL,CAAmByH,aAAnB,CAAiCjI,CAAjC,EAAmC1C,CAAC,CAAC4H,GAArC,CAAR;AAAA,cAAkDjH,CAAC,GAAC,KAAKuC,aAAL,CAAmB0H,iBAAnB,CAAqC5K,CAAC,CAAC4H,GAAvC,CAApD;;AAAgG,cAAM,KAAKiD,gBAAL,CAAsB7K,CAAtB,EAAwB;AAAC8K,UAAAA,MAAM,EAAC5K,CAAR;AAAU6K,UAAAA,gBAAgB,EAAC,KAAKrH,iBAAhC;AAAkDsH,UAAAA,sBAAsB,EAAC,KAAKvH,uBAA9E;AAAsGW,UAAAA,SAAS,EAAC7D,CAAhH;AAAkHgK,UAAAA,OAAO,EAAClK,CAA1H;AAA4H4K,UAAAA,MAAM,EAACxK,CAAnI;AAAqIiF,UAAAA,UAAU,EAAC/E;AAAhJ,SAAxB,CAAN,EAAkLX,CAAC,CAAC+H,IAAF,CAAO,QAAP,EAAiB,MAAI,KAAK5D,SAAL,CAAekB,aAAf,EAArB,CAAlL,EAAwO,KAAKtB,SAAL,CAAemH,QAAf,CAAwBlL,CAAxB,CAAxO;AAAmQ,OAAt4B,CAAs4B,OAAMG,CAAN,EAAQ;AAACU,QAAAA,CAAC,CAACV,CAAD,CAAD,IAAMwC,CAAC,CAAC8H,KAAF,CAAQtK,CAAR,CAAN;AAAiB;;AAAA,WAAKgE,SAAL,CAAekB,aAAf;AAA+B;AAAC;;AAAkB,QAAZb,YAAY,CAACxE,CAAD,EAAG;AAAC,QAAG,MAAI,KAAK+D,SAAL,CAAeoH,QAAf,CAAwB1E,MAA/B,EAAsC;AAAO,UAAM,KAAKI,eAAL,CAAqBuE,UAArB,CAAgC,KAAKpH,KAAL,CAAWqH,cAAX,EAAhC,CAAN,EAAmE,KAAKlH,SAAL,CAAegC,gBAAf,GAAgC,MAAM,KAAKmF,6BAAL,CAAmCtL,CAAnC,CAAtC,IAA6E,KAAKoG,uBAAL,IAA+B,KAAK3C,uBAAL,GAA6B,IAAzI,CAAnE;AAAkN,UAAMvD,CAAC,GAAC,KAAK6D,SAAL,CAAeoH,QAAf,CAAwBI,GAAxB,CAA6B,MAAMvL,CAAN,IAAS,KAAKwL,8BAAL,CAAoCxL,CAApC,EAAsC;AAACyL,MAAAA,KAAK,EAAC,KAAK/H,iBAAZ;AAA8BgI,MAAAA,MAAM,EAAC,KAAKjI;AAA1C,KAAtC,CAAtC,CAAR;AAA0J,UAAM1C,CAAC,CAACb,CAAD,CAAP,EAAW,KAAK6D,SAAL,CAAe4H,aAAf,EAAX;AAA0C;;AAAmC,QAA7BL,6BAA6B,CAACtL,CAAD,EAAG;AAAC,UAAME,CAAC,GAAC;AAACgJ,MAAAA,aAAa,EAAC,KAAK5F,eAAL,CAAqB,KAAKC,WAAL,CAAiBuC,KAAtC,CAAf;AAA4DkD,MAAAA,UAAU,EAAC,KAAK3F,qBAA5E;AAAkGqD,MAAAA,MAAM,EAAC1G;AAAzG,KAAR;AAAA,UAAoHG,CAAC,GAAC,MAAM,KAAK6D,KAAL,CAAW4H,WAAX,CAAuB,KAAKzH,SAAL,CAAewE,IAAf,CAAoBlD,MAA3C,EAAkD,KAAKtB,SAAL,CAAewE,IAAf,CAAoBR,KAAtE,EAA4E,KAAKhE,SAAL,CAAewE,IAAf,CAAoBP,MAAhG,EAAuGlI,CAAvG,CAA5H;AAAsO,QAAG,CAACC,CAAD,IAAI,CAACA,CAAC,CAAC0L,UAAV,EAAqB;AAAO,UAAMxL,CAAC,GAAC,KAAK2D,KAAL,CAAW8H,UAAX,CAAsBC,uBAAtB,CAA8C;AAACF,MAAAA,UAAU,EAAC9J,CAAC,CAAC5B,CAAC,CAAC0L,UAAH,EAAc,KAAK7H,KAAL,CAAWuG,OAAzB,CAAb;AAA+CyB,MAAAA,KAAK,EAAC,KAAK7H,SAAL,CAAewE,IAAf,CAAoBC,gBAApB,CAAqCqD,YAA1F;AAAuGvG,MAAAA,UAAU,EAAC;AAAC2D,QAAAA,CAAC,EAAC,KAAK9F,WAAL,CAAiBmC,UAApB;AAA+BpE,QAAAA,CAAC,EAAC,KAAKiC,WAAL,CAAiBmC;AAAlD,OAAlH;AAAgL6E,MAAAA,OAAO,EAAC,KAAKvG,KAAL,CAAWuG;AAAnM,KAA9C,CAAR;AAAmQ,KAAC,KAAK9B,wBAAL,EAAD,IAAkCpI,CAAlC,IAAqC,cAAYA,CAAC,CAACqK,IAAnD,IAAyD,KAAK1G,KAAL,CAAWkI,QAApE,IAA8E,qBAAmB,KAAKlI,KAAL,CAAWkI,QAAX,CAAoBxB,IAArH,KAA4HrK,CAAC,CAAC8L,MAAF,GAAS9L,CAAC,CAAC8L,MAAF,CAASZ,GAAT,CAAcvL,CAAC,IAAE,MAAIA,CAArB,CAAT,EAAkCK,CAAC,CAAC+L,MAAF,GAASC,IAAI,CAACC,KAAL,CAAW,MAAIjM,CAAC,CAAC+L,MAAjB,CAA3C,EAAoE/L,CAAC,CAACkM,MAAF,GAASF,IAAI,CAACC,KAAL,CAAW,MAAIjM,CAAC,CAACkM,MAAjB,CAAzM,GAAmO,KAAK9I,uBAAL,GAA6BpD,CAAhQ;AAAkQ;;AAAA+F,EAAAA,uBAAuB,GAAE;AAAC,SAAK1C,iBAAL,GAAuB,KAAKM,KAAL,CAAW8H,UAAX,CAAsBC,uBAAtB,CAA8C;AAACF,MAAAA,UAAU,EAAC,IAAZ;AAAiBG,MAAAA,KAAK,EAAC,KAAK7H,SAAL,CAAewE,IAAf,CAAoBC,gBAApB,CAAqCqD,YAA5D;AAAyEvG,MAAAA,UAAU,EAAC;AAAC2D,QAAAA,CAAC,EAAC,KAAK9F,WAAL,CAAiBmC,UAApB;AAA+BpE,QAAAA,CAAC,EAAC,KAAKiC,WAAL,CAAiBmC;AAAlD,OAApF;AAAkJ6E,MAAAA,OAAO,EAAC,KAAKvG,KAAL,CAAWuG;AAArK,KAA9C,CAAvB;AAAoP;;AAAAhD,EAAAA,yBAAyB,GAAM;AAAA,QAALvH,CAAK,uEAAH,CAAC,CAAE;;AAAC,UAAK;AAACwM,MAAAA,GAAG,EAACtM,CAAL;AAAOyJ,MAAAA,UAAU,EAACxJ,CAAlB;AAAoB0F,MAAAA,MAAM,EAACxF;AAA3B,QAA8B,KAAK2D,KAAxC;AAAA,UAA8C;AAACyI,MAAAA,0BAA0B,EAAClM;AAA5B,QAA+B,KAAKyD,KAAL,CAAW0I,2BAAX,CAAuC;AAACD,MAAAA,0BAA0B,EAAC,KAAKzI,KAAL,CAAWyI,0BAAvC;AAAkExI,MAAAA,UAAU,EAAC,KAAKE,SAAL,CAAeF;AAA5F,KAAvC,CAA7E;AAAA,UAA6NxD,CAAC,GAAC,QAAMN,CAAN,IAASA,CAAC,CAACwM,oBAAX,GAAgCtM,CAAC,CAACuM,aAAF,CAAgBrM,CAAhB,CAAhC,GAAmD,IAAlR;AAAA,UAAuRI,CAAC,GAACZ,CAAC,CAACG,CAAD,EAAGO,CAAH,CAA1R;;AAAgS,QAAGE,CAAC,KAAG,KAAKyC,sBAAZ,EAAmC;AAAC,UAAG,QAAM,KAAKA,sBAAX,IAAmC1B,CAAC,CAAC,KAAK0B,sBAAN,EAA6B,KAAKC,qBAAlC,CAApC,EAA6F,KAAKA,qBAAL,GAA2BzB,CAAC,CAACjB,CAAD,EAAG,KAAKqD,KAAL,CAAW6B,MAAX,CAAkB8D,UAArB,CAAzH,EAA0J3J,CAA7J,EAA+J;AAAC,cAAMA,CAAC,GAAC,KAAKkD,aAAL,CAAmB0C,sBAAnB,CAA0C,KAAKzB,SAAL,CAAewE,IAAf,CAAoBhD,KAA9D,CAAR;AAAA,cAA6EzF,CAAC,GAAC,KAAKoD,eAAL,CAAqBtD,CAAC,CAAC8F,KAAvB,CAA/E;;AAA6GtE,QAAAA,CAAC,CAACb,CAAD,EAAG,KAAK0C,qBAAR,EAA8B,KAAKc,SAAL,CAAewE,IAAf,CAAoBlD,MAAlD,EAAyD,KAAKtB,SAAL,CAAewE,IAAf,CAAoBjD,UAA7E,EAAwFxF,CAAxF,EAA0F,KAAK8D,KAAL,CAAW6B,MAAX,CAAkBI,QAAlB,CAA2BC,QAArH,CAAD;AAAgI;;AAAA,WAAK9C,sBAAL,GAA4BzC,CAA5B;AAA8B;AAAC;;AAAe,QAAT4D,SAAS,GAAE;AAAC,UAAM,KAAKsC,eAAL,CAAqBuE,UAArB,CAAgC,KAAKpH,KAAL,CAAWqH,cAAX,EAAhC,CAAN,EAAmE,KAAKlH,SAAL,CAAegC,gBAAf,IAAiC,KAAKC,uBAAL,EAApG,EAAmI,KAAKmB,yBAAL,CAA+B,CAAC,CAAhC,CAAnI,EAAsK,KAAKpE,WAAL,CAAiB0J,KAAjB,EAAtK;AAA+L,UAAM7M,CAAC,GAAC,EAAR;AAAW,SAAKiD,aAAL,CAAmB6J,KAAnB,CAAyBC,OAAzB,CAAkC7M,CAAC,IAAEF,CAAC,CAACsK,IAAF,CAAO,KAAK3C,iBAAL,CAAuBzH,CAAvB,CAAP,CAArC,GAAyE,MAAMa,CAAC,CAACf,CAAD,CAAhF;AAAoF;;AAAlxR,CAArB;AAAyyRA,CAAC,CAAC,CAACiB,CAAC,EAAF,CAAD,EAAO4B,CAAC,CAACmK,SAAT,EAAmB,aAAnB,EAAiC,KAAK,CAAtC,CAAD,EAA0ChN,CAAC,CAAC,CAACiB,CAAC,EAAF,CAAD,EAAO4B,CAAC,CAACmK,SAAT,EAAmB,wBAAnB,EAA4C,KAAK,CAAjD,CAA3C,EAA+FhN,CAAC,CAAC,CAACiB,CAAC,EAAF,CAAD,EAAO4B,CAAC,CAACmK,SAAT,EAAmB,UAAnB,EAA8B,KAAK,CAAnC,CAAhG,EAAsIhN,CAAC,CAAC,CAACiB,CAAC,EAAF,CAAD,EAAO4B,CAAC,CAACmK,SAAT,EAAmB,WAAnB,EAA+B,KAAK,CAApC,CAAvI,EAA8KhN,CAAC,CAAC,CAACiB,CAAC,EAAF,CAAD,EAAO4B,CAAC,CAACmK,SAAT,EAAmB,OAAnB,EAA2B,KAAK,CAAhC,CAA/K,EAAkNhN,CAAC,CAAC,CAACiB,CAAC,EAAF,CAAD,EAAO4B,CAAC,CAACmK,SAAT,EAAmB,WAAnB,EAA+B,KAAK,CAApC,CAAnN,EAA0PhN,CAAC,CAAC,CAACiB,CAAC,EAAF,CAAD,EAAO4B,CAAC,CAACmK,SAAT,EAAmB,MAAnB,EAA0B,KAAK,CAA/B,CAA3P,EAA6RhN,CAAC,CAAC,CAACiB,CAAC,EAAF,CAAD,EAAO4B,CAAC,CAACmK,SAAT,EAAmB,uBAAnB,EAA2C,IAA3C,CAA9R,EAA+UhN,CAAC,CAAC,CAACiB,CAAC,EAAF,CAAD,EAAO4B,CAAC,CAACmK,SAAT,EAAmB,sBAAnB,EAA0C,IAA1C,CAAhV,EAAgYhN,CAAC,CAAC,CAACiB,CAAC,EAAF,CAAD,EAAO4B,CAAC,CAACmK,SAAT,EAAmB,YAAnB,EAAgC,KAAK,CAArC,CAAjY,EAAyahN,CAAC,CAAC,CAACiB,CAAC,EAAF,CAAD,EAAO4B,CAAC,CAACmK,SAAT,EAAmB,UAAnB,EAA8B,IAA9B,CAA1a,EAA8cnK,CAAC,GAAC7C,CAAC,CAAC,CAACmB,CAAC,CAAC,uDAAD,CAAF,CAAD,EAA8D0B,CAA9D,CAAjd;AAAkhB,SAAOA,CAAC,IAAIoK,wBAAZ","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../../chunks/tslib.es6.js\";import\"../../../../geometry.js\";import{HandleOwner as t}from\"../../../../core/HandleOwner.js\";import i from\"../../../../core/Logger.js\";import{isSome as s,isNone as r,unwrap as l}from\"../../../../core/maybe.js\";import{debounce as a,isAbortError as o,eachAlways as h}from\"../../../../core/promiseUtils.js\";import{property as n}from\"../../../../core/accessorSupport/decorators/property.js\";import\"../../../../core/arrayUtils.js\";import\"../../../../core/has.js\";import\"../../../../core/accessorSupport/ensureType.js\";import{subclass as c}from\"../../../../core/accessorSupport/decorators/subclass.js\";import u from\"../../../../geometry/Point.js\";import p from\"../../../../layers/support/PixelBlock.js\";import y from\"../../../../layers/support/TileInfo.js\";import{update as d,unregister as m,register as g,getRasterId as _}from\"../../../../layers/support/rasterDatasets/RawBlockCache.js\";import{extractBands as f}from\"../../../../layers/support/rasterFunctions/pixelUtils.js\";import{getWorldWidth as w,computeProjectedScales as b}from\"../../../../layers/support/rasterFunctions/rasterProjectionHelper.js\";import\"../../tiling/PagedTileQueue.js\";import P from\"../../tiling/TileInfoView.js\";import\"../../tiling/TileKey.js\";import I from\"../../tiling/TileQueue.js\";import v from\"../../tiling/TileStrategy.js\";import{getWebGL1Capabilities as C}from\"../../../webgl/capabilities.js\";import R from\"../../../../geometry/Extent.js\";const V=[0,0],T=i.getLogger(\"esri.views.2d.layers.ImageryTileLayerView2D\");let S=class extends t{constructor(){super(...arguments),this._emptyTilePixelBlock=null,this._tileStrategy=null,this._tileInfoView=null,this._fetchQueue=null,this._blockCacheRegistryUrl=null,this._blockCacheRegistryId=null,this._srcResolutions=null,this.previousLOD=null,this._needBlockCacheUpdate=!1,this._globalSymbolizerParams=null,this._symbolizerParams=null,this._abortController=null,this._isCustomTilingScheme=!1,this._globalUpdateRequested=!1,this.attached=!1,this.container=null,this.layer=null,this.timeExtent=null,this.redrawOrRefetch=a(((e,t)=>!this.previousLOD||this.layerView.suspended?Promise.resolve():e?this.doRefresh():this._redrawImage(t)))}get useWebGLForProcessing(){var e;return null==(e=this._get(\"useWebGLForProcessing\"))||e}set useWebGLForProcessing(e){this._set(\"useWebGLForProcessing\",e)}get useProgressiveUpdate(){return null==this._get(\"useProgressiveUpdate\")||this._get(\"useProgressiveUpdate\")}set useProgressiveUpdate(e){if(this._tileStrategy&&this.useProgressiveUpdate!==e){this._tileStrategy.destroy(),this.container.removeAllChildren();const t=this._getCacheSize(e);this._tileStrategy=new v({cachePolicy:\"purge\",acquireTile:e=>this.acquireTile(e),releaseTile:e=>this.releaseTile(e),cacheSize:t,tileInfoView:this._tileInfoView}),this._set(\"useProgressiveUpdate\",e),this.layerView.requestUpdate()}}update(e){this._fetchQueue.pause(),this._fetchQueue.state=e.state,this._tileStrategy.update(e),this._fetchQueue.resume();const{extent:t,resolution:i,scale:s}=e.state,r=this._tileInfoView.getClosestInfoForScale(s);if(this.layer.raster){var l;if(!this.useProgressiveUpdate||this._needBlockCacheUpdate){const e=this._srcResolutions[r.level],s=t.toJSON?t:R.fromJSON(t);d(this._blockCacheRegistryUrl,this._blockCacheRegistryId,s,i,e,this.layer.raster.ioConfig.sampling)}this._needBlockCacheUpdate=!1,(null==(l=this.previousLOD)?void 0:l.level)!==r.level&&(this.previousLOD=r,null==this._symbolizerParams||this.layerView.hasTilingEffects||this._updateSymbolizerParams(),this._tileStrategy.updateCacheSize(0))}}moveEnd(){!this.layerView.hasTilingEffects&&this.useProgressiveUpdate||(this._abortController&&this._abortController.abort(),this._abortController=new AbortController,0===this._fetchQueue.length&&this._redrawImage(this._abortController.signal).then((()=>{this._globalUpdateRequested=!1,this.layerView.requestUpdate()})));const e=this._getCacheSize(this.useProgressiveUpdate);this._tileStrategy.updateCacheSize(e),this.layerView.requestUpdate()}get updating(){return this._fetchQueue.updating||this._globalUpdateRequested||!(!this.updatingHandles||!this.updatingHandles.updating)}attach(){C().supportsTextureFloat||(this.useWebGLForProcessing=!1),this._initializeTileInfo(),this._tileInfoView=new P(this.layerView.tileInfo,this.layerView.fullExtent);const e=this._computeFetchConcurrency();this._fetchQueue=new I({tileInfoView:this._tileInfoView,concurrency:e,process:(e,t)=>this._fetchTile1(e,t)});const t=this._getCacheSize(this.useProgressiveUpdate);this._tileStrategy=new v({cachePolicy:\"purge\",acquireTile:e=>this.acquireTile(e),releaseTile:e=>this.releaseTile(e),cacheSize:t,tileInfoView:this._tileInfoView}),this._updateBlockCacheRegistry()}detach(){this._tileStrategy.destroy(),this._fetchQueue.clear(),this.container.removeAllChildren(),this._fetchQueue=this._tileStrategy=this._tileInfoView=null,m(this._blockCacheRegistryUrl,this._blockCacheRegistryId),this._blockCacheRegistryUrl=this._blockCacheRegistryId=null}acquireTile(e){const t=this.container.createTile(e);return this._enqueueTileFetch(t),this.layerView.requestUpdate(),this._needBlockCacheUpdate=!0,this._globalUpdateRequested=this.layerView.hasTilingEffects||!this.useProgressiveUpdate,t}releaseTile(e){this._fetchQueue.abort(e.key.id),this.container.removeChild(e),e.once(\"detach\",(()=>{e.destroy(),this.layerView.requestUpdate()})),this.layerView.requestUpdate()}createEmptyTilePixelBlock(e=null){const t=null==e||e.join(\",\")===this._tileInfoView.tileInfo.size.join(\",\");if(t&&s(this._emptyTilePixelBlock))return this._emptyTilePixelBlock;e=e||this._tileInfoView.tileInfo.size;const[i,r]=e,l=new p({width:i,height:r,pixels:[new Uint8Array(i*r)],mask:new Uint8Array(i*r),pixelType:\"u8\"});return t&&(this._emptyTilePixelBlock=l),l}_fetchTile1(e,t){const i=!r(t)&&t.signal,a=this.canUseWebGLForProcessing(),{layerView:o}=this,h=!o.tileInfo.isWrappable&&s(w(o.view.spatialReference)),n={allowPartialFill:!0,datumTransformation:o.datumTransformation,interpolation:a?\"nearest\":this.layer.interpolation,registryId:this._blockCacheRegistryId,requestRawData:a,signal:l(i),srcResolution:this._srcResolutions[e.level],timeExtent:o.timeExtent,tileInfo:o.tileInfo,disableWrapAround:h};return this.fetchTile(e,n)}_getCacheSize(e){return e?40:0}_initializeTileInfo(){const e=this.layerView.view.spatialReference,t=new u({x:this.layerView.fullExtent.xmin,y:this.layerView.fullExtent.ymax,spatialReference:e}),{scales:i,srcResolutions:s,isCustomTilingScheme:r}=b(this.layer.rasterInfo,e),l=y.create({spatialReference:e,size:512,scales:i});(0===l.origin.x||l.origin.x>t.x)&&(l.origin=t),this._isCustomTilingScheme=r,this.layerView.set(\"tileInfo\",l),this._srcResolutions=null!=s?s:[]}_computeFetchConcurrency(){const{blockBoundary:e}=this.layer.rasterInfo.storageInfo,t=e[e.length-1];return(t.maxCol-t.minCol+1)*(t.maxRow-t.minRow+1)>64?2:10}async _enqueueTileFetch(e,t){if(!this._fetchQueue.has(e.key.id)){try{const t=await this._fetchQueue.push(e.key),{bandIds:s}=this.layer;let r=!this.useProgressiveUpdate||this.layerView.hasTilingEffects&&!this._globalSymbolizerParams;if(this._globalUpdateRequested&&!this.layerView.moving&&0===this._fetchQueue.length){r=!1;try{await this._redrawImage(this._abortController&&this._abortController.signal)}catch(i){o(i)&&T.error(i)}this._globalUpdateRequested=!1}!this.canUseWebGLForProcessing()&&\"rasterVF\"!==this.type||this.layerView.hasTilingEffects||null!=this._symbolizerParams||this._updateSymbolizerParams();const l=this._tileInfoView.getTileCoords(V,e.key),a=this._tileInfoView.getTileResolution(e.key);await this.updateTileSource(e,{source:t,symbolizerParams:this._symbolizerParams,globalSymbolizerParams:this._globalSymbolizerParams,suspended:r,bandIds:s,coords:l,resolution:a}),e.once(\"attach\",(()=>this.layerView.requestUpdate())),this.container.addChild(e)}catch(i){o(i)||T.error(i)}this.layerView.requestUpdate()}}async _redrawImage(e){if(0===this.container.children.length)return;await this.updatingHandles.addPromise(this.layer.updateRenderer()),this.layerView.hasTilingEffects?await this._updateGlobalSymbolizerParams(e):(this._updateSymbolizerParams(),this._globalSymbolizerParams=null);const t=this.container.children.map((async e=>this.updateTileSymbolizerParameters(e,{local:this._symbolizerParams,global:this._globalSymbolizerParams})));await h(t),this.container.requestRender()}async _updateGlobalSymbolizerParams(e){const t={srcResolution:this._srcResolutions[this.previousLOD.level],registryId:this._blockCacheRegistryId,signal:e},i=await this.layer.fetchPixels(this.layerView.view.extent,this.layerView.view.width,this.layerView.view.height,t);if(!i||!i.pixelBlock)return;const s=this.layer.symbolizer.generateWebGLParameters({pixelBlock:f(i.pixelBlock,this.layer.bandIds),isGCS:this.layerView.view.spatialReference.isGeographic,resolution:{x:this.previousLOD.resolution,y:this.previousLOD.resolution},bandIds:this.layer.bandIds});!this.canUseWebGLForProcessing()&&s&&\"stretch\"===s.type&&this.layer.renderer&&\"raster-stretch\"===this.layer.renderer.type&&(s.factor=s.factor.map((e=>255*e)),s.outMin=Math.round(255*s.outMin),s.outMax=Math.round(255*s.outMax)),this._globalSymbolizerParams=s}_updateSymbolizerParams(){this._symbolizerParams=this.layer.symbolizer.generateWebGLParameters({pixelBlock:null,isGCS:this.layerView.view.spatialReference.isGeographic,resolution:{x:this.previousLOD.resolution,y:this.previousLOD.resolution},bandIds:this.layer.bandIds})}_updateBlockCacheRegistry(e=!1){const{url:t,rasterInfo:i,raster:s}=this.layer,{multidimensionalDefinition:r}=this.layer.normalizeRasterFetchOptions({multidimensionalDefinition:this.layer.multidimensionalDefinition,timeExtent:this.layerView.timeExtent}),l=null!=i&&i.multidimensionalInfo?s.getSliceIndex(r):null,a=_(t,l);if(a!==this._blockCacheRegistryUrl){if(null!=this._blockCacheRegistryUrl&&m(this._blockCacheRegistryUrl,this._blockCacheRegistryId),this._blockCacheRegistryId=g(a,this.layer.raster.rasterInfo),e){const e=this._tileInfoView.getClosestInfoForScale(this.layerView.view.scale),t=this._srcResolutions[e.level];d(a,this._blockCacheRegistryId,this.layerView.view.extent,this.layerView.view.resolution,t,this.layer.raster.ioConfig.sampling)}this._blockCacheRegistryUrl=a}}async doRefresh(){await this.updatingHandles.addPromise(this.layer.updateRenderer()),this.layerView.hasTilingEffects||this._updateSymbolizerParams(),this._updateBlockCacheRegistry(!0),this._fetchQueue.reset();const e=[];this._tileStrategy.tiles.forEach((t=>e.push(this._enqueueTileFetch(t)))),await h(e)}};e([n()],S.prototype,\"_fetchQueue\",void 0),e([n()],S.prototype,\"_globalUpdateRequested\",void 0),e([n()],S.prototype,\"attached\",void 0),e([n()],S.prototype,\"container\",void 0),e([n()],S.prototype,\"layer\",void 0),e([n()],S.prototype,\"layerView\",void 0),e([n()],S.prototype,\"type\",void 0),e([n()],S.prototype,\"useWebGLForProcessing\",null),e([n()],S.prototype,\"useProgressiveUpdate\",null),e([n()],S.prototype,\"timeExtent\",void 0),e([n()],S.prototype,\"updating\",null),S=e([c(\"esri.views.2d.layers.imagery.BaseImageryTileSubView2D\")],S);export{S as BaseImageryTileSubView2D};\n"]},"metadata":{},"sourceType":"module"}