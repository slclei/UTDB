{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport e from \"../../../../../../core/Error.js\";\nimport t from \"../../../../../../core/Logger.js\";\nimport { clamp as i } from \"../../../../../../core/mathUtils.js\";\nimport { unwrap as o, isNone as n } from \"../../../../../../core/maybe.js\";\nimport { pt2px as s } from \"../../../../../../core/screenUtils.js\";\nimport { Alignment as r } from \"../../../../../../symbols/cim/enums.js\";\nimport { isMapAligned as a, getAlignmentFromPlacement as l, getXDirection as h, getYDirection as c } from \"../../alignmentUtils.js\";\nimport { premultiplyAlphaRGBAArray as m } from \"../../color.js\";\nimport { TEXT_PLACEMENT_PADDING as f } from \"../../definitions.js\";\nimport { WGLGeometryType as _ } from \"../../enums.js\";\nimport { i8888to32 as p } from \"../../number.js\";\nimport { LabelMaterialKey as g } from \"../../materialKey/MaterialKey.js\";\nimport { smoothPaths as u, pathDivide as d } from \"./segmentUtils.js\";\nimport x from \"./WGLTextTemplate.js\";\n\nconst y = t.getLogger(\"esri.views.2d.engine.webgl.WGLLabelTemplate\"),\n      b = function (t) {\n  let i = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : \"mapview-labeling\";\n  return y.error(new e(i, t));\n},\n      L = 1,\n      P = 0,\n      S = 4;\n\nfunction v(e, t) {\n  const o = !!e.minScale && t.scaleToZoom(e.minScale) || 0;\n  return i(o, 0, 25.5);\n}\n\nfunction w(e, t) {\n  const o = !!e.maxScale && t.scaleToZoom(e.maxScale) || 255;\n  return i(o, 0, 25.5);\n}\n\nfunction M(e) {\n  const t = new Map();\n  return i => (t.has(i) || t.set(i, e(i)), t.get(i));\n}\n\nconst Z = M(e => {\n  let t = 0;\n  if (0 === e) return 1 / 0;\n\n  for (; !(e % 2);) t++, e /= 2;\n\n  return t;\n}),\n      A = e => Math.floor(127 * e + 127),\n      O = e => Math.floor(10 * e),\n      z = e => Math.round(e * (254 / 360));\n\nclass I extends x {\n  constructor(e, t, i, o) {\n    var n, h, c;\n    super(e, i.font.size, i.haloSize || 0, i.font.size, i.color && m(i.color) || 0, i.haloColor && m(i.haloColor) || 0, i.horizontalAlignment, i.verticalAlignment, a(t.labelPlacement) ? r.MAP : r.SCREEN, i.font.decoration, !1, i.angle || 0, i.xoffset, i.yoffset, i.lineWidth, i.lineHeight, null, null, null, null, null), this._outLineLabelAngle = 0, this._refPlacementPadding = 0, this._refPlacementDirX = 0, this._refPlacementDirY = 0, this._refOffsetX = 0, this._refOffsetY = 0, this._zoomLevel = 0, this.geometryType = _.LABEL, this._allowOverrun = null != (n = t.allowOverrun) && n, this._repeatLabel = null == (h = t.repeatLabel) || h, this._labelPosition = null != (c = t.labelPosition) ? c : \"curved\";\n    const p = v(t, o),\n          u = w(t, o),\n          d = t.labelPlacement,\n          [x, y] = l(d);\n    this._xAlignD = x, this._yAlignD = y, this._minZoom = p, this._maxZoom = u, this._refPlacementPadding = s(i.haloSize) + f, this._repeatLabelDistance = t.repeatLabelDistance ? s(t.repeatLabelDistance) : 128;\n    const b = g.load(e);\n    b.sdf = !0, this._materialKey = b.data;\n  }\n\n  static fromLabelClass(e, t) {\n    if (\"esriServerLinePlacementCenterAlong\" === e.labelPlacement) {\n      const t = e.symbol;\n      t.xoffset = 0, t.yoffset = 0, t.angle = 0, t.font.decoration = \"none\";\n    }\n\n    return new I(e.materialKey, e, e.symbol, t);\n  }\n\n  get _shapedBox() {\n    return o(this._shapingInfo).bounds;\n  }\n\n  setZoomLevel(e) {\n    this._zoomLevel = e;\n  }\n\n  bindReferenceTemplate(e) {\n    let t = h(this._xAlignD),\n        i = c(this._yAlignD);\n    if (this._refOffsetX = 0, this._refOffsetY = 0, n(e)) return void (this._refSymbolAndPlacementOffset = p(0, 0, A(t), A(i)));\n\n    if (\"circle\" === e.boundsType && (t || i)) {\n      const e = Math.sqrt(t * t + i * i);\n      t /= e, i /= e;\n    }\n\n    const o = Math.max(e.height, e.width),\n          s = this._refPlacementPadding * S;\n    this._refSymbolAndPlacementOffset = p(s, o, A(t), A(i)), this._referenceSize = o, this._refPlacementDirX = t, this._refPlacementDirY = i, this._refOffsetX = e.xOffset, this._refOffsetY = e.yOffset;\n  }\n\n  _write(e, t) {\n    if (n(this._shapingInfo)) return;\n    const i = this._shapingInfo,\n          o = t.getDisplayId(),\n          s = \"esriGeometryPolygon\" === t.geometryType ? t.readLegacyCentroid() : t.readLegacyGeometry();\n    if (s) switch (this.current = {\n      out: e,\n      inId: o,\n      inShaping: i,\n      zoomLevel: this._zoomLevel\n    }, t.geometryType) {\n      case \"esriGeometryPolyline\":\n        this._placeLineLabels(s);\n\n        break;\n\n      case \"esriGeometryPoint\":\n      case \"esriGeometryPolygon\":\n        this._placePointLabels(s);\n\n        break;\n\n      default:\n        b(\"mapview-labeling\", `Geometry of type ${t.geometryType} is not supported`);\n    }\n  }\n\n  _isVisible(e, t) {\n    const i = O(this.current.zoomLevel);\n    return O(e) <= i && i <= O(t);\n  }\n\n  _placePointLabels(e) {\n    const {\n      out: t,\n      inId: i,\n      inShaping: o\n    } = this.current;\n\n    this._writeGlyphs(t, i, e, o);\n  }\n\n  _placeLineLabels(e) {\n    const t = u(e.paths, this.current.inShaping.bounds.width),\n          i = this._placeSubdivGlyphs.bind(this),\n          o = (this._shapedBox.width + this._repeatLabelDistance) / (1 << L);\n\n    for (const n of t) d(n, o, i, this._repeatLabel);\n  }\n\n  _placeSubdivGlyphs(e, t, i, o) {\n    const n = Z(t),\n          s = this._shapedBox.width / (1 << L),\n          r = Math.sqrt(this._repeatLabelDistance) / (1 << L),\n          a = Math.min(i, o - i),\n          l = Math.log2(a / (r + s / 2)),\n          h = 0 === t ? l : Math.min(n, l),\n          c = Math.max(this._minZoom, this.current.zoomLevel + L - h),\n          m = this.current.zoomLevel - c,\n          f = this._shapedBox.width / 2 * 2 ** m;\n    this.current.inShaping.isMultiline ? 0 === t && this._placeStraight(e, c) : this._allowOverrun && m < 0 ? this._placeStraightAlong(e, this._minZoom) : \"parallel\" === this._labelPosition ? this._placeStraightAlong(e, c) : \"curved\" === this._labelPosition && this._placeCurved(e, c, f);\n  }\n\n  _placeStraight(e, t) {\n    const {\n      out: i,\n      inId: o,\n      inShaping: n\n    } = this.current;\n\n    this._writeGlyphs(i, o, e, n, t);\n  }\n\n  _placeCurved(e, t, i) {\n    const {\n      out: o,\n      inId: n\n    } = this.current;\n    o.metricStart(n, t, e.x, e.y, 0, 0, 0, 0);\n    const s = e.clone(),\n          r = e.angle * (180 / Math.PI) % 360,\n          a = (e.angle * (180 / Math.PI) + 180) % 360;\n    this._outLineLabelAngle = z(r), this._placeFirst(s, t, 1), this._placeBack(e, s, t, i, 1), this._placeForward(e, s, t, i, 1), this._outLineLabelAngle = z(a), this._placeFirst(s, t, 0), this._placeBack(e, s, t, i, 0), this._placeForward(e, s, t, i, 0), o.metricEnd();\n  }\n\n  _placeStraightAlong(e, t) {\n    const {\n      out: i,\n      inId: o\n    } = this.current;\n    i.metricStart(o, t, e.x, e.y, 0, 0, 0, 0);\n    const n = e.clone(),\n          s = e.angle * (180 / Math.PI) % 360,\n          r = (e.angle * (180 / Math.PI) + 180) % 360;\n    this._outLineLabelAngle = z(s), this._placeFirst(n, t, 1, !0), this._outLineLabelAngle = z(r), this._placeFirst(n, t, 0, !0), i.metricEnd();\n  }\n\n  _placeBack(e, t, i, o, n) {\n    const s = e.clone();\n    let r = e.backwardLength + P;\n\n    for (; s.prev() && !(r >= o);) this._placeOnSegment(s, t, r, i, -1, n), r += s.length + P;\n  }\n\n  _placeForward(e, t, i, o, n) {\n    const s = e.clone();\n    let r = e.remainingLength + P;\n\n    for (; s.next() && !(r >= o);) this._placeOnSegment(s, t, r, i, 1, n), r += s.length + P;\n  }\n\n  _placeFirst(e, t, i) {\n    let o = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : !1;\n    const n = e,\n          s = this.current.inShaping,\n          r = s.glyphs,\n          a = this.current.zoomLevel,\n          {\n      out: l,\n      inId: h\n    } = this.current;\n\n    for (const c of r) {\n      const r = c.x > s.bounds.x ? i : 1 - i,\n            m = r * e.remainingLength + (1 - r) * e.backwardLength,\n            f = Math.abs(c.x + c.width / 2 - s.bounds.x),\n            _ = Math.max(0, a + Math.log2(f / (m + P))),\n            p = Math.max(t, o ? 0 : _);\n\n      if (c.maxZoom = 25, c.angle = e.angle + (1 - i) * Math.PI, c.minZoom = p, this._writeGlyph(l, h, n.x, n.y, c), i && this._isVisible(c.minZoom, c.maxZoom)) {\n        const e = c.bounds;\n        l.metricBoxWrite(e.center[0], e.center[1], e.width, e.height);\n      }\n    }\n  }\n\n  _placeOnSegment(e, t, i, o, n, s) {\n    const r = this.current.inShaping.glyphs,\n          {\n      out: a,\n      inId: l\n    } = this.current,\n          h = this.current.inShaping,\n          c = this.current.zoomLevel,\n          m = e.dx / e.length,\n          f = e.dy / e.length,\n          _ = {\n      x: e.x + i * -n * m,\n      y: e.y + i * -n * f\n    };\n\n    for (const p of r) {\n      const r = p.x > h.bounds.x ? s : 1 - s;\n      if (!(r && 1 === n || !r && -1 === n)) continue;\n      const m = Math.abs(p.x + p.width / 2 - h.bounds.x),\n            f = Math.max(0, c + Math.log2(m / i) - .1),\n            g = Math.max(o, c + Math.log2(m / (i + e.length + P)));\n\n      if (0 !== f && (p.angle = e.angle + (1 - s) * Math.PI, p.minZoom = g, p.maxZoom = f, this._writeGlyph(a, l, _.x, _.y, p), s && this._isVisible(p.minZoom, p.maxZoom))) {\n        const i = p.bounds,\n              o = e.x - t.x,\n              n = e.y - t.y;\n        a.metricBoxWrite(i.center[0] + o, i.center[1] + n, i.width, i.height);\n      }\n    }\n  }\n\n  _writeGlyphs(e, t, i, o) {\n    let n = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : this._minZoom;\n    if (i.x < 0 || i.x >= 512 || i.y < 0 || i.y >= 512) return;\n    const s = i.x + this._refOffsetX,\n          r = i.y - this._refOffsetY;\n\n    for (const c of o.glyphs) c.minZoom = n, c.maxZoom = this._maxZoom, this._writeGlyph(e, t, s, r, c);\n\n    const a = this._refPlacementDirX,\n          l = this._refPlacementDirY,\n          h = o.boundsT;\n    e.metricStart(t, n, s, r, a, l, this._referenceSize, this._materialKey), e.metricBoxWrite(h.center[0], h.center[1], h.width, h.height), e.metricEnd();\n  }\n\n  _writeVertexCommon(e, t, i, o) {\n    const n = this._color,\n          s = this._haloColor,\n          r = p(0, 0, this._size, this._haloSize),\n          a = Math.max(o.minZoom, this._minZoom),\n          l = Math.min(o.maxZoom, this._maxZoom),\n          h = p(O(a), O(l), this._outLineLabelAngle, 0);\n    e.vertexWrite(i), e.vertexWrite(t), e.vertexWrite(n), e.vertexWrite(s), e.vertexWrite(r), e.vertexWrite(this._refSymbolAndPlacementOffset), e.vertexWrite(h);\n  }\n\n}\n\nexport { I as default };","map":{"version":3,"sources":["D:/Github/CUSP_DataBase/CUSP_DB/src/main/gis/node_modules/@arcgis/core/views/2d/engine/webgl/mesh/templates/WGLLabelTemplate.js"],"names":["e","t","clamp","i","unwrap","o","isNone","n","pt2px","s","Alignment","r","isMapAligned","a","getAlignmentFromPlacement","l","getXDirection","h","getYDirection","c","premultiplyAlphaRGBAArray","m","TEXT_PLACEMENT_PADDING","f","WGLGeometryType","_","i8888to32","p","LabelMaterialKey","g","smoothPaths","u","pathDivide","d","x","y","getLogger","b","error","L","P","S","v","minScale","scaleToZoom","w","maxScale","M","Map","has","set","get","Z","A","Math","floor","O","z","round","I","constructor","font","size","haloSize","color","haloColor","horizontalAlignment","verticalAlignment","labelPlacement","MAP","SCREEN","decoration","angle","xoffset","yoffset","lineWidth","lineHeight","_outLineLabelAngle","_refPlacementPadding","_refPlacementDirX","_refPlacementDirY","_refOffsetX","_refOffsetY","_zoomLevel","geometryType","LABEL","_allowOverrun","allowOverrun","_repeatLabel","repeatLabel","_labelPosition","labelPosition","_xAlignD","_yAlignD","_minZoom","_maxZoom","_repeatLabelDistance","repeatLabelDistance","load","sdf","_materialKey","data","fromLabelClass","symbol","materialKey","_shapedBox","_shapingInfo","bounds","setZoomLevel","bindReferenceTemplate","_refSymbolAndPlacementOffset","boundsType","sqrt","max","height","width","_referenceSize","xOffset","yOffset","_write","getDisplayId","readLegacyCentroid","readLegacyGeometry","current","out","inId","inShaping","zoomLevel","_placeLineLabels","_placePointLabels","_isVisible","_writeGlyphs","paths","_placeSubdivGlyphs","bind","min","log2","isMultiline","_placeStraight","_placeStraightAlong","_placeCurved","metricStart","clone","PI","_placeFirst","_placeBack","_placeForward","metricEnd","backwardLength","prev","_placeOnSegment","length","remainingLength","next","glyphs","abs","maxZoom","minZoom","_writeGlyph","metricBoxWrite","center","dx","dy","boundsT","_writeVertexCommon","_color","_haloColor","_size","_haloSize","vertexWrite","default"],"mappings":"AAAA;AACA;AACA;AACA;AACA,OAAOA,CAAP,MAAa,iCAAb;AAA+C,OAAOC,CAAP,MAAa,kCAAb;AAAgD,SAAOC,KAAK,IAAIC,CAAhB,QAAsB,qCAAtB;AAA4D,SAAOC,MAAM,IAAIC,CAAjB,EAAmBC,MAAM,IAAIC,CAA7B,QAAmC,iCAAnC;AAAqE,SAAOC,KAAK,IAAIC,CAAhB,QAAsB,uCAAtB;AAA8D,SAAOC,SAAS,IAAIC,CAApB,QAA0B,wCAA1B;AAAmE,SAAOC,YAAY,IAAIC,CAAvB,EAAyBC,yBAAyB,IAAIC,CAAtD,EAAwDC,aAAa,IAAIC,CAAzE,EAA2EC,aAAa,IAAIC,CAA5F,QAAkG,yBAAlG;AAA4H,SAAOC,yBAAyB,IAAIC,CAApC,QAA0C,gBAA1C;AAA2D,SAAOC,sBAAsB,IAAIC,CAAjC,QAAuC,sBAAvC;AAA8D,SAAOC,eAAe,IAAIC,CAA1B,QAAgC,gBAAhC;AAAiD,SAAOC,SAAS,IAAIC,CAApB,QAA0B,iBAA1B;AAA4C,SAAOC,gBAAgB,IAAIC,CAA3B,QAAiC,kCAAjC;AAAoE,SAAOC,WAAW,IAAIC,CAAtB,EAAwBC,UAAU,IAAIC,CAAtC,QAA4C,mBAA5C;AAAgE,OAAOC,CAAP,MAAa,sBAAb;;AAAoC,MAAMC,CAAC,GAAClC,CAAC,CAACmC,SAAF,CAAY,6CAAZ,CAAR;AAAA,MAAmEC,CAAC,GAAC,UAACpC,CAAD;AAAA,MAAGE,CAAH,uEAAK,kBAAL;AAAA,SAA0BgC,CAAC,CAACG,KAAF,CAAQ,IAAItC,CAAJ,CAAMG,CAAN,EAAQF,CAAR,CAAR,CAA1B;AAAA,CAArE;AAAA,MAAmHsC,CAAC,GAAC,CAArH;AAAA,MAAuHC,CAAC,GAAC,CAAzH;AAAA,MAA2HC,CAAC,GAAC,CAA7H;;AAA+H,SAASC,CAAT,CAAW1C,CAAX,EAAaC,CAAb,EAAe;AAAC,QAAMI,CAAC,GAAC,CAAC,CAACL,CAAC,CAAC2C,QAAJ,IAAc1C,CAAC,CAAC2C,WAAF,CAAc5C,CAAC,CAAC2C,QAAhB,CAAd,IAAyC,CAAjD;AAAmD,SAAOxC,CAAC,CAACE,CAAD,EAAG,CAAH,EAAK,IAAL,CAAR;AAAmB;;AAAA,SAASwC,CAAT,CAAW7C,CAAX,EAAaC,CAAb,EAAe;AAAC,QAAMI,CAAC,GAAC,CAAC,CAACL,CAAC,CAAC8C,QAAJ,IAAc7C,CAAC,CAAC2C,WAAF,CAAc5C,CAAC,CAAC8C,QAAhB,CAAd,IAAyC,GAAjD;AAAqD,SAAO3C,CAAC,CAACE,CAAD,EAAG,CAAH,EAAK,IAAL,CAAR;AAAmB;;AAAA,SAAS0C,CAAT,CAAW/C,CAAX,EAAa;AAAC,QAAMC,CAAC,GAAC,IAAI+C,GAAJ,EAAR;AAAgB,SAAO7C,CAAC,KAAGF,CAAC,CAACgD,GAAF,CAAM9C,CAAN,KAAUF,CAAC,CAACiD,GAAF,CAAM/C,CAAN,EAAQH,CAAC,CAACG,CAAD,CAAT,CAAV,EAAwBF,CAAC,CAACkD,GAAF,CAAMhD,CAAN,CAA3B,CAAR;AAA6C;;AAAA,MAAMiD,CAAC,GAACL,CAAC,CAAE/C,CAAC,IAAE;AAAC,MAAIC,CAAC,GAAC,CAAN;AAAQ,MAAG,MAAID,CAAP,EAAS,OAAO,IAAE,CAAT;;AAAW,SAAK,EAAEA,CAAC,GAAC,CAAJ,CAAL,GAAaC,CAAC,IAAGD,CAAC,IAAE,CAAP;;AAAS,SAAOC,CAAP;AAAS,CAAjE,CAAT;AAAA,MAA6EoD,CAAC,GAACrD,CAAC,IAAEsD,IAAI,CAACC,KAAL,CAAW,MAAIvD,CAAJ,GAAM,GAAjB,CAAlF;AAAA,MAAwGwD,CAAC,GAACxD,CAAC,IAAEsD,IAAI,CAACC,KAAL,CAAW,KAAGvD,CAAd,CAA7G;AAAA,MAA8HyD,CAAC,GAACzD,CAAC,IAAEsD,IAAI,CAACI,KAAL,CAAW1D,CAAC,IAAE,MAAI,GAAN,CAAZ,CAAnI;;AAA2J,MAAM2D,CAAN,SAAgBzB,CAAhB,CAAiB;AAAC0B,EAAAA,WAAW,CAAC5D,CAAD,EAAGC,CAAH,EAAKE,CAAL,EAAOE,CAAP,EAAS;AAAC,QAAIE,CAAJ,EAAMU,CAAN,EAAQE,CAAR;AAAU,UAAMnB,CAAN,EAAQG,CAAC,CAAC0D,IAAF,CAAOC,IAAf,EAAoB3D,CAAC,CAAC4D,QAAF,IAAY,CAAhC,EAAkC5D,CAAC,CAAC0D,IAAF,CAAOC,IAAzC,EAA8C3D,CAAC,CAAC6D,KAAF,IAAS3C,CAAC,CAAClB,CAAC,CAAC6D,KAAH,CAAV,IAAqB,CAAnE,EAAqE7D,CAAC,CAAC8D,SAAF,IAAa5C,CAAC,CAAClB,CAAC,CAAC8D,SAAH,CAAd,IAA6B,CAAlG,EAAoG9D,CAAC,CAAC+D,mBAAtG,EAA0H/D,CAAC,CAACgE,iBAA5H,EAA8ItD,CAAC,CAACZ,CAAC,CAACmE,cAAH,CAAD,GAAoBzD,CAAC,CAAC0D,GAAtB,GAA0B1D,CAAC,CAAC2D,MAA1K,EAAiLnE,CAAC,CAAC0D,IAAF,CAAOU,UAAxL,EAAmM,CAAC,CAApM,EAAsMpE,CAAC,CAACqE,KAAF,IAAS,CAA/M,EAAiNrE,CAAC,CAACsE,OAAnN,EAA2NtE,CAAC,CAACuE,OAA7N,EAAqOvE,CAAC,CAACwE,SAAvO,EAAiPxE,CAAC,CAACyE,UAAnP,EAA8P,IAA9P,EAAmQ,IAAnQ,EAAwQ,IAAxQ,EAA6Q,IAA7Q,EAAkR,IAAlR,GAAwR,KAAKC,kBAAL,GAAwB,CAAhT,EAAkT,KAAKC,oBAAL,GAA0B,CAA5U,EAA8U,KAAKC,iBAAL,GAAuB,CAArW,EAAuW,KAAKC,iBAAL,GAAuB,CAA9X,EAAgY,KAAKC,WAAL,GAAiB,CAAjZ,EAAmZ,KAAKC,WAAL,GAAiB,CAApa,EAAsa,KAAKC,UAAL,GAAgB,CAAtb,EAAwb,KAAKC,YAAL,GAAkB3D,CAAC,CAAC4D,KAA5c,EAAkd,KAAKC,aAAL,GAAmB,SAAO/E,CAAC,GAACN,CAAC,CAACsF,YAAX,KAA0BhF,CAA/f,EAAigB,KAAKiF,YAAL,GAAkB,SAAOvE,CAAC,GAAChB,CAAC,CAACwF,WAAX,KAAyBxE,CAA5iB,EAA8iB,KAAKyE,cAAL,GAAoB,SAAOvE,CAAC,GAAClB,CAAC,CAAC0F,aAAX,IAA0BxE,CAA1B,GAA4B,QAA9lB;AAAumB,UAAMQ,CAAC,GAACe,CAAC,CAACzC,CAAD,EAAGI,CAAH,CAAT;AAAA,UAAe0B,CAAC,GAACc,CAAC,CAAC5C,CAAD,EAAGI,CAAH,CAAlB;AAAA,UAAwB4B,CAAC,GAAChC,CAAC,CAACmE,cAA5B;AAAA,UAA2C,CAAClC,CAAD,EAAGC,CAAH,IAAMpB,CAAC,CAACkB,CAAD,CAAlD;AAAsD,SAAK2D,QAAL,GAAc1D,CAAd,EAAgB,KAAK2D,QAAL,GAAc1D,CAA9B,EAAgC,KAAK2D,QAAL,GAAcnE,CAA9C,EAAgD,KAAKoE,QAAL,GAAchE,CAA9D,EAAgE,KAAK+C,oBAAL,GAA0BrE,CAAC,CAACN,CAAC,CAAC4D,QAAH,CAAD,GAAcxC,CAAxG,EAA0G,KAAKyE,oBAAL,GAA0B/F,CAAC,CAACgG,mBAAF,GAAsBxF,CAAC,CAACR,CAAC,CAACgG,mBAAH,CAAvB,GAA+C,GAAnL;AAAuL,UAAM5D,CAAC,GAACR,CAAC,CAACqE,IAAF,CAAOlG,CAAP,CAAR;AAAkBqC,IAAAA,CAAC,CAAC8D,GAAF,GAAM,CAAC,CAAP,EAAS,KAAKC,YAAL,GAAkB/D,CAAC,CAACgE,IAA7B;AAAkC;;AAAqB,SAAdC,cAAc,CAACtG,CAAD,EAAGC,CAAH,EAAK;AAAC,QAAG,yCAAuCD,CAAC,CAACoE,cAA5C,EAA2D;AAAC,YAAMnE,CAAC,GAACD,CAAC,CAACuG,MAAV;AAAiBtG,MAAAA,CAAC,CAACwE,OAAF,GAAU,CAAV,EAAYxE,CAAC,CAACyE,OAAF,GAAU,CAAtB,EAAwBzE,CAAC,CAACuE,KAAF,GAAQ,CAAhC,EAAkCvE,CAAC,CAAC4D,IAAF,CAAOU,UAAP,GAAkB,MAApD;AAA2D;;AAAA,WAAO,IAAIZ,CAAJ,CAAM3D,CAAC,CAACwG,WAAR,EAAoBxG,CAApB,EAAsBA,CAAC,CAACuG,MAAxB,EAA+BtG,CAA/B,CAAP;AAAyC;;AAAc,MAAVwG,UAAU,GAAE;AAAC,WAAOpG,CAAC,CAAC,KAAKqG,YAAN,CAAD,CAAqBC,MAA5B;AAAmC;;AAAAC,EAAAA,YAAY,CAAC5G,CAAD,EAAG;AAAC,SAAKmF,UAAL,GAAgBnF,CAAhB;AAAkB;;AAAA6G,EAAAA,qBAAqB,CAAC7G,CAAD,EAAG;AAAC,QAAIC,CAAC,GAACgB,CAAC,CAAC,KAAK2E,QAAN,CAAP;AAAA,QAAuBzF,CAAC,GAACgB,CAAC,CAAC,KAAK0E,QAAN,CAA1B;AAA0C,QAAG,KAAKZ,WAAL,GAAiB,CAAjB,EAAmB,KAAKC,WAAL,GAAiB,CAApC,EAAsC3E,CAAC,CAACP,CAAD,CAA1C,EAA8C,OAAO,MAAK,KAAK8G,4BAAL,GAAkCnF,CAAC,CAAC,CAAD,EAAG,CAAH,EAAK0B,CAAC,CAACpD,CAAD,CAAN,EAAUoD,CAAC,CAAClD,CAAD,CAAX,CAAxC,CAAP;;AAAgE,QAAG,aAAWH,CAAC,CAAC+G,UAAb,KAA0B9G,CAAC,IAAEE,CAA7B,CAAH,EAAmC;AAAC,YAAMH,CAAC,GAACsD,IAAI,CAAC0D,IAAL,CAAU/G,CAAC,GAACA,CAAF,GAAIE,CAAC,GAACA,CAAhB,CAAR;AAA2BF,MAAAA,CAAC,IAAED,CAAH,EAAKG,CAAC,IAAEH,CAAR;AAAU;;AAAA,UAAMK,CAAC,GAACiD,IAAI,CAAC2D,GAAL,CAASjH,CAAC,CAACkH,MAAX,EAAkBlH,CAAC,CAACmH,KAApB,CAAR;AAAA,UAAmC1G,CAAC,GAAC,KAAKqE,oBAAL,GAA0BrC,CAA/D;AAAiE,SAAKqE,4BAAL,GAAkCnF,CAAC,CAAClB,CAAD,EAAGJ,CAAH,EAAKgD,CAAC,CAACpD,CAAD,CAAN,EAAUoD,CAAC,CAAClD,CAAD,CAAX,CAAnC,EAAmD,KAAKiH,cAAL,GAAoB/G,CAAvE,EAAyE,KAAK0E,iBAAL,GAAuB9E,CAAhG,EAAkG,KAAK+E,iBAAL,GAAuB7E,CAAzH,EAA2H,KAAK8E,WAAL,GAAiBjF,CAAC,CAACqH,OAA9I,EAAsJ,KAAKnC,WAAL,GAAiBlF,CAAC,CAACsH,OAAzK;AAAiL;;AAAAC,EAAAA,MAAM,CAACvH,CAAD,EAAGC,CAAH,EAAK;AAAC,QAAGM,CAAC,CAAC,KAAKmG,YAAN,CAAJ,EAAwB;AAAO,UAAMvG,CAAC,GAAC,KAAKuG,YAAb;AAAA,UAA0BrG,CAAC,GAACJ,CAAC,CAACuH,YAAF,EAA5B;AAAA,UAA6C/G,CAAC,GAAC,0BAAwBR,CAAC,CAACmF,YAA1B,GAAuCnF,CAAC,CAACwH,kBAAF,EAAvC,GAA8DxH,CAAC,CAACyH,kBAAF,EAA7G;AAAoI,QAAGjH,CAAH,EAAK,QAAO,KAAKkH,OAAL,GAAa;AAACC,MAAAA,GAAG,EAAC5H,CAAL;AAAO6H,MAAAA,IAAI,EAACxH,CAAZ;AAAcyH,MAAAA,SAAS,EAAC3H,CAAxB;AAA0B4H,MAAAA,SAAS,EAAC,KAAK5C;AAAzC,KAAb,EAAkElF,CAAC,CAACmF,YAA3E;AAAyF,WAAI,sBAAJ;AAA2B,aAAK4C,gBAAL,CAAsBvH,CAAtB;;AAAyB;;AAAM,WAAI,mBAAJ;AAAwB,WAAI,qBAAJ;AAA0B,aAAKwH,iBAAL,CAAuBxH,CAAvB;;AAA0B;;AAAM;AAAQ4B,QAAAA,CAAC,CAAC,kBAAD,EAAqB,oBAAmBpC,CAAC,CAACmF,YAAa,mBAAvD,CAAD;AAA7O;AAA0T;;AAAA8C,EAAAA,UAAU,CAAClI,CAAD,EAAGC,CAAH,EAAK;AAAC,UAAME,CAAC,GAACqD,CAAC,CAAC,KAAKmE,OAAL,CAAaI,SAAd,CAAT;AAAkC,WAAOvE,CAAC,CAACxD,CAAD,CAAD,IAAMG,CAAN,IAASA,CAAC,IAAEqD,CAAC,CAACvD,CAAD,CAApB;AAAwB;;AAAAgI,EAAAA,iBAAiB,CAACjI,CAAD,EAAG;AAAC,UAAK;AAAC4H,MAAAA,GAAG,EAAC3H,CAAL;AAAO4H,MAAAA,IAAI,EAAC1H,CAAZ;AAAc2H,MAAAA,SAAS,EAACzH;AAAxB,QAA2B,KAAKsH,OAArC;;AAA6C,SAAKQ,YAAL,CAAkBlI,CAAlB,EAAoBE,CAApB,EAAsBH,CAAtB,EAAwBK,CAAxB;AAA2B;;AAAA2H,EAAAA,gBAAgB,CAAChI,CAAD,EAAG;AAAC,UAAMC,CAAC,GAAC8B,CAAC,CAAC/B,CAAC,CAACoI,KAAH,EAAS,KAAKT,OAAL,CAAaG,SAAb,CAAuBnB,MAAvB,CAA8BQ,KAAvC,CAAT;AAAA,UAAuDhH,CAAC,GAAC,KAAKkI,kBAAL,CAAwBC,IAAxB,CAA6B,IAA7B,CAAzD;AAAA,UAA4FjI,CAAC,GAAC,CAAC,KAAKoG,UAAL,CAAgBU,KAAhB,GAAsB,KAAKnB,oBAA5B,KAAmD,KAAGzD,CAAtD,CAA9F;;AAAuJ,SAAI,MAAMhC,CAAV,IAAeN,CAAf,EAAiBgC,CAAC,CAAC1B,CAAD,EAAGF,CAAH,EAAKF,CAAL,EAAO,KAAKqF,YAAZ,CAAD;AAA2B;;AAAA6C,EAAAA,kBAAkB,CAACrI,CAAD,EAAGC,CAAH,EAAKE,CAAL,EAAOE,CAAP,EAAS;AAAC,UAAME,CAAC,GAAC6C,CAAC,CAACnD,CAAD,CAAT;AAAA,UAAaQ,CAAC,GAAC,KAAKgG,UAAL,CAAgBU,KAAhB,IAAuB,KAAG5E,CAA1B,CAAf;AAAA,UAA4C5B,CAAC,GAAC2C,IAAI,CAAC0D,IAAL,CAAU,KAAKhB,oBAAf,KAAsC,KAAGzD,CAAzC,CAA9C;AAAA,UAA0F1B,CAAC,GAACyC,IAAI,CAACiF,GAAL,CAASpI,CAAT,EAAWE,CAAC,GAACF,CAAb,CAA5F;AAAA,UAA4GY,CAAC,GAACuC,IAAI,CAACkF,IAAL,CAAU3H,CAAC,IAAEF,CAAC,GAACF,CAAC,GAAC,CAAN,CAAX,CAA9G;AAAA,UAAmIQ,CAAC,GAAC,MAAIhB,CAAJ,GAAMc,CAAN,GAAQuC,IAAI,CAACiF,GAAL,CAAShI,CAAT,EAAWQ,CAAX,CAA7I;AAAA,UAA2JI,CAAC,GAACmC,IAAI,CAAC2D,GAAL,CAAS,KAAKnB,QAAd,EAAuB,KAAK6B,OAAL,CAAaI,SAAb,GAAuBxF,CAAvB,GAAyBtB,CAAhD,CAA7J;AAAA,UAAgNI,CAAC,GAAC,KAAKsG,OAAL,CAAaI,SAAb,GAAuB5G,CAAzO;AAAA,UAA2OI,CAAC,GAAC,KAAKkF,UAAL,CAAgBU,KAAhB,GAAsB,CAAtB,GAAwB,KAAG9F,CAAxQ;AAA0Q,SAAKsG,OAAL,CAAaG,SAAb,CAAuBW,WAAvB,GAAmC,MAAIxI,CAAJ,IAAO,KAAKyI,cAAL,CAAoB1I,CAApB,EAAsBmB,CAAtB,CAA1C,GAAmE,KAAKmE,aAAL,IAAoBjE,CAAC,GAAC,CAAtB,GAAwB,KAAKsH,mBAAL,CAAyB3I,CAAzB,EAA2B,KAAK8F,QAAhC,CAAxB,GAAkE,eAAa,KAAKJ,cAAlB,GAAiC,KAAKiD,mBAAL,CAAyB3I,CAAzB,EAA2BmB,CAA3B,CAAjC,GAA+D,aAAW,KAAKuE,cAAhB,IAAgC,KAAKkD,YAAL,CAAkB5I,CAAlB,EAAoBmB,CAApB,EAAsBI,CAAtB,CAApO;AAA6P;;AAAAmH,EAAAA,cAAc,CAAC1I,CAAD,EAAGC,CAAH,EAAK;AAAC,UAAK;AAAC2H,MAAAA,GAAG,EAACzH,CAAL;AAAO0H,MAAAA,IAAI,EAACxH,CAAZ;AAAcyH,MAAAA,SAAS,EAACvH;AAAxB,QAA2B,KAAKoH,OAArC;;AAA6C,SAAKQ,YAAL,CAAkBhI,CAAlB,EAAoBE,CAApB,EAAsBL,CAAtB,EAAwBO,CAAxB,EAA0BN,CAA1B;AAA6B;;AAAA2I,EAAAA,YAAY,CAAC5I,CAAD,EAAGC,CAAH,EAAKE,CAAL,EAAO;AAAC,UAAK;AAACyH,MAAAA,GAAG,EAACvH,CAAL;AAAOwH,MAAAA,IAAI,EAACtH;AAAZ,QAAe,KAAKoH,OAAzB;AAAiCtH,IAAAA,CAAC,CAACwI,WAAF,CAActI,CAAd,EAAgBN,CAAhB,EAAkBD,CAAC,CAACkC,CAApB,EAAsBlC,CAAC,CAACmC,CAAxB,EAA0B,CAA1B,EAA4B,CAA5B,EAA8B,CAA9B,EAAgC,CAAhC;AAAmC,UAAM1B,CAAC,GAACT,CAAC,CAAC8I,KAAF,EAAR;AAAA,UAAkBnI,CAAC,GAACX,CAAC,CAACwE,KAAF,IAAS,MAAIlB,IAAI,CAACyF,EAAlB,IAAsB,GAA1C;AAAA,UAA8ClI,CAAC,GAAC,CAACb,CAAC,CAACwE,KAAF,IAAS,MAAIlB,IAAI,CAACyF,EAAlB,IAAsB,GAAvB,IAA4B,GAA5E;AAAgF,SAAKlE,kBAAL,GAAwBpB,CAAC,CAAC9C,CAAD,CAAzB,EAA6B,KAAKqI,WAAL,CAAiBvI,CAAjB,EAAmBR,CAAnB,EAAqB,CAArB,CAA7B,EAAqD,KAAKgJ,UAAL,CAAgBjJ,CAAhB,EAAkBS,CAAlB,EAAoBR,CAApB,EAAsBE,CAAtB,EAAwB,CAAxB,CAArD,EAAgF,KAAK+I,aAAL,CAAmBlJ,CAAnB,EAAqBS,CAArB,EAAuBR,CAAvB,EAAyBE,CAAzB,EAA2B,CAA3B,CAAhF,EAA8G,KAAK0E,kBAAL,GAAwBpB,CAAC,CAAC5C,CAAD,CAAvI,EAA2I,KAAKmI,WAAL,CAAiBvI,CAAjB,EAAmBR,CAAnB,EAAqB,CAArB,CAA3I,EAAmK,KAAKgJ,UAAL,CAAgBjJ,CAAhB,EAAkBS,CAAlB,EAAoBR,CAApB,EAAsBE,CAAtB,EAAwB,CAAxB,CAAnK,EAA8L,KAAK+I,aAAL,CAAmBlJ,CAAnB,EAAqBS,CAArB,EAAuBR,CAAvB,EAAyBE,CAAzB,EAA2B,CAA3B,CAA9L,EAA4NE,CAAC,CAAC8I,SAAF,EAA5N;AAA0O;;AAAAR,EAAAA,mBAAmB,CAAC3I,CAAD,EAAGC,CAAH,EAAK;AAAC,UAAK;AAAC2H,MAAAA,GAAG,EAACzH,CAAL;AAAO0H,MAAAA,IAAI,EAACxH;AAAZ,QAAe,KAAKsH,OAAzB;AAAiCxH,IAAAA,CAAC,CAAC0I,WAAF,CAAcxI,CAAd,EAAgBJ,CAAhB,EAAkBD,CAAC,CAACkC,CAApB,EAAsBlC,CAAC,CAACmC,CAAxB,EAA0B,CAA1B,EAA4B,CAA5B,EAA8B,CAA9B,EAAgC,CAAhC;AAAmC,UAAM5B,CAAC,GAACP,CAAC,CAAC8I,KAAF,EAAR;AAAA,UAAkBrI,CAAC,GAACT,CAAC,CAACwE,KAAF,IAAS,MAAIlB,IAAI,CAACyF,EAAlB,IAAsB,GAA1C;AAAA,UAA8CpI,CAAC,GAAC,CAACX,CAAC,CAACwE,KAAF,IAAS,MAAIlB,IAAI,CAACyF,EAAlB,IAAsB,GAAvB,IAA4B,GAA5E;AAAgF,SAAKlE,kBAAL,GAAwBpB,CAAC,CAAChD,CAAD,CAAzB,EAA6B,KAAKuI,WAAL,CAAiBzI,CAAjB,EAAmBN,CAAnB,EAAqB,CAArB,EAAuB,CAAC,CAAxB,CAA7B,EAAwD,KAAK4E,kBAAL,GAAwBpB,CAAC,CAAC9C,CAAD,CAAjF,EAAqF,KAAKqI,WAAL,CAAiBzI,CAAjB,EAAmBN,CAAnB,EAAqB,CAArB,EAAuB,CAAC,CAAxB,CAArF,EAAgHE,CAAC,CAACgJ,SAAF,EAAhH;AAA8H;;AAAAF,EAAAA,UAAU,CAACjJ,CAAD,EAAGC,CAAH,EAAKE,CAAL,EAAOE,CAAP,EAASE,CAAT,EAAW;AAAC,UAAME,CAAC,GAACT,CAAC,CAAC8I,KAAF,EAAR;AAAkB,QAAInI,CAAC,GAACX,CAAC,CAACoJ,cAAF,GAAiB5G,CAAvB;;AAAyB,WAAK/B,CAAC,CAAC4I,IAAF,MAAU,EAAE1I,CAAC,IAAEN,CAAL,CAAf,GAAwB,KAAKiJ,eAAL,CAAqB7I,CAArB,EAAuBR,CAAvB,EAAyBU,CAAzB,EAA2BR,CAA3B,EAA6B,CAAC,CAA9B,EAAgCI,CAAhC,GAAmCI,CAAC,IAAEF,CAAC,CAAC8I,MAAF,GAAS/G,CAA/C;AAAiD;;AAAA0G,EAAAA,aAAa,CAAClJ,CAAD,EAAGC,CAAH,EAAKE,CAAL,EAAOE,CAAP,EAASE,CAAT,EAAW;AAAC,UAAME,CAAC,GAACT,CAAC,CAAC8I,KAAF,EAAR;AAAkB,QAAInI,CAAC,GAACX,CAAC,CAACwJ,eAAF,GAAkBhH,CAAxB;;AAA0B,WAAK/B,CAAC,CAACgJ,IAAF,MAAU,EAAE9I,CAAC,IAAEN,CAAL,CAAf,GAAwB,KAAKiJ,eAAL,CAAqB7I,CAArB,EAAuBR,CAAvB,EAAyBU,CAAzB,EAA2BR,CAA3B,EAA6B,CAA7B,EAA+BI,CAA/B,GAAkCI,CAAC,IAAEF,CAAC,CAAC8I,MAAF,GAAS/G,CAA9C;AAAgD;;AAAAwG,EAAAA,WAAW,CAAChJ,CAAD,EAAGC,CAAH,EAAKE,CAAL,EAAY;AAAA,QAALE,CAAK,uEAAH,CAAC,CAAE;AAAC,UAAME,CAAC,GAACP,CAAR;AAAA,UAAUS,CAAC,GAAC,KAAKkH,OAAL,CAAaG,SAAzB;AAAA,UAAmCnH,CAAC,GAACF,CAAC,CAACiJ,MAAvC;AAAA,UAA8C7I,CAAC,GAAC,KAAK8G,OAAL,CAAaI,SAA7D;AAAA,UAAuE;AAACH,MAAAA,GAAG,EAAC7G,CAAL;AAAO8G,MAAAA,IAAI,EAAC5G;AAAZ,QAAe,KAAK0G,OAA3F;;AAAmG,SAAI,MAAMxG,CAAV,IAAeR,CAAf,EAAiB;AAAC,YAAMA,CAAC,GAACQ,CAAC,CAACe,CAAF,GAAIzB,CAAC,CAACkG,MAAF,CAASzE,CAAb,GAAe/B,CAAf,GAAiB,IAAEA,CAA3B;AAAA,YAA6BkB,CAAC,GAACV,CAAC,GAACX,CAAC,CAACwJ,eAAJ,GAAoB,CAAC,IAAE7I,CAAH,IAAMX,CAAC,CAACoJ,cAA3D;AAAA,YAA0E7H,CAAC,GAAC+B,IAAI,CAACqG,GAAL,CAASxI,CAAC,CAACe,CAAF,GAAIf,CAAC,CAACgG,KAAF,GAAQ,CAAZ,GAAc1G,CAAC,CAACkG,MAAF,CAASzE,CAAhC,CAA5E;AAAA,YAA+GT,CAAC,GAAC6B,IAAI,CAAC2D,GAAL,CAAS,CAAT,EAAWpG,CAAC,GAACyC,IAAI,CAACkF,IAAL,CAAUjH,CAAC,IAAEF,CAAC,GAACmB,CAAJ,CAAX,CAAb,CAAjH;AAAA,YAAkJb,CAAC,GAAC2B,IAAI,CAAC2D,GAAL,CAAShH,CAAT,EAAWI,CAAC,GAAC,CAAD,GAAGoB,CAAf,CAApJ;;AAAsK,UAAGN,CAAC,CAACyI,OAAF,GAAU,EAAV,EAAazI,CAAC,CAACqD,KAAF,GAAQxE,CAAC,CAACwE,KAAF,GAAQ,CAAC,IAAErE,CAAH,IAAMmD,IAAI,CAACyF,EAAxC,EAA2C5H,CAAC,CAAC0I,OAAF,GAAUlI,CAArD,EAAuD,KAAKmI,WAAL,CAAiB/I,CAAjB,EAAmBE,CAAnB,EAAqBV,CAAC,CAAC2B,CAAvB,EAAyB3B,CAAC,CAAC4B,CAA3B,EAA6BhB,CAA7B,CAAvD,EAAuFhB,CAAC,IAAE,KAAK+H,UAAL,CAAgB/G,CAAC,CAAC0I,OAAlB,EAA0B1I,CAAC,CAACyI,OAA5B,CAA7F,EAAkI;AAAC,cAAM5J,CAAC,GAACmB,CAAC,CAACwF,MAAV;AAAiB5F,QAAAA,CAAC,CAACgJ,cAAF,CAAiB/J,CAAC,CAACgK,MAAF,CAAS,CAAT,CAAjB,EAA6BhK,CAAC,CAACgK,MAAF,CAAS,CAAT,CAA7B,EAAyChK,CAAC,CAACmH,KAA3C,EAAiDnH,CAAC,CAACkH,MAAnD;AAA2D;AAAC;AAAC;;AAAAoC,EAAAA,eAAe,CAACtJ,CAAD,EAAGC,CAAH,EAAKE,CAAL,EAAOE,CAAP,EAASE,CAAT,EAAWE,CAAX,EAAa;AAAC,UAAME,CAAC,GAAC,KAAKgH,OAAL,CAAaG,SAAb,CAAuB4B,MAA/B;AAAA,UAAsC;AAAC9B,MAAAA,GAAG,EAAC/G,CAAL;AAAOgH,MAAAA,IAAI,EAAC9G;AAAZ,QAAe,KAAK4G,OAA1D;AAAA,UAAkE1G,CAAC,GAAC,KAAK0G,OAAL,CAAaG,SAAjF;AAAA,UAA2F3G,CAAC,GAAC,KAAKwG,OAAL,CAAaI,SAA1G;AAAA,UAAoH1G,CAAC,GAACrB,CAAC,CAACiK,EAAF,GAAKjK,CAAC,CAACuJ,MAA7H;AAAA,UAAoIhI,CAAC,GAACvB,CAAC,CAACkK,EAAF,GAAKlK,CAAC,CAACuJ,MAA7I;AAAA,UAAoJ9H,CAAC,GAAC;AAACS,MAAAA,CAAC,EAAClC,CAAC,CAACkC,CAAF,GAAI/B,CAAC,GAAC,CAACI,CAAH,GAAKc,CAAZ;AAAcc,MAAAA,CAAC,EAACnC,CAAC,CAACmC,CAAF,GAAIhC,CAAC,GAAC,CAACI,CAAH,GAAKgB;AAAzB,KAAtJ;;AAAkL,SAAI,MAAMI,CAAV,IAAehB,CAAf,EAAiB;AAAC,YAAMA,CAAC,GAACgB,CAAC,CAACO,CAAF,GAAIjB,CAAC,CAAC0F,MAAF,CAASzE,CAAb,GAAezB,CAAf,GAAiB,IAAEA,CAA3B;AAA6B,UAAG,EAAEE,CAAC,IAAE,MAAIJ,CAAP,IAAU,CAACI,CAAD,IAAI,CAAC,CAAD,KAAKJ,CAArB,CAAH,EAA2B;AAAS,YAAMc,CAAC,GAACiC,IAAI,CAACqG,GAAL,CAAShI,CAAC,CAACO,CAAF,GAAIP,CAAC,CAACwF,KAAF,GAAQ,CAAZ,GAAclG,CAAC,CAAC0F,MAAF,CAASzE,CAAhC,CAAR;AAAA,YAA2CX,CAAC,GAAC+B,IAAI,CAAC2D,GAAL,CAAS,CAAT,EAAW9F,CAAC,GAACmC,IAAI,CAACkF,IAAL,CAAUnH,CAAC,GAAClB,CAAZ,CAAF,GAAiB,EAA5B,CAA7C;AAAA,YAA6E0B,CAAC,GAACyB,IAAI,CAAC2D,GAAL,CAAS5G,CAAT,EAAWc,CAAC,GAACmC,IAAI,CAACkF,IAAL,CAAUnH,CAAC,IAAElB,CAAC,GAACH,CAAC,CAACuJ,MAAJ,GAAW/G,CAAb,CAAX,CAAb,CAA/E;;AAAyH,UAAG,MAAIjB,CAAJ,KAAQI,CAAC,CAAC6C,KAAF,GAAQxE,CAAC,CAACwE,KAAF,GAAQ,CAAC,IAAE/D,CAAH,IAAM6C,IAAI,CAACyF,EAA3B,EAA8BpH,CAAC,CAACkI,OAAF,GAAUhI,CAAxC,EAA0CF,CAAC,CAACiI,OAAF,GAAUrI,CAApD,EAAsD,KAAKuI,WAAL,CAAiBjJ,CAAjB,EAAmBE,CAAnB,EAAqBU,CAAC,CAACS,CAAvB,EAAyBT,CAAC,CAACU,CAA3B,EAA6BR,CAA7B,CAAtD,EAAsFlB,CAAC,IAAE,KAAKyH,UAAL,CAAgBvG,CAAC,CAACkI,OAAlB,EAA0BlI,CAAC,CAACiI,OAA5B,CAAjG,CAAH,EAA0I;AAAC,cAAMzJ,CAAC,GAACwB,CAAC,CAACgF,MAAV;AAAA,cAAiBtG,CAAC,GAACL,CAAC,CAACkC,CAAF,GAAIjC,CAAC,CAACiC,CAAzB;AAAA,cAA2B3B,CAAC,GAACP,CAAC,CAACmC,CAAF,GAAIlC,CAAC,CAACkC,CAAnC;AAAqCtB,QAAAA,CAAC,CAACkJ,cAAF,CAAiB5J,CAAC,CAAC6J,MAAF,CAAS,CAAT,IAAY3J,CAA7B,EAA+BF,CAAC,CAAC6J,MAAF,CAAS,CAAT,IAAYzJ,CAA3C,EAA6CJ,CAAC,CAACgH,KAA/C,EAAqDhH,CAAC,CAAC+G,MAAvD;AAA+D;AAAC;AAAC;;AAAAiB,EAAAA,YAAY,CAACnI,CAAD,EAAGC,CAAH,EAAKE,CAAL,EAAOE,CAAP,EAAyB;AAAA,QAAhBE,CAAgB,uEAAd,KAAKuF,QAAS;AAAC,QAAG3F,CAAC,CAAC+B,CAAF,GAAI,CAAJ,IAAO/B,CAAC,CAAC+B,CAAF,IAAK,GAAZ,IAAiB/B,CAAC,CAACgC,CAAF,GAAI,CAArB,IAAwBhC,CAAC,CAACgC,CAAF,IAAK,GAAhC,EAAoC;AAAO,UAAM1B,CAAC,GAACN,CAAC,CAAC+B,CAAF,GAAI,KAAK+C,WAAjB;AAAA,UAA6BtE,CAAC,GAACR,CAAC,CAACgC,CAAF,GAAI,KAAK+C,WAAxC;;AAAoD,SAAI,MAAM/D,CAAV,IAAed,CAAC,CAACqJ,MAAjB,EAAwBvI,CAAC,CAAC0I,OAAF,GAAUtJ,CAAV,EAAYY,CAAC,CAACyI,OAAF,GAAU,KAAK7D,QAA3B,EAAoC,KAAK+D,WAAL,CAAiB9J,CAAjB,EAAmBC,CAAnB,EAAqBQ,CAArB,EAAuBE,CAAvB,EAAyBQ,CAAzB,CAApC;;AAAgE,UAAMN,CAAC,GAAC,KAAKkE,iBAAb;AAAA,UAA+BhE,CAAC,GAAC,KAAKiE,iBAAtC;AAAA,UAAwD/D,CAAC,GAACZ,CAAC,CAAC8J,OAA5D;AAAoEnK,IAAAA,CAAC,CAAC6I,WAAF,CAAc5I,CAAd,EAAgBM,CAAhB,EAAkBE,CAAlB,EAAoBE,CAApB,EAAsBE,CAAtB,EAAwBE,CAAxB,EAA0B,KAAKqG,cAA/B,EAA8C,KAAKhB,YAAnD,GAAiEpG,CAAC,CAAC+J,cAAF,CAAiB9I,CAAC,CAAC+I,MAAF,CAAS,CAAT,CAAjB,EAA6B/I,CAAC,CAAC+I,MAAF,CAAS,CAAT,CAA7B,EAAyC/I,CAAC,CAACkG,KAA3C,EAAiDlG,CAAC,CAACiG,MAAnD,CAAjE,EAA4HlH,CAAC,CAACmJ,SAAF,EAA5H;AAA0I;;AAAAiB,EAAAA,kBAAkB,CAACpK,CAAD,EAAGC,CAAH,EAAKE,CAAL,EAAOE,CAAP,EAAS;AAAC,UAAME,CAAC,GAAC,KAAK8J,MAAb;AAAA,UAAoB5J,CAAC,GAAC,KAAK6J,UAA3B;AAAA,UAAsC3J,CAAC,GAACgB,CAAC,CAAC,CAAD,EAAG,CAAH,EAAK,KAAK4I,KAAV,EAAgB,KAAKC,SAArB,CAAzC;AAAA,UAAyE3J,CAAC,GAACyC,IAAI,CAAC2D,GAAL,CAAS5G,CAAC,CAACwJ,OAAX,EAAmB,KAAK/D,QAAxB,CAA3E;AAAA,UAA6G/E,CAAC,GAACuC,IAAI,CAACiF,GAAL,CAASlI,CAAC,CAACuJ,OAAX,EAAmB,KAAK7D,QAAxB,CAA/G;AAAA,UAAiJ9E,CAAC,GAACU,CAAC,CAAC6B,CAAC,CAAC3C,CAAD,CAAF,EAAM2C,CAAC,CAACzC,CAAD,CAAP,EAAW,KAAK8D,kBAAhB,EAAmC,CAAnC,CAApJ;AAA0L7E,IAAAA,CAAC,CAACyK,WAAF,CAActK,CAAd,GAAiBH,CAAC,CAACyK,WAAF,CAAcxK,CAAd,CAAjB,EAAkCD,CAAC,CAACyK,WAAF,CAAclK,CAAd,CAAlC,EAAmDP,CAAC,CAACyK,WAAF,CAAchK,CAAd,CAAnD,EAAoET,CAAC,CAACyK,WAAF,CAAc9J,CAAd,CAApE,EAAqFX,CAAC,CAACyK,WAAF,CAAc,KAAK3D,4BAAnB,CAArF,EAAsI9G,CAAC,CAACyK,WAAF,CAAcxJ,CAAd,CAAtI;AAAuJ;;AAA/hM;;AAAgiM,SAAO0C,CAAC,IAAI+G,OAAZ","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport e from\"../../../../../../core/Error.js\";import t from\"../../../../../../core/Logger.js\";import{clamp as i}from\"../../../../../../core/mathUtils.js\";import{unwrap as o,isNone as n}from\"../../../../../../core/maybe.js\";import{pt2px as s}from\"../../../../../../core/screenUtils.js\";import{Alignment as r}from\"../../../../../../symbols/cim/enums.js\";import{isMapAligned as a,getAlignmentFromPlacement as l,getXDirection as h,getYDirection as c}from\"../../alignmentUtils.js\";import{premultiplyAlphaRGBAArray as m}from\"../../color.js\";import{TEXT_PLACEMENT_PADDING as f}from\"../../definitions.js\";import{WGLGeometryType as _}from\"../../enums.js\";import{i8888to32 as p}from\"../../number.js\";import{LabelMaterialKey as g}from\"../../materialKey/MaterialKey.js\";import{smoothPaths as u,pathDivide as d}from\"./segmentUtils.js\";import x from\"./WGLTextTemplate.js\";const y=t.getLogger(\"esri.views.2d.engine.webgl.WGLLabelTemplate\"),b=(t,i=\"mapview-labeling\")=>y.error(new e(i,t)),L=1,P=0,S=4;function v(e,t){const o=!!e.minScale&&t.scaleToZoom(e.minScale)||0;return i(o,0,25.5)}function w(e,t){const o=!!e.maxScale&&t.scaleToZoom(e.maxScale)||255;return i(o,0,25.5)}function M(e){const t=new Map;return i=>(t.has(i)||t.set(i,e(i)),t.get(i))}const Z=M((e=>{let t=0;if(0===e)return 1/0;for(;!(e%2);)t++,e/=2;return t})),A=e=>Math.floor(127*e+127),O=e=>Math.floor(10*e),z=e=>Math.round(e*(254/360));class I extends x{constructor(e,t,i,o){var n,h,c;super(e,i.font.size,i.haloSize||0,i.font.size,i.color&&m(i.color)||0,i.haloColor&&m(i.haloColor)||0,i.horizontalAlignment,i.verticalAlignment,a(t.labelPlacement)?r.MAP:r.SCREEN,i.font.decoration,!1,i.angle||0,i.xoffset,i.yoffset,i.lineWidth,i.lineHeight,null,null,null,null,null),this._outLineLabelAngle=0,this._refPlacementPadding=0,this._refPlacementDirX=0,this._refPlacementDirY=0,this._refOffsetX=0,this._refOffsetY=0,this._zoomLevel=0,this.geometryType=_.LABEL,this._allowOverrun=null!=(n=t.allowOverrun)&&n,this._repeatLabel=null==(h=t.repeatLabel)||h,this._labelPosition=null!=(c=t.labelPosition)?c:\"curved\";const p=v(t,o),u=w(t,o),d=t.labelPlacement,[x,y]=l(d);this._xAlignD=x,this._yAlignD=y,this._minZoom=p,this._maxZoom=u,this._refPlacementPadding=s(i.haloSize)+f,this._repeatLabelDistance=t.repeatLabelDistance?s(t.repeatLabelDistance):128;const b=g.load(e);b.sdf=!0,this._materialKey=b.data}static fromLabelClass(e,t){if(\"esriServerLinePlacementCenterAlong\"===e.labelPlacement){const t=e.symbol;t.xoffset=0,t.yoffset=0,t.angle=0,t.font.decoration=\"none\"}return new I(e.materialKey,e,e.symbol,t)}get _shapedBox(){return o(this._shapingInfo).bounds}setZoomLevel(e){this._zoomLevel=e}bindReferenceTemplate(e){let t=h(this._xAlignD),i=c(this._yAlignD);if(this._refOffsetX=0,this._refOffsetY=0,n(e))return void(this._refSymbolAndPlacementOffset=p(0,0,A(t),A(i)));if(\"circle\"===e.boundsType&&(t||i)){const e=Math.sqrt(t*t+i*i);t/=e,i/=e}const o=Math.max(e.height,e.width),s=this._refPlacementPadding*S;this._refSymbolAndPlacementOffset=p(s,o,A(t),A(i)),this._referenceSize=o,this._refPlacementDirX=t,this._refPlacementDirY=i,this._refOffsetX=e.xOffset,this._refOffsetY=e.yOffset}_write(e,t){if(n(this._shapingInfo))return;const i=this._shapingInfo,o=t.getDisplayId(),s=\"esriGeometryPolygon\"===t.geometryType?t.readLegacyCentroid():t.readLegacyGeometry();if(s)switch(this.current={out:e,inId:o,inShaping:i,zoomLevel:this._zoomLevel},t.geometryType){case\"esriGeometryPolyline\":this._placeLineLabels(s);break;case\"esriGeometryPoint\":case\"esriGeometryPolygon\":this._placePointLabels(s);break;default:b(\"mapview-labeling\",`Geometry of type ${t.geometryType} is not supported`)}}_isVisible(e,t){const i=O(this.current.zoomLevel);return O(e)<=i&&i<=O(t)}_placePointLabels(e){const{out:t,inId:i,inShaping:o}=this.current;this._writeGlyphs(t,i,e,o)}_placeLineLabels(e){const t=u(e.paths,this.current.inShaping.bounds.width),i=this._placeSubdivGlyphs.bind(this),o=(this._shapedBox.width+this._repeatLabelDistance)/(1<<L);for(const n of t)d(n,o,i,this._repeatLabel)}_placeSubdivGlyphs(e,t,i,o){const n=Z(t),s=this._shapedBox.width/(1<<L),r=Math.sqrt(this._repeatLabelDistance)/(1<<L),a=Math.min(i,o-i),l=Math.log2(a/(r+s/2)),h=0===t?l:Math.min(n,l),c=Math.max(this._minZoom,this.current.zoomLevel+L-h),m=this.current.zoomLevel-c,f=this._shapedBox.width/2*2**m;this.current.inShaping.isMultiline?0===t&&this._placeStraight(e,c):this._allowOverrun&&m<0?this._placeStraightAlong(e,this._minZoom):\"parallel\"===this._labelPosition?this._placeStraightAlong(e,c):\"curved\"===this._labelPosition&&this._placeCurved(e,c,f)}_placeStraight(e,t){const{out:i,inId:o,inShaping:n}=this.current;this._writeGlyphs(i,o,e,n,t)}_placeCurved(e,t,i){const{out:o,inId:n}=this.current;o.metricStart(n,t,e.x,e.y,0,0,0,0);const s=e.clone(),r=e.angle*(180/Math.PI)%360,a=(e.angle*(180/Math.PI)+180)%360;this._outLineLabelAngle=z(r),this._placeFirst(s,t,1),this._placeBack(e,s,t,i,1),this._placeForward(e,s,t,i,1),this._outLineLabelAngle=z(a),this._placeFirst(s,t,0),this._placeBack(e,s,t,i,0),this._placeForward(e,s,t,i,0),o.metricEnd()}_placeStraightAlong(e,t){const{out:i,inId:o}=this.current;i.metricStart(o,t,e.x,e.y,0,0,0,0);const n=e.clone(),s=e.angle*(180/Math.PI)%360,r=(e.angle*(180/Math.PI)+180)%360;this._outLineLabelAngle=z(s),this._placeFirst(n,t,1,!0),this._outLineLabelAngle=z(r),this._placeFirst(n,t,0,!0),i.metricEnd()}_placeBack(e,t,i,o,n){const s=e.clone();let r=e.backwardLength+P;for(;s.prev()&&!(r>=o);)this._placeOnSegment(s,t,r,i,-1,n),r+=s.length+P}_placeForward(e,t,i,o,n){const s=e.clone();let r=e.remainingLength+P;for(;s.next()&&!(r>=o);)this._placeOnSegment(s,t,r,i,1,n),r+=s.length+P}_placeFirst(e,t,i,o=!1){const n=e,s=this.current.inShaping,r=s.glyphs,a=this.current.zoomLevel,{out:l,inId:h}=this.current;for(const c of r){const r=c.x>s.bounds.x?i:1-i,m=r*e.remainingLength+(1-r)*e.backwardLength,f=Math.abs(c.x+c.width/2-s.bounds.x),_=Math.max(0,a+Math.log2(f/(m+P))),p=Math.max(t,o?0:_);if(c.maxZoom=25,c.angle=e.angle+(1-i)*Math.PI,c.minZoom=p,this._writeGlyph(l,h,n.x,n.y,c),i&&this._isVisible(c.minZoom,c.maxZoom)){const e=c.bounds;l.metricBoxWrite(e.center[0],e.center[1],e.width,e.height)}}}_placeOnSegment(e,t,i,o,n,s){const r=this.current.inShaping.glyphs,{out:a,inId:l}=this.current,h=this.current.inShaping,c=this.current.zoomLevel,m=e.dx/e.length,f=e.dy/e.length,_={x:e.x+i*-n*m,y:e.y+i*-n*f};for(const p of r){const r=p.x>h.bounds.x?s:1-s;if(!(r&&1===n||!r&&-1===n))continue;const m=Math.abs(p.x+p.width/2-h.bounds.x),f=Math.max(0,c+Math.log2(m/i)-.1),g=Math.max(o,c+Math.log2(m/(i+e.length+P)));if(0!==f&&(p.angle=e.angle+(1-s)*Math.PI,p.minZoom=g,p.maxZoom=f,this._writeGlyph(a,l,_.x,_.y,p),s&&this._isVisible(p.minZoom,p.maxZoom))){const i=p.bounds,o=e.x-t.x,n=e.y-t.y;a.metricBoxWrite(i.center[0]+o,i.center[1]+n,i.width,i.height)}}}_writeGlyphs(e,t,i,o,n=this._minZoom){if(i.x<0||i.x>=512||i.y<0||i.y>=512)return;const s=i.x+this._refOffsetX,r=i.y-this._refOffsetY;for(const c of o.glyphs)c.minZoom=n,c.maxZoom=this._maxZoom,this._writeGlyph(e,t,s,r,c);const a=this._refPlacementDirX,l=this._refPlacementDirY,h=o.boundsT;e.metricStart(t,n,s,r,a,l,this._referenceSize,this._materialKey),e.metricBoxWrite(h.center[0],h.center[1],h.width,h.height),e.metricEnd()}_writeVertexCommon(e,t,i,o){const n=this._color,s=this._haloColor,r=p(0,0,this._size,this._haloSize),a=Math.max(o.minZoom,this._minZoom),l=Math.min(o.maxZoom,this._maxZoom),h=p(O(a),O(l),this._outLineLabelAngle,0);e.vertexWrite(i),e.vertexWrite(t),e.vertexWrite(n),e.vertexWrite(s),e.vertexWrite(r),e.vertexWrite(this._refSymbolAndPlacementOffset),e.vertexWrite(h)}}export{I as default};\n"]},"metadata":{},"sourceType":"module"}