{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport \"../../../../../core/has.js\";\nimport { isSome as e } from \"../../../../../core/maybe.js\";\nimport { r as t } from \"../../../../../chunks/rbush.js\";\nimport { convertFromFeature as s, quantizeOptimizedGeometry as r, quantizeX as n, quantizeY as i } from \"../../../../../layers/graphics/featureConversionUtils.js\";\nimport o from \"../../../../../layers/graphics/OptimizedGeometry.js\";\nimport { StreamFeatureManager as a } from \"../../../../../layers/graphics/data/StreamFeatureManager.js\";\nimport { createConnection as c } from \"../../../../../layers/graphics/sources/connections/createConnection.js\";\nimport { DataTileSource as d } from \"./DataTileSource.js\";\nimport { FeatureSetReaderJSON as h } from \"../support/FeatureSetReaderJSON.js\";\nimport { UpdateToken as u } from \"../support/UpdateToken.js\";\nconst p = 2500;\n\nfunction m(t, s) {\n  const r = t.weakClone();\n\n  if (e(t.geometry)) {\n    const e = n(s, t.geometry.coords[0]),\n          a = i(s, t.geometry.coords[1]);\n    r.geometry = new o([], [e, a]);\n  }\n\n  return r;\n}\n\nfunction l(e) {\n  return \"esriGeometryPoint\" === e ? m : (t, s) => {\n    const n = t.weakClone(),\n          i = new o(),\n          a = !1,\n          c = !1,\n          d = r(i, t.geometry, a, c, e, s, !1, !1);\n    return n.geometry = d, n;\n  };\n}\n\nfunction _(t) {\n  return \"esriGeometryPoint\" === t ? t => e(t.geometry) ? {\n    minX: t.geometry.coords[0],\n    minY: t.geometry.coords[1],\n    maxX: t.geometry.coords[0],\n    maxY: t.geometry.coords[1]\n  } : {\n    minX: 1 / 0,\n    minY: 1 / 0,\n    maxX: -1 / 0,\n    maxY: -1 / 0\n  } : t => {\n    let s = 1 / 0,\n        r = 1 / 0,\n        n = -1 / 0,\n        i = -1 / 0;\n    return e(t.geometry) && t.geometry.forEachVertex((e, t) => {\n      s = Math.min(s, e), r = Math.min(r, t), n = Math.max(n, e), i = Math.max(i, t);\n    }), {\n      minX: s,\n      minY: r,\n      maxX: n,\n      maxY: i\n    };\n  };\n}\n\nfunction f(e, s) {\n  const r = t(9, _(s));\n  return r.load(e), r;\n}\n\nfunction g(e, t) {\n  return e.search({\n    minX: t.bounds[0],\n    minY: t.bounds[1],\n    maxX: t.bounds[2],\n    maxY: t.bounds[3]\n  });\n}\n\nclass v {\n  constructor(e, t) {\n    this.onUpdate = e, this._geometryType = t, this._objectIdToFeature = new Map();\n  }\n\n  get _features() {\n    const e = [];\n    return this._objectIdToFeature.forEach(t => e.push(t)), e;\n  }\n\n  add(e) {\n    this._objectIdToFeature.set(e.objectId, e), this._index = null;\n  }\n\n  get(e) {\n    return this._objectIdToFeature.has(e) ? this._objectIdToFeature.get(e) : null;\n  }\n\n  forEach(e) {\n    this._objectIdToFeature.forEach(e);\n  }\n\n  search(e) {\n    return this._index || (this._index = f(this._features, this._geometryType)), g(this._index, e);\n  }\n\n  removeById(e) {\n    const t = this._objectIdToFeature.get(e);\n\n    return t ? (this._objectIdToFeature.delete(e), this._index = null, t) : null;\n  }\n\n  update(e, t) {\n    this.onUpdate(e, t);\n  }\n\n  get size() {\n    return this._objectIdToFeature.size;\n  }\n\n}\n\nclass y extends d {\n  constructor(e) {\n    super(e), this.type = \"geoevent\", this._dataReceiveEventEnabled = !1, this._level = 0, this._updateInfo = {\n      websocket: 0,\n      client: 0\n    };\n    const {\n      outSR: t\n    } = e,\n          {\n      geometryType: s,\n      objectIdField: r,\n      timeInfo: n,\n      purgeOptions: i,\n      source: o,\n      spatialReference: d,\n      serviceFilter: h,\n      maxReconnectionAttempts: u,\n      maxReconnectionInterval: m,\n      updateInterval: _,\n      enableDataReceived: f,\n      customParameters: g\n    } = e.serviceInfo,\n          y = new v(this._onUpdate.bind(this), s),\n          b = new a(y, r, n, i),\n          I = c(o, d, t, s, h, u, m, g);\n    this._store = y, this._manager = b, this._connection = I, this._quantize = l(s), this._dataReceiveEventEnabled = f, this._handles = [this._connection.on(\"feature\", e => this._onFeature(e)), this._connection.watch(\"connectionStatus\", e => this.events.emit(\"connectionStatus\", e)), this._connection.watch(\"errorString\", e => this.events.emit(\"errorString\", e))], this._initUpdateInterval = () => {\n      let t = performance.now();\n      this._updateIntervalId = setInterval(() => {\n        const s = performance.now(),\n              r = s - t;\n\n        if (r > p) {\n          t = s;\n          const e = Math.round(this._updateInfo.client / (r / 1e3)),\n                n = Math.round(this._updateInfo.websocket / (r / 1e3));\n          this._updateInfo.client = 0, this._updateInfo.websocket = 0, this.events.emit(\"updateRate\", {\n            client: e,\n            websocket: n\n          });\n        }\n\n        e.canAcceptRequest() && this._manager.checkForUpdates();\n      }, _);\n    }, this._initUpdateInterval();\n  }\n\n  destroy() {\n    super.destroy(), this._clearUpdateInterval(), this._handles.forEach(e => e.remove()), this._connection.destroy();\n  }\n\n  _fetchDataTile() {}\n\n  pauseStream() {\n    this._clearUpdateInterval();\n  }\n\n  resumeStream() {\n    this._initUpdateInterval();\n  }\n\n  enableEvent(e, t) {\n    \"data-received\" === e && (this._dataReceiveEventEnabled = t);\n  }\n\n  get updating() {\n    return !1;\n  }\n\n  subscribe(e) {\n    super.subscribe(e);\n\n    const t = this._subscriptions.get(e.id);\n\n    this._level = e.level;\n\n    const s = this._getTileFeatures(e);\n\n    this._onMessage({\n      type: \"append\",\n      id: e.key.id,\n      addOrUpdate: s,\n      end: !0\n    }), t.didSend = !0;\n  }\n\n  unsubscribe(e) {\n    super.unsubscribe(e);\n  }\n\n  *readers(t) {\n    const s = this._subscriptions.get(t),\n          {\n      tile: r\n    } = s;\n\n    yield this._getTileFeatures(r);\n\n    for (const n of s.requests.stream.entries) e(n) && e(n.addOrUpdate) && (yield n.addOrUpdate);\n  }\n\n  createTileQuery(e) {\n    throw new Error(\"Service does not support tile  queries\");\n  }\n\n  async resend() {\n    this._subscriptions.forEach(e => {\n      const {\n        tile: t\n      } = e,\n            s = {\n        type: \"append\",\n        id: t.id,\n        addOrUpdate: this._getTileFeatures(t),\n        end: !0\n      };\n\n      this._onMessage(s);\n    });\n  }\n\n  _getTileFeatures(e) {\n    const t = this._store.search(e).map(t => this._quantize(t, e.transform));\n\n    return h.fromOptimizedFeatures(t, this._serviceInfo, e.transform);\n  }\n\n  _onFeature(e) {\n    this._updateInfo.websocket++;\n\n    try {\n      this._dataReceiveEventEnabled && this.events.emit(\"feature\", e);\n      const t = s(e, this._serviceInfo.geometryType, !1, !1, this._serviceInfo.objectIdField);\n\n      this._manager.add(t);\n    } catch (t) {}\n  }\n\n  _clearUpdateInterval() {\n    clearInterval(this._updateIntervalId), this._updateIntervalId = 0;\n  }\n\n  _onUpdate(t, s) {\n    e(t) && (this._updateInfo.client += t.length), this._subscriptions.forEach((e, t) => {\n      e.didSend && e.tile.level === this._level && this._onMessage({\n        type: \"append\",\n        id: t,\n        addOrUpdate: null,\n        clear: !0,\n        end: !1\n      });\n    }), this._subscriptions.forEach((e, t) => {\n      if (!e.didSend || e.tile.level !== this._level) return;\n      const s = e.tile,\n            r = {\n        type: \"append\",\n        id: t,\n        addOrUpdate: this._getTileFeatures(s),\n        remove: [],\n        end: !0,\n        status: u.empty()\n      };\n      e.requests.stream.enqueue(r), this._onMessage(r);\n    });\n  }\n\n}\n\nexport { y as GeoEventSource };","map":{"version":3,"sources":["D:/Github/CUSP_DataBase/CUSP_DB/src/main/gis/node_modules/@arcgis/core/views/2d/layers/features/sources/GeoEventSource.js"],"names":["isSome","e","r","t","convertFromFeature","s","quantizeOptimizedGeometry","quantizeX","n","quantizeY","i","o","StreamFeatureManager","a","createConnection","c","DataTileSource","d","FeatureSetReaderJSON","h","UpdateToken","u","p","m","weakClone","geometry","coords","l","_","minX","minY","maxX","maxY","forEachVertex","Math","min","max","f","load","g","search","bounds","v","constructor","onUpdate","_geometryType","_objectIdToFeature","Map","_features","forEach","push","add","set","objectId","_index","get","has","removeById","delete","update","size","y","type","_dataReceiveEventEnabled","_level","_updateInfo","websocket","client","outSR","geometryType","objectIdField","timeInfo","purgeOptions","source","spatialReference","serviceFilter","maxReconnectionAttempts","maxReconnectionInterval","updateInterval","enableDataReceived","customParameters","serviceInfo","_onUpdate","bind","b","I","_store","_manager","_connection","_quantize","_handles","on","_onFeature","watch","events","emit","_initUpdateInterval","performance","now","_updateIntervalId","setInterval","round","canAcceptRequest","checkForUpdates","destroy","_clearUpdateInterval","remove","_fetchDataTile","pauseStream","resumeStream","enableEvent","updating","subscribe","_subscriptions","id","level","_getTileFeatures","_onMessage","key","addOrUpdate","end","didSend","unsubscribe","readers","tile","requests","stream","entries","createTileQuery","Error","resend","map","transform","fromOptimizedFeatures","_serviceInfo","clearInterval","length","clear","status","empty","enqueue","GeoEventSource"],"mappings":"AAAA;AACA;AACA;AACA;AACA,OAAM,4BAAN;AAAmC,SAAOA,MAAM,IAAIC,CAAjB,QAAuB,8BAAvB;AAAsD,SAAOC,CAAC,IAAIC,CAAZ,QAAkB,gCAAlB;AAAmD,SAAOC,kBAAkB,IAAIC,CAA7B,EAA+BC,yBAAyB,IAAIJ,CAA5D,EAA8DK,SAAS,IAAIC,CAA3E,EAA6EC,SAAS,IAAIC,CAA1F,QAAgG,0DAAhG;AAA2J,OAAOC,CAAP,MAAa,qDAAb;AAAmE,SAAOC,oBAAoB,IAAIC,CAA/B,QAAqC,6DAArC;AAAmG,SAAOC,gBAAgB,IAAIC,CAA3B,QAAiC,wEAAjC;AAA0G,SAAOC,cAAc,IAAIC,CAAzB,QAA+B,qBAA/B;AAAqD,SAAOC,oBAAoB,IAAIC,CAA/B,QAAqC,oCAArC;AAA0E,SAAOC,WAAW,IAAIC,CAAtB,QAA4B,2BAA5B;AAAwD,MAAMC,CAAC,GAAC,IAAR;;AAAa,SAASC,CAAT,CAAWpB,CAAX,EAAaE,CAAb,EAAe;AAAC,QAAMH,CAAC,GAACC,CAAC,CAACqB,SAAF,EAAR;;AAAsB,MAAGvB,CAAC,CAACE,CAAC,CAACsB,QAAH,CAAJ,EAAiB;AAAC,UAAMxB,CAAC,GAACO,CAAC,CAACH,CAAD,EAAGF,CAAC,CAACsB,QAAF,CAAWC,MAAX,CAAkB,CAAlB,CAAH,CAAT;AAAA,UAAkCb,CAAC,GAACH,CAAC,CAACL,CAAD,EAAGF,CAAC,CAACsB,QAAF,CAAWC,MAAX,CAAkB,CAAlB,CAAH,CAArC;AAA8DxB,IAAAA,CAAC,CAACuB,QAAF,GAAW,IAAId,CAAJ,CAAM,EAAN,EAAS,CAACV,CAAD,EAAGY,CAAH,CAAT,CAAX;AAA2B;;AAAA,SAAOX,CAAP;AAAS;;AAAA,SAASyB,CAAT,CAAW1B,CAAX,EAAa;AAAC,SAAM,wBAAsBA,CAAtB,GAAwBsB,CAAxB,GAA0B,CAACpB,CAAD,EAAGE,CAAH,KAAO;AAAC,UAAMG,CAAC,GAACL,CAAC,CAACqB,SAAF,EAAR;AAAA,UAAsBd,CAAC,GAAC,IAAIC,CAAJ,EAAxB;AAAA,UAA8BE,CAAC,GAAC,CAAC,CAAjC;AAAA,UAAmCE,CAAC,GAAC,CAAC,CAAtC;AAAA,UAAwCE,CAAC,GAACf,CAAC,CAACQ,CAAD,EAAGP,CAAC,CAACsB,QAAL,EAAcZ,CAAd,EAAgBE,CAAhB,EAAkBd,CAAlB,EAAoBI,CAApB,EAAsB,CAAC,CAAvB,EAAyB,CAAC,CAA1B,CAA3C;AAAwE,WAAOG,CAAC,CAACiB,QAAF,GAAWR,CAAX,EAAaT,CAApB;AAAsB,GAAtI;AAAuI;;AAAA,SAASoB,CAAT,CAAWzB,CAAX,EAAa;AAAC,SAAM,wBAAsBA,CAAtB,GAAwBA,CAAC,IAAEF,CAAC,CAACE,CAAC,CAACsB,QAAH,CAAD,GAAc;AAACI,IAAAA,IAAI,EAAC1B,CAAC,CAACsB,QAAF,CAAWC,MAAX,CAAkB,CAAlB,CAAN;AAA2BI,IAAAA,IAAI,EAAC3B,CAAC,CAACsB,QAAF,CAAWC,MAAX,CAAkB,CAAlB,CAAhC;AAAqDK,IAAAA,IAAI,EAAC5B,CAAC,CAACsB,QAAF,CAAWC,MAAX,CAAkB,CAAlB,CAA1D;AAA+EM,IAAAA,IAAI,EAAC7B,CAAC,CAACsB,QAAF,CAAWC,MAAX,CAAkB,CAAlB;AAApF,GAAd,GAAwH;AAACG,IAAAA,IAAI,EAAC,IAAE,CAAR;AAAUC,IAAAA,IAAI,EAAC,IAAE,CAAjB;AAAmBC,IAAAA,IAAI,EAAC,CAAC,CAAD,GAAG,CAA3B;AAA6BC,IAAAA,IAAI,EAAC,CAAC,CAAD,GAAG;AAArC,GAAnJ,GAA2L7B,CAAC,IAAE;AAAC,QAAIE,CAAC,GAAC,IAAE,CAAR;AAAA,QAAUH,CAAC,GAAC,IAAE,CAAd;AAAA,QAAgBM,CAAC,GAAC,CAAC,CAAD,GAAG,CAArB;AAAA,QAAuBE,CAAC,GAAC,CAAC,CAAD,GAAG,CAA5B;AAA8B,WAAOT,CAAC,CAACE,CAAC,CAACsB,QAAH,CAAD,IAAetB,CAAC,CAACsB,QAAF,CAAWQ,aAAX,CAA0B,CAAChC,CAAD,EAAGE,CAAH,KAAO;AAACE,MAAAA,CAAC,GAAC6B,IAAI,CAACC,GAAL,CAAS9B,CAAT,EAAWJ,CAAX,CAAF,EAAgBC,CAAC,GAACgC,IAAI,CAACC,GAAL,CAASjC,CAAT,EAAWC,CAAX,CAAlB,EAAgCK,CAAC,GAAC0B,IAAI,CAACE,GAAL,CAAS5B,CAAT,EAAWP,CAAX,CAAlC,EAAgDS,CAAC,GAACwB,IAAI,CAACE,GAAL,CAAS1B,CAAT,EAAWP,CAAX,CAAlD;AAAgE,KAAlG,CAAf,EAAoH;AAAC0B,MAAAA,IAAI,EAACxB,CAAN;AAAQyB,MAAAA,IAAI,EAAC5B,CAAb;AAAe6B,MAAAA,IAAI,EAACvB,CAApB;AAAsBwB,MAAAA,IAAI,EAACtB;AAA3B,KAA3H;AAAyJ,GAA5X;AAA6X;;AAAA,SAAS2B,CAAT,CAAWpC,CAAX,EAAaI,CAAb,EAAe;AAAC,QAAMH,CAAC,GAACC,CAAC,CAAC,CAAD,EAAGyB,CAAC,CAACvB,CAAD,CAAJ,CAAT;AAAkB,SAAOH,CAAC,CAACoC,IAAF,CAAOrC,CAAP,GAAUC,CAAjB;AAAmB;;AAAA,SAASqC,CAAT,CAAWtC,CAAX,EAAaE,CAAb,EAAe;AAAC,SAAOF,CAAC,CAACuC,MAAF,CAAS;AAACX,IAAAA,IAAI,EAAC1B,CAAC,CAACsC,MAAF,CAAS,CAAT,CAAN;AAAkBX,IAAAA,IAAI,EAAC3B,CAAC,CAACsC,MAAF,CAAS,CAAT,CAAvB;AAAmCV,IAAAA,IAAI,EAAC5B,CAAC,CAACsC,MAAF,CAAS,CAAT,CAAxC;AAAoDT,IAAAA,IAAI,EAAC7B,CAAC,CAACsC,MAAF,CAAS,CAAT;AAAzD,GAAT,CAAP;AAAuF;;AAAA,MAAMC,CAAN,CAAO;AAACC,EAAAA,WAAW,CAAC1C,CAAD,EAAGE,CAAH,EAAK;AAAC,SAAKyC,QAAL,GAAc3C,CAAd,EAAgB,KAAK4C,aAAL,GAAmB1C,CAAnC,EAAqC,KAAK2C,kBAAL,GAAwB,IAAIC,GAAJ,EAA7D;AAAqE;;AAAa,MAATC,SAAS,GAAE;AAAC,UAAM/C,CAAC,GAAC,EAAR;AAAW,WAAO,KAAK6C,kBAAL,CAAwBG,OAAxB,CAAiC9C,CAAC,IAAEF,CAAC,CAACiD,IAAF,CAAO/C,CAAP,CAApC,GAAgDF,CAAvD;AAAyD;;AAAAkD,EAAAA,GAAG,CAAClD,CAAD,EAAG;AAAC,SAAK6C,kBAAL,CAAwBM,GAAxB,CAA4BnD,CAAC,CAACoD,QAA9B,EAAuCpD,CAAvC,GAA0C,KAAKqD,MAAL,GAAY,IAAtD;AAA2D;;AAAAC,EAAAA,GAAG,CAACtD,CAAD,EAAG;AAAC,WAAO,KAAK6C,kBAAL,CAAwBU,GAAxB,CAA4BvD,CAA5B,IAA+B,KAAK6C,kBAAL,CAAwBS,GAAxB,CAA4BtD,CAA5B,CAA/B,GAA8D,IAArE;AAA0E;;AAAAgD,EAAAA,OAAO,CAAChD,CAAD,EAAG;AAAC,SAAK6C,kBAAL,CAAwBG,OAAxB,CAAgChD,CAAhC;AAAmC;;AAAAuC,EAAAA,MAAM,CAACvC,CAAD,EAAG;AAAC,WAAO,KAAKqD,MAAL,KAAc,KAAKA,MAAL,GAAYjB,CAAC,CAAC,KAAKW,SAAN,EAAgB,KAAKH,aAArB,CAA3B,GAAgEN,CAAC,CAAC,KAAKe,MAAN,EAAarD,CAAb,CAAxE;AAAwF;;AAAAwD,EAAAA,UAAU,CAACxD,CAAD,EAAG;AAAC,UAAME,CAAC,GAAC,KAAK2C,kBAAL,CAAwBS,GAAxB,CAA4BtD,CAA5B,CAAR;;AAAuC,WAAOE,CAAC,IAAE,KAAK2C,kBAAL,CAAwBY,MAAxB,CAA+BzD,CAA/B,GAAkC,KAAKqD,MAAL,GAAY,IAA9C,EAAmDnD,CAArD,IAAwD,IAAhE;AAAqE;;AAAAwD,EAAAA,MAAM,CAAC1D,CAAD,EAAGE,CAAH,EAAK;AAAC,SAAKyC,QAAL,CAAc3C,CAAd,EAAgBE,CAAhB;AAAmB;;AAAQ,MAAJyD,IAAI,GAAE;AAAC,WAAO,KAAKd,kBAAL,CAAwBc,IAA/B;AAAoC;;AAAtpB;;AAAupB,MAAMC,CAAN,SAAgB5C,CAAhB,CAAiB;AAAC0B,EAAAA,WAAW,CAAC1C,CAAD,EAAG;AAAC,UAAMA,CAAN,GAAS,KAAK6D,IAAL,GAAU,UAAnB,EAA8B,KAAKC,wBAAL,GAA8B,CAAC,CAA7D,EAA+D,KAAKC,MAAL,GAAY,CAA3E,EAA6E,KAAKC,WAAL,GAAiB;AAACC,MAAAA,SAAS,EAAC,CAAX;AAAaC,MAAAA,MAAM,EAAC;AAApB,KAA9F;AAAqH,UAAK;AAACC,MAAAA,KAAK,EAACjE;AAAP,QAAUF,CAAf;AAAA,UAAiB;AAACoE,MAAAA,YAAY,EAAChE,CAAd;AAAgBiE,MAAAA,aAAa,EAACpE,CAA9B;AAAgCqE,MAAAA,QAAQ,EAAC/D,CAAzC;AAA2CgE,MAAAA,YAAY,EAAC9D,CAAxD;AAA0D+D,MAAAA,MAAM,EAAC9D,CAAjE;AAAmE+D,MAAAA,gBAAgB,EAACzD,CAApF;AAAsF0D,MAAAA,aAAa,EAACxD,CAApG;AAAsGyD,MAAAA,uBAAuB,EAACvD,CAA9H;AAAgIwD,MAAAA,uBAAuB,EAACtD,CAAxJ;AAA0JuD,MAAAA,cAAc,EAAClD,CAAzK;AAA2KmD,MAAAA,kBAAkB,EAAC1C,CAA9L;AAAgM2C,MAAAA,gBAAgB,EAACzC;AAAjN,QAAoNtC,CAAC,CAACgF,WAAvO;AAAA,UAAmPpB,CAAC,GAAC,IAAInB,CAAJ,CAAM,KAAKwC,SAAL,CAAeC,IAAf,CAAoB,IAApB,CAAN,EAAgC9E,CAAhC,CAArP;AAAA,UAAwR+E,CAAC,GAAC,IAAIvE,CAAJ,CAAMgD,CAAN,EAAQ3D,CAAR,EAAUM,CAAV,EAAYE,CAAZ,CAA1R;AAAA,UAAyS2E,CAAC,GAACtE,CAAC,CAACJ,CAAD,EAAGM,CAAH,EAAKd,CAAL,EAAOE,CAAP,EAASc,CAAT,EAAWE,CAAX,EAAaE,CAAb,EAAegB,CAAf,CAA5S;AAA8T,SAAK+C,MAAL,GAAYzB,CAAZ,EAAc,KAAK0B,QAAL,GAAcH,CAA5B,EAA8B,KAAKI,WAAL,GAAiBH,CAA/C,EAAiD,KAAKI,SAAL,GAAe9D,CAAC,CAACtB,CAAD,CAAjE,EAAqE,KAAK0D,wBAAL,GAA8B1B,CAAnG,EAAqG,KAAKqD,QAAL,GAAc,CAAC,KAAKF,WAAL,CAAiBG,EAAjB,CAAoB,SAApB,EAA+B1F,CAAC,IAAE,KAAK2F,UAAL,CAAgB3F,CAAhB,CAAlC,CAAD,EAAwD,KAAKuF,WAAL,CAAiBK,KAAjB,CAAuB,kBAAvB,EAA2C5F,CAAC,IAAE,KAAK6F,MAAL,CAAYC,IAAZ,CAAiB,kBAAjB,EAAoC9F,CAApC,CAA9C,CAAxD,EAA+I,KAAKuF,WAAL,CAAiBK,KAAjB,CAAuB,aAAvB,EAAsC5F,CAAC,IAAE,KAAK6F,MAAL,CAAYC,IAAZ,CAAiB,aAAjB,EAA+B9F,CAA/B,CAAzC,CAA/I,CAAnH,EAAgV,KAAK+F,mBAAL,GAAyB,MAAI;AAAC,UAAI7F,CAAC,GAAC8F,WAAW,CAACC,GAAZ,EAAN;AAAwB,WAAKC,iBAAL,GAAuBC,WAAW,CAAE,MAAI;AAAC,cAAM/F,CAAC,GAAC4F,WAAW,CAACC,GAAZ,EAAR;AAAA,cAA0BhG,CAAC,GAACG,CAAC,GAACF,CAA9B;;AAAgC,YAAGD,CAAC,GAACoB,CAAL,EAAO;AAACnB,UAAAA,CAAC,GAACE,CAAF;AAAI,gBAAMJ,CAAC,GAACiC,IAAI,CAACmE,KAAL,CAAW,KAAKpC,WAAL,CAAiBE,MAAjB,IAAyBjE,CAAC,GAAC,GAA3B,CAAX,CAAR;AAAA,gBAAoDM,CAAC,GAAC0B,IAAI,CAACmE,KAAL,CAAW,KAAKpC,WAAL,CAAiBC,SAAjB,IAA4BhE,CAAC,GAAC,GAA9B,CAAX,CAAtD;AAAqG,eAAK+D,WAAL,CAAiBE,MAAjB,GAAwB,CAAxB,EAA0B,KAAKF,WAAL,CAAiBC,SAAjB,GAA2B,CAArD,EAAuD,KAAK4B,MAAL,CAAYC,IAAZ,CAAiB,YAAjB,EAA8B;AAAC5B,YAAAA,MAAM,EAAClE,CAAR;AAAUiE,YAAAA,SAAS,EAAC1D;AAApB,WAA9B,CAAvD;AAA6G;;AAAAP,QAAAA,CAAC,CAACqG,gBAAF,MAAsB,KAAKf,QAAL,CAAcgB,eAAd,EAAtB;AAAsD,OAA3T,EAA6T3E,CAA7T,CAAlC;AAAkW,KAAxuB,EAAyuB,KAAKoE,mBAAL,EAAzuB;AAAowB;;AAAAQ,EAAAA,OAAO,GAAE;AAAC,UAAMA,OAAN,IAAgB,KAAKC,oBAAL,EAAhB,EAA4C,KAAKf,QAAL,CAAczC,OAAd,CAAuBhD,CAAC,IAAEA,CAAC,CAACyG,MAAF,EAA1B,CAA5C,EAAmF,KAAKlB,WAAL,CAAiBgB,OAAjB,EAAnF;AAA8G;;AAAAG,EAAAA,cAAc,GAAE,CAAE;;AAAAC,EAAAA,WAAW,GAAE;AAAC,SAAKH,oBAAL;AAA4B;;AAAAI,EAAAA,YAAY,GAAE;AAAC,SAAKb,mBAAL;AAA2B;;AAAAc,EAAAA,WAAW,CAAC7G,CAAD,EAAGE,CAAH,EAAK;AAAC,wBAAkBF,CAAlB,KAAsB,KAAK8D,wBAAL,GAA8B5D,CAApD;AAAuD;;AAAY,MAAR4G,QAAQ,GAAE;AAAC,WAAM,CAAC,CAAP;AAAS;;AAAAC,EAAAA,SAAS,CAAC/G,CAAD,EAAG;AAAC,UAAM+G,SAAN,CAAgB/G,CAAhB;;AAAmB,UAAME,CAAC,GAAC,KAAK8G,cAAL,CAAoB1D,GAApB,CAAwBtD,CAAC,CAACiH,EAA1B,CAAR;;AAAsC,SAAKlD,MAAL,GAAY/D,CAAC,CAACkH,KAAd;;AAAoB,UAAM9G,CAAC,GAAC,KAAK+G,gBAAL,CAAsBnH,CAAtB,CAAR;;AAAiC,SAAKoH,UAAL,CAAgB;AAACvD,MAAAA,IAAI,EAAC,QAAN;AAAeoD,MAAAA,EAAE,EAACjH,CAAC,CAACqH,GAAF,CAAMJ,EAAxB;AAA2BK,MAAAA,WAAW,EAAClH,CAAvC;AAAyCmH,MAAAA,GAAG,EAAC,CAAC;AAA9C,KAAhB,GAAkErH,CAAC,CAACsH,OAAF,GAAU,CAAC,CAA7E;AAA+E;;AAAAC,EAAAA,WAAW,CAACzH,CAAD,EAAG;AAAC,UAAMyH,WAAN,CAAkBzH,CAAlB;AAAqB;;AAAQ,GAAP0H,OAAO,CAACxH,CAAD,EAAG;AAAC,UAAME,CAAC,GAAC,KAAK4G,cAAL,CAAoB1D,GAApB,CAAwBpD,CAAxB,CAAR;AAAA,UAAmC;AAACyH,MAAAA,IAAI,EAAC1H;AAAN,QAASG,CAA5C;;AAA8C,UAAM,KAAK+G,gBAAL,CAAsBlH,CAAtB,CAAN;;AAA+B,SAAI,MAAMM,CAAV,IAAeH,CAAC,CAACwH,QAAF,CAAWC,MAAX,CAAkBC,OAAjC,EAAyC9H,CAAC,CAACO,CAAD,CAAD,IAAMP,CAAC,CAACO,CAAC,CAAC+G,WAAH,CAAP,KAAyB,MAAM/G,CAAC,CAAC+G,WAAjC;AAA8C;;AAAAS,EAAAA,eAAe,CAAC/H,CAAD,EAAG;AAAC,UAAM,IAAIgI,KAAJ,CAAU,wCAAV,CAAN;AAA0D;;AAAY,QAANC,MAAM,GAAE;AAAC,SAAKjB,cAAL,CAAoBhE,OAApB,CAA6BhD,CAAC,IAAE;AAAC,YAAK;AAAC2H,QAAAA,IAAI,EAACzH;AAAN,UAASF,CAAd;AAAA,YAAgBI,CAAC,GAAC;AAACyD,QAAAA,IAAI,EAAC,QAAN;AAAeoD,QAAAA,EAAE,EAAC/G,CAAC,CAAC+G,EAApB;AAAuBK,QAAAA,WAAW,EAAC,KAAKH,gBAAL,CAAsBjH,CAAtB,CAAnC;AAA4DqH,QAAAA,GAAG,EAAC,CAAC;AAAjE,OAAlB;;AAAsF,WAAKH,UAAL,CAAgBhH,CAAhB;AAAmB,KAA1I;AAA6I;;AAAA+G,EAAAA,gBAAgB,CAACnH,CAAD,EAAG;AAAC,UAAME,CAAC,GAAC,KAAKmF,MAAL,CAAY9C,MAAZ,CAAmBvC,CAAnB,EAAsBkI,GAAtB,CAA2BhI,CAAC,IAAE,KAAKsF,SAAL,CAAetF,CAAf,EAAiBF,CAAC,CAACmI,SAAnB,CAA9B,CAAR;;AAAsE,WAAOjH,CAAC,CAACkH,qBAAF,CAAwBlI,CAAxB,EAA0B,KAAKmI,YAA/B,EAA4CrI,CAAC,CAACmI,SAA9C,CAAP;AAAgE;;AAAAxC,EAAAA,UAAU,CAAC3F,CAAD,EAAG;AAAC,SAAKgE,WAAL,CAAiBC,SAAjB;;AAA6B,QAAG;AAAC,WAAKH,wBAAL,IAA+B,KAAK+B,MAAL,CAAYC,IAAZ,CAAiB,SAAjB,EAA2B9F,CAA3B,CAA/B;AAA6D,YAAME,CAAC,GAACE,CAAC,CAACJ,CAAD,EAAG,KAAKqI,YAAL,CAAkBjE,YAArB,EAAkC,CAAC,CAAnC,EAAqC,CAAC,CAAtC,EAAwC,KAAKiE,YAAL,CAAkBhE,aAA1D,CAAT;;AAAkF,WAAKiB,QAAL,CAAcpC,GAAd,CAAkBhD,CAAlB;AAAqB,KAAxK,CAAwK,OAAMA,CAAN,EAAQ,CAAE;AAAC;;AAAAsG,EAAAA,oBAAoB,GAAE;AAAC8B,IAAAA,aAAa,CAAC,KAAKpC,iBAAN,CAAb,EAAsC,KAAKA,iBAAL,GAAuB,CAA7D;AAA+D;;AAAAjB,EAAAA,SAAS,CAAC/E,CAAD,EAAGE,CAAH,EAAK;AAACJ,IAAAA,CAAC,CAACE,CAAD,CAAD,KAAO,KAAK8D,WAAL,CAAiBE,MAAjB,IAAyBhE,CAAC,CAACqI,MAAlC,GAA0C,KAAKvB,cAAL,CAAoBhE,OAApB,CAA6B,CAAChD,CAAD,EAAGE,CAAH,KAAO;AAACF,MAAAA,CAAC,CAACwH,OAAF,IAAWxH,CAAC,CAAC2H,IAAF,CAAOT,KAAP,KAAe,KAAKnD,MAA/B,IAAuC,KAAKqD,UAAL,CAAgB;AAACvD,QAAAA,IAAI,EAAC,QAAN;AAAeoD,QAAAA,EAAE,EAAC/G,CAAlB;AAAoBoH,QAAAA,WAAW,EAAC,IAAhC;AAAqCkB,QAAAA,KAAK,EAAC,CAAC,CAA5C;AAA8CjB,QAAAA,GAAG,EAAC,CAAC;AAAnD,OAAhB,CAAvC;AAA8G,KAAnJ,CAA1C,EAAgM,KAAKP,cAAL,CAAoBhE,OAApB,CAA6B,CAAChD,CAAD,EAAGE,CAAH,KAAO;AAAC,UAAG,CAACF,CAAC,CAACwH,OAAH,IAAYxH,CAAC,CAAC2H,IAAF,CAAOT,KAAP,KAAe,KAAKnD,MAAnC,EAA0C;AAAO,YAAM3D,CAAC,GAACJ,CAAC,CAAC2H,IAAV;AAAA,YAAe1H,CAAC,GAAC;AAAC4D,QAAAA,IAAI,EAAC,QAAN;AAAeoD,QAAAA,EAAE,EAAC/G,CAAlB;AAAoBoH,QAAAA,WAAW,EAAC,KAAKH,gBAAL,CAAsB/G,CAAtB,CAAhC;AAAyDqG,QAAAA,MAAM,EAAC,EAAhE;AAAmEc,QAAAA,GAAG,EAAC,CAAC,CAAxE;AAA0EkB,QAAAA,MAAM,EAACrH,CAAC,CAACsH,KAAF;AAAjF,OAAjB;AAA6G1I,MAAAA,CAAC,CAAC4H,QAAF,CAAWC,MAAX,CAAkBc,OAAlB,CAA0B1I,CAA1B,GAA6B,KAAKmH,UAAL,CAAgBnH,CAAhB,CAA7B;AAAgD,KAAnP,CAAhM;AAAsb;;AAA/hG;;AAAgiG,SAAO2D,CAAC,IAAIgF,cAAZ","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport\"../../../../../core/has.js\";import{isSome as e}from\"../../../../../core/maybe.js\";import{r as t}from\"../../../../../chunks/rbush.js\";import{convertFromFeature as s,quantizeOptimizedGeometry as r,quantizeX as n,quantizeY as i}from\"../../../../../layers/graphics/featureConversionUtils.js\";import o from\"../../../../../layers/graphics/OptimizedGeometry.js\";import{StreamFeatureManager as a}from\"../../../../../layers/graphics/data/StreamFeatureManager.js\";import{createConnection as c}from\"../../../../../layers/graphics/sources/connections/createConnection.js\";import{DataTileSource as d}from\"./DataTileSource.js\";import{FeatureSetReaderJSON as h}from\"../support/FeatureSetReaderJSON.js\";import{UpdateToken as u}from\"../support/UpdateToken.js\";const p=2500;function m(t,s){const r=t.weakClone();if(e(t.geometry)){const e=n(s,t.geometry.coords[0]),a=i(s,t.geometry.coords[1]);r.geometry=new o([],[e,a])}return r}function l(e){return\"esriGeometryPoint\"===e?m:(t,s)=>{const n=t.weakClone(),i=new o,a=!1,c=!1,d=r(i,t.geometry,a,c,e,s,!1,!1);return n.geometry=d,n}}function _(t){return\"esriGeometryPoint\"===t?t=>e(t.geometry)?{minX:t.geometry.coords[0],minY:t.geometry.coords[1],maxX:t.geometry.coords[0],maxY:t.geometry.coords[1]}:{minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}:t=>{let s=1/0,r=1/0,n=-1/0,i=-1/0;return e(t.geometry)&&t.geometry.forEachVertex(((e,t)=>{s=Math.min(s,e),r=Math.min(r,t),n=Math.max(n,e),i=Math.max(i,t)})),{minX:s,minY:r,maxX:n,maxY:i}}}function f(e,s){const r=t(9,_(s));return r.load(e),r}function g(e,t){return e.search({minX:t.bounds[0],minY:t.bounds[1],maxX:t.bounds[2],maxY:t.bounds[3]})}class v{constructor(e,t){this.onUpdate=e,this._geometryType=t,this._objectIdToFeature=new Map}get _features(){const e=[];return this._objectIdToFeature.forEach((t=>e.push(t))),e}add(e){this._objectIdToFeature.set(e.objectId,e),this._index=null}get(e){return this._objectIdToFeature.has(e)?this._objectIdToFeature.get(e):null}forEach(e){this._objectIdToFeature.forEach(e)}search(e){return this._index||(this._index=f(this._features,this._geometryType)),g(this._index,e)}removeById(e){const t=this._objectIdToFeature.get(e);return t?(this._objectIdToFeature.delete(e),this._index=null,t):null}update(e,t){this.onUpdate(e,t)}get size(){return this._objectIdToFeature.size}}class y extends d{constructor(e){super(e),this.type=\"geoevent\",this._dataReceiveEventEnabled=!1,this._level=0,this._updateInfo={websocket:0,client:0};const{outSR:t}=e,{geometryType:s,objectIdField:r,timeInfo:n,purgeOptions:i,source:o,spatialReference:d,serviceFilter:h,maxReconnectionAttempts:u,maxReconnectionInterval:m,updateInterval:_,enableDataReceived:f,customParameters:g}=e.serviceInfo,y=new v(this._onUpdate.bind(this),s),b=new a(y,r,n,i),I=c(o,d,t,s,h,u,m,g);this._store=y,this._manager=b,this._connection=I,this._quantize=l(s),this._dataReceiveEventEnabled=f,this._handles=[this._connection.on(\"feature\",(e=>this._onFeature(e))),this._connection.watch(\"connectionStatus\",(e=>this.events.emit(\"connectionStatus\",e))),this._connection.watch(\"errorString\",(e=>this.events.emit(\"errorString\",e)))],this._initUpdateInterval=()=>{let t=performance.now();this._updateIntervalId=setInterval((()=>{const s=performance.now(),r=s-t;if(r>p){t=s;const e=Math.round(this._updateInfo.client/(r/1e3)),n=Math.round(this._updateInfo.websocket/(r/1e3));this._updateInfo.client=0,this._updateInfo.websocket=0,this.events.emit(\"updateRate\",{client:e,websocket:n})}e.canAcceptRequest()&&this._manager.checkForUpdates()}),_)},this._initUpdateInterval()}destroy(){super.destroy(),this._clearUpdateInterval(),this._handles.forEach((e=>e.remove())),this._connection.destroy()}_fetchDataTile(){}pauseStream(){this._clearUpdateInterval()}resumeStream(){this._initUpdateInterval()}enableEvent(e,t){\"data-received\"===e&&(this._dataReceiveEventEnabled=t)}get updating(){return!1}subscribe(e){super.subscribe(e);const t=this._subscriptions.get(e.id);this._level=e.level;const s=this._getTileFeatures(e);this._onMessage({type:\"append\",id:e.key.id,addOrUpdate:s,end:!0}),t.didSend=!0}unsubscribe(e){super.unsubscribe(e)}*readers(t){const s=this._subscriptions.get(t),{tile:r}=s;yield this._getTileFeatures(r);for(const n of s.requests.stream.entries)e(n)&&e(n.addOrUpdate)&&(yield n.addOrUpdate)}createTileQuery(e){throw new Error(\"Service does not support tile  queries\")}async resend(){this._subscriptions.forEach((e=>{const{tile:t}=e,s={type:\"append\",id:t.id,addOrUpdate:this._getTileFeatures(t),end:!0};this._onMessage(s)}))}_getTileFeatures(e){const t=this._store.search(e).map((t=>this._quantize(t,e.transform)));return h.fromOptimizedFeatures(t,this._serviceInfo,e.transform)}_onFeature(e){this._updateInfo.websocket++;try{this._dataReceiveEventEnabled&&this.events.emit(\"feature\",e);const t=s(e,this._serviceInfo.geometryType,!1,!1,this._serviceInfo.objectIdField);this._manager.add(t)}catch(t){}}_clearUpdateInterval(){clearInterval(this._updateIntervalId),this._updateIntervalId=0}_onUpdate(t,s){e(t)&&(this._updateInfo.client+=t.length),this._subscriptions.forEach(((e,t)=>{e.didSend&&e.tile.level===this._level&&this._onMessage({type:\"append\",id:t,addOrUpdate:null,clear:!0,end:!1})})),this._subscriptions.forEach(((e,t)=>{if(!e.didSend||e.tile.level!==this._level)return;const s=e.tile,r={type:\"append\",id:t,addOrUpdate:this._getTileFeatures(s),remove:[],end:!0,status:u.empty()};e.requests.stream.enqueue(r),this._onMessage(r)}))}}export{y as GeoEventSource};\n"]},"metadata":{},"sourceType":"module"}