{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport { isNone as t, isSome as e } from \"../../../../../core/maybe.js\";\nimport { TranslateAnchor as i } from \"../../vectorTiles/style/StyleDefinition.js\";\nimport { VTL_TEXTURE_BINDING_UNIT_SPRITES as a, VTL_HIGH_RES_CUTOFF as n } from \"../definitions.js\";\nimport { WGLDrawPhase as r } from \"../enums.js\";\nimport { u32to4Xu8 as o } from \"../number.js\";\nimport l from \"./WGLBrush.js\";\nimport { TextureSamplingMode as s, CompareFunction as f, PrimitiveType as u, DataType as c } from \"../../../../webgl/enums.js\";\nconst d = 1 / 65536;\n\nclass m extends l {\n  constructor() {\n    super(...arguments), this._fillProgramOptions = {\n      id: !1,\n      pattern: !1\n    }, this._outlineProgramOptions = {\n      id: !1\n    };\n  }\n\n  dispose() {}\n\n  drawMany(t, e) {\n    const {\n      displayLevel: i,\n      drawPhase: a,\n      renderPass: n,\n      spriteMosaic: l,\n      styleLayerUID: s\n    } = t;\n    let f = !1;\n\n    for (const r of e) if (r.layerData.has(s)) {\n      const t = r.layerData.get(s);\n\n      if (t.fillIndexCount > 0 || t.outlineIndexCount > 0) {\n        f = !0;\n        break;\n      }\n    }\n\n    if (!f) return;\n    const u = t.styleLayer,\n          c = u.getPaintProperty(\"fill-pattern\"),\n          d = void 0 !== c,\n          m = d && c.isDataDriven;\n    let p;\n\n    if (d && !m) {\n      const t = c.getValue(i);\n      p = l.getMosaicItemPosition(t, !0);\n    }\n\n    const y = !d && u.getPaintValue(\"fill-antialias\", i);\n    let g = !0,\n        _ = 1;\n\n    if (!d) {\n      const t = u.getPaintProperty(\"fill-color\"),\n            e = u.getPaintProperty(\"fill-opacity\");\n\n      if (!(null != t && t.isDataDriven || null != e && e.isDataDriven)) {\n        const t = u.getPaintValue(\"fill-color\", i);\n        _ = u.getPaintValue(\"fill-opacity\", i) * t[3], _ >= 1 && (g = !1);\n      }\n    }\n\n    if (g && \"opaque\" === n) return;\n    let E;\n    a === r.HITTEST && (E = o(s + 1));\n    const M = u.getPaintValue(\"fill-translate\", i),\n          P = u.getPaintValue(\"fill-translate-anchor\", i);\n    (g || \"translucent\" !== n) && this._drawFill(t, s, u, e, M, P, d, p, m, E);\n    const v = !u.hasDataDrivenOutlineColor && u.outlineUsesFillColor && _ < 1;\n    y && \"opaque\" !== n && !v && this._drawOutline(t, s, u, e, M, P, E);\n  }\n\n  _drawFill(o, l, m, p, y, g, _, E, M, P) {\n    if (_ && !M && t(E)) return;\n    const {\n      context: v,\n      displayLevel: I,\n      state: T,\n      drawPhase: U,\n      painter: x,\n      pixelRatio: h,\n      spriteMosaic: D\n    } = o,\n          S = m.fillMaterial,\n          N = x.vectorTilesMaterialManager,\n          w = h > n ? 2 : 1,\n          L = U === r.HITTEST,\n          R = this._fillProgramOptions;\n    R.id = L, R.pattern = _;\n    const A = N.getMaterialProgram(v, S, R);\n\n    if (v.useProgram(A), e(E)) {\n      const {\n        page: t\n      } = E,\n            i = D.getPageSize(t);\n      e(i) && (D.bind(v, s.LINEAR, t, a), A.setUniform2fv(\"u_mosaicSize\", i), A.setUniform1i(\"u_texture\", a));\n    }\n\n    A.setUniformMatrix3fv(\"u_displayMat3\", g === i.VIEWPORT ? T.displayMat3 : T.displayViewMat3), A.setUniform2fv(\"u_fillTranslation\", y), A.setUniform1f(\"u_depth\", m.z + d), L && A.setUniform4fv(\"u_id\", P);\n    let V = -1;\n\n    for (const i of p) {\n      if (!i.layerData.has(l)) continue;\n      i.key.level !== V && (V = i.key.level, S.setDataUniforms(A, I, m, V, D));\n      const n = i.layerData.get(l);\n      if (!n.fillIndexCount) continue;\n      n.prepareForRendering(v);\n      const r = n.fillVertexArrayObject;\n\n      if (!t(r)) {\n        if (v.bindVAO(r), A.setUniformMatrix3fv(\"u_dvsMat3\", i.transforms.dvs), v.setStencilFunction(f.EQUAL, i.stencilRef, 255), _) {\n          const t = Math.max(2 ** (Math.round(I) - i.key.level), 1),\n                e = i.rangeX / (w * i.width * t);\n          A.setUniform1f(\"u_patternFactor\", e);\n        }\n\n        if (M) {\n          const t = n.patternMap;\n          if (!t) continue;\n\n          for (const [i, n] of t) {\n            const t = D.getPageSize(i);\n            e(t) && (D.bind(v, s.LINEAR, i, a), A.setUniform2fv(\"u_mosaicSize\", t), A.setUniform1i(\"u_texture\", a), v.drawElements(u.TRIANGLES, n[1], c.UNSIGNED_INT, Uint32Array.BYTES_PER_ELEMENT * n[0]));\n          }\n        } else v.drawElements(u.TRIANGLES, n.fillIndexCount, c.UNSIGNED_INT, Uint32Array.BYTES_PER_ELEMENT * n.fillIndexStart);\n\n        i.triangleCount += n.fillIndexCount / 3;\n      }\n    }\n  }\n\n  _drawOutline(e, a, n, o, l, s, m) {\n    const {\n      context: p,\n      displayLevel: y,\n      state: g,\n      drawPhase: _,\n      painter: E,\n      pixelRatio: M,\n      spriteMosaic: P\n    } = e,\n          v = n.outlineMaterial,\n          I = E.vectorTilesMaterialManager,\n          T = .75 / M,\n          U = _ === r.HITTEST,\n          x = this._outlineProgramOptions;\n    x.id = U;\n    const h = I.getMaterialProgram(p, v, x);\n    p.useProgram(h), h.setUniformMatrix3fv(\"u_displayMat3\", s === i.VIEWPORT ? g.displayMat3 : g.displayViewMat3), h.setUniform2fv(\"u_fillTranslation\", l), h.setUniform1f(\"u_depth\", n.z + d), h.setUniform1f(\"u_outline_width\", T), U && h.setUniform4fv(\"u_id\", m);\n    let D = -1;\n\n    for (const i of o) {\n      if (!i.layerData.has(a)) continue;\n      i.key.level !== D && (D = i.key.level, v.setDataUniforms(h, y, n, D, P));\n      const e = i.layerData.get(a);\n      if (e.prepareForRendering(p), !e.outlineIndexCount) continue;\n      const r = e.outlineVertexArrayObject;\n      t(r) || (p.bindVAO(r), h.setUniformMatrix3fv(\"u_dvsMat3\", i.transforms.dvs), p.setStencilFunction(f.EQUAL, i.stencilRef, 255), p.drawElements(u.TRIANGLES, e.outlineIndexCount, c.UNSIGNED_INT, Uint32Array.BYTES_PER_ELEMENT * e.outlineIndexStart), i.triangleCount += e.outlineIndexCount / 3);\n    }\n  }\n\n}\n\nexport { m as WGLBrushVTLFill };","map":{"version":3,"sources":["D:/Github/CUSP_DataBase/CUSP_DB/src/main/gis/node_modules/@arcgis/core/views/2d/engine/webgl/brushes/WGLBrushVTLFill.js"],"names":["isNone","t","isSome","e","TranslateAnchor","i","VTL_TEXTURE_BINDING_UNIT_SPRITES","a","VTL_HIGH_RES_CUTOFF","n","WGLDrawPhase","r","u32to4Xu8","o","l","TextureSamplingMode","s","CompareFunction","f","PrimitiveType","u","DataType","c","d","m","constructor","arguments","_fillProgramOptions","id","pattern","_outlineProgramOptions","dispose","drawMany","displayLevel","drawPhase","renderPass","spriteMosaic","styleLayerUID","layerData","has","get","fillIndexCount","outlineIndexCount","styleLayer","getPaintProperty","isDataDriven","p","getValue","getMosaicItemPosition","y","getPaintValue","g","_","E","HITTEST","M","P","_drawFill","v","hasDataDrivenOutlineColor","outlineUsesFillColor","_drawOutline","context","I","state","T","U","painter","x","pixelRatio","h","D","S","fillMaterial","N","vectorTilesMaterialManager","w","L","R","A","getMaterialProgram","useProgram","page","getPageSize","bind","LINEAR","setUniform2fv","setUniform1i","setUniformMatrix3fv","VIEWPORT","displayMat3","displayViewMat3","setUniform1f","z","setUniform4fv","V","key","level","setDataUniforms","prepareForRendering","fillVertexArrayObject","bindVAO","transforms","dvs","setStencilFunction","EQUAL","stencilRef","Math","max","round","rangeX","width","patternMap","drawElements","TRIANGLES","UNSIGNED_INT","Uint32Array","BYTES_PER_ELEMENT","fillIndexStart","triangleCount","outlineMaterial","outlineVertexArrayObject","outlineIndexStart","WGLBrushVTLFill"],"mappings":"AAAA;AACA;AACA;AACA;AACA,SAAOA,MAAM,IAAIC,CAAjB,EAAmBC,MAAM,IAAIC,CAA7B,QAAmC,8BAAnC;AAAkE,SAAOC,eAAe,IAAIC,CAA1B,QAAgC,4CAAhC;AAA6E,SAAOC,gCAAgC,IAAIC,CAA3C,EAA6CC,mBAAmB,IAAIC,CAApE,QAA0E,mBAA1E;AAA8F,SAAOC,YAAY,IAAIC,CAAvB,QAA6B,aAA7B;AAA2C,SAAOC,SAAS,IAAIC,CAApB,QAA0B,cAA1B;AAAyC,OAAOC,CAAP,MAAa,eAAb;AAA6B,SAAOC,mBAAmB,IAAIC,CAA9B,EAAgCC,eAAe,IAAIC,CAAnD,EAAqDC,aAAa,IAAIC,CAAtE,EAAwEC,QAAQ,IAAIC,CAApF,QAA0F,4BAA1F;AAAuH,MAAMC,CAAC,GAAC,IAAE,KAAV;;AAAgB,MAAMC,CAAN,SAAgBV,CAAhB,CAAiB;AAACW,EAAAA,WAAW,GAAE;AAAC,UAAM,GAAGC,SAAT,GAAoB,KAAKC,mBAAL,GAAyB;AAACC,MAAAA,EAAE,EAAC,CAAC,CAAL;AAAOC,MAAAA,OAAO,EAAC,CAAC;AAAhB,KAA7C,EAAgE,KAAKC,sBAAL,GAA4B;AAACF,MAAAA,EAAE,EAAC,CAAC;AAAL,KAA5F;AAAoG;;AAAAG,EAAAA,OAAO,GAAE,CAAE;;AAAAC,EAAAA,QAAQ,CAAC/B,CAAD,EAAGE,CAAH,EAAK;AAAC,UAAK;AAAC8B,MAAAA,YAAY,EAAC5B,CAAd;AAAgB6B,MAAAA,SAAS,EAAC3B,CAA1B;AAA4B4B,MAAAA,UAAU,EAAC1B,CAAvC;AAAyC2B,MAAAA,YAAY,EAACtB,CAAtD;AAAwDuB,MAAAA,aAAa,EAACrB;AAAtE,QAAyEf,CAA9E;AAAgF,QAAIiB,CAAC,GAAC,CAAC,CAAP;;AAAS,SAAI,MAAMP,CAAV,IAAeR,CAAf,EAAiB,IAAGQ,CAAC,CAAC2B,SAAF,CAAYC,GAAZ,CAAgBvB,CAAhB,CAAH,EAAsB;AAAC,YAAMf,CAAC,GAACU,CAAC,CAAC2B,SAAF,CAAYE,GAAZ,CAAgBxB,CAAhB,CAAR;;AAA2B,UAAGf,CAAC,CAACwC,cAAF,GAAiB,CAAjB,IAAoBxC,CAAC,CAACyC,iBAAF,GAAoB,CAA3C,EAA6C;AAACxB,QAAAA,CAAC,GAAC,CAAC,CAAH;AAAK;AAAM;AAAC;;AAAA,QAAG,CAACA,CAAJ,EAAM;AAAO,UAAME,CAAC,GAACnB,CAAC,CAAC0C,UAAV;AAAA,UAAqBrB,CAAC,GAACF,CAAC,CAACwB,gBAAF,CAAmB,cAAnB,CAAvB;AAAA,UAA0DrB,CAAC,GAAC,KAAK,CAAL,KAASD,CAArE;AAAA,UAAuEE,CAAC,GAACD,CAAC,IAAED,CAAC,CAACuB,YAA9E;AAA2F,QAAIC,CAAJ;;AAAM,QAAGvB,CAAC,IAAE,CAACC,CAAP,EAAS;AAAC,YAAMvB,CAAC,GAACqB,CAAC,CAACyB,QAAF,CAAW1C,CAAX,CAAR;AAAsByC,MAAAA,CAAC,GAAChC,CAAC,CAACkC,qBAAF,CAAwB/C,CAAxB,EAA0B,CAAC,CAA3B,CAAF;AAAgC;;AAAA,UAAMgD,CAAC,GAAC,CAAC1B,CAAD,IAAIH,CAAC,CAAC8B,aAAF,CAAgB,gBAAhB,EAAiC7C,CAAjC,CAAZ;AAAgD,QAAI8C,CAAC,GAAC,CAAC,CAAP;AAAA,QAASC,CAAC,GAAC,CAAX;;AAAa,QAAG,CAAC7B,CAAJ,EAAM;AAAC,YAAMtB,CAAC,GAACmB,CAAC,CAACwB,gBAAF,CAAmB,YAAnB,CAAR;AAAA,YAAyCzC,CAAC,GAACiB,CAAC,CAACwB,gBAAF,CAAmB,cAAnB,CAA3C;;AAA8E,UAAG,EAAE,QAAM3C,CAAN,IAASA,CAAC,CAAC4C,YAAX,IAAyB,QAAM1C,CAAN,IAASA,CAAC,CAAC0C,YAAtC,CAAH,EAAuD;AAAC,cAAM5C,CAAC,GAACmB,CAAC,CAAC8B,aAAF,CAAgB,YAAhB,EAA6B7C,CAA7B,CAAR;AAAwC+C,QAAAA,CAAC,GAAChC,CAAC,CAAC8B,aAAF,CAAgB,cAAhB,EAA+B7C,CAA/B,IAAkCJ,CAAC,CAAC,CAAD,CAArC,EAAyCmD,CAAC,IAAE,CAAH,KAAOD,CAAC,GAAC,CAAC,CAAV,CAAzC;AAAsD;AAAC;;AAAA,QAAGA,CAAC,IAAE,aAAW1C,CAAjB,EAAmB;AAAO,QAAI4C,CAAJ;AAAM9C,IAAAA,CAAC,KAAGI,CAAC,CAAC2C,OAAN,KAAgBD,CAAC,GAACxC,CAAC,CAACG,CAAC,GAAC,CAAH,CAAnB;AAA0B,UAAMuC,CAAC,GAACnC,CAAC,CAAC8B,aAAF,CAAgB,gBAAhB,EAAiC7C,CAAjC,CAAR;AAAA,UAA4CmD,CAAC,GAACpC,CAAC,CAAC8B,aAAF,CAAgB,uBAAhB,EAAwC7C,CAAxC,CAA9C;AAAyF,KAAC8C,CAAC,IAAE,kBAAgB1C,CAApB,KAAwB,KAAKgD,SAAL,CAAexD,CAAf,EAAiBe,CAAjB,EAAmBI,CAAnB,EAAqBjB,CAArB,EAAuBoD,CAAvB,EAAyBC,CAAzB,EAA2BjC,CAA3B,EAA6BuB,CAA7B,EAA+BtB,CAA/B,EAAiC6B,CAAjC,CAAxB;AAA4D,UAAMK,CAAC,GAAC,CAACtC,CAAC,CAACuC,yBAAH,IAA8BvC,CAAC,CAACwC,oBAAhC,IAAsDR,CAAC,GAAC,CAAhE;AAAkEH,IAAAA,CAAC,IAAE,aAAWxC,CAAd,IAAiB,CAACiD,CAAlB,IAAqB,KAAKG,YAAL,CAAkB5D,CAAlB,EAAoBe,CAApB,EAAsBI,CAAtB,EAAwBjB,CAAxB,EAA0BoD,CAA1B,EAA4BC,CAA5B,EAA8BH,CAA9B,CAArB;AAAsD;;AAAAI,EAAAA,SAAS,CAAC5C,CAAD,EAAGC,CAAH,EAAKU,CAAL,EAAOsB,CAAP,EAASG,CAAT,EAAWE,CAAX,EAAaC,CAAb,EAAeC,CAAf,EAAiBE,CAAjB,EAAmBC,CAAnB,EAAqB;AAAC,QAAGJ,CAAC,IAAE,CAACG,CAAJ,IAAOtD,CAAC,CAACoD,CAAD,CAAX,EAAe;AAAO,UAAK;AAACS,MAAAA,OAAO,EAACJ,CAAT;AAAWzB,MAAAA,YAAY,EAAC8B,CAAxB;AAA0BC,MAAAA,KAAK,EAACC,CAAhC;AAAkC/B,MAAAA,SAAS,EAACgC,CAA5C;AAA8CC,MAAAA,OAAO,EAACC,CAAtD;AAAwDC,MAAAA,UAAU,EAACC,CAAnE;AAAqElC,MAAAA,YAAY,EAACmC;AAAlF,QAAqF1D,CAA1F;AAAA,UAA4F2D,CAAC,GAAChD,CAAC,CAACiD,YAAhG;AAAA,UAA6GC,CAAC,GAACN,CAAC,CAACO,0BAAjH;AAAA,UAA4IC,CAAC,GAACN,CAAC,GAAC7D,CAAF,GAAI,CAAJ,GAAM,CAApJ;AAAA,UAAsJoE,CAAC,GAACX,CAAC,KAAGvD,CAAC,CAAC2C,OAA9J;AAAA,UAAsKwB,CAAC,GAAC,KAAKnD,mBAA7K;AAAiMmD,IAAAA,CAAC,CAAClD,EAAF,GAAKiD,CAAL,EAAOC,CAAC,CAACjD,OAAF,GAAUuB,CAAjB;AAAmB,UAAM2B,CAAC,GAACL,CAAC,CAACM,kBAAF,CAAqBtB,CAArB,EAAuBc,CAAvB,EAAyBM,CAAzB,CAAR;;AAAoC,QAAGpB,CAAC,CAACuB,UAAF,CAAaF,CAAb,GAAgB5E,CAAC,CAACkD,CAAD,CAApB,EAAwB;AAAC,YAAK;AAAC6B,QAAAA,IAAI,EAACjF;AAAN,UAASoD,CAAd;AAAA,YAAgBhD,CAAC,GAACkE,CAAC,CAACY,WAAF,CAAclF,CAAd,CAAlB;AAAmCE,MAAAA,CAAC,CAACE,CAAD,CAAD,KAAOkE,CAAC,CAACa,IAAF,CAAO1B,CAAP,EAAS1C,CAAC,CAACqE,MAAX,EAAkBpF,CAAlB,EAAoBM,CAApB,GAAuBwE,CAAC,CAACO,aAAF,CAAgB,cAAhB,EAA+BjF,CAA/B,CAAvB,EAAyD0E,CAAC,CAACQ,YAAF,CAAe,WAAf,EAA2BhF,CAA3B,CAAhE;AAA+F;;AAAAwE,IAAAA,CAAC,CAACS,mBAAF,CAAsB,eAAtB,EAAsCrC,CAAC,KAAG9C,CAAC,CAACoF,QAAN,GAAexB,CAAC,CAACyB,WAAjB,GAA6BzB,CAAC,CAAC0B,eAArE,GAAsFZ,CAAC,CAACO,aAAF,CAAgB,mBAAhB,EAAoCrC,CAApC,CAAtF,EAA6H8B,CAAC,CAACa,YAAF,CAAe,SAAf,EAAyBpE,CAAC,CAACqE,CAAF,GAAItE,CAA7B,CAA7H,EAA6JsD,CAAC,IAAEE,CAAC,CAACe,aAAF,CAAgB,MAAhB,EAAuBtC,CAAvB,CAAhK;AAA0L,QAAIuC,CAAC,GAAC,CAAC,CAAP;;AAAS,SAAI,MAAM1F,CAAV,IAAeyC,CAAf,EAAiB;AAAC,UAAG,CAACzC,CAAC,CAACiC,SAAF,CAAYC,GAAZ,CAAgBzB,CAAhB,CAAJ,EAAuB;AAAST,MAAAA,CAAC,CAAC2F,GAAF,CAAMC,KAAN,KAAcF,CAAd,KAAkBA,CAAC,GAAC1F,CAAC,CAAC2F,GAAF,CAAMC,KAAR,EAAczB,CAAC,CAAC0B,eAAF,CAAkBnB,CAAlB,EAAoBhB,CAApB,EAAsBvC,CAAtB,EAAwBuE,CAAxB,EAA0BxB,CAA1B,CAAhC;AAA8D,YAAM9D,CAAC,GAACJ,CAAC,CAACiC,SAAF,CAAYE,GAAZ,CAAgB1B,CAAhB,CAAR;AAA2B,UAAG,CAACL,CAAC,CAACgC,cAAN,EAAqB;AAAShC,MAAAA,CAAC,CAAC0F,mBAAF,CAAsBzC,CAAtB;AAAyB,YAAM/C,CAAC,GAACF,CAAC,CAAC2F,qBAAV;;AAAgC,UAAG,CAACnG,CAAC,CAACU,CAAD,CAAL,EAAS;AAAC,YAAG+C,CAAC,CAAC2C,OAAF,CAAU1F,CAAV,GAAaoE,CAAC,CAACS,mBAAF,CAAsB,WAAtB,EAAkCnF,CAAC,CAACiG,UAAF,CAAaC,GAA/C,CAAb,EAAiE7C,CAAC,CAAC8C,kBAAF,CAAqBtF,CAAC,CAACuF,KAAvB,EAA6BpG,CAAC,CAACqG,UAA/B,EAA0C,GAA1C,CAAjE,EAAgHtD,CAAnH,EAAqH;AAAC,gBAAMnD,CAAC,GAAC0G,IAAI,CAACC,GAAL,CAAS,MAAID,IAAI,CAACE,KAAL,CAAW9C,CAAX,IAAc1D,CAAC,CAAC2F,GAAF,CAAMC,KAAxB,CAAT,EAAwC,CAAxC,CAAR;AAAA,gBAAmD9F,CAAC,GAACE,CAAC,CAACyG,MAAF,IAAUlC,CAAC,GAACvE,CAAC,CAAC0G,KAAJ,GAAU9G,CAApB,CAArD;AAA4E8E,UAAAA,CAAC,CAACa,YAAF,CAAe,iBAAf,EAAiCzF,CAAjC;AAAoC;;AAAA,YAAGoD,CAAH,EAAK;AAAC,gBAAMtD,CAAC,GAACQ,CAAC,CAACuG,UAAV;AAAqB,cAAG,CAAC/G,CAAJ,EAAM;;AAAS,eAAI,MAAK,CAACI,CAAD,EAAGI,CAAH,CAAT,IAAiBR,CAAjB,EAAmB;AAAC,kBAAMA,CAAC,GAACsE,CAAC,CAACY,WAAF,CAAc9E,CAAd,CAAR;AAAyBF,YAAAA,CAAC,CAACF,CAAD,CAAD,KAAOsE,CAAC,CAACa,IAAF,CAAO1B,CAAP,EAAS1C,CAAC,CAACqE,MAAX,EAAkBhF,CAAlB,EAAoBE,CAApB,GAAuBwE,CAAC,CAACO,aAAF,CAAgB,cAAhB,EAA+BrF,CAA/B,CAAvB,EAAyD8E,CAAC,CAACQ,YAAF,CAAe,WAAf,EAA2BhF,CAA3B,CAAzD,EAAuFmD,CAAC,CAACuD,YAAF,CAAe7F,CAAC,CAAC8F,SAAjB,EAA2BzG,CAAC,CAAC,CAAD,CAA5B,EAAgCa,CAAC,CAAC6F,YAAlC,EAA+CC,WAAW,CAACC,iBAAZ,GAA8B5G,CAAC,CAAC,CAAD,CAA9E,CAA9F;AAAkL;AAAC,SAA1Q,MAA+QiD,CAAC,CAACuD,YAAF,CAAe7F,CAAC,CAAC8F,SAAjB,EAA2BzG,CAAC,CAACgC,cAA7B,EAA4CnB,CAAC,CAAC6F,YAA9C,EAA2DC,WAAW,CAACC,iBAAZ,GAA8B5G,CAAC,CAAC6G,cAA3F;;AAA2GjH,QAAAA,CAAC,CAACkH,aAAF,IAAiB9G,CAAC,CAACgC,cAAF,GAAiB,CAAlC;AAAoC;AAAC;AAAC;;AAAAoB,EAAAA,YAAY,CAAC1D,CAAD,EAAGI,CAAH,EAAKE,CAAL,EAAOI,CAAP,EAASC,CAAT,EAAWE,CAAX,EAAaQ,CAAb,EAAe;AAAC,UAAK;AAACsC,MAAAA,OAAO,EAAChB,CAAT;AAAWb,MAAAA,YAAY,EAACgB,CAAxB;AAA0Be,MAAAA,KAAK,EAACb,CAAhC;AAAkCjB,MAAAA,SAAS,EAACkB,CAA5C;AAA8Ce,MAAAA,OAAO,EAACd,CAAtD;AAAwDgB,MAAAA,UAAU,EAACd,CAAnE;AAAqEnB,MAAAA,YAAY,EAACoB;AAAlF,QAAqFrD,CAA1F;AAAA,UAA4FuD,CAAC,GAACjD,CAAC,CAAC+G,eAAhG;AAAA,UAAgHzD,CAAC,GAACV,CAAC,CAACsB,0BAApH;AAAA,UAA+IV,CAAC,GAAC,MAAIV,CAArJ;AAAA,UAAuJW,CAAC,GAACd,CAAC,KAAGzC,CAAC,CAAC2C,OAA/J;AAAA,UAAuKc,CAAC,GAAC,KAAKtC,sBAA9K;AAAqMsC,IAAAA,CAAC,CAACxC,EAAF,GAAKsC,CAAL;AAAO,UAAMI,CAAC,GAACP,CAAC,CAACiB,kBAAF,CAAqBlC,CAArB,EAAuBY,CAAvB,EAAyBU,CAAzB,CAAR;AAAoCtB,IAAAA,CAAC,CAACmC,UAAF,CAAaX,CAAb,GAAgBA,CAAC,CAACkB,mBAAF,CAAsB,eAAtB,EAAsCxE,CAAC,KAAGX,CAAC,CAACoF,QAAN,GAAetC,CAAC,CAACuC,WAAjB,GAA6BvC,CAAC,CAACwC,eAArE,CAAhB,EAAsGrB,CAAC,CAACgB,aAAF,CAAgB,mBAAhB,EAAoCxE,CAApC,CAAtG,EAA6IwD,CAAC,CAACsB,YAAF,CAAe,SAAf,EAAyBnF,CAAC,CAACoF,CAAF,GAAItE,CAA7B,CAA7I,EAA6K+C,CAAC,CAACsB,YAAF,CAAe,iBAAf,EAAiC3B,CAAjC,CAA7K,EAAiNC,CAAC,IAAEI,CAAC,CAACwB,aAAF,CAAgB,MAAhB,EAAuBtE,CAAvB,CAApN;AAA8O,QAAI+C,CAAC,GAAC,CAAC,CAAP;;AAAS,SAAI,MAAMlE,CAAV,IAAeQ,CAAf,EAAiB;AAAC,UAAG,CAACR,CAAC,CAACiC,SAAF,CAAYC,GAAZ,CAAgBhC,CAAhB,CAAJ,EAAuB;AAASF,MAAAA,CAAC,CAAC2F,GAAF,CAAMC,KAAN,KAAc1B,CAAd,KAAkBA,CAAC,GAAClE,CAAC,CAAC2F,GAAF,CAAMC,KAAR,EAAcvC,CAAC,CAACwC,eAAF,CAAkB5B,CAAlB,EAAoBrB,CAApB,EAAsBxC,CAAtB,EAAwB8D,CAAxB,EAA0Bf,CAA1B,CAAhC;AAA8D,YAAMrD,CAAC,GAACE,CAAC,CAACiC,SAAF,CAAYE,GAAZ,CAAgBjC,CAAhB,CAAR;AAA2B,UAAGJ,CAAC,CAACgG,mBAAF,CAAsBrD,CAAtB,GAAyB,CAAC3C,CAAC,CAACuC,iBAA/B,EAAiD;AAAS,YAAM/B,CAAC,GAACR,CAAC,CAACsH,wBAAV;AAAmCxH,MAAAA,CAAC,CAACU,CAAD,CAAD,KAAOmC,CAAC,CAACuD,OAAF,CAAU1F,CAAV,GAAa2D,CAAC,CAACkB,mBAAF,CAAsB,WAAtB,EAAkCnF,CAAC,CAACiG,UAAF,CAAaC,GAA/C,CAAb,EAAiEzD,CAAC,CAAC0D,kBAAF,CAAqBtF,CAAC,CAACuF,KAAvB,EAA6BpG,CAAC,CAACqG,UAA/B,EAA0C,GAA1C,CAAjE,EAAgH5D,CAAC,CAACmE,YAAF,CAAe7F,CAAC,CAAC8F,SAAjB,EAA2B/G,CAAC,CAACuC,iBAA7B,EAA+CpB,CAAC,CAAC6F,YAAjD,EAA8DC,WAAW,CAACC,iBAAZ,GAA8BlH,CAAC,CAACuH,iBAA9F,CAAhH,EAAiOrH,CAAC,CAACkH,aAAF,IAAiBpH,CAAC,CAACuC,iBAAF,GAAoB,CAA7Q;AAAgR;AAAC;;AAAznH;;AAA0nH,SAAOlB,CAAC,IAAImG,eAAZ","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport{isNone as t,isSome as e}from\"../../../../../core/maybe.js\";import{TranslateAnchor as i}from\"../../vectorTiles/style/StyleDefinition.js\";import{VTL_TEXTURE_BINDING_UNIT_SPRITES as a,VTL_HIGH_RES_CUTOFF as n}from\"../definitions.js\";import{WGLDrawPhase as r}from\"../enums.js\";import{u32to4Xu8 as o}from\"../number.js\";import l from\"./WGLBrush.js\";import{TextureSamplingMode as s,CompareFunction as f,PrimitiveType as u,DataType as c}from\"../../../../webgl/enums.js\";const d=1/65536;class m extends l{constructor(){super(...arguments),this._fillProgramOptions={id:!1,pattern:!1},this._outlineProgramOptions={id:!1}}dispose(){}drawMany(t,e){const{displayLevel:i,drawPhase:a,renderPass:n,spriteMosaic:l,styleLayerUID:s}=t;let f=!1;for(const r of e)if(r.layerData.has(s)){const t=r.layerData.get(s);if(t.fillIndexCount>0||t.outlineIndexCount>0){f=!0;break}}if(!f)return;const u=t.styleLayer,c=u.getPaintProperty(\"fill-pattern\"),d=void 0!==c,m=d&&c.isDataDriven;let p;if(d&&!m){const t=c.getValue(i);p=l.getMosaicItemPosition(t,!0)}const y=!d&&u.getPaintValue(\"fill-antialias\",i);let g=!0,_=1;if(!d){const t=u.getPaintProperty(\"fill-color\"),e=u.getPaintProperty(\"fill-opacity\");if(!(null!=t&&t.isDataDriven||null!=e&&e.isDataDriven)){const t=u.getPaintValue(\"fill-color\",i);_=u.getPaintValue(\"fill-opacity\",i)*t[3],_>=1&&(g=!1)}}if(g&&\"opaque\"===n)return;let E;a===r.HITTEST&&(E=o(s+1));const M=u.getPaintValue(\"fill-translate\",i),P=u.getPaintValue(\"fill-translate-anchor\",i);(g||\"translucent\"!==n)&&this._drawFill(t,s,u,e,M,P,d,p,m,E);const v=!u.hasDataDrivenOutlineColor&&u.outlineUsesFillColor&&_<1;y&&\"opaque\"!==n&&!v&&this._drawOutline(t,s,u,e,M,P,E)}_drawFill(o,l,m,p,y,g,_,E,M,P){if(_&&!M&&t(E))return;const{context:v,displayLevel:I,state:T,drawPhase:U,painter:x,pixelRatio:h,spriteMosaic:D}=o,S=m.fillMaterial,N=x.vectorTilesMaterialManager,w=h>n?2:1,L=U===r.HITTEST,R=this._fillProgramOptions;R.id=L,R.pattern=_;const A=N.getMaterialProgram(v,S,R);if(v.useProgram(A),e(E)){const{page:t}=E,i=D.getPageSize(t);e(i)&&(D.bind(v,s.LINEAR,t,a),A.setUniform2fv(\"u_mosaicSize\",i),A.setUniform1i(\"u_texture\",a))}A.setUniformMatrix3fv(\"u_displayMat3\",g===i.VIEWPORT?T.displayMat3:T.displayViewMat3),A.setUniform2fv(\"u_fillTranslation\",y),A.setUniform1f(\"u_depth\",m.z+d),L&&A.setUniform4fv(\"u_id\",P);let V=-1;for(const i of p){if(!i.layerData.has(l))continue;i.key.level!==V&&(V=i.key.level,S.setDataUniforms(A,I,m,V,D));const n=i.layerData.get(l);if(!n.fillIndexCount)continue;n.prepareForRendering(v);const r=n.fillVertexArrayObject;if(!t(r)){if(v.bindVAO(r),A.setUniformMatrix3fv(\"u_dvsMat3\",i.transforms.dvs),v.setStencilFunction(f.EQUAL,i.stencilRef,255),_){const t=Math.max(2**(Math.round(I)-i.key.level),1),e=i.rangeX/(w*i.width*t);A.setUniform1f(\"u_patternFactor\",e)}if(M){const t=n.patternMap;if(!t)continue;for(const[i,n]of t){const t=D.getPageSize(i);e(t)&&(D.bind(v,s.LINEAR,i,a),A.setUniform2fv(\"u_mosaicSize\",t),A.setUniform1i(\"u_texture\",a),v.drawElements(u.TRIANGLES,n[1],c.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*n[0]))}}else v.drawElements(u.TRIANGLES,n.fillIndexCount,c.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*n.fillIndexStart);i.triangleCount+=n.fillIndexCount/3}}}_drawOutline(e,a,n,o,l,s,m){const{context:p,displayLevel:y,state:g,drawPhase:_,painter:E,pixelRatio:M,spriteMosaic:P}=e,v=n.outlineMaterial,I=E.vectorTilesMaterialManager,T=.75/M,U=_===r.HITTEST,x=this._outlineProgramOptions;x.id=U;const h=I.getMaterialProgram(p,v,x);p.useProgram(h),h.setUniformMatrix3fv(\"u_displayMat3\",s===i.VIEWPORT?g.displayMat3:g.displayViewMat3),h.setUniform2fv(\"u_fillTranslation\",l),h.setUniform1f(\"u_depth\",n.z+d),h.setUniform1f(\"u_outline_width\",T),U&&h.setUniform4fv(\"u_id\",m);let D=-1;for(const i of o){if(!i.layerData.has(a))continue;i.key.level!==D&&(D=i.key.level,v.setDataUniforms(h,y,n,D,P));const e=i.layerData.get(a);if(e.prepareForRendering(p),!e.outlineIndexCount)continue;const r=e.outlineVertexArrayObject;t(r)||(p.bindVAO(r),h.setUniformMatrix3fv(\"u_dvsMat3\",i.transforms.dvs),p.setStencilFunction(f.EQUAL,i.stencilRef,255),p.drawElements(u.TRIANGLES,e.outlineIndexCount,c.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*e.outlineIndexStart),i.triangleCount+=e.outlineIndexCount/3)}}}export{m as WGLBrushVTLFill};\n"]},"metadata":{},"sourceType":"module"}