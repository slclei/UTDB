{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport e from \"../../../../core/CircularArray.js\";\nimport \"../../../../core/has.js\";\nimport { isSome as t, unwrapOr as r, isNone as s } from \"../../../../core/maybe.js\";\nimport { a as i, m as a } from \"../../../../chunks/mat2d.js\";\nimport { c as n } from \"../../../../chunks/mat2df32.js\";\nimport { t as h } from \"../../../../chunks/vec2.js\";\nimport { c } from \"../../../../chunks/vec2f32.js\";\nimport { WGLGeometryType as o } from \"./enums.js\";\nimport { forEachGeometryType as d } from \"./Utils.js\";\nimport { WGLTile as _ } from \"./WGLTile.js\";\nimport { MetricReader as u } from \"./collisions/MetricReader.js\";\nimport { Geometry as m } from \"./cpuMapped/Geometry.js\";\nconst p = 50,\n      l = 4,\n      f = 8,\n      S = 100;\nlet y = 0;\n\nclass w extends _ {\n  constructor(t, r, s, i, a) {\n    super(t, r, s), this.instanceId = y++, this.patchCount = 0, this._renderState = {\n      current: {\n        geometry: new Map(),\n        metrics: null\n      },\n      next: null,\n      swap: !1,\n      swapFrames: 0,\n      locked: !1\n    }, this._patches = new e(S), this._bufferPatches = new e(S), this._lastCommitTime = 0, this._lastMessageWasClear = !1, this.transforms.labelMat2d = n(), this._store = i, this._requestLabelUpdate = a;\n  }\n\n  destroy() {\n    super.destroy(), this._renderState.current.geometry.forEach(e => e.destroy());\n  }\n\n  get labelMetrics() {\n    return this._renderState.current.metrics;\n  }\n\n  get hasData() {\n    return !!this._renderState.current.geometry.size;\n  }\n\n  getGeometry(e) {\n    return this._renderState.current.geometry.get(e);\n  }\n\n  setTransform(e, t) {\n    super.setTransform(e, t);\n    const r = this.transforms.labelMat2d,\n          s = e.getScreenTransform(r, t),\n          n = c();\n    h(n, [this.x, this.y], s), i(r, n), a(r, e.viewMat2d, r);\n  }\n\n  patch(e, t) {\n    if (this.patchCount++, e.clear && this._lastMessageWasClear) return;\n    this._lastMessageWasClear = e.clear, e.clear && this._patches.size >= p && this._dropPatches();\n    const r = e,\n          s = r.addOrUpdate && this.key.id !== r.addOrUpdate.tileKeyOrigin;\n    t && s ? this._bufferPatches.enqueue(r) : (r.sort = r.sort && !t, this._patches.enqueue(r)), this.requestRender();\n  }\n\n  commit(e) {\n    if (this._lastCommitTime !== e.time) {\n      this._lastCommitTime = e.time;\n\n      for (let e = 0; e < l; e++) this._updateMesh(), this.isReady && this._updateBufferMesh();\n\n      this._renderState.swap && (this._swapRenderStates(), this.requestRender());\n    }\n  }\n\n  lock() {\n    this._renderState.locked = !0;\n  }\n\n  unlock() {\n    this._renderState.locked = !1, this._flushUpdates(), this._swap();\n  }\n\n  _swapRenderStates() {\n    if (this._renderState.next) {\n      if (this._renderState.locked) return this._renderState.swap = !0, void this.requestRender();\n      if (this._renderState.swap = !0, 0 === this._renderState.swapFrames) return this._renderState.swapFrames = f, void this.requestRender();\n      1 == this._renderState.swapFrames-- ? this._swap() : this.requestRender();\n    }\n  }\n\n  _swap() {\n    this._renderState.swap && (this._renderState.swap = !1, t(this._renderState.next) && (this._renderState.current.geometry.forEach(e => e.destroy()), this._renderState.current = this._renderState.next, this._renderState.next = null, this._requestLabelUpdate()));\n  }\n\n  _flushUpdates() {\n    let e = this._patches.maxSize;\n\n    for (; this._patches.size && e--;) this._updateMesh(), this._swap();\n  }\n\n  _updateBufferMesh() {\n    const e = this._bufferPatches.peek();\n\n    if (!t(e) || !e.clear || null === this._renderState.next) for (; this._bufferPatches.size;) {\n      const e = this._bufferPatches.dequeue();\n\n      t(e) && this._patchBuffer(e);\n    }\n  }\n\n  _updateMesh() {\n    const e = this._patches.peek();\n\n    if (t(e) && e.clear && null !== this._renderState.next) return;\n\n    const r = this._patches.dequeue();\n\n    if (t(r)) {\n      if (!0 === r.clear) {\n        if (!this.isReady) return;\n        return this._renderState.next, void (this._renderState.next = {\n          geometry: new Map(),\n          metrics: null\n        });\n      }\n\n      this.requestRender(), this._patch(r), r.end && (this.ready(), this._swapRenderStates());\n    }\n  }\n\n  _patch(e) {\n    d(t => {\n      this._remove(t, e.remove), this._insert(t, e, !1);\n    });\n  }\n\n  _patchBuffer(e) {\n    d(t => {\n      this._insert(t, e, !0);\n    });\n  }\n\n  _insert(e, t, i) {\n    try {\n      var a;\n      const n = r(this._renderState.next, this._renderState.current),\n            h = null == (a = t.addOrUpdate) ? void 0 : a.data[e],\n            c = n.geometry;\n      if (s(h)) return;\n      c.has(e) || c.set(e, new m(e, this.stage)), c.get(e).insert(h, t.sort, i), e === o.LABEL && this._insertLabelMetrics(t.type, h.metrics, t.clear);\n    } catch (n) {}\n  }\n\n  _insertLabelMetrics(e, t, i) {\n    const a = r(this._renderState.next, this._renderState.current);\n    if (s(t)) return;\n    const n = u.from(t);\n    if (s(a.metrics)) a.metrics = n;else {\n      if (\"update\" === e) {\n        const e = n.getCursor();\n\n        for (; e.next();) a.metrics.delete(e.id);\n      }\n\n      a.metrics.link(n);\n    }\n  }\n\n  _remove(e, t) {\n    const s = r(this._renderState.next, this._renderState.current).geometry.get(e);\n    t && t.length && s && (s.remove(t), this._removeLabelMetrics(t));\n  }\n\n  _removeLabelMetrics(e) {\n    const {\n      metrics: t\n    } = r(this._renderState.next, this._renderState.current);\n    if (!s(t) && e.length) for (const r of e) for (; t.delete(r););\n  }\n\n  _dropPatches() {\n    const e = new Array();\n    let t = !1;\n\n    for (; this._patches.size;) {\n      const r = this._patches.dequeue();\n\n      if (s(r)) break;\n\n      if (r.clear) {\n        if (t) break;\n        t = !0;\n      }\n\n      e.push(r);\n    }\n\n    this._patches.clear(), e.forEach(e => this._patches.enqueue(e));\n  }\n\n}\n\nexport { w as FeatureTile };","map":{"version":3,"sources":["D:/Github/CUSP_DataBase/CUSP_DB/src/main/gis/node_modules/@arcgis/core/views/2d/engine/webgl/FeatureTile.js"],"names":["e","isSome","t","unwrapOr","r","isNone","s","a","i","m","c","n","h","WGLGeometryType","o","forEachGeometryType","d","WGLTile","_","MetricReader","u","Geometry","p","l","f","S","y","w","constructor","instanceId","patchCount","_renderState","current","geometry","Map","metrics","next","swap","swapFrames","locked","_patches","_bufferPatches","_lastCommitTime","_lastMessageWasClear","transforms","labelMat2d","_store","_requestLabelUpdate","destroy","forEach","labelMetrics","hasData","size","getGeometry","get","setTransform","getScreenTransform","x","viewMat2d","patch","clear","_dropPatches","addOrUpdate","key","id","tileKeyOrigin","enqueue","sort","requestRender","commit","time","_updateMesh","isReady","_updateBufferMesh","_swapRenderStates","lock","unlock","_flushUpdates","_swap","maxSize","peek","dequeue","_patchBuffer","_patch","end","ready","_remove","remove","_insert","data","has","set","stage","insert","LABEL","_insertLabelMetrics","type","from","getCursor","delete","link","length","_removeLabelMetrics","Array","push","FeatureTile"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport e from\"../../../../core/CircularArray.js\";import\"../../../../core/has.js\";import{isSome as t,unwrapOr as r,isNone as s}from\"../../../../core/maybe.js\";import{a as i,m as a}from\"../../../../chunks/mat2d.js\";import{c as n}from\"../../../../chunks/mat2df32.js\";import{t as h}from\"../../../../chunks/vec2.js\";import{c}from\"../../../../chunks/vec2f32.js\";import{WGLGeometryType as o}from\"./enums.js\";import{forEachGeometryType as d}from\"./Utils.js\";import{WGLTile as _}from\"./WGLTile.js\";import{MetricReader as u}from\"./collisions/MetricReader.js\";import{Geometry as m}from\"./cpuMapped/Geometry.js\";const p=50,l=4,f=8,S=100;let y=0;class w extends _{constructor(t,r,s,i,a){super(t,r,s),this.instanceId=y++,this.patchCount=0,this._renderState={current:{geometry:new Map,metrics:null},next:null,swap:!1,swapFrames:0,locked:!1},this._patches=new e(S),this._bufferPatches=new e(S),this._lastCommitTime=0,this._lastMessageWasClear=!1,this.transforms.labelMat2d=n(),this._store=i,this._requestLabelUpdate=a}destroy(){super.destroy(),this._renderState.current.geometry.forEach((e=>e.destroy()))}get labelMetrics(){return this._renderState.current.metrics}get hasData(){return!!this._renderState.current.geometry.size}getGeometry(e){return this._renderState.current.geometry.get(e)}setTransform(e,t){super.setTransform(e,t);const r=this.transforms.labelMat2d,s=e.getScreenTransform(r,t),n=c();h(n,[this.x,this.y],s),i(r,n),a(r,e.viewMat2d,r)}patch(e,t){if(this.patchCount++,e.clear&&this._lastMessageWasClear)return;this._lastMessageWasClear=e.clear,e.clear&&this._patches.size>=p&&this._dropPatches();const r=e,s=r.addOrUpdate&&this.key.id!==r.addOrUpdate.tileKeyOrigin;t&&s?this._bufferPatches.enqueue(r):(r.sort=r.sort&&!t,this._patches.enqueue(r)),this.requestRender()}commit(e){if(this._lastCommitTime!==e.time){this._lastCommitTime=e.time;for(let e=0;e<l;e++)this._updateMesh(),this.isReady&&this._updateBufferMesh();this._renderState.swap&&(this._swapRenderStates(),this.requestRender())}}lock(){this._renderState.locked=!0}unlock(){this._renderState.locked=!1,this._flushUpdates(),this._swap()}_swapRenderStates(){if(this._renderState.next){if(this._renderState.locked)return this._renderState.swap=!0,void this.requestRender();if(this._renderState.swap=!0,0===this._renderState.swapFrames)return this._renderState.swapFrames=f,void this.requestRender();1==this._renderState.swapFrames--?this._swap():this.requestRender()}}_swap(){this._renderState.swap&&(this._renderState.swap=!1,t(this._renderState.next)&&(this._renderState.current.geometry.forEach((e=>e.destroy())),this._renderState.current=this._renderState.next,this._renderState.next=null,this._requestLabelUpdate()))}_flushUpdates(){let e=this._patches.maxSize;for(;this._patches.size&&e--;)this._updateMesh(),this._swap()}_updateBufferMesh(){const e=this._bufferPatches.peek();if(!t(e)||!e.clear||null===this._renderState.next)for(;this._bufferPatches.size;){const e=this._bufferPatches.dequeue();t(e)&&this._patchBuffer(e)}}_updateMesh(){const e=this._patches.peek();if(t(e)&&e.clear&&null!==this._renderState.next)return;const r=this._patches.dequeue();if(t(r)){if(!0===r.clear){if(!this.isReady)return;return this._renderState.next,void(this._renderState.next={geometry:new Map,metrics:null})}this.requestRender(),this._patch(r),r.end&&(this.ready(),this._swapRenderStates())}}_patch(e){d((t=>{this._remove(t,e.remove),this._insert(t,e,!1)}))}_patchBuffer(e){d((t=>{this._insert(t,e,!0)}))}_insert(e,t,i){try{var a;const n=r(this._renderState.next,this._renderState.current),h=null==(a=t.addOrUpdate)?void 0:a.data[e],c=n.geometry;if(s(h))return;c.has(e)||c.set(e,new m(e,this.stage)),c.get(e).insert(h,t.sort,i),e===o.LABEL&&this._insertLabelMetrics(t.type,h.metrics,t.clear)}catch(n){}}_insertLabelMetrics(e,t,i){const a=r(this._renderState.next,this._renderState.current);if(s(t))return;const n=u.from(t);if(s(a.metrics))a.metrics=n;else{if(\"update\"===e){const e=n.getCursor();for(;e.next();)a.metrics.delete(e.id)}a.metrics.link(n)}}_remove(e,t){const s=r(this._renderState.next,this._renderState.current).geometry.get(e);t&&t.length&&s&&(s.remove(t),this._removeLabelMetrics(t))}_removeLabelMetrics(e){const{metrics:t}=r(this._renderState.next,this._renderState.current);if(!s(t)&&e.length)for(const r of e)for(;t.delete(r););}_dropPatches(){const e=new Array;let t=!1;for(;this._patches.size;){const r=this._patches.dequeue();if(s(r))break;if(r.clear){if(t)break;t=!0}e.push(r)}this._patches.clear(),e.forEach((e=>this._patches.enqueue(e)))}}export{w as FeatureTile};\n"]},"metadata":{},"sourceType":"module"}