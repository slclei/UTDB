{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../chunks/tslib.es6.js\";\nimport t from \"../../request.js\";\nimport i from \"../../core/Accessor.js\";\nimport { ByteSizeUnit as r } from \"../../core/byteSizeEstimations.js\";\nimport l from \"../../core/Error.js\";\nimport { HandleOwnerMixin as s } from \"../../core/HandleOwner.js\";\nimport a from \"../../core/Logger.js\";\nimport o from \"../../core/LRUCache.js\";\nimport n from \"../../core/PooledArray.js\";\nimport { onAbort as c, isAbortError as h, isAborted as p, createAbortError as m } from \"../../core/promiseUtils.js\";\nimport { watch as u, syncAndInitial as v } from \"../../core/reactiveUtils.js\";\nimport { waitTicks as f } from \"../../core/scheduling.js\";\nimport { objectToQuery as y } from \"../../core/urlUtils.js\";\nimport { property as b } from \"../../core/accessorSupport/decorators/property.js\";\nimport \"../../core/arrayUtils.js\";\nimport \"../../core/has.js\";\nimport { cast as d } from \"../../core/accessorSupport/decorators/cast.js\";\nimport { subclass as _ } from \"../../core/accessorSupport/decorators/subclass.js\";\nimport { tilemapDefinitionId as g, Tilemap as w } from \"./Tilemap.js\";\nvar T;\nconst j = a.getLogger(\"esri.layers.support.TilemapCache\");\nlet z = T = class extends s(i) {\n  constructor(e) {\n    super(e), this._pendingTilemapRequests = {}, this._availableLevels = {}, this.levels = 5, this.cacheByteSize = 2 * r.MEGABYTES, this.request = t, this._prefetchingEnabled = !0;\n  }\n\n  initialize() {\n    this._tilemapCache = new o(this.cacheByteSize), this.handles.add([this.watch([\"layer.parsedUrl\", \"layer.tileServers?\", \"layer.apiKey?\", \"layer.customParameters?\"], () => this._initializeTilemapDefinition()), u(() => {\n      var e, t;\n      return null == (e = this.layer) || null == (t = e.tileInfo) ? void 0 : t.lods;\n    }, e => this._initializeAvailableLevels(e), v)]), this._initializeTilemapDefinition();\n  }\n\n  castLevels(e) {\n    return e <= 2 ? (j.error(\"Minimum levels for Tilemap is 3, but got \", e), 3) : e;\n  }\n\n  get size() {\n    return 1 << this.levels;\n  }\n\n  fetchTilemap(e, t, i, r) {\n    if (!this._availableLevels[e]) return Promise.reject(new l(\"tilemap-cache:level-unavailable\", `Level ${e} is unavailable in the service`));\n\n    const s = this._tmpTilemapDefinition,\n          a = this._tilemapFromCache(e, t, i, s);\n\n    if (a) return Promise.resolve(a);\n    const o = r && r.signal;\n    return r = { ...r,\n      signal: null\n    }, new Promise((e, t) => {\n      c(o, () => t(m()));\n      const i = g(s);\n      let l = this._pendingTilemapRequests[i];\n\n      if (!l) {\n        l = w.fromDefinition(s, r).then(e => (this._tilemapCache.put(i, e, e.byteSize), e));\n\n        const e = () => delete this._pendingTilemapRequests[i];\n\n        this._pendingTilemapRequests[i] = l, l.then(e, e);\n      }\n\n      l.then(e, t);\n    });\n  }\n\n  getAvailability(e, t, i) {\n    if (!this._availableLevels[e]) return \"unavailable\";\n\n    const r = this._tilemapFromCache(e, t, i, this._tmpTilemapDefinition);\n\n    return r ? r.getAvailability(t, i) : \"unknown\";\n  }\n\n  fetchAvailability(e, t, i, r) {\n    return this._availableLevels[e] ? this.fetchTilemap(e, t, i, r).catch(e => e).then(r => {\n      if (r instanceof w) {\n        const s = r.getAvailability(t, i);\n        return \"unavailable\" === s ? Promise.reject(new l(\"tile-map:tile-unavailable\", \"Tile is not available\", {\n          level: e,\n          row: t,\n          col: i\n        })) : s;\n      }\n\n      if (h(r)) throw r;\n      return \"unknown\";\n    }) : Promise.reject(new l(\"tilemap-cache:level-unavailable\", `Level ${e} is unavailable in the service`));\n  }\n\n  fetchAvailabilityUpsample(e, t, i, r, l) {\n    r.level = e, r.row = t, r.col = i;\n    const s = this.layer.tileInfo;\n    s.updateTileInfo(r);\n    const a = this.fetchAvailability(e, t, i, l).catch(e => {\n      if (h(e)) throw e;\n      if (s.upsampleTile(r)) return this.fetchAvailabilityUpsample(r.level, r.row, r.col, r);\n      throw e;\n    });\n    return this._fetchAvailabilityUpsamplePrefetch(r.id, e, t, i, l, a), a;\n  }\n\n  async _fetchAvailabilityUpsamplePrefetch(e, t, i, r, l, s) {\n    if (!this._prefetchingEnabled) return;\n    const a = `prefetch-${e}`;\n    if (this.handles.has(a)) return;\n    const o = new AbortController();\n    s.then(() => o.abort(), () => o.abort());\n    let n = !1;\n    const c = {\n      remove() {\n        n || (n = !0, o.abort());\n      }\n\n    };\n    if (this.handles.add(c, a), await f(10, o.signal).catch(() => {}), n || (n = !0, this.handles.remove(a)), p(o)) return;\n    const h = {\n      id: e,\n      level: t,\n      row: i,\n      col: r\n    },\n          m = { ...l,\n      signal: o.signal\n    },\n          u = this.layer.tileInfo;\n\n    for (let p = 0; T._prefetches.length < T._maxPrefetch && u.upsampleTile(h); ++p) {\n      const e = this.fetchAvailability(h.level, h.row, h.col, m);\n\n      T._prefetches.push(e);\n\n      const t = () => {\n        T._prefetches.removeUnordered(e);\n      };\n\n      e.then(t, t);\n    }\n  }\n\n  _initializeTilemapDefinition() {\n    var e;\n    if (!this.layer.parsedUrl) return;\n    const {\n      parsedUrl: t,\n      apiKey: i,\n      customParameters: r\n    } = this.layer;\n    this._tilemapCache.clear(), this._tmpTilemapDefinition = {\n      service: {\n        url: t.path,\n        query: y({ ...t.query,\n          ...r,\n          token: null != i ? i : null == (e = t.query) ? void 0 : e.token\n        }),\n        tileServers: this.layer.tileServers,\n        request: this.request,\n        type: this.layer.type\n      },\n      width: this.size,\n      height: this.size,\n      level: 0,\n      row: 0,\n      col: 0\n    };\n  }\n\n  _tilemapFromCache(e, t, i, r) {\n    r.level = e, r.row = t - t % this.size, r.col = i - i % this.size;\n    const l = g(r);\n    return this._tilemapCache.get(l);\n  }\n\n  _initializeAvailableLevels(e) {\n    this._availableLevels = {}, e && e.forEach(e => this._availableLevels[e.level] = !0);\n  }\n\n  get test() {\n    const e = this;\n    return {\n      get prefetchingEnabled() {\n        return e._prefetchingEnabled;\n      },\n\n      set prefetchingEnabled(t) {\n        e._prefetchingEnabled = t;\n      },\n\n      hasTilemap: (t, i, r) => !!e._tilemapFromCache(t, i, r, e._tmpTilemapDefinition)\n    };\n  }\n\n};\nz._maxPrefetch = 4, z._prefetches = new n({\n  initialSize: T._maxPrefetch\n}), e([b({\n  constructOnly: !0,\n  type: Number\n})], z.prototype, \"levels\", void 0), e([d(\"levels\")], z.prototype, \"castLevels\", null), e([b({\n  readOnly: !0,\n  type: Number\n})], z.prototype, \"size\", null), e([b({\n  constructOnly: !0,\n  type: Number\n})], z.prototype, \"cacheByteSize\", void 0), e([b({\n  constructOnly: !0\n})], z.prototype, \"layer\", void 0), e([b({\n  constructOnly: !0\n})], z.prototype, \"request\", void 0), z = T = e([_(\"esri.layers.support.TilemapCache\")], z);\nexport { z as TilemapCache };","map":{"version":3,"sources":["D:/Github/CUSP_DataBase/CUSP_DB/src/main/gis/node_modules/@arcgis/core/layers/support/TilemapCache.js"],"names":["_","e","t","i","ByteSizeUnit","r","l","HandleOwnerMixin","s","a","o","n","onAbort","c","isAbortError","h","isAborted","p","createAbortError","m","watch","u","syncAndInitial","v","waitTicks","f","objectToQuery","y","property","b","cast","d","subclass","tilemapDefinitionId","g","Tilemap","w","T","j","getLogger","z","constructor","_pendingTilemapRequests","_availableLevels","levels","cacheByteSize","MEGABYTES","request","_prefetchingEnabled","initialize","_tilemapCache","handles","add","_initializeTilemapDefinition","layer","tileInfo","lods","_initializeAvailableLevels","castLevels","error","size","fetchTilemap","Promise","reject","_tmpTilemapDefinition","_tilemapFromCache","resolve","signal","fromDefinition","then","put","byteSize","getAvailability","fetchAvailability","catch","level","row","col","fetchAvailabilityUpsample","updateTileInfo","upsampleTile","_fetchAvailabilityUpsamplePrefetch","id","has","AbortController","abort","remove","_prefetches","length","_maxPrefetch","push","removeUnordered","parsedUrl","apiKey","customParameters","clear","service","url","path","query","token","tileServers","type","width","height","get","forEach","test","prefetchingEnabled","hasTilemap","initialSize","constructOnly","Number","prototype","readOnly","TilemapCache"],"mappings":"AAAA;AACA;AACA;AACA;AACA,SAAOA,CAAC,IAAIC,CAAZ,QAAkB,2BAAlB;AAA8C,OAAOC,CAAP,MAAa,kBAAb;AAAgC,OAAOC,CAAP,MAAa,wBAAb;AAAsC,SAAOC,YAAY,IAAIC,CAAvB,QAA6B,mCAA7B;AAAiE,OAAOC,CAAP,MAAa,qBAAb;AAAmC,SAAOC,gBAAgB,IAAIC,CAA3B,QAAiC,2BAAjC;AAA6D,OAAOC,CAAP,MAAa,sBAAb;AAAoC,OAAOC,CAAP,MAAa,wBAAb;AAAsC,OAAOC,CAAP,MAAa,2BAAb;AAAyC,SAAOC,OAAO,IAAIC,CAAlB,EAAoBC,YAAY,IAAIC,CAApC,EAAsCC,SAAS,IAAIC,CAAnD,EAAqDC,gBAAgB,IAAIC,CAAzE,QAA+E,4BAA/E;AAA4G,SAAOC,KAAK,IAAIC,CAAhB,EAAkBC,cAAc,IAAIC,CAApC,QAA0C,6BAA1C;AAAwE,SAAOC,SAAS,IAAIC,CAApB,QAA0B,0BAA1B;AAAqD,SAAOC,aAAa,IAAIC,CAAxB,QAA8B,wBAA9B;AAAuD,SAAOC,QAAQ,IAAIC,CAAnB,QAAyB,mDAAzB;AAA6E,OAAM,0BAAN;AAAiC,OAAM,mBAAN;AAA0B,SAAOC,IAAI,IAAIC,CAAf,QAAqB,+CAArB;AAAqE,SAAOC,QAAQ,IAAIhC,CAAnB,QAAyB,mDAAzB;AAA6E,SAAOiC,mBAAmB,IAAIC,CAA9B,EAAgCC,OAAO,IAAIC,CAA3C,QAAiD,cAAjD;AAAgE,IAAIC,CAAJ;AAAM,MAAMC,CAAC,GAAC7B,CAAC,CAAC8B,SAAF,CAAY,kCAAZ,CAAR;AAAwD,IAAIC,CAAC,GAACH,CAAC,GAAC,cAAc7B,CAAC,CAACL,CAAD,CAAf,CAAmB;AAACsC,EAAAA,WAAW,CAACxC,CAAD,EAAG;AAAC,UAAMA,CAAN,GAAS,KAAKyC,uBAAL,GAA6B,EAAtC,EAAyC,KAAKC,gBAAL,GAAsB,EAA/D,EAAkE,KAAKC,MAAL,GAAY,CAA9E,EAAgF,KAAKC,aAAL,GAAmB,IAAExC,CAAC,CAACyC,SAAvG,EAAiH,KAAKC,OAAL,GAAa7C,CAA9H,EAAgI,KAAK8C,mBAAL,GAAyB,CAAC,CAA1J;AAA4J;;AAAAC,EAAAA,UAAU,GAAE;AAAC,SAAKC,aAAL,GAAmB,IAAIxC,CAAJ,CAAM,KAAKmC,aAAX,CAAnB,EAA6C,KAAKM,OAAL,CAAaC,GAAb,CAAiB,CAAC,KAAKhC,KAAL,CAAW,CAAC,iBAAD,EAAmB,oBAAnB,EAAwC,eAAxC,EAAwD,yBAAxD,CAAX,EAA+F,MAAI,KAAKiC,4BAAL,EAAnG,CAAD,EAA0IhC,CAAC,CAAE,MAAI;AAAC,UAAIpB,CAAJ,EAAMC,CAAN;AAAQ,aAAO,SAAOD,CAAC,GAAC,KAAKqD,KAAd,KAAsB,SAAOpD,CAAC,GAACD,CAAC,CAACsD,QAAX,CAAtB,GAA2C,KAAK,CAAhD,GAAkDrD,CAAC,CAACsD,IAA3D;AAAgE,KAA/E,EAAkFvD,CAAC,IAAE,KAAKwD,0BAAL,CAAgCxD,CAAhC,CAArF,EAAyHsB,CAAzH,CAA3I,CAAjB,CAA7C,EAAuU,KAAK8B,4BAAL,EAAvU;AAA2W;;AAAAK,EAAAA,UAAU,CAACzD,CAAD,EAAG;AAAC,WAAOA,CAAC,IAAE,CAAH,IAAMqC,CAAC,CAACqB,KAAF,CAAQ,2CAAR,EAAoD1D,CAApD,GAAuD,CAA7D,IAAgEA,CAAvE;AAAyE;;AAAQ,MAAJ2D,IAAI,GAAE;AAAC,WAAO,KAAG,KAAKhB,MAAf;AAAsB;;AAAAiB,EAAAA,YAAY,CAAC5D,CAAD,EAAGC,CAAH,EAAKC,CAAL,EAAOE,CAAP,EAAS;AAAC,QAAG,CAAC,KAAKsC,gBAAL,CAAsB1C,CAAtB,CAAJ,EAA6B,OAAO6D,OAAO,CAACC,MAAR,CAAe,IAAIzD,CAAJ,CAAM,iCAAN,EAAyC,SAAQL,CAAE,gCAAnD,CAAf,CAAP;;AAA2G,UAAMO,CAAC,GAAC,KAAKwD,qBAAb;AAAA,UAAmCvD,CAAC,GAAC,KAAKwD,iBAAL,CAAuBhE,CAAvB,EAAyBC,CAAzB,EAA2BC,CAA3B,EAA6BK,CAA7B,CAArC;;AAAqE,QAAGC,CAAH,EAAK,OAAOqD,OAAO,CAACI,OAAR,CAAgBzD,CAAhB,CAAP;AAA0B,UAAMC,CAAC,GAACL,CAAC,IAAEA,CAAC,CAAC8D,MAAb;AAAoB,WAAO9D,CAAC,GAAC,EAAC,GAAGA,CAAJ;AAAM8D,MAAAA,MAAM,EAAC;AAAb,KAAF,EAAqB,IAAIL,OAAJ,CAAa,CAAC7D,CAAD,EAAGC,CAAH,KAAO;AAACW,MAAAA,CAAC,CAACH,CAAD,EAAI,MAAIR,CAAC,CAACiB,CAAC,EAAF,CAAT,CAAD;AAAkB,YAAMhB,CAAC,GAAC+B,CAAC,CAAC1B,CAAD,CAAT;AAAa,UAAIF,CAAC,GAAC,KAAKoC,uBAAL,CAA6BvC,CAA7B,CAAN;;AAAsC,UAAG,CAACG,CAAJ,EAAM;AAACA,QAAAA,CAAC,GAAC8B,CAAC,CAACgC,cAAF,CAAiB5D,CAAjB,EAAmBH,CAAnB,EAAsBgE,IAAtB,CAA4BpE,CAAC,KAAG,KAAKiD,aAAL,CAAmBoB,GAAnB,CAAuBnE,CAAvB,EAAyBF,CAAzB,EAA2BA,CAAC,CAACsE,QAA7B,GAAuCtE,CAA1C,CAA7B,CAAF;;AAA8E,cAAMA,CAAC,GAAC,MAAI,OAAO,KAAKyC,uBAAL,CAA6BvC,CAA7B,CAAnB;;AAAmD,aAAKuC,uBAAL,CAA6BvC,CAA7B,IAAgCG,CAAhC,EAAkCA,CAAC,CAAC+D,IAAF,CAAOpE,CAAP,EAASA,CAAT,CAAlC;AAA8C;;AAAAK,MAAAA,CAAC,CAAC+D,IAAF,CAAOpE,CAAP,EAASC,CAAT;AAAY,KAA5R,CAA5B;AAA2T;;AAAAsE,EAAAA,eAAe,CAACvE,CAAD,EAAGC,CAAH,EAAKC,CAAL,EAAO;AAAC,QAAG,CAAC,KAAKwC,gBAAL,CAAsB1C,CAAtB,CAAJ,EAA6B,OAAM,aAAN;;AAAoB,UAAMI,CAAC,GAAC,KAAK4D,iBAAL,CAAuBhE,CAAvB,EAAyBC,CAAzB,EAA2BC,CAA3B,EAA6B,KAAK6D,qBAAlC,CAAR;;AAAiE,WAAO3D,CAAC,GAACA,CAAC,CAACmE,eAAF,CAAkBtE,CAAlB,EAAoBC,CAApB,CAAD,GAAwB,SAAhC;AAA0C;;AAAAsE,EAAAA,iBAAiB,CAACxE,CAAD,EAAGC,CAAH,EAAKC,CAAL,EAAOE,CAAP,EAAS;AAAC,WAAO,KAAKsC,gBAAL,CAAsB1C,CAAtB,IAAyB,KAAK4D,YAAL,CAAkB5D,CAAlB,EAAoBC,CAApB,EAAsBC,CAAtB,EAAwBE,CAAxB,EAA2BqE,KAA3B,CAAkCzE,CAAC,IAAEA,CAArC,EAAyCoE,IAAzC,CAA+ChE,CAAC,IAAE;AAAC,UAAGA,CAAC,YAAY+B,CAAhB,EAAkB;AAAC,cAAM5B,CAAC,GAACH,CAAC,CAACmE,eAAF,CAAkBtE,CAAlB,EAAoBC,CAApB,CAAR;AAA+B,eAAM,kBAAgBK,CAAhB,GAAkBsD,OAAO,CAACC,MAAR,CAAe,IAAIzD,CAAJ,CAAM,2BAAN,EAAkC,uBAAlC,EAA0D;AAACqE,UAAAA,KAAK,EAAC1E,CAAP;AAAS2E,UAAAA,GAAG,EAAC1E,CAAb;AAAe2E,UAAAA,GAAG,EAAC1E;AAAnB,SAA1D,CAAf,CAAlB,GAAmHK,CAAzH;AAA2H;;AAAA,UAAGO,CAAC,CAACV,CAAD,CAAJ,EAAQ,MAAMA,CAAN;AAAQ,aAAM,SAAN;AAAgB,KAAhQ,CAAzB,GAA4RyD,OAAO,CAACC,MAAR,CAAe,IAAIzD,CAAJ,CAAM,iCAAN,EAAyC,SAAQL,CAAE,gCAAnD,CAAf,CAAnS;AAAuY;;AAAA6E,EAAAA,yBAAyB,CAAC7E,CAAD,EAAGC,CAAH,EAAKC,CAAL,EAAOE,CAAP,EAASC,CAAT,EAAW;AAACD,IAAAA,CAAC,CAACsE,KAAF,GAAQ1E,CAAR,EAAUI,CAAC,CAACuE,GAAF,GAAM1E,CAAhB,EAAkBG,CAAC,CAACwE,GAAF,GAAM1E,CAAxB;AAA0B,UAAMK,CAAC,GAAC,KAAK8C,KAAL,CAAWC,QAAnB;AAA4B/C,IAAAA,CAAC,CAACuE,cAAF,CAAiB1E,CAAjB;AAAoB,UAAMI,CAAC,GAAC,KAAKgE,iBAAL,CAAuBxE,CAAvB,EAAyBC,CAAzB,EAA2BC,CAA3B,EAA6BG,CAA7B,EAAgCoE,KAAhC,CAAuCzE,CAAC,IAAE;AAAC,UAAGc,CAAC,CAACd,CAAD,CAAJ,EAAQ,MAAMA,CAAN;AAAQ,UAAGO,CAAC,CAACwE,YAAF,CAAe3E,CAAf,CAAH,EAAqB,OAAO,KAAKyE,yBAAL,CAA+BzE,CAAC,CAACsE,KAAjC,EAAuCtE,CAAC,CAACuE,GAAzC,EAA6CvE,CAAC,CAACwE,GAA/C,EAAmDxE,CAAnD,CAAP;AAA6D,YAAMJ,CAAN;AAAQ,KAArJ,CAAR;AAAgK,WAAO,KAAKgF,kCAAL,CAAwC5E,CAAC,CAAC6E,EAA1C,EAA6CjF,CAA7C,EAA+CC,CAA/C,EAAiDC,CAAjD,EAAmDG,CAAnD,EAAqDG,CAArD,GAAwDA,CAA/D;AAAiE;;AAAwC,QAAlCwE,kCAAkC,CAAChF,CAAD,EAAGC,CAAH,EAAKC,CAAL,EAAOE,CAAP,EAASC,CAAT,EAAWE,CAAX,EAAa;AAAC,QAAG,CAAC,KAAKwC,mBAAT,EAA6B;AAAO,UAAMvC,CAAC,GAAE,YAAWR,CAAE,EAAtB;AAAwB,QAAG,KAAKkD,OAAL,CAAagC,GAAb,CAAiB1E,CAAjB,CAAH,EAAuB;AAAO,UAAMC,CAAC,GAAC,IAAI0E,eAAJ,EAAR;AAA4B5E,IAAAA,CAAC,CAAC6D,IAAF,CAAQ,MAAI3D,CAAC,CAAC2E,KAAF,EAAZ,EAAwB,MAAI3E,CAAC,CAAC2E,KAAF,EAA5B;AAAwC,QAAI1E,CAAC,GAAC,CAAC,CAAP;AAAS,UAAME,CAAC,GAAC;AAACyE,MAAAA,MAAM,GAAE;AAAC3E,QAAAA,CAAC,KAAGA,CAAC,GAAC,CAAC,CAAH,EAAKD,CAAC,CAAC2E,KAAF,EAAR,CAAD;AAAoB;;AAA9B,KAAR;AAAwC,QAAG,KAAKlC,OAAL,CAAaC,GAAb,CAAiBvC,CAAjB,EAAmBJ,CAAnB,GAAsB,MAAMgB,CAAC,CAAC,EAAD,EAAIf,CAAC,CAACyD,MAAN,CAAD,CAAeO,KAAf,CAAsB,MAAI,CAAE,CAA5B,CAA5B,EAA2D/D,CAAC,KAAGA,CAAC,GAAC,CAAC,CAAH,EAAK,KAAKwC,OAAL,CAAamC,MAAb,CAAoB7E,CAApB,CAAR,CAA5D,EAA4FQ,CAAC,CAACP,CAAD,CAAhG,EAAoG;AAAO,UAAMK,CAAC,GAAC;AAACmE,MAAAA,EAAE,EAACjF,CAAJ;AAAM0E,MAAAA,KAAK,EAACzE,CAAZ;AAAc0E,MAAAA,GAAG,EAACzE,CAAlB;AAAoB0E,MAAAA,GAAG,EAACxE;AAAxB,KAAR;AAAA,UAAmCc,CAAC,GAAC,EAAC,GAAGb,CAAJ;AAAM6D,MAAAA,MAAM,EAACzD,CAAC,CAACyD;AAAf,KAArC;AAAA,UAA4D9C,CAAC,GAAC,KAAKiC,KAAL,CAAWC,QAAzE;;AAAkF,SAAI,IAAItC,CAAC,GAAC,CAAV,EAAYoB,CAAC,CAACkD,WAAF,CAAcC,MAAd,GAAqBnD,CAAC,CAACoD,YAAvB,IAAqCpE,CAAC,CAAC2D,YAAF,CAAejE,CAAf,CAAjD,EAAmE,EAAEE,CAArE,EAAuE;AAAC,YAAMhB,CAAC,GAAC,KAAKwE,iBAAL,CAAuB1D,CAAC,CAAC4D,KAAzB,EAA+B5D,CAAC,CAAC6D,GAAjC,EAAqC7D,CAAC,CAAC8D,GAAvC,EAA2C1D,CAA3C,CAAR;;AAAsDkB,MAAAA,CAAC,CAACkD,WAAF,CAAcG,IAAd,CAAmBzF,CAAnB;;AAAsB,YAAMC,CAAC,GAAC,MAAI;AAACmC,QAAAA,CAAC,CAACkD,WAAF,CAAcI,eAAd,CAA8B1F,CAA9B;AAAiC,OAA9C;;AAA+CA,MAAAA,CAAC,CAACoE,IAAF,CAAOnE,CAAP,EAASA,CAAT;AAAY;AAAC;;AAAAmD,EAAAA,4BAA4B,GAAE;AAAC,QAAIpD,CAAJ;AAAM,QAAG,CAAC,KAAKqD,KAAL,CAAWsC,SAAf,EAAyB;AAAO,UAAK;AAACA,MAAAA,SAAS,EAAC1F,CAAX;AAAa2F,MAAAA,MAAM,EAAC1F,CAApB;AAAsB2F,MAAAA,gBAAgB,EAACzF;AAAvC,QAA0C,KAAKiD,KAApD;AAA0D,SAAKJ,aAAL,CAAmB6C,KAAnB,IAA2B,KAAK/B,qBAAL,GAA2B;AAACgC,MAAAA,OAAO,EAAC;AAACC,QAAAA,GAAG,EAAC/F,CAAC,CAACgG,IAAP;AAAYC,QAAAA,KAAK,EAACxE,CAAC,CAAC,EAAC,GAAGzB,CAAC,CAACiG,KAAN;AAAY,aAAG9F,CAAf;AAAiB+F,UAAAA,KAAK,EAAC,QAAMjG,CAAN,GAAQA,CAAR,GAAU,SAAOF,CAAC,GAACC,CAAC,CAACiG,KAAX,IAAkB,KAAK,CAAvB,GAAyBlG,CAAC,CAACmG;AAA5D,SAAD,CAAnB;AAAwFC,QAAAA,WAAW,EAAC,KAAK/C,KAAL,CAAW+C,WAA/G;AAA2HtD,QAAAA,OAAO,EAAC,KAAKA,OAAxI;AAAgJuD,QAAAA,IAAI,EAAC,KAAKhD,KAAL,CAAWgD;AAAhK,OAAT;AAA+KC,MAAAA,KAAK,EAAC,KAAK3C,IAA1L;AAA+L4C,MAAAA,MAAM,EAAC,KAAK5C,IAA3M;AAAgNe,MAAAA,KAAK,EAAC,CAAtN;AAAwNC,MAAAA,GAAG,EAAC,CAA5N;AAA8NC,MAAAA,GAAG,EAAC;AAAlO,KAAtD;AAA2R;;AAAAZ,EAAAA,iBAAiB,CAAChE,CAAD,EAAGC,CAAH,EAAKC,CAAL,EAAOE,CAAP,EAAS;AAACA,IAAAA,CAAC,CAACsE,KAAF,GAAQ1E,CAAR,EAAUI,CAAC,CAACuE,GAAF,GAAM1E,CAAC,GAACA,CAAC,GAAC,KAAK0D,IAAzB,EAA8BvD,CAAC,CAACwE,GAAF,GAAM1E,CAAC,GAACA,CAAC,GAAC,KAAKyD,IAA7C;AAAkD,UAAMtD,CAAC,GAAC4B,CAAC,CAAC7B,CAAD,CAAT;AAAa,WAAO,KAAK6C,aAAL,CAAmBuD,GAAnB,CAAuBnG,CAAvB,CAAP;AAAiC;;AAAAmD,EAAAA,0BAA0B,CAACxD,CAAD,EAAG;AAAC,SAAK0C,gBAAL,GAAsB,EAAtB,EAAyB1C,CAAC,IAAEA,CAAC,CAACyG,OAAF,CAAWzG,CAAC,IAAE,KAAK0C,gBAAL,CAAsB1C,CAAC,CAAC0E,KAAxB,IAA+B,CAAC,CAA9C,CAA5B;AAA8E;;AAAQ,MAAJgC,IAAI,GAAE;AAAC,UAAM1G,CAAC,GAAC,IAAR;AAAa,WAAM;AAAC,UAAI2G,kBAAJ,GAAwB;AAAC,eAAO3G,CAAC,CAAC+C,mBAAT;AAA6B,OAAvD;;AAAwD,UAAI4D,kBAAJ,CAAuB1G,CAAvB,EAAyB;AAACD,QAAAA,CAAC,CAAC+C,mBAAF,GAAsB9C,CAAtB;AAAwB,OAA1G;;AAA2G2G,MAAAA,UAAU,EAAC,CAAC3G,CAAD,EAAGC,CAAH,EAAKE,CAAL,KAAS,CAAC,CAACJ,CAAC,CAACgE,iBAAF,CAAoB/D,CAApB,EAAsBC,CAAtB,EAAwBE,CAAxB,EAA0BJ,CAAC,CAAC+D,qBAA5B;AAAjI,KAAN;AAA2L;;AAAxnH,CAA3B;AAAqpHxB,CAAC,CAACiD,YAAF,GAAe,CAAf,EAAiBjD,CAAC,CAAC+C,WAAF,GAAc,IAAI5E,CAAJ,CAAM;AAACmG,EAAAA,WAAW,EAACzE,CAAC,CAACoD;AAAf,CAAN,CAA/B,EAAmExF,CAAC,CAAC,CAAC4B,CAAC,CAAC;AAACkF,EAAAA,aAAa,EAAC,CAAC,CAAhB;AAAkBT,EAAAA,IAAI,EAACU;AAAvB,CAAD,CAAF,CAAD,EAAqCxE,CAAC,CAACyE,SAAvC,EAAiD,QAAjD,EAA0D,KAAK,CAA/D,CAApE,EAAsIhH,CAAC,CAAC,CAAC8B,CAAC,CAAC,QAAD,CAAF,CAAD,EAAeS,CAAC,CAACyE,SAAjB,EAA2B,YAA3B,EAAwC,IAAxC,CAAvI,EAAqLhH,CAAC,CAAC,CAAC4B,CAAC,CAAC;AAACqF,EAAAA,QAAQ,EAAC,CAAC,CAAX;AAAaZ,EAAAA,IAAI,EAACU;AAAlB,CAAD,CAAF,CAAD,EAAgCxE,CAAC,CAACyE,SAAlC,EAA4C,MAA5C,EAAmD,IAAnD,CAAtL,EAA+OhH,CAAC,CAAC,CAAC4B,CAAC,CAAC;AAACkF,EAAAA,aAAa,EAAC,CAAC,CAAhB;AAAkBT,EAAAA,IAAI,EAACU;AAAvB,CAAD,CAAF,CAAD,EAAqCxE,CAAC,CAACyE,SAAvC,EAAiD,eAAjD,EAAiE,KAAK,CAAtE,CAAhP,EAAyThH,CAAC,CAAC,CAAC4B,CAAC,CAAC;AAACkF,EAAAA,aAAa,EAAC,CAAC;AAAhB,CAAD,CAAF,CAAD,EAAyBvE,CAAC,CAACyE,SAA3B,EAAqC,OAArC,EAA6C,KAAK,CAAlD,CAA1T,EAA+WhH,CAAC,CAAC,CAAC4B,CAAC,CAAC;AAACkF,EAAAA,aAAa,EAAC,CAAC;AAAhB,CAAD,CAAF,CAAD,EAAyBvE,CAAC,CAACyE,SAA3B,EAAqC,SAArC,EAA+C,KAAK,CAApD,CAAhX,EAAuazE,CAAC,GAACH,CAAC,GAACpC,CAAC,CAAC,CAACD,CAAC,CAAC,kCAAD,CAAF,CAAD,EAAyCwC,CAAzC,CAA5a;AAAwd,SAAOA,CAAC,IAAI2E,YAAZ","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../chunks/tslib.es6.js\";import t from\"../../request.js\";import i from\"../../core/Accessor.js\";import{ByteSizeUnit as r}from\"../../core/byteSizeEstimations.js\";import l from\"../../core/Error.js\";import{HandleOwnerMixin as s}from\"../../core/HandleOwner.js\";import a from\"../../core/Logger.js\";import o from\"../../core/LRUCache.js\";import n from\"../../core/PooledArray.js\";import{onAbort as c,isAbortError as h,isAborted as p,createAbortError as m}from\"../../core/promiseUtils.js\";import{watch as u,syncAndInitial as v}from\"../../core/reactiveUtils.js\";import{waitTicks as f}from\"../../core/scheduling.js\";import{objectToQuery as y}from\"../../core/urlUtils.js\";import{property as b}from\"../../core/accessorSupport/decorators/property.js\";import\"../../core/arrayUtils.js\";import\"../../core/has.js\";import{cast as d}from\"../../core/accessorSupport/decorators/cast.js\";import{subclass as _}from\"../../core/accessorSupport/decorators/subclass.js\";import{tilemapDefinitionId as g,Tilemap as w}from\"./Tilemap.js\";var T;const j=a.getLogger(\"esri.layers.support.TilemapCache\");let z=T=class extends(s(i)){constructor(e){super(e),this._pendingTilemapRequests={},this._availableLevels={},this.levels=5,this.cacheByteSize=2*r.MEGABYTES,this.request=t,this._prefetchingEnabled=!0}initialize(){this._tilemapCache=new o(this.cacheByteSize),this.handles.add([this.watch([\"layer.parsedUrl\",\"layer.tileServers?\",\"layer.apiKey?\",\"layer.customParameters?\"],(()=>this._initializeTilemapDefinition())),u((()=>{var e,t;return null==(e=this.layer)||null==(t=e.tileInfo)?void 0:t.lods}),(e=>this._initializeAvailableLevels(e)),v)]),this._initializeTilemapDefinition()}castLevels(e){return e<=2?(j.error(\"Minimum levels for Tilemap is 3, but got \",e),3):e}get size(){return 1<<this.levels}fetchTilemap(e,t,i,r){if(!this._availableLevels[e])return Promise.reject(new l(\"tilemap-cache:level-unavailable\",`Level ${e} is unavailable in the service`));const s=this._tmpTilemapDefinition,a=this._tilemapFromCache(e,t,i,s);if(a)return Promise.resolve(a);const o=r&&r.signal;return r={...r,signal:null},new Promise(((e,t)=>{c(o,(()=>t(m())));const i=g(s);let l=this._pendingTilemapRequests[i];if(!l){l=w.fromDefinition(s,r).then((e=>(this._tilemapCache.put(i,e,e.byteSize),e)));const e=()=>delete this._pendingTilemapRequests[i];this._pendingTilemapRequests[i]=l,l.then(e,e)}l.then(e,t)}))}getAvailability(e,t,i){if(!this._availableLevels[e])return\"unavailable\";const r=this._tilemapFromCache(e,t,i,this._tmpTilemapDefinition);return r?r.getAvailability(t,i):\"unknown\"}fetchAvailability(e,t,i,r){return this._availableLevels[e]?this.fetchTilemap(e,t,i,r).catch((e=>e)).then((r=>{if(r instanceof w){const s=r.getAvailability(t,i);return\"unavailable\"===s?Promise.reject(new l(\"tile-map:tile-unavailable\",\"Tile is not available\",{level:e,row:t,col:i})):s}if(h(r))throw r;return\"unknown\"})):Promise.reject(new l(\"tilemap-cache:level-unavailable\",`Level ${e} is unavailable in the service`))}fetchAvailabilityUpsample(e,t,i,r,l){r.level=e,r.row=t,r.col=i;const s=this.layer.tileInfo;s.updateTileInfo(r);const a=this.fetchAvailability(e,t,i,l).catch((e=>{if(h(e))throw e;if(s.upsampleTile(r))return this.fetchAvailabilityUpsample(r.level,r.row,r.col,r);throw e}));return this._fetchAvailabilityUpsamplePrefetch(r.id,e,t,i,l,a),a}async _fetchAvailabilityUpsamplePrefetch(e,t,i,r,l,s){if(!this._prefetchingEnabled)return;const a=`prefetch-${e}`;if(this.handles.has(a))return;const o=new AbortController;s.then((()=>o.abort()),(()=>o.abort()));let n=!1;const c={remove(){n||(n=!0,o.abort())}};if(this.handles.add(c,a),await f(10,o.signal).catch((()=>{})),n||(n=!0,this.handles.remove(a)),p(o))return;const h={id:e,level:t,row:i,col:r},m={...l,signal:o.signal},u=this.layer.tileInfo;for(let p=0;T._prefetches.length<T._maxPrefetch&&u.upsampleTile(h);++p){const e=this.fetchAvailability(h.level,h.row,h.col,m);T._prefetches.push(e);const t=()=>{T._prefetches.removeUnordered(e)};e.then(t,t)}}_initializeTilemapDefinition(){var e;if(!this.layer.parsedUrl)return;const{parsedUrl:t,apiKey:i,customParameters:r}=this.layer;this._tilemapCache.clear(),this._tmpTilemapDefinition={service:{url:t.path,query:y({...t.query,...r,token:null!=i?i:null==(e=t.query)?void 0:e.token}),tileServers:this.layer.tileServers,request:this.request,type:this.layer.type},width:this.size,height:this.size,level:0,row:0,col:0}}_tilemapFromCache(e,t,i,r){r.level=e,r.row=t-t%this.size,r.col=i-i%this.size;const l=g(r);return this._tilemapCache.get(l)}_initializeAvailableLevels(e){this._availableLevels={},e&&e.forEach((e=>this._availableLevels[e.level]=!0))}get test(){const e=this;return{get prefetchingEnabled(){return e._prefetchingEnabled},set prefetchingEnabled(t){e._prefetchingEnabled=t},hasTilemap:(t,i,r)=>!!e._tilemapFromCache(t,i,r,e._tmpTilemapDefinition)}}};z._maxPrefetch=4,z._prefetches=new n({initialSize:T._maxPrefetch}),e([b({constructOnly:!0,type:Number})],z.prototype,\"levels\",void 0),e([d(\"levels\")],z.prototype,\"castLevels\",null),e([b({readOnly:!0,type:Number})],z.prototype,\"size\",null),e([b({constructOnly:!0,type:Number})],z.prototype,\"cacheByteSize\",void 0),e([b({constructOnly:!0})],z.prototype,\"layer\",void 0),e([b({constructOnly:!0})],z.prototype,\"request\",void 0),z=T=e([_(\"esri.layers.support.TilemapCache\")],z);export{z as TilemapCache};\n"]},"metadata":{},"sourceType":"module"}