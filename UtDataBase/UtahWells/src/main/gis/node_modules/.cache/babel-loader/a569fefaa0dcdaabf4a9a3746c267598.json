{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport t from \"../../../../core/Error.js\";\nimport { isSome as e } from \"../../../../core/maybe.js\";\nimport { SPRITE_PADDING as i } from \"./definitions.js\";\nimport { log2 as s } from \"./GeometryUtils.js\";\nimport a from \"./Rect.js\";\nimport r from \"./RectangleBinPack.js\";\nimport { PixelFormat as o, PixelType as h, TextureSamplingMode as c, TextureWrapMode as n } from \"../../../webgl/enums.js\";\nimport { Texture as g } from \"../../../webgl/Texture.js\";\n\nfunction m(t) {\n  return t && \"static\" === t.type;\n}\n\nclass p {\n  constructor(t, e, i) {\n    let s = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : 0;\n    this._mosaicPages = [], this._maxItemSize = 0, this._currentPage = 0, this._pageWidth = 0, this._pageHeight = 0, this._mosaicRects = new Map(), this._spriteCopyQueue = [], this.pixelRatio = 1, (e <= 0 || i <= 0) && console.error(\"Sprites mosaic defaultWidth and defaultHeight must be greater than zero!\"), this._pageWidth = e, this._pageHeight = i, this._requestRender = t, s > 0 && (this._maxItemSize = s), this.pixelRatio = window.devicePixelRatio || 1, this._binPack = new r(this._pageWidth, this._pageHeight);\n    const a = Math.floor(this._pageWidth),\n          o = Math.floor(this._pageHeight);\n\n    this._mosaicPages.push({\n      mosaicsData: {\n        type: \"static\",\n        data: new Uint32Array(a * o)\n      },\n      size: [this._pageWidth, this._pageHeight],\n      dirty: !0,\n      texture: void 0\n    });\n  }\n\n  getWidth(t) {\n    return t >= this._mosaicPages.length ? -1 : this._mosaicPages[t].size[0];\n  }\n\n  getHeight(t) {\n    return t >= this._mosaicPages.length ? -1 : this._mosaicPages[t].size[1];\n  }\n\n  getPageTexture(t) {\n    return t < this._mosaicPages.length ? this._mosaicPages[t].texture : null;\n  }\n\n  has(t) {\n    return this._mosaicRects.has(t);\n  }\n\n  get itemCount() {\n    return this._mosaicRects.size;\n  }\n\n  getSpriteItem(t) {\n    return this._mosaicRects.get(t);\n  }\n\n  addSpriteItem(t, e, i, s, r, o) {\n    if (this._mosaicRects.has(t)) return this._mosaicRects.get(t);\n    let h, c, n;\n    if (m(i)) [h, c, n] = this._allocateImage(e[0], e[1]);else {\n      h = new a(0, 0, e[0], e[1]), c = this._mosaicPages.length;\n      const t = void 0;\n\n      this._mosaicPages.push({\n        mosaicsData: i,\n        size: e,\n        dirty: !0,\n        texture: t\n      });\n    }\n    if (h.width <= 0 || h.height <= 0) return null;\n    const g = {\n      rect: h,\n      width: e[0],\n      height: e[1],\n      sdf: r,\n      simplePattern: o,\n      pixelRatio: 1,\n      page: c\n    };\n    return this._mosaicRects.set(t, g), m(i) && this._copy({\n      rect: h,\n      spriteSize: e,\n      spriteData: i.data,\n      page: c,\n      pageSize: n,\n      repeat: s,\n      sdf: r\n    }), g;\n  }\n\n  hasItemsToProcess() {\n    return 0 !== this._spriteCopyQueue.length;\n  }\n\n  processNextItem() {\n    const t = this._spriteCopyQueue.pop();\n\n    t && this._copy(t);\n  }\n\n  getSpriteItems(t) {\n    const e = {};\n\n    for (const i of t) e[i] = this.getSpriteItem(i);\n\n    return e;\n  }\n\n  getMosaicItemPosition(t) {\n    const e = this.getSpriteItem(t),\n          s = e && e.rect;\n    if (!s) return null;\n    s.width = e.width, s.height = e.height;\n    const a = e.width,\n          r = e.height,\n          o = i,\n          h = this._mosaicPages[e.page];\n    return {\n      size: [e.width, e.height],\n      tl: [(s.x + o) / h[0], (s.y + o) / h[1]],\n      br: [(s.x + o + a) / h[0], (s.y + o + r) / h[1]],\n      page: e.page\n    };\n  }\n\n  bind(t, i) {\n    let s = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 0;\n    let a = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : 0;\n    const r = this._mosaicPages[s],\n          o = r.mosaicsData;\n    let h = r.texture;\n    if (h || (h = _(t, o, r.size), r.texture = h), h.setSamplingMode(i), m(o)) t.bindTexture(h, a), r.dirty && (h.setData(new Uint8Array(o.data.buffer)), h.generateMipmap());else {\n      const i = o.data,\n            s = i.bindFrame(t, h, a);\n      e(this._requestRender) && s && i.frameCount > 0 && this._requestRender.requestRender(), i.bindFrame(t, h, a);\n    }\n    r.dirty = !1;\n  }\n\n  static _copyBits(t, e, i, s, a, r, o, h, c, n, g) {\n    let m = s * e + i,\n        p = h * r + o;\n\n    if (g) {\n      p -= r;\n\n      for (let o = -1; o <= n; o++, m = ((o + n) % n + s) * e + i, p += r) for (let e = -1; e <= c; e++) a[p + e] = t[m + (e + c) % c];\n    } else for (let _ = 0; _ < n; _++) {\n      for (let e = 0; e < c; e++) a[p + e] = t[m + e];\n\n      m += e, p += r;\n    }\n  }\n\n  _copy(e) {\n    if (e.page >= this._mosaicPages.length) return;\n    const s = this._mosaicPages[e.page],\n          a = s.mosaicsData;\n    if (!m(s.mosaicsData)) throw new t(\"mapview-invalid-resource\", \"unsuitable data type!\");\n    const r = e.spriteData,\n          o = a.data;\n    o && r || console.error(\"Source or target images are uninitialized!\"), p._copyBits(r, e.spriteSize[0], 0, 0, o, e.pageSize[0], e.rect.x + i, e.rect.y + i, e.spriteSize[0], e.spriteSize[1], e.repeat), s.dirty = !0;\n  }\n\n  _allocateImage(t, e) {\n    t += 2 * i, e += 2 * i;\n    const o = Math.max(t, e);\n\n    if (this._maxItemSize && this._maxItemSize < o) {\n      const i = 2 ** Math.ceil(s(t)),\n            r = 2 ** Math.ceil(s(e)),\n            o = new a(0, 0, t, e);\n      return this._mosaicPages.push({\n        mosaicsData: {\n          type: \"static\",\n          data: new Uint32Array(i * r)\n        },\n        size: [i, r],\n        dirty: !0,\n        texture: void 0\n      }), [o, this._mosaicPages.length - 1, [i, r]];\n    }\n\n    const h = this._binPack.allocate(t, e);\n\n    if (h.width <= 0) {\n      const i = this._mosaicPages[this._currentPage];\n      return !i.dirty && m(i.mosaicsData) && (i.mosaicsData.data = null), this._currentPage = this._mosaicPages.length, this._mosaicPages.push({\n        mosaicsData: {\n          type: \"static\",\n          data: new Uint32Array(this._pageWidth * this._pageHeight)\n        },\n        size: [this._pageWidth, this._pageHeight],\n        dirty: !0,\n        texture: void 0\n      }), this._binPack = new r(this._pageWidth, this._pageHeight), this._allocateImage(t, e);\n    }\n\n    return [h, this._currentPage, [this._pageWidth, this._pageHeight]];\n  }\n\n  dispose() {\n    this._binPack = null;\n\n    for (const t of this._mosaicPages) {\n      const e = t.texture;\n      e && e.dispose();\n      const i = t.mosaicsData;\n\n      if (!m(i)) {\n        i.data.pause();\n      }\n    }\n\n    this._mosaicPages = null, this._mosaicRects.clear();\n  }\n\n}\n\nfunction _(t, e, i) {\n  return m(e) ? new g(t, {\n    pixelFormat: o.RGBA,\n    dataType: h.UNSIGNED_BYTE,\n    width: i[0],\n    height: i[1]\n  }, new Uint8Array(e.data.buffer)) : new g(t, {\n    pixelFormat: o.RGBA,\n    dataType: h.UNSIGNED_BYTE,\n    samplingMode: c.LINEAR,\n    wrapMode: n.CLAMP_TO_EDGE,\n    width: i[0],\n    height: i[1]\n  }, null);\n}\n\nexport { p as default };","map":{"version":3,"sources":["D:/Github/CUSP_DataBase/CUSP_DB/src/main/gis/node_modules/@arcgis/core/views/2d/engine/webgl/SpriteMosaic.js"],"names":["t","isSome","e","SPRITE_PADDING","i","log2","s","a","r","PixelFormat","o","PixelType","h","TextureSamplingMode","c","TextureWrapMode","n","Texture","g","m","type","p","constructor","_mosaicPages","_maxItemSize","_currentPage","_pageWidth","_pageHeight","_mosaicRects","Map","_spriteCopyQueue","pixelRatio","console","error","_requestRender","window","devicePixelRatio","_binPack","Math","floor","push","mosaicsData","data","Uint32Array","size","dirty","texture","getWidth","length","getHeight","getPageTexture","has","itemCount","getSpriteItem","get","addSpriteItem","_allocateImage","width","height","rect","sdf","simplePattern","page","set","_copy","spriteSize","spriteData","pageSize","repeat","hasItemsToProcess","processNextItem","pop","getSpriteItems","getMosaicItemPosition","tl","x","y","br","bind","_","setSamplingMode","bindTexture","setData","Uint8Array","buffer","generateMipmap","bindFrame","frameCount","requestRender","_copyBits","max","ceil","allocate","dispose","pause","clear","pixelFormat","RGBA","dataType","UNSIGNED_BYTE","samplingMode","LINEAR","wrapMode","CLAMP_TO_EDGE","default"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport t from\"../../../../core/Error.js\";import{isSome as e}from\"../../../../core/maybe.js\";import{SPRITE_PADDING as i}from\"./definitions.js\";import{log2 as s}from\"./GeometryUtils.js\";import a from\"./Rect.js\";import r from\"./RectangleBinPack.js\";import{PixelFormat as o,PixelType as h,TextureSamplingMode as c,TextureWrapMode as n}from\"../../../webgl/enums.js\";import{Texture as g}from\"../../../webgl/Texture.js\";function m(t){return t&&\"static\"===t.type}class p{constructor(t,e,i,s=0){this._mosaicPages=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects=new Map,this._spriteCopyQueue=[],this.pixelRatio=1,(e<=0||i<=0)&&console.error(\"Sprites mosaic defaultWidth and defaultHeight must be greater than zero!\"),this._pageWidth=e,this._pageHeight=i,this._requestRender=t,s>0&&(this._maxItemSize=s),this.pixelRatio=window.devicePixelRatio||1,this._binPack=new r(this._pageWidth,this._pageHeight);const a=Math.floor(this._pageWidth),o=Math.floor(this._pageHeight);this._mosaicPages.push({mosaicsData:{type:\"static\",data:new Uint32Array(a*o)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0})}getWidth(t){return t>=this._mosaicPages.length?-1:this._mosaicPages[t].size[0]}getHeight(t){return t>=this._mosaicPages.length?-1:this._mosaicPages[t].size[1]}getPageTexture(t){return t<this._mosaicPages.length?this._mosaicPages[t].texture:null}has(t){return this._mosaicRects.has(t)}get itemCount(){return this._mosaicRects.size}getSpriteItem(t){return this._mosaicRects.get(t)}addSpriteItem(t,e,i,s,r,o){if(this._mosaicRects.has(t))return this._mosaicRects.get(t);let h,c,n;if(m(i))[h,c,n]=this._allocateImage(e[0],e[1]);else{h=new a(0,0,e[0],e[1]),c=this._mosaicPages.length;const t=void 0;this._mosaicPages.push({mosaicsData:i,size:e,dirty:!0,texture:t})}if(h.width<=0||h.height<=0)return null;const g={rect:h,width:e[0],height:e[1],sdf:r,simplePattern:o,pixelRatio:1,page:c};return this._mosaicRects.set(t,g),m(i)&&this._copy({rect:h,spriteSize:e,spriteData:i.data,page:c,pageSize:n,repeat:s,sdf:r}),g}hasItemsToProcess(){return 0!==this._spriteCopyQueue.length}processNextItem(){const t=this._spriteCopyQueue.pop();t&&this._copy(t)}getSpriteItems(t){const e={};for(const i of t)e[i]=this.getSpriteItem(i);return e}getMosaicItemPosition(t){const e=this.getSpriteItem(t),s=e&&e.rect;if(!s)return null;s.width=e.width,s.height=e.height;const a=e.width,r=e.height,o=i,h=this._mosaicPages[e.page];return{size:[e.width,e.height],tl:[(s.x+o)/h[0],(s.y+o)/h[1]],br:[(s.x+o+a)/h[0],(s.y+o+r)/h[1]],page:e.page}}bind(t,i,s=0,a=0){const r=this._mosaicPages[s],o=r.mosaicsData;let h=r.texture;if(h||(h=_(t,o,r.size),r.texture=h),h.setSamplingMode(i),m(o))t.bindTexture(h,a),r.dirty&&(h.setData(new Uint8Array(o.data.buffer)),h.generateMipmap());else{const i=o.data,s=i.bindFrame(t,h,a);e(this._requestRender)&&s&&i.frameCount>0&&this._requestRender.requestRender(),i.bindFrame(t,h,a)}r.dirty=!1}static _copyBits(t,e,i,s,a,r,o,h,c,n,g){let m=s*e+i,p=h*r+o;if(g){p-=r;for(let o=-1;o<=n;o++,m=((o+n)%n+s)*e+i,p+=r)for(let e=-1;e<=c;e++)a[p+e]=t[m+(e+c)%c]}else for(let _=0;_<n;_++){for(let e=0;e<c;e++)a[p+e]=t[m+e];m+=e,p+=r}}_copy(e){if(e.page>=this._mosaicPages.length)return;const s=this._mosaicPages[e.page],a=s.mosaicsData;if(!m(s.mosaicsData))throw new t(\"mapview-invalid-resource\",\"unsuitable data type!\");const r=e.spriteData,o=a.data;o&&r||console.error(\"Source or target images are uninitialized!\"),p._copyBits(r,e.spriteSize[0],0,0,o,e.pageSize[0],e.rect.x+i,e.rect.y+i,e.spriteSize[0],e.spriteSize[1],e.repeat),s.dirty=!0}_allocateImage(t,e){t+=2*i,e+=2*i;const o=Math.max(t,e);if(this._maxItemSize&&this._maxItemSize<o){const i=2**Math.ceil(s(t)),r=2**Math.ceil(s(e)),o=new a(0,0,t,e);return this._mosaicPages.push({mosaicsData:{type:\"static\",data:new Uint32Array(i*r)},size:[i,r],dirty:!0,texture:void 0}),[o,this._mosaicPages.length-1,[i,r]]}const h=this._binPack.allocate(t,e);if(h.width<=0){const i=this._mosaicPages[this._currentPage];return!i.dirty&&m(i.mosaicsData)&&(i.mosaicsData.data=null),this._currentPage=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:{type:\"static\",data:new Uint32Array(this._pageWidth*this._pageHeight)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0}),this._binPack=new r(this._pageWidth,this._pageHeight),this._allocateImage(t,e)}return[h,this._currentPage,[this._pageWidth,this._pageHeight]]}dispose(){this._binPack=null;for(const t of this._mosaicPages){const e=t.texture;e&&e.dispose();const i=t.mosaicsData;if(!m(i)){i.data.pause()}}this._mosaicPages=null,this._mosaicRects.clear()}}function _(t,e,i){return m(e)?new g(t,{pixelFormat:o.RGBA,dataType:h.UNSIGNED_BYTE,width:i[0],height:i[1]},new Uint8Array(e.data.buffer)):new g(t,{pixelFormat:o.RGBA,dataType:h.UNSIGNED_BYTE,samplingMode:c.LINEAR,wrapMode:n.CLAMP_TO_EDGE,width:i[0],height:i[1]},null)}export{p as default};\n"]},"metadata":{},"sourceType":"module"}