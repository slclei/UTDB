{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport \"../../../../../core/has.js\";\nimport t from \"../../../../../core/Logger.js\";\nimport { unwrapOrThrow as e, isSome as s, isNone as r } from \"../../../../../core/maybe.js\";\nimport { throwIfAborted as o, after as a } from \"../../../../../core/promiseUtils.js\";\nimport i from \"../../../../../core/RandomLCG.js\";\nimport { BaseFeatureSource as n } from \"./BaseFeatureSource.js\";\nimport { FeatureSetReaderIndirect as d } from \"../support/FeatureSetReaderPBFIndirect.js\";\nimport { UpdateToken as h } from \"../support/UpdateToken.js\";\nconst l = t.getLogger(\"esri.views.2d.layers.features.sources.SnapshotFeatureSource\");\n\nfunction u(t, e, s) {\n  const r = t.getXHydrated(),\n        o = t.getYHydrated(),\n        a = e.getColumnForX(r),\n        i = Math.floor(e.normalizeCol(a));\n  return `${s}/${Math.floor(e.getRowForY(o))}/${i}`;\n}\n\nfunction c(t, e) {\n  if (r(t)) return null;\n  const s = e.transform,\n        o = t.getQuantizationTransform();\n\n  if (r(o)) {\n    const [e, r] = s.scale,\n          [o, a] = s.translate,\n          i = -o / e,\n          n = 1 / e,\n          d = a / r,\n          h = 1 / -r;\n    return t.transform(i, d, n, h);\n  }\n\n  const [a, i] = o.scale,\n        [n, d] = o.translate,\n        [h, l] = s.scale,\n        [u, c] = s.translate,\n        g = a / h,\n        p = (n - u) / h,\n        _ = i / l,\n        m = (-d + c) / l;\n\n  return t.transform(p, m, g, _);\n}\n\nclass g extends n {\n  constructor(t) {\n    super(t), this.mode = \"snapshot\", this._loading = !0, this._controller = new AbortController(), this._downloadPromise = null, this._didSendEnd = !1, this._queries = new Array(), this._invalidated = !1, this._hasAggregates = !1, this._random = new i(1e3), this._store = t.store, this._markedIdsBufId = this._store.storage.createBitset();\n  }\n\n  destroy() {\n    super.destroy(), this._controller.abort();\n  }\n\n  get loading() {\n    return this._loading;\n  }\n\n  get _signal() {\n    return this._controller.signal;\n  }\n\n  update(t, e) {\n    super.update(t, e), this._hasAggregates = t.targets.aggregate;\n  }\n\n  async resend() {\n    let t = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : !1;\n\n    if (await this._downloadPromise, this._invalidated || t) {\n      const t = e(this._schema.featureCount, \"Expected featureCount to be defined\");\n      return this._invalidated = !1, this._subscriptions.forEach(t => t.clear()), this._downloadPromise = this._download(t), void (await this._downloadPromise);\n    }\n\n    const s = this._queries.map(_ref => {\n      let {\n        query: t,\n        reader: e\n      } = _ref;\n      return this._sendPatchQuery(t, e);\n    });\n\n    await Promise.all(s), this._subscriptions.forEach(t => {\n      t.requests.done.forEach(t => this._onMessage(t.message));\n    });\n  }\n\n  async refresh() {\n    await this.resend(!0);\n  }\n\n  async _sendPatchQuery(t, e) {\n    const r = s(t.outFields) ? t.outFields : [],\n          a = this._queryInfo.outFields,\n          i = a.filter(t => -1 === r.indexOf(t));\n    if (!i.length) return;\n    const n = t.clone(),\n          d = this._signal;\n    n.returnGeometry = !1, n.returnCentroid = !1, n.outFields = i, t.outFields = a;\n    const h = await this._queue.push({\n      query: n,\n      depth: 0,\n      signal: d\n    });\n    o({\n      signal: d\n    }), e.joinAttributes(h);\n  }\n\n  async _fetchDataTile(t) {\n    if (!this._downloadPromise) {\n      const t = e(this._schema.featureCount, \"Expected featureCount to be defined\");\n      this._downloadPromise = this._download(t);\n    }\n\n    const s = this._store.search(t),\n          r = this._subscriptions.get(t.key.id),\n          o = s.length - 1;\n\n    for (let e = 0; e < o; e++) {\n      const o = c(s[e], t),\n            i = {\n        type: \"append\",\n        id: t.id,\n        addOrUpdate: o,\n        end: !1,\n        status: h.empty()\n      };\n      r.add({\n        query: null,\n        message: i\n      }), this._hasAggregates || (await a(1)), this._onMessage(i);\n    }\n\n    const i = c(o >= 0 ? s[o] : null, t),\n          n = this._didSendEnd,\n          d = {\n      type: \"append\",\n      id: t.id,\n      addOrUpdate: i,\n      end: n,\n      status: h.empty()\n    };\n    r.add({\n      query: null,\n      message: d\n    }), this._onMessage(d);\n  }\n\n  async _download(t) {\n    try {\n      await this.whenInitialized();\n\n      const e = this._store.storage.getBitset(this._markedIdsBufId),\n            s = new Set();\n\n      e.clear();\n      const r = Math.ceil(t / this.pageSize),\n            o = Array.from({\n        length: r\n      }, (t, e) => e).sort((t, e) => this._random.getInt() - this._random.getInt()).map(t => this._downloadPage(t, e, s));\n      await Promise.all(o), this._store.sweepFeatures(e, this._store.storage), this._store.sweepFeatureSets(s);\n    } catch (e) {\n      l.error(\"mapview-snapshot-source\", \"Encountered and error when downloading feature snapshot\", e);\n    }\n\n    this._sendEnd(), this._loading = !1;\n  }\n\n  async _downloadPage(t, e, r) {\n    const a = this.pageSize,\n          i = {\n      start: t * a,\n      num: a,\n      cacheHint: !0\n    };\n    s(this.maxRecordCountFactor) && (i.maxRecordCountFactor = this.maxRecordCountFactor);\n    const n = this.createQuery(i),\n          d = this._signal,\n          h = await this._queue.push({\n      query: n,\n      depth: t,\n      signal: d\n    });\n    o({\n      signal: d\n    }), this._queries.push({\n      query: n,\n      reader: h\n    }), this._store.insert(h), r.add(h.instance);\n    const l = h.getCursor();\n\n    for (; l.next();) e.set(l.getDisplayId());\n\n    this._send(h);\n  }\n\n  _send(t) {\n    if (!this._subscriptions.size) return;\n    let e = null;\n    const o = new Map(),\n          a = new Set(),\n          i = new Map();\n\n    this._subscriptions.forEach(t => {\n      var s;\n      const r = t.tile;\n      o.set(r.key.id, null), e = r.tileInfoView, a.add(r.level);\n      const {\n        row: n,\n        col: d\n      } = r.key,\n            h = `${r.level}/${n}/${d}`,\n            l = null != (s = i.get(h)) ? s : [];\n      l.push(t), i.set(h, l);\n    });\n\n    for (const s of a) {\n      const a = e.getLODInfoAt(s),\n            n = t.getCursor();\n\n      for (; n.next();) {\n        const t = u(n, a, s),\n              e = n.getIndex();\n        if (i.has(t)) for (const s of i.get(t)) {\n          const t = s.tile.id;\n          let a = o.get(t);\n          r(a) && (a = [], o.set(t, a)), a.push(e);\n        }\n      }\n    }\n\n    o.forEach((e, r) => {\n      if (s(e)) {\n        const s = this._subscriptions.get(r),\n              o = {\n          type: \"append\",\n          id: r,\n          addOrUpdate: c(d.from(t, e), s.tile),\n          end: !1,\n          status: h.empty()\n        };\n\n        s.add({\n          query: null,\n          message: o\n        }), this._onMessage(o);\n      }\n    });\n  }\n\n  _sendEnd() {\n    this._subscriptions.forEach(t => {\n      const e = {\n        type: \"append\",\n        id: t.tile.id,\n        addOrUpdate: null,\n        end: !0,\n        status: h.empty()\n      };\n      t.add({\n        query: null,\n        message: e\n      }), this._onMessage(e);\n    }), this._didSendEnd = !0;\n  }\n\n}\n\nexport { g as SnapshotFeatureSource };","map":{"version":3,"sources":["D:/Github/CUSP_DataBase/CUSP_DB/src/main/gis/node_modules/@arcgis/core/views/2d/layers/features/sources/SnapshotFeatureSource.js"],"names":["t","unwrapOrThrow","e","isSome","s","isNone","r","throwIfAborted","o","after","a","i","BaseFeatureSource","n","FeatureSetReaderIndirect","d","UpdateToken","h","l","getLogger","u","getXHydrated","getYHydrated","getColumnForX","Math","floor","normalizeCol","getRowForY","c","transform","getQuantizationTransform","scale","translate","g","p","_","m","constructor","mode","_loading","_controller","AbortController","_downloadPromise","_didSendEnd","_queries","Array","_invalidated","_hasAggregates","_random","_store","store","_markedIdsBufId","storage","createBitset","destroy","abort","loading","_signal","signal","update","targets","aggregate","resend","_schema","featureCount","_subscriptions","forEach","clear","_download","map","query","reader","_sendPatchQuery","Promise","all","requests","done","_onMessage","message","refresh","outFields","_queryInfo","filter","indexOf","length","clone","returnGeometry","returnCentroid","_queue","push","depth","joinAttributes","_fetchDataTile","search","get","key","id","type","addOrUpdate","end","status","empty","add","whenInitialized","getBitset","Set","ceil","pageSize","from","sort","getInt","_downloadPage","sweepFeatures","sweepFeatureSets","error","_sendEnd","start","num","cacheHint","maxRecordCountFactor","createQuery","insert","instance","getCursor","next","set","getDisplayId","_send","size","Map","tile","tileInfoView","level","row","col","getLODInfoAt","getIndex","has","SnapshotFeatureSource"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport\"../../../../../core/has.js\";import t from\"../../../../../core/Logger.js\";import{unwrapOrThrow as e,isSome as s,isNone as r}from\"../../../../../core/maybe.js\";import{throwIfAborted as o,after as a}from\"../../../../../core/promiseUtils.js\";import i from\"../../../../../core/RandomLCG.js\";import{BaseFeatureSource as n}from\"./BaseFeatureSource.js\";import{FeatureSetReaderIndirect as d}from\"../support/FeatureSetReaderPBFIndirect.js\";import{UpdateToken as h}from\"../support/UpdateToken.js\";const l=t.getLogger(\"esri.views.2d.layers.features.sources.SnapshotFeatureSource\");function u(t,e,s){const r=t.getXHydrated(),o=t.getYHydrated(),a=e.getColumnForX(r),i=Math.floor(e.normalizeCol(a));return`${s}/${Math.floor(e.getRowForY(o))}/${i}`}function c(t,e){if(r(t))return null;const s=e.transform,o=t.getQuantizationTransform();if(r(o)){const[e,r]=s.scale,[o,a]=s.translate,i=-o/e,n=1/e,d=a/r,h=1/-r;return t.transform(i,d,n,h)}const[a,i]=o.scale,[n,d]=o.translate,[h,l]=s.scale,[u,c]=s.translate,g=a/h,p=(n-u)/h,_=i/l,m=(-d+c)/l;return t.transform(p,m,g,_)}class g extends n{constructor(t){super(t),this.mode=\"snapshot\",this._loading=!0,this._controller=new AbortController,this._downloadPromise=null,this._didSendEnd=!1,this._queries=new Array,this._invalidated=!1,this._hasAggregates=!1,this._random=new i(1e3),this._store=t.store,this._markedIdsBufId=this._store.storage.createBitset()}destroy(){super.destroy(),this._controller.abort()}get loading(){return this._loading}get _signal(){return this._controller.signal}update(t,e){super.update(t,e),this._hasAggregates=t.targets.aggregate}async resend(t=!1){if(await this._downloadPromise,this._invalidated||t){const t=e(this._schema.featureCount,\"Expected featureCount to be defined\");return this._invalidated=!1,this._subscriptions.forEach((t=>t.clear())),this._downloadPromise=this._download(t),void await this._downloadPromise}const s=this._queries.map((({query:t,reader:e})=>this._sendPatchQuery(t,e)));await Promise.all(s),this._subscriptions.forEach((t=>{t.requests.done.forEach((t=>this._onMessage(t.message)))}))}async refresh(){await this.resend(!0)}async _sendPatchQuery(t,e){const r=s(t.outFields)?t.outFields:[],a=this._queryInfo.outFields,i=a.filter((t=>-1===r.indexOf(t)));if(!i.length)return;const n=t.clone(),d=this._signal;n.returnGeometry=!1,n.returnCentroid=!1,n.outFields=i,t.outFields=a;const h=await this._queue.push({query:n,depth:0,signal:d});o({signal:d}),e.joinAttributes(h)}async _fetchDataTile(t){if(!this._downloadPromise){const t=e(this._schema.featureCount,\"Expected featureCount to be defined\");this._downloadPromise=this._download(t)}const s=this._store.search(t),r=this._subscriptions.get(t.key.id),o=s.length-1;for(let e=0;e<o;e++){const o=c(s[e],t),i={type:\"append\",id:t.id,addOrUpdate:o,end:!1,status:h.empty()};r.add({query:null,message:i}),this._hasAggregates||await a(1),this._onMessage(i)}const i=c(o>=0?s[o]:null,t),n=this._didSendEnd,d={type:\"append\",id:t.id,addOrUpdate:i,end:n,status:h.empty()};r.add({query:null,message:d}),this._onMessage(d)}async _download(t){try{await this.whenInitialized();const e=this._store.storage.getBitset(this._markedIdsBufId),s=new Set;e.clear();const r=Math.ceil(t/this.pageSize),o=Array.from({length:r},((t,e)=>e)).sort(((t,e)=>this._random.getInt()-this._random.getInt())).map((t=>this._downloadPage(t,e,s)));await Promise.all(o),this._store.sweepFeatures(e,this._store.storage),this._store.sweepFeatureSets(s)}catch(e){l.error(\"mapview-snapshot-source\",\"Encountered and error when downloading feature snapshot\",e)}this._sendEnd(),this._loading=!1}async _downloadPage(t,e,r){const a=this.pageSize,i={start:t*a,num:a,cacheHint:!0};s(this.maxRecordCountFactor)&&(i.maxRecordCountFactor=this.maxRecordCountFactor);const n=this.createQuery(i),d=this._signal,h=await this._queue.push({query:n,depth:t,signal:d});o({signal:d}),this._queries.push({query:n,reader:h}),this._store.insert(h),r.add(h.instance);const l=h.getCursor();for(;l.next();)e.set(l.getDisplayId());this._send(h)}_send(t){if(!this._subscriptions.size)return;let e=null;const o=new Map,a=new Set,i=new Map;this._subscriptions.forEach((t=>{var s;const r=t.tile;o.set(r.key.id,null),e=r.tileInfoView,a.add(r.level);const{row:n,col:d}=r.key,h=`${r.level}/${n}/${d}`,l=null!=(s=i.get(h))?s:[];l.push(t),i.set(h,l)}));for(const s of a){const a=e.getLODInfoAt(s),n=t.getCursor();for(;n.next();){const t=u(n,a,s),e=n.getIndex();if(i.has(t))for(const s of i.get(t)){const t=s.tile.id;let a=o.get(t);r(a)&&(a=[],o.set(t,a)),a.push(e)}}}o.forEach(((e,r)=>{if(s(e)){const s=this._subscriptions.get(r),o={type:\"append\",id:r,addOrUpdate:c(d.from(t,e),s.tile),end:!1,status:h.empty()};s.add({query:null,message:o}),this._onMessage(o)}}))}_sendEnd(){this._subscriptions.forEach((t=>{const e={type:\"append\",id:t.tile.id,addOrUpdate:null,end:!0,status:h.empty()};t.add({query:null,message:e}),this._onMessage(e)})),this._didSendEnd=!0}}export{g as SnapshotFeatureSource};\n"]},"metadata":{},"sourceType":"module"}