{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../chunks/tslib.es6.js\";\nimport t from \"../../../Graphic.js\";\nimport { clone as i } from \"../../../core/lang.js\";\nimport s from \"../../../core/Logger.js\";\nimport { isNone as r } from \"../../../core/maybe.js\";\nimport { isAbortError as a } from \"../../../core/promiseUtils.js\";\nimport { watch as l, initial as n } from \"../../../core/reactiveUtils.js\";\nimport { property as o } from \"../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../core/accessorSupport/ensureType.js\";\nimport { subclass as h } from \"../../../core/accessorSupport/decorators/subclass.js\";\nimport { diff as u, hasDiff as y } from \"../../../core/accessorSupport/diffUtils.js\";\nimport { create as c } from \"../../../geometry/support/aaBoundingRect.js\";\nimport { equals as p } from \"../../../geometry/support/spatialReferenceUtils.js\";\nimport { StyleUpdateType as d } from \"../engine/vectorTiles/enums.js\";\nimport { TileHandler as _ } from \"../engine/vectorTiles/TileHandler.js\";\nimport { TileManager as f } from \"../engine/vectorTiles/TileManager.js\";\nimport { VectorTile as g } from \"../engine/vectorTiles/VectorTile.js\";\nimport { VectorTileContainer as m } from \"../engine/vectorTiles/VectorTileContainer.js\";\nimport { drawColliders as C } from \"../engine/vectorTiles/decluttering/debugging.js\";\nimport { StyleLayerType as T } from \"../engine/vectorTiles/style/StyleDefinition.js\";\nimport v from \"../engine/vectorTiles/style/StyleRepository.js\";\nimport { LayerView2DMixin as R } from \"./LayerView2D.js\";\nimport { Display as D } from \"./support/Display.js\";\nimport H from \"../tiling/TileInfoViewPOT.js\";\nimport w from \"../tiling/TileQueue.js\";\nimport S from \"../../layers/LayerView.js\";\nconst Q = s.getLogger(\"esri.views.2d.layers.VectorTileLayerView2D\");\nlet L = class extends R(S) {\n  constructor() {\n    super(...arguments), this._styleChanges = [], this._fetchQueue = null, this._parseQueue = null, this._isTileHandlerReady = !1, this.fading = !1;\n  }\n\n  async hitTest(e, i) {\n    if (!this._tileHandlerPromise) return null;\n    await this._tileHandlerPromise;\n    const s = await this._vectorTileContainer.hitTest(i);\n    if (!s || 0 === s.length) return null;\n    const r = s[0] - 1,\n          a = this._styleRepository,\n          l = a.getStyleLayerByUID(r);\n    if (!l) return null;\n    const n = a.getStyleLayerIndex(l.id),\n          o = new t({\n      attributes: {\n        layerId: n,\n        layerName: l.id,\n        layerUID: r\n      }\n    });\n    return o.layer = this.layer, o.sourceLayer = this.layer, [o];\n  }\n\n  update(e) {\n    if (this._tileHandlerPromise && this._isTileHandlerReady) return e.pixelRatio !== this._tileHandler.devicePixelRatio ? (this._start(), void (this._tileHandler.devicePixelRatio = e.pixelRatio)) : void (this._styleChanges.length > 0 ? this._tileHandlerPromise = this._applyStyleChanges() : (this._fetchQueue.pause(), this._parseQueue.pause(), this._fetchQueue.state = e.state, this._parseQueue.state = e.state, this._tileManager.update(e) || this.requestUpdate(), this._parseQueue.resume(), this._fetchQueue.resume()));\n  }\n\n  attach() {\n    const {\n      style: e\n    } = this.layer.currentStyleInfo;\n    this._styleRepository = new v(e), this._tileInfoView = new H(this.layer.tileInfo, this.layer.fullExtent), this._vectorTileContainer = new m(this._tileInfoView), this._tileHandler = new _(this.layer, this._styleRepository, window.devicePixelRatio || 1), this.container.addChild(this._vectorTileContainer), this._start(), this.handles.add([this._vectorTileContainer.on(\"fade-start\", () => {\n      this.fading = !0, this.notifyChange(\"updating\"), this.requestUpdate();\n    }), this._vectorTileContainer.on(\"fade-complete\", () => {\n      var e;\n      null == (e = this._collisionBoxesDisplay) || e.requestRender(), this.fading = !1, this.notifyChange(\"updating\"), this.requestUpdate();\n    }), l(() => this.layer.symbolCollisionBoxesVisible, e => {\n      e ? (this._collisionBoxesDisplay = new D({\n        render: e => this._renderCollisionBoxes(e.context)\n      }), this.container.addChild(this._collisionBoxesDisplay)) : (this.container.removeChild(this._collisionBoxesDisplay), this._collisionBoxesDisplay = null);\n    }, n), this.layer.on(\"paint-change\", e => {\n      if (e.isDataDriven) this._styleChanges.push({\n        type: d.PAINTER_CHANGED,\n        data: e\n      }), this.notifyChange(\"updating\"), this.requestUpdate();else {\n        const t = this._styleRepository,\n              i = t.getLayerById(e.layer);\n        if (!i) return;\n        const s = i.type === T.SYMBOL;\n        t.setPaintProperties(e.layer, e.paint), s && this._vectorTileContainer.restartDeclutter(), this._vectorTileContainer.requestRender();\n      }\n    }), this.layer.on(\"layout-change\", e => {\n      const t = this._styleRepository,\n            i = t.getLayerById(e.layer);\n      if (!i) return;\n      const s = u(i.layout, e.layout);\n\n      if (!r(s)) {\n        if (y(s, \"visibility\") && 1 === b(s)) return t.setLayoutProperties(e.layer, e.layout), i.type === T.SYMBOL && this._vectorTileContainer.restartDeclutter(), void this._vectorTileContainer.requestRender();\n        this._styleChanges.push({\n          type: d.LAYOUT_CHANGED,\n          data: e\n        }), this.notifyChange(\"updating\"), this.requestUpdate();\n      }\n    }), this.layer.on(\"style-layer-visibility-change\", e => {\n      const t = this._styleRepository,\n            i = t.getLayerById(e.layer);\n      i && (t.setStyleLayerVisibility(e.layer, e.visibility), i.type === T.SYMBOL && this._vectorTileContainer.restartDeclutter(), this._vectorTileContainer.requestRender());\n    }), this.layer.on(\"style-layer-change\", e => {\n      this._styleChanges.push({\n        type: d.LAYER_CHANGED,\n        data: e\n      }), this.notifyChange(\"updating\"), this.requestUpdate();\n    }), this.layer.on(\"delete-style-layer\", e => {\n      this._styleChanges.push({\n        type: d.LAYER_REMOVED,\n        data: e\n      }), this.notifyChange(\"updating\"), this.requestUpdate();\n    }), this.layer.on(\"load-style\", () => this._loadStyle()), this.layer.on(\"spriteSource-change\", e => {\n      this._newSpriteSource = e.spriteSource, this._styleChanges.push({\n        type: d.SPRITES_CHANGED,\n        data: null\n      });\n      const t = this._styleRepository.layers;\n\n      for (const i of t) switch (i.type) {\n        case T.SYMBOL:\n          i.getLayoutProperty(\"icon-image\") && this._styleChanges.push({\n            type: d.LAYOUT_CHANGED,\n            data: {\n              layer: i.id,\n              layout: i.layout\n            }\n          });\n          break;\n\n        case T.LINE:\n          i.getPaintProperty(\"line-pattern\") && this._styleChanges.push({\n            type: d.PAINTER_CHANGED,\n            data: {\n              layer: i.id,\n              paint: i.paint,\n              isDataDriven: i.isPainterDataDriven()\n            }\n          });\n          break;\n\n        case T.FILL:\n          i.getLayoutProperty(\"fill-pattern\") && this._styleChanges.push({\n            type: d.PAINTER_CHANGED,\n            data: {\n              layer: i.id,\n              paint: i.paint,\n              isDataDriven: i.isPainterDataDriven()\n            }\n          });\n      }\n\n      this.notifyChange(\"updating\"), this.requestUpdate();\n    })], this.declaredClass);\n  }\n\n  detach() {\n    var e, t;\n    this._stop(), this.container.removeAllChildren(), null == (e = this._vectorTileContainer) || e.destroy(), this._vectorTileContainer = null, null == (t = this._tileHandler) || t.destroy(), this._tileHandler = null, this.handles.remove(this.declaredClass);\n  }\n\n  moveStart() {\n    this.requestUpdate();\n  }\n\n  viewChange() {\n    this.requestUpdate();\n  }\n\n  moveEnd() {\n    this._collisionBoxesDisplay && this._vectorTileContainer.restartDeclutter(), this.requestUpdate();\n  }\n\n  supportsSpatialReference(e) {\n    var t;\n    return p(null == (t = this.layer.tileInfo) ? void 0 : t.spatialReference, e);\n  }\n\n  canResume() {\n    let e = super.canResume();\n    const {\n      currentStyleInfo: t\n    } = this.layer;\n\n    if (e && null != t && t.layerDefinition) {\n      const i = this.view.scale,\n            {\n        minScale: s,\n        maxScale: r\n      } = t.layerDefinition;\n      t && t.layerDefinition && (s && s < i && (e = !1), r && r > i && (e = !1));\n    }\n\n    return e;\n  }\n\n  isUpdating() {\n    const e = this._vectorTileContainer.children;\n    return !this._isTileHandlerReady || !this._fetchQueue || !this._parseQueue || this._fetchQueue.updating || this._parseQueue.updating || e.length > 0 && e.filter(e => e.invalidating).length > 0 || this.fading;\n  }\n\n  acquireTile(e) {\n    const t = this._createVectorTile(e);\n\n    return this._tileHandlerPromise.then(() => {\n      this._fetchQueue.push(t.key).then(e => this._parseQueue.push({\n        key: t.key,\n        data: e\n      })).then(e => {\n        t.once(\"attach\", () => this.requestUpdate()), t.setData(e), this.requestUpdate(), this.notifyChange(\"updating\");\n      }).catch(e => {\n        this.notifyChange(\"updating\"), a(e) || Q.error(e);\n      });\n    }), t;\n  }\n\n  releaseTile(e) {\n    const t = e.key.id;\n    this._fetchQueue.abort(t), this._parseQueue.abort(t), this.requestUpdate();\n  }\n\n  _start() {\n    if (this._stop(), this._tileManager = new f({\n      acquireTile: e => this.acquireTile(e),\n      releaseTile: e => this.releaseTile(e),\n      tileInfoView: this._tileInfoView\n    }, this._vectorTileContainer), !this.layer.currentStyleInfo) return;\n\n    const e = new AbortController(),\n          t = this._tileHandler.start({\n      signal: e.signal\n    }).then(() => {\n      this._fetchQueue = new w({\n        tileInfoView: this._tileInfoView,\n        process: (e, t) => this._getTileData(e, t),\n        concurrency: 15\n      }), this._parseQueue = new w({\n        tileInfoView: this._tileInfoView,\n        process: (e, t) => this._parseTileData(e, t),\n        concurrency: 8\n      }), this.requestUpdate(), this._isTileHandlerReady = !0;\n    });\n\n    this._tileHandler.spriteMosaic.then(e => {\n      this._vectorTileContainer.setStyleResources(e, this._tileHandler.glyphMosaic, this._styleRepository), this.requestUpdate();\n    }), this._tileHandlerAbortController = e, this._tileHandlerPromise = t;\n  }\n\n  _stop() {\n    if (!this._tileHandlerAbortController || !this._vectorTileContainer) return;\n    const e = this._tileHandlerAbortController;\n    e && e.abort(), this._tileHandlerPromise = null, this._isTileHandlerReady = !1, this._fetchQueue && (this._fetchQueue.destroy(), this._fetchQueue = null), this._parseQueue && (this._parseQueue.destroy(), this._parseQueue = null), this._tileManager && (this._tileManager.destroy(), this._tileManager = null), this._vectorTileContainer.removeAllChildren();\n  }\n\n  async _getTileData(e, t) {\n    const i = await this._tileHandler.fetchTileData(e, t);\n    return this.notifyChange(\"updating\"), i;\n  }\n\n  async _parseTileData(e, t) {\n    return this._tileHandler.parseTileData(e, t);\n  }\n\n  async _applyStyleChanges() {\n    this._isTileHandlerReady = !1, this._fetchQueue.pause(), this._parseQueue.pause(), this._fetchQueue.clear(), this._parseQueue.clear(), this._tileManager.clearCache();\n    const e = this._styleChanges;\n\n    try {\n      await this._tileHandler.updateStyle(e);\n    } catch (l) {\n      Q.error(\"error applying vector-tiles style update\", l.message), this._fetchQueue.resume(), this._parseQueue.resume(), this._isTileHandlerReady = !0;\n    }\n\n    const t = this._styleRepository,\n          i = [];\n    e.forEach(e => {\n      if (e.type !== d.LAYER_REMOVED) return;\n      const s = e.data,\n            r = t.getLayerById(s.layer);\n      r && i.push(r.uid);\n    });\n    const s = [];\n    let r;\n    e.forEach(e => {\n      const i = e.type,\n            a = e.data;\n\n      switch (i) {\n        case d.PAINTER_CHANGED:\n          t.setPaintProperties(a.layer, a.paint), r = a.layer;\n          break;\n\n        case d.LAYOUT_CHANGED:\n          t.setLayoutProperties(a.layer, a.layout), r = a.layer;\n          break;\n\n        case d.LAYER_REMOVED:\n          return void t.deleteStyleLayer(a.layer);\n\n        case d.LAYER_CHANGED:\n          t.setStyleLayer(a.layer, a.index), r = a.layer.id;\n          break;\n\n        case d.SPRITES_CHANGED:\n          this._vectorTileContainer.setSpriteMosaic(this._tileHandler.setSpriteSource(this._newSpriteSource)), this._newSpriteSource = null, r = null;\n      }\n\n      const l = t.getLayerById(r);\n      l && s.push(l.uid);\n    });\n    const a = this._vectorTileContainer.children;\n\n    if (i.length > 0) {\n      this._vectorTileContainer.deleteStyleLayers(i);\n\n      for (const e of a) e.deleteLayerData(i);\n    }\n\n    if (this._fetchQueue.resume(), this._parseQueue.resume(), s.length > 0) {\n      const e = [];\n\n      for (const t of a) {\n        const i = this._fetchQueue.push(t.key).then(e => this._parseQueue.push({\n          key: t.key,\n          data: e,\n          styleLayerUIDs: s\n        })).then(e => t.setData(e));\n\n        e.push(i);\n      }\n\n      await Promise.all(e);\n    }\n\n    this._styleChanges = [], this._isTileHandlerReady = !0, this.notifyChange(\"updating\"), this.requestUpdate();\n  }\n\n  async _loadStyle() {\n    const {\n      style: e\n    } = this.layer.currentStyleInfo,\n          t = i(e);\n    this._isTileHandlerReady = !1, this._fetchQueue.pause(), this._parseQueue.pause(), this._fetchQueue.clear(), this._parseQueue.clear(), this.notifyChange(\"updating\"), this._styleRepository = new v(t), this._vectorTileContainer.destroy(), this._tileManager.clear(), this._tileHandlerAbortController.abort(), this._tileHandlerAbortController = new AbortController();\n    const {\n      signal: s\n    } = this._tileHandlerAbortController;\n\n    try {\n      this._tileHandlerPromise = this._tileHandler.setStyle(this._styleRepository, t), await this._tileHandlerPromise;\n    } catch (l) {\n      if (!a(l)) throw l;\n    }\n\n    if (s.aborted) return this._fetchQueue.resume(), this._parseQueue.resume(), this._isTileHandlerReady = !0, this.notifyChange(\"updating\"), void this.requestUpdate();\n    const r = await this._tileHandler.spriteMosaic;\n    this._vectorTileContainer.setStyleResources(r, this._tileHandler.glyphMosaic, this._styleRepository), this._fetchQueue.resume(), this._parseQueue.resume(), this._isTileHandlerReady = !0, this.notifyChange(\"updating\"), this.requestUpdate();\n  }\n\n  _createVectorTile(e) {\n    const t = this._tileInfoView.getTileBounds(c(), e);\n\n    return new g(e, t[0], t[3], 512, 512, this._styleRepository);\n  }\n\n  _renderCollisionBoxes(e) {\n    for (const t of this._vectorTileContainer.children) if (t.symbols) {\n      const i = [];\n\n      for (const [e, s] of t.symbols) i.push(...s);\n\n      C(e, i);\n    }\n  }\n\n};\n\nfunction b(e) {\n  if (r(e)) return 0;\n\n  switch (e.type) {\n    case \"partial\":\n      return Object.keys(e.diff).length;\n\n    case \"complete\":\n      return Math.max(Object.keys(e.oldValue).length, Object.keys(e.newValue).length);\n\n    case \"collection\":\n      return Object.keys(e.added).length + Object.keys(e.changed).length + Object.keys(e.removed).length;\n  }\n}\n\ne([o()], L.prototype, \"_fetchQueue\", void 0), e([o()], L.prototype, \"_parseQueue\", void 0), e([o()], L.prototype, \"_isTileHandlerReady\", void 0), e([o()], L.prototype, \"fading\", void 0), L = e([h(\"esri.views.2d.layers.VectorTileLayerView2D\")], L);\nconst I = L;\nexport { I as default };","map":{"version":3,"sources":["D:/Github/CUSP_DataBase/CUSP_DB/src/main/gis/node_modules/@arcgis/core/views/2d/layers/VectorTileLayerView2D.js"],"names":["_","e","t","clone","i","s","isNone","r","isAbortError","a","watch","l","initial","n","property","o","subclass","h","diff","u","hasDiff","y","create","c","equals","p","StyleUpdateType","d","TileHandler","TileManager","f","VectorTile","g","VectorTileContainer","m","drawColliders","C","StyleLayerType","T","v","LayerView2DMixin","R","Display","D","H","w","S","Q","getLogger","L","constructor","arguments","_styleChanges","_fetchQueue","_parseQueue","_isTileHandlerReady","fading","hitTest","_tileHandlerPromise","_vectorTileContainer","length","_styleRepository","getStyleLayerByUID","getStyleLayerIndex","id","attributes","layerId","layerName","layerUID","layer","sourceLayer","update","pixelRatio","_tileHandler","devicePixelRatio","_start","_applyStyleChanges","pause","state","_tileManager","requestUpdate","resume","attach","style","currentStyleInfo","_tileInfoView","tileInfo","fullExtent","window","container","addChild","handles","add","on","notifyChange","_collisionBoxesDisplay","requestRender","symbolCollisionBoxesVisible","render","_renderCollisionBoxes","context","removeChild","isDataDriven","push","type","PAINTER_CHANGED","data","getLayerById","SYMBOL","setPaintProperties","paint","restartDeclutter","layout","b","setLayoutProperties","LAYOUT_CHANGED","setStyleLayerVisibility","visibility","LAYER_CHANGED","LAYER_REMOVED","_loadStyle","_newSpriteSource","spriteSource","SPRITES_CHANGED","layers","getLayoutProperty","LINE","getPaintProperty","isPainterDataDriven","FILL","declaredClass","detach","_stop","removeAllChildren","destroy","remove","moveStart","viewChange","moveEnd","supportsSpatialReference","spatialReference","canResume","layerDefinition","view","scale","minScale","maxScale","isUpdating","children","updating","filter","invalidating","acquireTile","_createVectorTile","then","key","once","setData","catch","error","releaseTile","abort","tileInfoView","AbortController","start","signal","process","_getTileData","concurrency","_parseTileData","spriteMosaic","setStyleResources","glyphMosaic","_tileHandlerAbortController","fetchTileData","parseTileData","clear","clearCache","updateStyle","message","forEach","uid","deleteStyleLayer","setStyleLayer","index","setSpriteMosaic","setSpriteSource","deleteStyleLayers","deleteLayerData","styleLayerUIDs","Promise","all","setStyle","aborted","getTileBounds","symbols","Object","keys","Math","max","oldValue","newValue","added","changed","removed","prototype","I","default"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../chunks/tslib.es6.js\";import t from\"../../../Graphic.js\";import{clone as i}from\"../../../core/lang.js\";import s from\"../../../core/Logger.js\";import{isNone as r}from\"../../../core/maybe.js\";import{isAbortError as a}from\"../../../core/promiseUtils.js\";import{watch as l,initial as n}from\"../../../core/reactiveUtils.js\";import{property as o}from\"../../../core/accessorSupport/decorators/property.js\";import\"../../../core/accessorSupport/ensureType.js\";import{subclass as h}from\"../../../core/accessorSupport/decorators/subclass.js\";import{diff as u,hasDiff as y}from\"../../../core/accessorSupport/diffUtils.js\";import{create as c}from\"../../../geometry/support/aaBoundingRect.js\";import{equals as p}from\"../../../geometry/support/spatialReferenceUtils.js\";import{StyleUpdateType as d}from\"../engine/vectorTiles/enums.js\";import{TileHandler as _}from\"../engine/vectorTiles/TileHandler.js\";import{TileManager as f}from\"../engine/vectorTiles/TileManager.js\";import{VectorTile as g}from\"../engine/vectorTiles/VectorTile.js\";import{VectorTileContainer as m}from\"../engine/vectorTiles/VectorTileContainer.js\";import{drawColliders as C}from\"../engine/vectorTiles/decluttering/debugging.js\";import{StyleLayerType as T}from\"../engine/vectorTiles/style/StyleDefinition.js\";import v from\"../engine/vectorTiles/style/StyleRepository.js\";import{LayerView2DMixin as R}from\"./LayerView2D.js\";import{Display as D}from\"./support/Display.js\";import H from\"../tiling/TileInfoViewPOT.js\";import w from\"../tiling/TileQueue.js\";import S from\"../../layers/LayerView.js\";const Q=s.getLogger(\"esri.views.2d.layers.VectorTileLayerView2D\");let L=class extends(R(S)){constructor(){super(...arguments),this._styleChanges=[],this._fetchQueue=null,this._parseQueue=null,this._isTileHandlerReady=!1,this.fading=!1}async hitTest(e,i){if(!this._tileHandlerPromise)return null;await this._tileHandlerPromise;const s=await this._vectorTileContainer.hitTest(i);if(!s||0===s.length)return null;const r=s[0]-1,a=this._styleRepository,l=a.getStyleLayerByUID(r);if(!l)return null;const n=a.getStyleLayerIndex(l.id),o=new t({attributes:{layerId:n,layerName:l.id,layerUID:r}});return o.layer=this.layer,o.sourceLayer=this.layer,[o]}update(e){if(this._tileHandlerPromise&&this._isTileHandlerReady)return e.pixelRatio!==this._tileHandler.devicePixelRatio?(this._start(),void(this._tileHandler.devicePixelRatio=e.pixelRatio)):void(this._styleChanges.length>0?this._tileHandlerPromise=this._applyStyleChanges():(this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.state=e.state,this._parseQueue.state=e.state,this._tileManager.update(e)||this.requestUpdate(),this._parseQueue.resume(),this._fetchQueue.resume()))}attach(){const{style:e}=this.layer.currentStyleInfo;this._styleRepository=new v(e),this._tileInfoView=new H(this.layer.tileInfo,this.layer.fullExtent),this._vectorTileContainer=new m(this._tileInfoView),this._tileHandler=new _(this.layer,this._styleRepository,window.devicePixelRatio||1),this.container.addChild(this._vectorTileContainer),this._start(),this.handles.add([this._vectorTileContainer.on(\"fade-start\",(()=>{this.fading=!0,this.notifyChange(\"updating\"),this.requestUpdate()})),this._vectorTileContainer.on(\"fade-complete\",(()=>{var e;null==(e=this._collisionBoxesDisplay)||e.requestRender(),this.fading=!1,this.notifyChange(\"updating\"),this.requestUpdate()})),l((()=>this.layer.symbolCollisionBoxesVisible),(e=>{e?(this._collisionBoxesDisplay=new D({render:e=>this._renderCollisionBoxes(e.context)}),this.container.addChild(this._collisionBoxesDisplay)):(this.container.removeChild(this._collisionBoxesDisplay),this._collisionBoxesDisplay=null)}),n),this.layer.on(\"paint-change\",(e=>{if(e.isDataDriven)this._styleChanges.push({type:d.PAINTER_CHANGED,data:e}),this.notifyChange(\"updating\"),this.requestUpdate();else{const t=this._styleRepository,i=t.getLayerById(e.layer);if(!i)return;const s=i.type===T.SYMBOL;t.setPaintProperties(e.layer,e.paint),s&&this._vectorTileContainer.restartDeclutter(),this._vectorTileContainer.requestRender()}})),this.layer.on(\"layout-change\",(e=>{const t=this._styleRepository,i=t.getLayerById(e.layer);if(!i)return;const s=u(i.layout,e.layout);if(!r(s)){if(y(s,\"visibility\")&&1===b(s))return t.setLayoutProperties(e.layer,e.layout),i.type===T.SYMBOL&&this._vectorTileContainer.restartDeclutter(),void this._vectorTileContainer.requestRender();this._styleChanges.push({type:d.LAYOUT_CHANGED,data:e}),this.notifyChange(\"updating\"),this.requestUpdate()}})),this.layer.on(\"style-layer-visibility-change\",(e=>{const t=this._styleRepository,i=t.getLayerById(e.layer);i&&(t.setStyleLayerVisibility(e.layer,e.visibility),i.type===T.SYMBOL&&this._vectorTileContainer.restartDeclutter(),this._vectorTileContainer.requestRender())})),this.layer.on(\"style-layer-change\",(e=>{this._styleChanges.push({type:d.LAYER_CHANGED,data:e}),this.notifyChange(\"updating\"),this.requestUpdate()})),this.layer.on(\"delete-style-layer\",(e=>{this._styleChanges.push({type:d.LAYER_REMOVED,data:e}),this.notifyChange(\"updating\"),this.requestUpdate()})),this.layer.on(\"load-style\",(()=>this._loadStyle())),this.layer.on(\"spriteSource-change\",(e=>{this._newSpriteSource=e.spriteSource,this._styleChanges.push({type:d.SPRITES_CHANGED,data:null});const t=this._styleRepository.layers;for(const i of t)switch(i.type){case T.SYMBOL:i.getLayoutProperty(\"icon-image\")&&this._styleChanges.push({type:d.LAYOUT_CHANGED,data:{layer:i.id,layout:i.layout}});break;case T.LINE:i.getPaintProperty(\"line-pattern\")&&this._styleChanges.push({type:d.PAINTER_CHANGED,data:{layer:i.id,paint:i.paint,isDataDriven:i.isPainterDataDriven()}});break;case T.FILL:i.getLayoutProperty(\"fill-pattern\")&&this._styleChanges.push({type:d.PAINTER_CHANGED,data:{layer:i.id,paint:i.paint,isDataDriven:i.isPainterDataDriven()}})}this.notifyChange(\"updating\"),this.requestUpdate()}))],this.declaredClass)}detach(){var e,t;this._stop(),this.container.removeAllChildren(),null==(e=this._vectorTileContainer)||e.destroy(),this._vectorTileContainer=null,null==(t=this._tileHandler)||t.destroy(),this._tileHandler=null,this.handles.remove(this.declaredClass)}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this._collisionBoxesDisplay&&this._vectorTileContainer.restartDeclutter(),this.requestUpdate()}supportsSpatialReference(e){var t;return p(null==(t=this.layer.tileInfo)?void 0:t.spatialReference,e)}canResume(){let e=super.canResume();const{currentStyleInfo:t}=this.layer;if(e&&null!=t&&t.layerDefinition){const i=this.view.scale,{minScale:s,maxScale:r}=t.layerDefinition;t&&t.layerDefinition&&(s&&s<i&&(e=!1),r&&r>i&&(e=!1))}return e}isUpdating(){const e=this._vectorTileContainer.children;return!this._isTileHandlerReady||!this._fetchQueue||!this._parseQueue||this._fetchQueue.updating||this._parseQueue.updating||e.length>0&&e.filter((e=>e.invalidating)).length>0||this.fading}acquireTile(e){const t=this._createVectorTile(e);return this._tileHandlerPromise.then((()=>{this._fetchQueue.push(t.key).then((e=>this._parseQueue.push({key:t.key,data:e}))).then((e=>{t.once(\"attach\",(()=>this.requestUpdate())),t.setData(e),this.requestUpdate(),this.notifyChange(\"updating\")})).catch((e=>{this.notifyChange(\"updating\"),a(e)||Q.error(e)}))})),t}releaseTile(e){const t=e.key.id;this._fetchQueue.abort(t),this._parseQueue.abort(t),this.requestUpdate()}_start(){if(this._stop(),this._tileManager=new f({acquireTile:e=>this.acquireTile(e),releaseTile:e=>this.releaseTile(e),tileInfoView:this._tileInfoView},this._vectorTileContainer),!this.layer.currentStyleInfo)return;const e=new AbortController,t=this._tileHandler.start({signal:e.signal}).then((()=>{this._fetchQueue=new w({tileInfoView:this._tileInfoView,process:(e,t)=>this._getTileData(e,t),concurrency:15}),this._parseQueue=new w({tileInfoView:this._tileInfoView,process:(e,t)=>this._parseTileData(e,t),concurrency:8}),this.requestUpdate(),this._isTileHandlerReady=!0}));this._tileHandler.spriteMosaic.then((e=>{this._vectorTileContainer.setStyleResources(e,this._tileHandler.glyphMosaic,this._styleRepository),this.requestUpdate()})),this._tileHandlerAbortController=e,this._tileHandlerPromise=t}_stop(){if(!this._tileHandlerAbortController||!this._vectorTileContainer)return;const e=this._tileHandlerAbortController;e&&e.abort(),this._tileHandlerPromise=null,this._isTileHandlerReady=!1,this._fetchQueue&&(this._fetchQueue.destroy(),this._fetchQueue=null),this._parseQueue&&(this._parseQueue.destroy(),this._parseQueue=null),this._tileManager&&(this._tileManager.destroy(),this._tileManager=null),this._vectorTileContainer.removeAllChildren()}async _getTileData(e,t){const i=await this._tileHandler.fetchTileData(e,t);return this.notifyChange(\"updating\"),i}async _parseTileData(e,t){return this._tileHandler.parseTileData(e,t)}async _applyStyleChanges(){this._isTileHandlerReady=!1,this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.clear(),this._parseQueue.clear(),this._tileManager.clearCache();const e=this._styleChanges;try{await this._tileHandler.updateStyle(e)}catch(l){Q.error(\"error applying vector-tiles style update\",l.message),this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0}const t=this._styleRepository,i=[];e.forEach((e=>{if(e.type!==d.LAYER_REMOVED)return;const s=e.data,r=t.getLayerById(s.layer);r&&i.push(r.uid)}));const s=[];let r;e.forEach((e=>{const i=e.type,a=e.data;switch(i){case d.PAINTER_CHANGED:t.setPaintProperties(a.layer,a.paint),r=a.layer;break;case d.LAYOUT_CHANGED:t.setLayoutProperties(a.layer,a.layout),r=a.layer;break;case d.LAYER_REMOVED:return void t.deleteStyleLayer(a.layer);case d.LAYER_CHANGED:t.setStyleLayer(a.layer,a.index),r=a.layer.id;break;case d.SPRITES_CHANGED:this._vectorTileContainer.setSpriteMosaic(this._tileHandler.setSpriteSource(this._newSpriteSource)),this._newSpriteSource=null,r=null}const l=t.getLayerById(r);l&&s.push(l.uid)}));const a=this._vectorTileContainer.children;if(i.length>0){this._vectorTileContainer.deleteStyleLayers(i);for(const e of a)e.deleteLayerData(i)}if(this._fetchQueue.resume(),this._parseQueue.resume(),s.length>0){const e=[];for(const t of a){const i=this._fetchQueue.push(t.key).then((e=>this._parseQueue.push({key:t.key,data:e,styleLayerUIDs:s}))).then((e=>t.setData(e)));e.push(i)}await Promise.all(e)}this._styleChanges=[],this._isTileHandlerReady=!0,this.notifyChange(\"updating\"),this.requestUpdate()}async _loadStyle(){const{style:e}=this.layer.currentStyleInfo,t=i(e);this._isTileHandlerReady=!1,this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.clear(),this._parseQueue.clear(),this.notifyChange(\"updating\"),this._styleRepository=new v(t),this._vectorTileContainer.destroy(),this._tileManager.clear(),this._tileHandlerAbortController.abort(),this._tileHandlerAbortController=new AbortController;const{signal:s}=this._tileHandlerAbortController;try{this._tileHandlerPromise=this._tileHandler.setStyle(this._styleRepository,t),await this._tileHandlerPromise}catch(l){if(!a(l))throw l}if(s.aborted)return this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0,this.notifyChange(\"updating\"),void this.requestUpdate();const r=await this._tileHandler.spriteMosaic;this._vectorTileContainer.setStyleResources(r,this._tileHandler.glyphMosaic,this._styleRepository),this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0,this.notifyChange(\"updating\"),this.requestUpdate()}_createVectorTile(e){const t=this._tileInfoView.getTileBounds(c(),e);return new g(e,t[0],t[3],512,512,this._styleRepository)}_renderCollisionBoxes(e){for(const t of this._vectorTileContainer.children)if(t.symbols){const i=[];for(const[e,s]of t.symbols)i.push(...s);C(e,i)}}};function b(e){if(r(e))return 0;switch(e.type){case\"partial\":return Object.keys(e.diff).length;case\"complete\":return Math.max(Object.keys(e.oldValue).length,Object.keys(e.newValue).length);case\"collection\":return Object.keys(e.added).length+Object.keys(e.changed).length+Object.keys(e.removed).length}}e([o()],L.prototype,\"_fetchQueue\",void 0),e([o()],L.prototype,\"_parseQueue\",void 0),e([o()],L.prototype,\"_isTileHandlerReady\",void 0),e([o()],L.prototype,\"fading\",void 0),L=e([h(\"esri.views.2d.layers.VectorTileLayerView2D\")],L);const I=L;export{I as default};\n"]},"metadata":{},"sourceType":"module"}