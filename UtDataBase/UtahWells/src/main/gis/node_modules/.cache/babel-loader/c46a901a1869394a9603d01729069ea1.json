{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport t from \"../../VertexStream.js\";\nimport { BlendFactor as e, TargetType as i, DepthStencilTargetType as s, TextureType as r, PixelFormat as o, PixelType as n, TextureWrapMode as a, TextureSamplingMode as l } from \"../../../../../webgl/enums.js\";\nimport { FramebufferObject as h } from \"../../../../../webgl/FramebufferObject.js\";\nconst u = 5,\n      p = [1, 0],\n      _ = [0, 1],\n      m = [1, .8, .6, .4, .2],\n      d = [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1];\n\nclass c {\n  constructor() {\n    this._intensityFBO = null, this._compositeFBO = null, this._mipsFBOs = new Array(u), this._nMips = u, this._kernelSizeArray = [3, 5, 7, 9, 11], this._size = [0, 0], this._programDesc = {\n      luminosityHighPass: {\n        vsPath: \"post-processing/pp\",\n        fsPath: \"post-processing/bloom/luminosityHighPass\",\n        attributes: new Map([[\"a_position\", 0]])\n      },\n      gaussianBlur: {\n        vsPath: \"post-processing/pp\",\n        fsPath: \"post-processing/bloom/gaussianBlur\",\n        attributes: new Map([[\"a_position\", 0]])\n      },\n      composite: {\n        vsPath: \"post-processing/pp\",\n        fsPath: \"post-processing/bloom/composite\",\n        attributes: new Map([[\"a_position\", 0]])\n      },\n      blit: {\n        vsPath: \"post-processing/pp\",\n        fsPath: \"post-processing/blit\",\n        attributes: new Map([[\"a_position\", 0]])\n      }\n    };\n  }\n\n  dispose() {\n    if (this._quad && (this._quad.dispose(), this._quad = null), this._intensityFBO && (this._intensityFBO.dispose(), this._intensityFBO = null), this._compositeFBO && (this._compositeFBO.dispose(), this._compositeFBO = null), this._mipsFBOs) {\n      for (let t = 0; t < this._nMips; t++) this._mipsFBOs[t] && (this._mipsFBOs[t].horizontal.dispose(), this._mipsFBOs[t].vertical.dispose());\n\n      this._mipsFBOs = null;\n    }\n  }\n\n  draw(i, s, r) {\n    const {\n      width: o,\n      height: n\n    } = s,\n          {\n      context: a,\n      painter: l\n    } = i,\n          {\n      materialManager: h\n    } = l,\n          c = a.gl,\n          T = this._programDesc,\n          {\n      strength: f,\n      radius: g,\n      threshold: B\n    } = r;\n    this._quad || (this._quad = new t(a, [-1, -1, 1, -1, -1, 1, 1, 1])), this._createOrResizeResources(i, o, n), a.setStencilTestEnabled(!1), a.setBlendingEnabled(!0), a.setBlendFunction(e.ONE, e.ONE_MINUS_SRC_ALPHA), a.setStencilWriteMask(0);\n    const O = this._quad;\n    O.bind(), a.bindFramebuffer(this._intensityFBO);\n    const F = h.getProgram(i, T.luminosityHighPass);\n    a.useProgram(F), a.bindTexture(s.colorTexture, 0), F.setUniform1i(\"u_texture\", 0), F.setUniform3fv(\"u_defaultColor\", [0, 0, 0]), F.setUniform1f(\"u_defaultOpacity\", 0), F.setUniform1f(\"u_luminosityThreshold\", B), F.setUniform1f(\"u_smoothWidth\", .01);\n    const b = [Math.round(o / 2), Math.round(n / 2)];\n    a.setViewport(0, 0, b[0], b[1]), a.setClearColor(0, 0, 0, 0), a.clear(c.COLOR_BUFFER_BIT), O.draw(), a.setBlendingEnabled(!1);\n    let E = this._intensityFBO.colorTexture;\n\n    for (let t = 0; t < this._nMips; t++) {\n      const e = h.getProgram(i, T.gaussianBlur, [{\n        name: \"radius\",\n        value: this._kernelSizeArray[t]\n      }]);\n      a.useProgram(e), a.bindTexture(E, t + 1), e.setUniform1i(\"u_colorTexture\", t + 1), e.setUniform2fv(\"u_texSize\", b), e.setUniform2fv(\"u_direction\", p), a.setViewport(0, 0, b[0], b[1]);\n      const s = this._mipsFBOs[t];\n      a.bindFramebuffer(s.horizontal), O.draw(), E = s.horizontal.colorTexture, a.bindFramebuffer(s.vertical), a.bindTexture(E, t + 1), e.setUniform2fv(\"u_direction\", _), O.draw(), E = s.vertical.colorTexture, b[0] = Math.round(b[0] / 2), b[1] = Math.round(b[1] / 2);\n    }\n\n    a.setViewport(0, 0, o, n);\n    const x = h.getProgram(i, T.composite, [{\n      name: \"nummips\",\n      value: u\n    }]);\n    a.bindFramebuffer(this._compositeFBO), a.useProgram(x), x.setUniform1f(\"u_bloomStrength\", f), x.setUniform1f(\"u_bloomRadius\", g), x.setUniform1fv(\"u_bloomFactors\", m), x.setUniform3fv(\"u_bloomTintColors\", d), a.bindTexture(this._mipsFBOs[0].vertical.colorTexture, 1), x.setUniform1i(\"u_blurTexture1\", 1), a.bindTexture(this._mipsFBOs[1].vertical.colorTexture, 2), x.setUniform1i(\"u_blurTexture2\", 2), a.bindTexture(this._mipsFBOs[2].vertical.colorTexture, 3), x.setUniform1i(\"u_blurTexture3\", 3), a.bindTexture(this._mipsFBOs[3].vertical.colorTexture, 4), x.setUniform1i(\"u_blurTexture4\", 4), a.bindTexture(this._mipsFBOs[4].vertical.colorTexture, 5), x.setUniform1i(\"u_blurTexture5\", 5), O.draw(), a.bindFramebuffer(s), a.setBlendingEnabled(!0);\n    const w = h.getProgram(i, T.blit);\n    a.useProgram(w), a.bindTexture(this._compositeFBO.colorTexture, 6), w.setUniform1i(\"u_texture\", 6), a.setBlendFunction(e.ONE, e.ONE), O.draw(), O.unbind(), a.setBlendFunction(e.ONE, e.ONE_MINUS_SRC_ALPHA), a.setStencilTestEnabled(!0);\n  }\n\n  _createOrResizeResources(t, e, u) {\n    const {\n      context: p\n    } = t;\n    if (this._compositeFBO && this._size[0] === e && this._size[1] === u) return;\n    this._size[0] = e, this._size[1] = u;\n    const _ = [Math.round(e / 2), Math.round(u / 2)];\n    this._compositeFBO ? this._compositeFBO.resize(e, u) : this._compositeFBO = new h(p, {\n      colorTarget: i.TEXTURE,\n      depthStencilTarget: s.NONE,\n      width: e,\n      height: u\n    }), this._intensityFBO ? this._intensityFBO.resize(_[0], _[1]) : this._intensityFBO = new h(p, {\n      colorTarget: i.TEXTURE,\n      depthStencilTarget: s.NONE,\n      width: _[0],\n      height: _[1]\n    }, {\n      target: r.TEXTURE_2D,\n      pixelFormat: o.RGBA,\n      internalFormat: o.RGBA,\n      dataType: n.UNSIGNED_BYTE,\n      wrapMode: a.CLAMP_TO_EDGE,\n      samplingMode: l.LINEAR,\n      flipped: !1,\n      width: _[0],\n      height: _[1]\n    });\n\n    for (let m = 0; m < this._nMips; m++) this._mipsFBOs[m] ? (this._mipsFBOs[m].horizontal.resize(_[0], _[1]), this._mipsFBOs[m].vertical.resize(_[0], _[1])) : this._mipsFBOs[m] = {\n      horizontal: new h(p, {\n        colorTarget: i.TEXTURE,\n        depthStencilTarget: s.NONE,\n        width: _[0],\n        height: _[1]\n      }, {\n        target: r.TEXTURE_2D,\n        pixelFormat: o.RGBA,\n        internalFormat: o.RGBA,\n        dataType: n.UNSIGNED_BYTE,\n        wrapMode: a.CLAMP_TO_EDGE,\n        samplingMode: l.LINEAR,\n        flipped: !1,\n        width: _[0],\n        height: _[1]\n      }),\n      vertical: new h(p, {\n        colorTarget: i.TEXTURE,\n        depthStencilTarget: s.NONE,\n        width: _[0],\n        height: _[1]\n      }, {\n        target: r.TEXTURE_2D,\n        pixelFormat: o.RGBA,\n        internalFormat: o.RGBA,\n        dataType: n.UNSIGNED_BYTE,\n        wrapMode: a.CLAMP_TO_EDGE,\n        samplingMode: l.LINEAR,\n        flipped: !1,\n        width: _[0],\n        height: _[1]\n      })\n    }, _[0] = Math.round(_[0] / 2), _[1] = Math.round(_[1] / 2);\n  }\n\n}\n\nexport { c as Bloom };","map":{"version":3,"sources":["D:/Github/CUSP_DataBase/CUSP_DB/src/main/gis/node_modules/@arcgis/core/views/2d/engine/webgl/effects/post-processing/Bloom.js"],"names":["t","BlendFactor","e","TargetType","i","DepthStencilTargetType","s","TextureType","r","PixelFormat","o","PixelType","n","TextureWrapMode","a","TextureSamplingMode","l","FramebufferObject","h","u","p","_","m","d","c","constructor","_intensityFBO","_compositeFBO","_mipsFBOs","Array","_nMips","_kernelSizeArray","_size","_programDesc","luminosityHighPass","vsPath","fsPath","attributes","Map","gaussianBlur","composite","blit","dispose","_quad","horizontal","vertical","draw","width","height","context","painter","materialManager","gl","T","strength","f","radius","g","threshold","B","_createOrResizeResources","setStencilTestEnabled","setBlendingEnabled","setBlendFunction","ONE","ONE_MINUS_SRC_ALPHA","setStencilWriteMask","O","bind","bindFramebuffer","F","getProgram","useProgram","bindTexture","colorTexture","setUniform1i","setUniform3fv","setUniform1f","b","Math","round","setViewport","setClearColor","clear","COLOR_BUFFER_BIT","E","name","value","setUniform2fv","x","setUniform1fv","w","unbind","resize","colorTarget","TEXTURE","depthStencilTarget","NONE","target","TEXTURE_2D","pixelFormat","RGBA","internalFormat","dataType","UNSIGNED_BYTE","wrapMode","CLAMP_TO_EDGE","samplingMode","LINEAR","flipped","Bloom"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport t from\"../../VertexStream.js\";import{BlendFactor as e,TargetType as i,DepthStencilTargetType as s,TextureType as r,PixelFormat as o,PixelType as n,TextureWrapMode as a,TextureSamplingMode as l}from\"../../../../../webgl/enums.js\";import{FramebufferObject as h}from\"../../../../../webgl/FramebufferObject.js\";const u=5,p=[1,0],_=[0,1],m=[1,.8,.6,.4,.2],d=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];class c{constructor(){this._intensityFBO=null,this._compositeFBO=null,this._mipsFBOs=new Array(u),this._nMips=u,this._kernelSizeArray=[3,5,7,9,11],this._size=[0,0],this._programDesc={luminosityHighPass:{vsPath:\"post-processing/pp\",fsPath:\"post-processing/bloom/luminosityHighPass\",attributes:new Map([[\"a_position\",0]])},gaussianBlur:{vsPath:\"post-processing/pp\",fsPath:\"post-processing/bloom/gaussianBlur\",attributes:new Map([[\"a_position\",0]])},composite:{vsPath:\"post-processing/pp\",fsPath:\"post-processing/bloom/composite\",attributes:new Map([[\"a_position\",0]])},blit:{vsPath:\"post-processing/pp\",fsPath:\"post-processing/blit\",attributes:new Map([[\"a_position\",0]])}}}dispose(){if(this._quad&&(this._quad.dispose(),this._quad=null),this._intensityFBO&&(this._intensityFBO.dispose(),this._intensityFBO=null),this._compositeFBO&&(this._compositeFBO.dispose(),this._compositeFBO=null),this._mipsFBOs){for(let t=0;t<this._nMips;t++)this._mipsFBOs[t]&&(this._mipsFBOs[t].horizontal.dispose(),this._mipsFBOs[t].vertical.dispose());this._mipsFBOs=null}}draw(i,s,r){const{width:o,height:n}=s,{context:a,painter:l}=i,{materialManager:h}=l,c=a.gl,T=this._programDesc,{strength:f,radius:g,threshold:B}=r;this._quad||(this._quad=new t(a,[-1,-1,1,-1,-1,1,1,1])),this._createOrResizeResources(i,o,n),a.setStencilTestEnabled(!1),a.setBlendingEnabled(!0),a.setBlendFunction(e.ONE,e.ONE_MINUS_SRC_ALPHA),a.setStencilWriteMask(0);const O=this._quad;O.bind(),a.bindFramebuffer(this._intensityFBO);const F=h.getProgram(i,T.luminosityHighPass);a.useProgram(F),a.bindTexture(s.colorTexture,0),F.setUniform1i(\"u_texture\",0),F.setUniform3fv(\"u_defaultColor\",[0,0,0]),F.setUniform1f(\"u_defaultOpacity\",0),F.setUniform1f(\"u_luminosityThreshold\",B),F.setUniform1f(\"u_smoothWidth\",.01);const b=[Math.round(o/2),Math.round(n/2)];a.setViewport(0,0,b[0],b[1]),a.setClearColor(0,0,0,0),a.clear(c.COLOR_BUFFER_BIT),O.draw(),a.setBlendingEnabled(!1);let E=this._intensityFBO.colorTexture;for(let t=0;t<this._nMips;t++){const e=h.getProgram(i,T.gaussianBlur,[{name:\"radius\",value:this._kernelSizeArray[t]}]);a.useProgram(e),a.bindTexture(E,t+1),e.setUniform1i(\"u_colorTexture\",t+1),e.setUniform2fv(\"u_texSize\",b),e.setUniform2fv(\"u_direction\",p),a.setViewport(0,0,b[0],b[1]);const s=this._mipsFBOs[t];a.bindFramebuffer(s.horizontal),O.draw(),E=s.horizontal.colorTexture,a.bindFramebuffer(s.vertical),a.bindTexture(E,t+1),e.setUniform2fv(\"u_direction\",_),O.draw(),E=s.vertical.colorTexture,b[0]=Math.round(b[0]/2),b[1]=Math.round(b[1]/2)}a.setViewport(0,0,o,n);const x=h.getProgram(i,T.composite,[{name:\"nummips\",value:u}]);a.bindFramebuffer(this._compositeFBO),a.useProgram(x),x.setUniform1f(\"u_bloomStrength\",f),x.setUniform1f(\"u_bloomRadius\",g),x.setUniform1fv(\"u_bloomFactors\",m),x.setUniform3fv(\"u_bloomTintColors\",d),a.bindTexture(this._mipsFBOs[0].vertical.colorTexture,1),x.setUniform1i(\"u_blurTexture1\",1),a.bindTexture(this._mipsFBOs[1].vertical.colorTexture,2),x.setUniform1i(\"u_blurTexture2\",2),a.bindTexture(this._mipsFBOs[2].vertical.colorTexture,3),x.setUniform1i(\"u_blurTexture3\",3),a.bindTexture(this._mipsFBOs[3].vertical.colorTexture,4),x.setUniform1i(\"u_blurTexture4\",4),a.bindTexture(this._mipsFBOs[4].vertical.colorTexture,5),x.setUniform1i(\"u_blurTexture5\",5),O.draw(),a.bindFramebuffer(s),a.setBlendingEnabled(!0);const w=h.getProgram(i,T.blit);a.useProgram(w),a.bindTexture(this._compositeFBO.colorTexture,6),w.setUniform1i(\"u_texture\",6),a.setBlendFunction(e.ONE,e.ONE),O.draw(),O.unbind(),a.setBlendFunction(e.ONE,e.ONE_MINUS_SRC_ALPHA),a.setStencilTestEnabled(!0)}_createOrResizeResources(t,e,u){const{context:p}=t;if(this._compositeFBO&&this._size[0]===e&&this._size[1]===u)return;this._size[0]=e,this._size[1]=u;const _=[Math.round(e/2),Math.round(u/2)];this._compositeFBO?this._compositeFBO.resize(e,u):this._compositeFBO=new h(p,{colorTarget:i.TEXTURE,depthStencilTarget:s.NONE,width:e,height:u}),this._intensityFBO?this._intensityFBO.resize(_[0],_[1]):this._intensityFBO=new h(p,{colorTarget:i.TEXTURE,depthStencilTarget:s.NONE,width:_[0],height:_[1]},{target:r.TEXTURE_2D,pixelFormat:o.RGBA,internalFormat:o.RGBA,dataType:n.UNSIGNED_BYTE,wrapMode:a.CLAMP_TO_EDGE,samplingMode:l.LINEAR,flipped:!1,width:_[0],height:_[1]});for(let m=0;m<this._nMips;m++)this._mipsFBOs[m]?(this._mipsFBOs[m].horizontal.resize(_[0],_[1]),this._mipsFBOs[m].vertical.resize(_[0],_[1])):this._mipsFBOs[m]={horizontal:new h(p,{colorTarget:i.TEXTURE,depthStencilTarget:s.NONE,width:_[0],height:_[1]},{target:r.TEXTURE_2D,pixelFormat:o.RGBA,internalFormat:o.RGBA,dataType:n.UNSIGNED_BYTE,wrapMode:a.CLAMP_TO_EDGE,samplingMode:l.LINEAR,flipped:!1,width:_[0],height:_[1]}),vertical:new h(p,{colorTarget:i.TEXTURE,depthStencilTarget:s.NONE,width:_[0],height:_[1]},{target:r.TEXTURE_2D,pixelFormat:o.RGBA,internalFormat:o.RGBA,dataType:n.UNSIGNED_BYTE,wrapMode:a.CLAMP_TO_EDGE,samplingMode:l.LINEAR,flipped:!1,width:_[0],height:_[1]})},_[0]=Math.round(_[0]/2),_[1]=Math.round(_[1]/2)}}export{c as Bloom};\n"]},"metadata":{},"sourceType":"module"}