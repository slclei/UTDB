{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport e from \"../../Color.js\";\nimport t from \"../../request.js\";\nimport { throwIfAborted as r } from \"../../core/promiseUtils.js\";\nimport { pt2px as a } from \"../../core/screenUtils.js\";\nimport { numericHash as i } from \"../../core/string.js\";\nimport { getJsonType as s, isPolygon as o, isPolyline as n } from \"../../geometry/support/jsonUtils.js\";\nimport { analyzeCIMSymbol as c, analyzeCIMResource as l } from \"./cimAnalyzer.js\";\nimport m from \"./CIMResourceManager.js\";\nimport h from \"./Rasterizer.js\";\nimport { TextRasterizer as f } from \"./TextRasterizer.js\";\nimport { createLabelOverrideFunction as g, evaluateValueOrFunction as u, colorToArray as y } from \"./utils.js\";\nimport { scaleCIMMarker as p } from \"../support/cimSymbolUtils.js\";\nimport { Symbol3DAnchorPosition2D as d } from \"../support/Symbol3DAnchorPosition2D.js\";\nvar M;\n!function (e) {\n  e.Legend = \"legend\", e.Preview = \"preview\";\n}(M || (M = {}));\n\nconst C = (e, t, r) => {\n  if (e && e.targetSize) {\n    let i;\n\n    if (r) {\n      const t = Math.max(r.frame.xmax - r.frame.xmin, r.frame.ymax - r.frame.ymin);\n      i = e.targetSize / a(t);\n    } else i = e.targetSize / t.referenceSize;\n\n    return i;\n  }\n\n  return e && e.scaleFactor ? e.scaleFactor : 1;\n},\n      I = {\n  fill: {\n    legend: {\n      frame: {\n        xmax: 15,\n        xmin: 0,\n        ymax: 15,\n        ymin: 0\n      },\n      geometry: {\n        rings: [[[0, 15], [15, 7.5], [15, 0], [0, 0], [0, 15]]]\n      },\n      canvasPaths: {\n        rings: [[[0, 15], [0, 0], [15, 7.5], [15, 15], [0, 15]]]\n      }\n    },\n    preview: {\n      frame: {\n        xmax: 100,\n        xmin: 0,\n        ymax: 100,\n        ymin: 0\n      },\n      geometry: {\n        rings: [[[0, 100], [100, 100], [100, 0], [0, 0], [0, 100]]]\n      },\n      canvasPaths: {\n        rings: [[[0, 100], [0, 0], [100, 0], [100, 100], [0, 100]]]\n      }\n    }\n  },\n  stroke: {\n    legend: {\n      frame: {\n        xmax: 24,\n        xmin: 0,\n        ymax: 2,\n        ymin: -2\n      },\n      geometry: {\n        paths: [[[0, 0], [12, 0], [24, 0]]]\n      },\n      canvasPaths: {\n        paths: [[[0, 2], [12, 2], [24, 2]]]\n      }\n    },\n    preview: {\n      frame: {\n        xmax: 100,\n        xmin: 0,\n        ymax: 2,\n        ymin: -2\n      },\n      geometry: {\n        paths: [[[0, 0], [50, 0], [100, 0]]]\n      },\n      canvasPaths: {\n        paths: [[[0, 2], [50, 2], [100, 2]]]\n      }\n    }\n  }\n};\n\nclass z {\n  constructor(e, t) {\n    this._spatialReference = e, this._avoidSDF = t, this._resourceCache = new Map(), this._pictureMarkerCache = new Map(), this._textRasterizer = new f(), this._cimResourceManager = new m(), this._rasterizer = new h(this._cimResourceManager);\n  }\n\n  async rasterizeCIMSymbolAsync(e, t, r, a, i, o, n, c) {\n    a = a || (t ? null != t.centroid ? \"esriGeometryPolygon\" : s(t.geometry) : null) || x(e);\n    const l = await this.analyzeCIMSymbol(e, t ? P(t.attributes) : null, r, a, c);\n    return this.rasterizeCIMSymbol(l, t, a, i, o, n);\n  }\n\n  async analyzeCIMSymbol(e, t, a, i, s) {\n    const o = [],\n          n = t ? {\n      geometryType: i,\n      spatialReference: this._spatialReference,\n      fields: t\n    } : null;\n    let l;\n    await c(e.data, n, this._cimResourceManager, o, this._avoidSDF), r(s);\n\n    for (const r of o) \"CIMPictureMarker\" !== r.cim.type && \"CIMPictureFill\" !== r.cim.type && \"CIMPictureStroke\" !== r.cim.type || (l || (l = []), l.push(this._fetchPictureMarkerResource(r, s))), a && \"text\" === r.type && \"string\" == typeof r.text && r.text.indexOf(\"[\") > -1 && (r.text = g(a, r.text, r.cim.textCase));\n\n    return l && (await Promise.all(l)), o;\n  }\n\n  async _fetchPictureMarkerResource(e, r) {\n    const a = e.materialHash;\n\n    if (!this._pictureMarkerCache.get(a)) {\n      const i = (await t(e.cim.url, {\n        responseType: \"image\",\n        signal: r && r.signal\n      })).data;\n\n      this._pictureMarkerCache.set(a, i);\n    }\n  }\n\n  rasterizeCIMSymbol(e, t, r, a, i, s) {\n    const o = [];\n\n    for (const n of e) {\n      a && \"function\" == typeof a.scaleFactor && (a.scaleFactor = a.scaleFactor(t, i, s));\n\n      const e = this._getRasterizedResource(n, t, r, a, i, s);\n\n      if (!e) continue;\n      let c = 0,\n          l = e.anchorX || 0,\n          m = e.anchorY || 0,\n          h = !1,\n          f = 0,\n          g = 0;\n\n      if (\"esriGeometryPoint\" === r) {\n        const e = C(a, n, null);\n        if (f = u(n.offsetX, t, i, s) * e || 0, g = u(n.offsetY, t, i, s) * e || 0, \"marker\" === n.type) c = u(n.rotation, t, i, s) || 0, h = !!n.rotateClockwise && n.rotateClockwise;else if (\"text\" === n.type) {\n          if (c = u(n.angle, t, i, s) || 0, void 0 !== n.horizontalAlignment) switch (n.horizontalAlignment) {\n            case \"left\":\n              l = -.5;\n              break;\n\n            case \"right\":\n              l = .5;\n              break;\n\n            default:\n              l = 0;\n          }\n          if (void 0 !== n.verticalAlignment) switch (n.verticalAlignment) {\n            case \"top\":\n              m = .5;\n              break;\n\n            case \"bottom\":\n              m = -.5;\n              break;\n\n            case \"baseline\":\n              m = -.25;\n              break;\n\n            default:\n              m = 0;\n          }\n        }\n      }\n\n      null != e && o.push({\n        angle: c,\n        rotateClockWise: h,\n        anchorX: l,\n        anchorY: m,\n        offsetX: f,\n        offsetY: g,\n        rasterizedResource: e\n      });\n    }\n\n    return this.getSymbolImage(o);\n  }\n\n  getSymbolImage(e) {\n    const t = document.createElement(\"canvas\"),\n          r = t.getContext(\"2d\");\n    let i = 0,\n        s = 0,\n        o = 0,\n        n = 0;\n    const c = [];\n\n    for (let f = 0; f < e.length; f++) {\n      const t = e[f],\n            l = t.rasterizedResource;\n      if (!l) continue;\n      const m = l.size,\n            h = t.offsetX,\n            g = t.offsetY,\n            u = t.anchorX,\n            y = t.anchorY,\n            p = t.rotateClockWise || !1;\n      let d = t.angle,\n          M = a(h) - m[0] * (.5 + u),\n          C = a(g) - m[1] * (.5 + y),\n          I = M + m[0],\n          z = C + m[1];\n\n      if (d) {\n        p && (d = -d);\n        const e = Math.sin(d * Math.PI / 180),\n              t = Math.cos(d * Math.PI / 180),\n              r = M * t - C * e,\n              a = M * e + C * t,\n              i = M * t - z * e,\n              s = M * e + z * t,\n              o = I * t - z * e,\n              n = I * e + z * t,\n              c = I * t - C * e,\n              l = I * e + C * t;\n        M = Math.min(r, i, o, c), C = Math.min(a, s, n, l), I = Math.max(r, i, o, c), z = Math.max(a, s, n, l);\n      }\n\n      i = M < i ? M : i, s = C < s ? C : s, o = I > o ? I : o, n = z > n ? z : n;\n      const P = r.createImageData(l.size[0], l.size[1]);\n      P.data.set(new Uint8ClampedArray(l.image.buffer));\n      const x = {\n        offsetX: h,\n        offsetY: g,\n        rotateClockwise: p,\n        angle: d,\n        rasterizedImage: P,\n        anchorX: u,\n        anchorY: y\n      };\n      c.push(x);\n    }\n\n    t.width = o - i, t.height = n - s;\n    const l = -i,\n          m = n;\n\n    for (let f = 0; f < c.length; f++) {\n      const e = c[f],\n            t = this._imageDataToCanvas(e.rasterizedImage),\n            i = e.rasterizedImage.width,\n            s = e.rasterizedImage.height,\n            o = l - i * (.5 + e.anchorX),\n            n = m - s * (.5 - e.anchorY);\n\n      if (e.angle) {\n        const i = (360 - e.angle) * Math.PI / 180;\n        r.save(), r.translate(a(e.offsetX), -a(e.offsetY)), r.translate(l, m), r.rotate(i), r.translate(-l, -m), r.drawImage(t, o, n), r.restore();\n      } else r.drawImage(t, o + a(e.offsetX), n - a(e.offsetY));\n    }\n\n    const h = new d({\n      x: l / t.width - .5,\n      y: m / t.height - .5\n    });\n    return {\n      imageData: 0 !== t.width && 0 !== t.height ? r.getImageData(0, 0, t.width, t.height) : r.createImageData(1, 1),\n      anchorPosition: h\n    };\n  }\n\n  _imageDataToCanvas(e) {\n    this._imageDataCanvas || (this._imageDataCanvas = document.createElement(\"canvas\"));\n    const t = this._imageDataCanvas,\n          r = t.getContext(\"2d\");\n    return t.width = e.width, t.height = e.height, r.putImageData(e, 0, 0), t;\n  }\n\n  _imageTo32Array(t, r, a, i) {\n    this._imageDataCanvas || (this._imageDataCanvas = document.createElement(\"canvas\"));\n    const s = this._imageDataCanvas,\n          o = s.getContext(\"2d\");\n\n    if (s.width = r, s.height = a, o.drawImage(t, 0, 0, r, a), i) {\n      o.save();\n      const s = new e(i);\n      o.fillStyle = s.toHex(), o.globalCompositeOperation = \"multiply\", o.fillRect(0, 0, r, a), o.globalCompositeOperation = \"destination-atop\", o.drawImage(t, 0, 0, r, a), o.restore();\n    }\n\n    return new Uint32Array(o.getImageData(0, 0, r, a).data.buffer);\n  }\n\n  _getRasterizedResource(e, t, r, a, s, o) {\n    let n,\n        c,\n        l,\n        m,\n        h = null,\n        f = null;\n\n    if (\"esriGeometryPolyline\" === r || \"esriGeometryPolygon\" === r) {\n      const m = a && a.style ? a.style : M.Legend,\n            g = \"esriGeometryPolyline\" === r ? I.stroke[m] : I.fill[m];\n\n      if (\"line\" === e.type) {\n        if (\"CIMSolidStroke\" !== e.cim.type) {\n          if (\"CIMPictureStroke\" === e.cim.type) {\n            const r = u(e.width, t, s, o),\n                  a = u(e.color, t, s, o),\n                  {\n              image: i,\n              width: n,\n              height: c\n            } = this._getPictureResource(e, r, a);\n\n            return this._rasterizePictureResource(e, i, n, c, g, r);\n          }\n\n          return null;\n        }\n\n        ({\n          analyzedCIM: n,\n          hash: l\n        } = w(e, t, s, o)), c = this._embedCIMLayerInVectorMarker(n, g);\n      } else if (\"marker\" === e.type) {\n        if (\"CIMPictureMarker\" === e.cim.type) {\n          const r = u(e.size, t, s, o),\n                a = u(e.color, t, s, o),\n                {\n            image: i,\n            width: n,\n            height: c\n          } = this._getPictureResource(e, r, a);\n\n          return this._rasterizePictureResource(e, i, n, c, g, r);\n        }\n\n        if (\"CIMVectorMarker\" !== e.cim.type) return null;\n        e.cim.offsetX = u(e.offsetX, t, s, o), e.cim.offsetY = u(e.offsetY, t, s, o), e.cim.rotation = u(e.rotation, t, s, o), e.cim.markerPlacement = e.markerPlacement, ({\n          analyzedCIM: n\n        } = w(e, t, s, o)), l = i(JSON.stringify(n)).toString(), c = this._embedCIMLayerInVectorMarker(n, g), h = u(e.size, t, s, o), f = e.path;\n      } else {\n        if (\"text\" === e.type) return null;\n\n        if (\"fill\" === e.type) {\n          if (\"CIMHatchFill\" === e.cim.type || \"CIMVectorMarker\" === e.cim.type || \"CIMPictureMarker\" === e.cim.type || \"CIMPictureFill\" === e.cim.type) {\n            const r = e.cim.size || e.cim.height;\n            let a, i, c;\n            if (\"CIMPictureMarker\" === e.cim.type || \"CIMPictureFill\" === e.cim.type) ({\n              image: a,\n              width: i,\n              height: c\n            } = this._getPictureResource(e, r, u(e.color, t, s, o)));else {\n              ({\n                analyzedCIM: n,\n                hash: l\n              } = w(e, t, s, o));\n\n              const m = this._rasterizer.rasterizeJSONResource({\n                cim: n,\n                type: e.type,\n                url: e.url,\n                mosaicHash: l,\n                size: r,\n                path: f\n              }, 1, this._avoidSDF);\n\n              a = m.image, i = m.size[0], c = m.size[1];\n            }\n            return this._rasterizePictureResource(e, a, i, c, g, null);\n          }\n\n          if (\"CIMSolidFill\" !== e.cim.type) return null;\n          ({\n            analyzedCIM: n,\n            hash: l\n          } = w(e, t, s, o)), c = this._embedCIMLayerInVectorMarker(n, g);\n        }\n      }\n    } else {\n      if (\"text\" === e.type) return m = this._rasterizeTextResource(e, t, a, s, o), m;\n      ({\n        analyzedCIM: n,\n        hash: l\n      } = w(e, t, s, o));\n      const r = C(a, e, null);\n\n      if (\"CIMPictureMarker\" === e.cim.type) {\n        const a = u(e.size, t, s, o) * r,\n              {\n          image: i,\n          width: n,\n          height: c\n        } = this._getPictureResource(e, a, u(e.color, t, s, o));\n\n        return m = {\n          image: i,\n          size: [n, c],\n          sdf: !1,\n          simplePattern: !1,\n          anchorX: e.anchorPoint ? e.anchorPoint.x : 0,\n          anchorY: e.anchorPoint ? e.anchorPoint.y : 0\n        }, m;\n      }\n\n      p(n, r, {\n        preserveOutlineWidth: !1\n      }), c = n;\n    }\n\n    l += r, a && (l += JSON.stringify(a));\n    const g = this._resourceCache;\n    return g.has(l) ? g.get(l) : (m = this._rasterizer.rasterizeJSONResource({\n      cim: c,\n      type: e.type,\n      url: e.url,\n      mosaicHash: l,\n      size: h,\n      path: f\n    }, window.devicePixelRatio || 1, this._avoidSDF), g.set(l, m), m);\n  }\n\n  _rasterizeTextResource(e, t, r, a, i) {\n    const s = C(r, e, null),\n          o = u(e.text, t, a, i);\n    if (!o || 0 === o.length) return null;\n    const n = u(e.fontName, t, a, i),\n          c = u(e.style, t, a, i),\n          l = u(e.weight, t, a, i),\n          m = u(e.decoration, t, a, i),\n          h = u(e.size, t, a, i) * s,\n          f = u(e.horizontalAlignment, t, a, i),\n          g = u(e.verticalAlignment, t, a, i),\n          p = y(u(e.color, t, a, i)),\n          d = y(u(e.outlineColor, t, a, i)),\n          M = {\n      color: p,\n      size: h,\n      horizontalAlignment: f,\n      verticalAlignment: g,\n      font: {\n        family: n,\n        style: c,\n        weight: l,\n        decoration: m\n      },\n      halo: {\n        size: u(e.outlineSize, t, a, i) || 0,\n        color: d,\n        style: c\n      },\n      pixelRatio: 1,\n      premultiplyColors: !this._avoidSDF\n    };\n    return this._textRasterizer.rasterizeText(o, M);\n  }\n\n  _rasterizePictureResource(e, t, r, i, s, c) {\n    const l = document.createElement(\"canvas\"),\n          m = l.getContext(\"2d\");\n    l.height = a(Math.max(s.frame.ymax - s.frame.ymin, c)), l.width = a(s.frame.xmax - s.frame.xmin);\n    const h = m.createImageData(r, i);\n    h.data.set(new Uint8ClampedArray(t.buffer));\n\n    const f = this._imageDataToCanvas(h),\n          g = m.createPattern(f, \"repeat\"),\n          u = Math.cos((-e.cim.rotation || 0) * Math.PI / 180),\n          y = Math.sin((-e.cim.rotation || 0) * Math.PI / 180);\n\n    g.setTransform({\n      m11: u,\n      m12: y,\n      m21: -y,\n      m22: u,\n      m41: a(e.cim.offsetX) || 0,\n      m42: a(e.cim.offsetY) || 0\n    });\n    const p = s.canvasPaths;\n    let d, M, C;\n    o(p) ? (d = p.rings, m.fillStyle = g, M = m.fill, C = [\"evenodd\"]) : n(p) && (d = p.paths, m.strokeStyle = g, m.lineWidth = c, M = m.stroke, d[0][0][1] = l.height / 2, d[0][1][1] = l.height / 2), m.beginPath();\n\n    for (const o of d) {\n      const e = o ? o.length : 0;\n\n      if (e > 1) {\n        let t = o[0];\n        m.moveTo(a(t[0]), a(t[1]));\n\n        for (let r = 1; r < e; ++r) t = o[r], m.lineTo(a(t[0]), a(t[1]));\n\n        m.closePath();\n      }\n    }\n\n    M.apply(m, C);\n    const I = m.getImageData(0, 0, l.width, l.height),\n          z = new Uint8Array(I.data);\n    return {\n      size: [l.width, l.height],\n      image: new Uint32Array(z.buffer),\n      sdf: !1,\n      simplePattern: !1,\n      anchorX: 0,\n      anchorY: 0\n    };\n  }\n\n  _getPictureResource(e, t, r) {\n    const i = this._pictureMarkerCache.get(e.materialHash);\n\n    if (!i) return null;\n    const s = i.height / i.width,\n          o = t ? s > 1 ? a(t) : a(t) / s : i.width,\n          n = t ? s > 1 ? a(t) * s : a(t) : i.height;\n    return {\n      image: this._imageTo32Array(i, o, n, r),\n      width: o,\n      height: n\n    };\n  }\n\n  _embedCIMLayerInVectorMarker(e, t) {\n    const r = o(t.geometry) ? \"CIMPolygonSymbol\" : \"CIMLineSymbol\",\n          a = t.frame;\n    return {\n      type: \"CIMVectorMarker\",\n      frame: a,\n      size: a.ymax - a.ymin,\n      markerGraphics: [{\n        type: \"CIMMarkerGraphic\",\n        geometry: t.geometry,\n        symbol: {\n          type: r,\n          symbolLayers: [e]\n        }\n      }]\n    };\n  }\n\n}\n\nfunction P(e) {\n  return (e ? Object.keys(e) : []).map(t => ({\n    name: t,\n    alias: t,\n    type: \"string\" == typeof e[t] ? \"esriFieldTypeString\" : \"esriFieldTypeDouble\"\n  }));\n}\n\nfunction x(e) {\n  if (!(e && e.data && e.data.symbol)) return null;\n\n  switch (e.data.symbol.type) {\n    case \"CIMPointSymbol\":\n    case \"CIMTextSymbol\":\n      return \"esriGeometryPoint\";\n\n    case \"CIMLineSymbol\":\n      return \"esriGeometryPolyline\";\n\n    case \"CIMPolygonSymbol\":\n      return \"esriGeometryPolygon\";\n\n    default:\n      return null;\n  }\n}\n\nfunction w(e, t, r, a) {\n  let i, s;\n\n  if (\"function\" == typeof e.materialHash) {\n    i = (0, e.materialHash)(t, r, a), s = l(e.cim, e.materialOverrides);\n  } else i = e.materialHash, s = e.cim;\n\n  return {\n    analyzedCIM: s,\n    hash: i\n  };\n}\n\nexport { z as CIMSymbolRasterizer, M as GeometryStyle };","map":{"version":3,"sources":["D:/Github/CUSP_DataBase/CUSP_DB/src/main/gis/node_modules/@arcgis/core/symbols/cim/CIMSymbolRasterizer.js"],"names":["e","t","throwIfAborted","r","pt2px","a","numericHash","i","getJsonType","s","isPolygon","o","isPolyline","n","analyzeCIMSymbol","c","analyzeCIMResource","l","m","h","TextRasterizer","f","createLabelOverrideFunction","g","evaluateValueOrFunction","u","colorToArray","y","scaleCIMMarker","p","Symbol3DAnchorPosition2D","d","M","Legend","Preview","C","targetSize","Math","max","frame","xmax","xmin","ymax","ymin","referenceSize","scaleFactor","I","fill","legend","geometry","rings","canvasPaths","preview","stroke","paths","z","constructor","_spatialReference","_avoidSDF","_resourceCache","Map","_pictureMarkerCache","_textRasterizer","_cimResourceManager","_rasterizer","rasterizeCIMSymbolAsync","centroid","x","P","attributes","rasterizeCIMSymbol","geometryType","spatialReference","fields","data","cim","type","push","_fetchPictureMarkerResource","text","indexOf","textCase","Promise","all","materialHash","get","url","responseType","signal","set","_getRasterizedResource","anchorX","anchorY","offsetX","offsetY","rotation","rotateClockwise","angle","horizontalAlignment","verticalAlignment","rotateClockWise","rasterizedResource","getSymbolImage","document","createElement","getContext","length","size","sin","PI","cos","min","createImageData","Uint8ClampedArray","image","buffer","rasterizedImage","width","height","_imageDataToCanvas","save","translate","rotate","drawImage","restore","imageData","getImageData","anchorPosition","_imageDataCanvas","putImageData","_imageTo32Array","fillStyle","toHex","globalCompositeOperation","fillRect","Uint32Array","style","color","_getPictureResource","_rasterizePictureResource","analyzedCIM","hash","w","_embedCIMLayerInVectorMarker","markerPlacement","JSON","stringify","toString","path","rasterizeJSONResource","mosaicHash","_rasterizeTextResource","sdf","simplePattern","anchorPoint","preserveOutlineWidth","has","window","devicePixelRatio","fontName","weight","decoration","outlineColor","font","family","halo","outlineSize","pixelRatio","premultiplyColors","rasterizeText","createPattern","setTransform","m11","m12","m21","m22","m41","m42","strokeStyle","lineWidth","beginPath","moveTo","lineTo","closePath","apply","Uint8Array","markerGraphics","symbol","symbolLayers","Object","keys","map","name","alias","materialOverrides","CIMSymbolRasterizer","GeometryStyle"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport e from\"../../Color.js\";import t from\"../../request.js\";import{throwIfAborted as r}from\"../../core/promiseUtils.js\";import{pt2px as a}from\"../../core/screenUtils.js\";import{numericHash as i}from\"../../core/string.js\";import{getJsonType as s,isPolygon as o,isPolyline as n}from\"../../geometry/support/jsonUtils.js\";import{analyzeCIMSymbol as c,analyzeCIMResource as l}from\"./cimAnalyzer.js\";import m from\"./CIMResourceManager.js\";import h from\"./Rasterizer.js\";import{TextRasterizer as f}from\"./TextRasterizer.js\";import{createLabelOverrideFunction as g,evaluateValueOrFunction as u,colorToArray as y}from\"./utils.js\";import{scaleCIMMarker as p}from\"../support/cimSymbolUtils.js\";import{Symbol3DAnchorPosition2D as d}from\"../support/Symbol3DAnchorPosition2D.js\";var M;!function(e){e.Legend=\"legend\",e.Preview=\"preview\"}(M||(M={}));const C=(e,t,r)=>{if(e&&e.targetSize){let i;if(r){const t=Math.max(r.frame.xmax-r.frame.xmin,r.frame.ymax-r.frame.ymin);i=e.targetSize/a(t)}else i=e.targetSize/t.referenceSize;return i}return e&&e.scaleFactor?e.scaleFactor:1},I={fill:{legend:{frame:{xmax:15,xmin:0,ymax:15,ymin:0},geometry:{rings:[[[0,15],[15,7.5],[15,0],[0,0],[0,15]]]},canvasPaths:{rings:[[[0,15],[0,0],[15,7.5],[15,15],[0,15]]]}},preview:{frame:{xmax:100,xmin:0,ymax:100,ymin:0},geometry:{rings:[[[0,100],[100,100],[100,0],[0,0],[0,100]]]},canvasPaths:{rings:[[[0,100],[0,0],[100,0],[100,100],[0,100]]]}}},stroke:{legend:{frame:{xmax:24,xmin:0,ymax:2,ymin:-2},geometry:{paths:[[[0,0],[12,0],[24,0]]]},canvasPaths:{paths:[[[0,2],[12,2],[24,2]]]}},preview:{frame:{xmax:100,xmin:0,ymax:2,ymin:-2},geometry:{paths:[[[0,0],[50,0],[100,0]]]},canvasPaths:{paths:[[[0,2],[50,2],[100,2]]]}}}};class z{constructor(e,t){this._spatialReference=e,this._avoidSDF=t,this._resourceCache=new Map,this._pictureMarkerCache=new Map,this._textRasterizer=new f,this._cimResourceManager=new m,this._rasterizer=new h(this._cimResourceManager)}async rasterizeCIMSymbolAsync(e,t,r,a,i,o,n,c){a=a||(t?null!=t.centroid?\"esriGeometryPolygon\":s(t.geometry):null)||x(e);const l=await this.analyzeCIMSymbol(e,t?P(t.attributes):null,r,a,c);return this.rasterizeCIMSymbol(l,t,a,i,o,n)}async analyzeCIMSymbol(e,t,a,i,s){const o=[],n=t?{geometryType:i,spatialReference:this._spatialReference,fields:t}:null;let l;await c(e.data,n,this._cimResourceManager,o,this._avoidSDF),r(s);for(const r of o)\"CIMPictureMarker\"!==r.cim.type&&\"CIMPictureFill\"!==r.cim.type&&\"CIMPictureStroke\"!==r.cim.type||(l||(l=[]),l.push(this._fetchPictureMarkerResource(r,s))),a&&\"text\"===r.type&&\"string\"==typeof r.text&&r.text.indexOf(\"[\")>-1&&(r.text=g(a,r.text,r.cim.textCase));return l&&await Promise.all(l),o}async _fetchPictureMarkerResource(e,r){const a=e.materialHash;if(!this._pictureMarkerCache.get(a)){const i=(await t(e.cim.url,{responseType:\"image\",signal:r&&r.signal})).data;this._pictureMarkerCache.set(a,i)}}rasterizeCIMSymbol(e,t,r,a,i,s){const o=[];for(const n of e){a&&\"function\"==typeof a.scaleFactor&&(a.scaleFactor=a.scaleFactor(t,i,s));const e=this._getRasterizedResource(n,t,r,a,i,s);if(!e)continue;let c=0,l=e.anchorX||0,m=e.anchorY||0,h=!1,f=0,g=0;if(\"esriGeometryPoint\"===r){const e=C(a,n,null);if(f=u(n.offsetX,t,i,s)*e||0,g=u(n.offsetY,t,i,s)*e||0,\"marker\"===n.type)c=u(n.rotation,t,i,s)||0,h=!!n.rotateClockwise&&n.rotateClockwise;else if(\"text\"===n.type){if(c=u(n.angle,t,i,s)||0,void 0!==n.horizontalAlignment)switch(n.horizontalAlignment){case\"left\":l=-.5;break;case\"right\":l=.5;break;default:l=0}if(void 0!==n.verticalAlignment)switch(n.verticalAlignment){case\"top\":m=.5;break;case\"bottom\":m=-.5;break;case\"baseline\":m=-.25;break;default:m=0}}}null!=e&&o.push({angle:c,rotateClockWise:h,anchorX:l,anchorY:m,offsetX:f,offsetY:g,rasterizedResource:e})}return this.getSymbolImage(o)}getSymbolImage(e){const t=document.createElement(\"canvas\"),r=t.getContext(\"2d\");let i=0,s=0,o=0,n=0;const c=[];for(let f=0;f<e.length;f++){const t=e[f],l=t.rasterizedResource;if(!l)continue;const m=l.size,h=t.offsetX,g=t.offsetY,u=t.anchorX,y=t.anchorY,p=t.rotateClockWise||!1;let d=t.angle,M=a(h)-m[0]*(.5+u),C=a(g)-m[1]*(.5+y),I=M+m[0],z=C+m[1];if(d){p&&(d=-d);const e=Math.sin(d*Math.PI/180),t=Math.cos(d*Math.PI/180),r=M*t-C*e,a=M*e+C*t,i=M*t-z*e,s=M*e+z*t,o=I*t-z*e,n=I*e+z*t,c=I*t-C*e,l=I*e+C*t;M=Math.min(r,i,o,c),C=Math.min(a,s,n,l),I=Math.max(r,i,o,c),z=Math.max(a,s,n,l)}i=M<i?M:i,s=C<s?C:s,o=I>o?I:o,n=z>n?z:n;const P=r.createImageData(l.size[0],l.size[1]);P.data.set(new Uint8ClampedArray(l.image.buffer));const x={offsetX:h,offsetY:g,rotateClockwise:p,angle:d,rasterizedImage:P,anchorX:u,anchorY:y};c.push(x)}t.width=o-i,t.height=n-s;const l=-i,m=n;for(let f=0;f<c.length;f++){const e=c[f],t=this._imageDataToCanvas(e.rasterizedImage),i=e.rasterizedImage.width,s=e.rasterizedImage.height,o=l-i*(.5+e.anchorX),n=m-s*(.5-e.anchorY);if(e.angle){const i=(360-e.angle)*Math.PI/180;r.save(),r.translate(a(e.offsetX),-a(e.offsetY)),r.translate(l,m),r.rotate(i),r.translate(-l,-m),r.drawImage(t,o,n),r.restore()}else r.drawImage(t,o+a(e.offsetX),n-a(e.offsetY))}const h=new d({x:l/t.width-.5,y:m/t.height-.5});return{imageData:0!==t.width&&0!==t.height?r.getImageData(0,0,t.width,t.height):r.createImageData(1,1),anchorPosition:h}}_imageDataToCanvas(e){this._imageDataCanvas||(this._imageDataCanvas=document.createElement(\"canvas\"));const t=this._imageDataCanvas,r=t.getContext(\"2d\");return t.width=e.width,t.height=e.height,r.putImageData(e,0,0),t}_imageTo32Array(t,r,a,i){this._imageDataCanvas||(this._imageDataCanvas=document.createElement(\"canvas\"));const s=this._imageDataCanvas,o=s.getContext(\"2d\");if(s.width=r,s.height=a,o.drawImage(t,0,0,r,a),i){o.save();const s=new e(i);o.fillStyle=s.toHex(),o.globalCompositeOperation=\"multiply\",o.fillRect(0,0,r,a),o.globalCompositeOperation=\"destination-atop\",o.drawImage(t,0,0,r,a),o.restore()}return new Uint32Array(o.getImageData(0,0,r,a).data.buffer)}_getRasterizedResource(e,t,r,a,s,o){let n,c,l,m,h=null,f=null;if(\"esriGeometryPolyline\"===r||\"esriGeometryPolygon\"===r){const m=a&&a.style?a.style:M.Legend,g=\"esriGeometryPolyline\"===r?I.stroke[m]:I.fill[m];if(\"line\"===e.type){if(\"CIMSolidStroke\"!==e.cim.type){if(\"CIMPictureStroke\"===e.cim.type){const r=u(e.width,t,s,o),a=u(e.color,t,s,o),{image:i,width:n,height:c}=this._getPictureResource(e,r,a);return this._rasterizePictureResource(e,i,n,c,g,r)}return null}({analyzedCIM:n,hash:l}=w(e,t,s,o)),c=this._embedCIMLayerInVectorMarker(n,g)}else if(\"marker\"===e.type){if(\"CIMPictureMarker\"===e.cim.type){const r=u(e.size,t,s,o),a=u(e.color,t,s,o),{image:i,width:n,height:c}=this._getPictureResource(e,r,a);return this._rasterizePictureResource(e,i,n,c,g,r)}if(\"CIMVectorMarker\"!==e.cim.type)return null;e.cim.offsetX=u(e.offsetX,t,s,o),e.cim.offsetY=u(e.offsetY,t,s,o),e.cim.rotation=u(e.rotation,t,s,o),e.cim.markerPlacement=e.markerPlacement,({analyzedCIM:n}=w(e,t,s,o)),l=i(JSON.stringify(n)).toString(),c=this._embedCIMLayerInVectorMarker(n,g),h=u(e.size,t,s,o),f=e.path}else{if(\"text\"===e.type)return null;if(\"fill\"===e.type){if(\"CIMHatchFill\"===e.cim.type||\"CIMVectorMarker\"===e.cim.type||\"CIMPictureMarker\"===e.cim.type||\"CIMPictureFill\"===e.cim.type){const r=e.cim.size||e.cim.height;let a,i,c;if(\"CIMPictureMarker\"===e.cim.type||\"CIMPictureFill\"===e.cim.type)({image:a,width:i,height:c}=this._getPictureResource(e,r,u(e.color,t,s,o)));else{({analyzedCIM:n,hash:l}=w(e,t,s,o));const m=this._rasterizer.rasterizeJSONResource({cim:n,type:e.type,url:e.url,mosaicHash:l,size:r,path:f},1,this._avoidSDF);a=m.image,i=m.size[0],c=m.size[1]}return this._rasterizePictureResource(e,a,i,c,g,null)}if(\"CIMSolidFill\"!==e.cim.type)return null;({analyzedCIM:n,hash:l}=w(e,t,s,o)),c=this._embedCIMLayerInVectorMarker(n,g)}}}else{if(\"text\"===e.type)return m=this._rasterizeTextResource(e,t,a,s,o),m;({analyzedCIM:n,hash:l}=w(e,t,s,o));const r=C(a,e,null);if(\"CIMPictureMarker\"===e.cim.type){const a=u(e.size,t,s,o)*r,{image:i,width:n,height:c}=this._getPictureResource(e,a,u(e.color,t,s,o));return m={image:i,size:[n,c],sdf:!1,simplePattern:!1,anchorX:e.anchorPoint?e.anchorPoint.x:0,anchorY:e.anchorPoint?e.anchorPoint.y:0},m}p(n,r,{preserveOutlineWidth:!1}),c=n}l+=r,a&&(l+=JSON.stringify(a));const g=this._resourceCache;return g.has(l)?g.get(l):(m=this._rasterizer.rasterizeJSONResource({cim:c,type:e.type,url:e.url,mosaicHash:l,size:h,path:f},window.devicePixelRatio||1,this._avoidSDF),g.set(l,m),m)}_rasterizeTextResource(e,t,r,a,i){const s=C(r,e,null),o=u(e.text,t,a,i);if(!o||0===o.length)return null;const n=u(e.fontName,t,a,i),c=u(e.style,t,a,i),l=u(e.weight,t,a,i),m=u(e.decoration,t,a,i),h=u(e.size,t,a,i)*s,f=u(e.horizontalAlignment,t,a,i),g=u(e.verticalAlignment,t,a,i),p=y(u(e.color,t,a,i)),d=y(u(e.outlineColor,t,a,i)),M={color:p,size:h,horizontalAlignment:f,verticalAlignment:g,font:{family:n,style:c,weight:l,decoration:m},halo:{size:u(e.outlineSize,t,a,i)||0,color:d,style:c},pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(o,M)}_rasterizePictureResource(e,t,r,i,s,c){const l=document.createElement(\"canvas\"),m=l.getContext(\"2d\");l.height=a(Math.max(s.frame.ymax-s.frame.ymin,c)),l.width=a(s.frame.xmax-s.frame.xmin);const h=m.createImageData(r,i);h.data.set(new Uint8ClampedArray(t.buffer));const f=this._imageDataToCanvas(h),g=m.createPattern(f,\"repeat\"),u=Math.cos((-e.cim.rotation||0)*Math.PI/180),y=Math.sin((-e.cim.rotation||0)*Math.PI/180);g.setTransform({m11:u,m12:y,m21:-y,m22:u,m41:a(e.cim.offsetX)||0,m42:a(e.cim.offsetY)||0});const p=s.canvasPaths;let d,M,C;o(p)?(d=p.rings,m.fillStyle=g,M=m.fill,C=[\"evenodd\"]):n(p)&&(d=p.paths,m.strokeStyle=g,m.lineWidth=c,M=m.stroke,d[0][0][1]=l.height/2,d[0][1][1]=l.height/2),m.beginPath();for(const o of d){const e=o?o.length:0;if(e>1){let t=o[0];m.moveTo(a(t[0]),a(t[1]));for(let r=1;r<e;++r)t=o[r],m.lineTo(a(t[0]),a(t[1]));m.closePath()}}M.apply(m,C);const I=m.getImageData(0,0,l.width,l.height),z=new Uint8Array(I.data);return{size:[l.width,l.height],image:new Uint32Array(z.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}_getPictureResource(e,t,r){const i=this._pictureMarkerCache.get(e.materialHash);if(!i)return null;const s=i.height/i.width,o=t?s>1?a(t):a(t)/s:i.width,n=t?s>1?a(t)*s:a(t):i.height;return{image:this._imageTo32Array(i,o,n,r),width:o,height:n}}_embedCIMLayerInVectorMarker(e,t){const r=o(t.geometry)?\"CIMPolygonSymbol\":\"CIMLineSymbol\",a=t.frame;return{type:\"CIMVectorMarker\",frame:a,size:a.ymax-a.ymin,markerGraphics:[{type:\"CIMMarkerGraphic\",geometry:t.geometry,symbol:{type:r,symbolLayers:[e]}}]}}}function P(e){return(e?Object.keys(e):[]).map((t=>({name:t,alias:t,type:\"string\"==typeof e[t]?\"esriFieldTypeString\":\"esriFieldTypeDouble\"})))}function x(e){if(!(e&&e.data&&e.data.symbol))return null;switch(e.data.symbol.type){case\"CIMPointSymbol\":case\"CIMTextSymbol\":return\"esriGeometryPoint\";case\"CIMLineSymbol\":return\"esriGeometryPolyline\";case\"CIMPolygonSymbol\":return\"esriGeometryPolygon\";default:return null}}function w(e,t,r,a){let i,s;if(\"function\"==typeof e.materialHash){i=(0,e.materialHash)(t,r,a),s=l(e.cim,e.materialOverrides)}else i=e.materialHash,s=e.cim;return{analyzedCIM:s,hash:i}}export{z as CIMSymbolRasterizer,M as GeometryStyle};\n"]},"metadata":{},"sourceType":"module"}