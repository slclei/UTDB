{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../../../chunks/tslib.es6.js\";\nimport { bidiText as t } from \"../../../../../core/BidiText.js\";\nimport \"../../../../../core/Error.js\";\nimport s from \"../../../../../core/has.js\";\nimport r from \"../../../../../core/Logger.js\";\nimport { applySome as i, isNone as a, isSome as o, unwrapOrThrow as n, unwrap as l } from \"../../../../../core/maybe.js\";\nimport { throwIfAborted as c, all as d, isAbortError as f } from \"../../../../../core/promiseUtils.js\";\nimport \"../../../../../core/accessorSupport/ensureType.js\";\nimport \"../../../../../core/arrayUtils.js\";\nimport \"../../../../../core/accessorSupport/set.js\";\nimport { subclass as h } from \"../../../../../core/accessorSupport/decorators/subclass.js\";\nimport { diff as u, hasDiff as m } from \"../../../../../core/accessorSupport/diffUtils.js\";\nimport p from \"../../../../../geometry/SpatialReference.js\";\nimport { isAggregateId as g } from \"../../../engine/webgl/DisplayId.js\";\nimport { MeshData as y } from \"../../../engine/webgl/mesh/MeshData.js\";\nimport { WGLMeshFactory as _ } from \"../../../engine/webgl/mesh/factories/WGLMeshFactory.js\";\nimport { WGLTemplateStore as b } from \"../../../engine/webgl/mesh/templates/WGLTemplateStore.js\";\nimport { createMatcher as S } from \"../../../engine/webgl/util/Matcher.js\";\nimport { codepoints as w } from \"../textUtils.js\";\nimport I from \"./BaseProcessor.js\";\nimport M from \"../support/ResourceManagerProxy.js\";\n\nfunction v(e, t) {\n  return (!e.minScale || e.minScale >= t) && (!e.maxScale || e.maxScale <= t);\n}\n\nfunction x(e) {\n  const t = e.message,\n        s = {\n    message: {\n      data: {},\n      tileKey: t.tileKey,\n      tileKeyOrigin: t.tileKeyOrigin\n    },\n    transferList: new Array()\n  };\n\n  for (const r in t.data) {\n    const e = t.data[r];\n\n    if (s.message.data[r] = null, o(e)) {\n      const t = e.stride,\n            a = e.indices.slice(0),\n            o = e.vertices.slice(0),\n            n = e.records.slice(0),\n            l = {\n        stride: t,\n        indices: a,\n        vertices: o,\n        records: n,\n        metrics: i(e.metrics, e => e.slice(0))\n      };\n      s.transferList.push(a, o, n), s.message.data[r] = l;\n    }\n  }\n\n  return s;\n}\n\nr.getLogger(\"esri.views.2d.layers.features.processors.SymbolProcessor\");\nlet j = class extends I {\n  constructor() {\n    super(...arguments), this.type = \"symbol\", this._matchers = {\n      feature: null,\n      aggregate: null\n    }, this._bufferData = new Map(), this._bufferIds = new Map();\n  }\n\n  initialize() {\n    this.handles.add([this.tileStore.on(\"update\", this.onTileUpdate.bind(this))]), this._resourceManagerProxy = new M(this.remoteClient);\n  }\n\n  destroy() {\n    this._resourceManagerProxy.destroy();\n  }\n\n  get supportsTileUpdates() {\n    return !0;\n  }\n\n  forEachBufferId(e) {\n    this._bufferIds.forEach(t => {\n      t.forEach(e);\n    });\n  }\n\n  async update(e, t) {\n    const r = t.schema.processors[0];\n    if (\"symbol\" !== r.type) return;\n    const i = u(this._schema, r);\n    m(i, \"mesh\") && (s(\"esri-2d-update-debug\") && console.debug(\"Applying Update - Processor:\", i), e.mesh = !0, e.why.mesh.push(\"Symbology changed\"), this._schema = r, this._factory = this._createFactory(r), this._factory.update(r, this.tileStore.tileScheme.tileInfo));\n  }\n\n  onTileMessage(e, t, s, r) {\n    return c(r), this._onTileData(e, t, s, r);\n  }\n\n  onTileClear(e) {\n    const t = {\n      clear: !0\n    };\n    return this._bufferData.delete(e.key.id), this._bufferIds.delete(e.key.id), this.remoteClient.invoke(\"tileRenderer.onTileData\", {\n      tileKey: e.id,\n      data: t\n    });\n  }\n\n  onTileError(e, t, s) {\n    const r = s.signal,\n          i = {\n      tileKey: e.id,\n      error: t\n    };\n    return this.remoteClient.invoke(\"tileRenderer.onTileError\", i, {\n      signal: r\n    });\n  }\n\n  onTileUpdate(e) {\n    for (const t of e.removed) this._bufferData.has(t.key.id) && this._bufferData.delete(t.key.id), this._bufferIds.has(t.key.id) && this._bufferIds.delete(t.key.id);\n\n    for (const t of e.added) this._bufferData.forEach(e => {\n      for (const s of e) s.message.tileKey === t.id && this._updateTileMesh(\"append\", t, x(s), [], !1, !1, null);\n    });\n  }\n\n  _addBufferData(e, t) {\n    this._bufferData.has(e) || this._bufferData.set(e, []), this._bufferData.get(e).push(x(t));\n  }\n\n  _createFactory(e) {\n    const {\n      geometryType: t,\n      objectIdField: s,\n      fields: r\n    } = this.service,\n          a = (e, t) => this.remoteClient.invoke(\"tileRenderer.getMaterialItems\", e, t),\n          o = {\n      geometryType: t,\n      fields: r,\n      spatialReference: p.fromJSON(this.spatialReference)\n    },\n          n = new b(a, this.tileStore.tileScheme.tileInfo),\n          {\n      matcher: l,\n      aggregateMatcher: c\n    } = e.mesh;\n\n    return this._store = n, this._matchers.feature = S(l, n, o, this._resourceManagerProxy), this._matchers.aggregate = i(c, e => S(e, n, o, this._resourceManagerProxy)), new _(t, s, n);\n  }\n\n  async _onTileData(e, t, s, r) {\n    c(r);\n    const {\n      type: i,\n      addOrUpdate: n,\n      remove: l\n    } = t,\n          f = t.end,\n          h = !!this._schema.mesh.sortKey;\n\n    if (!n) {\n      const t = {\n        type: i,\n        addOrUpdate: null,\n        remove: l,\n        clear: !1,\n        end: f,\n        sort: h\n      };\n      return this.remoteClient.invoke(\"tileRenderer.onTileData\", {\n        tileKey: e.id,\n        data: t\n      }, r);\n    }\n\n    const u = this._processFeatures(e, n, s, r);\n\n    try {\n      const s = await u;\n\n      if (a(s)) {\n        const t = {\n          type: i,\n          addOrUpdate: null,\n          remove: l,\n          clear: !1,\n          end: f,\n          sort: h\n        };\n        return this.remoteClient.invoke(\"tileRenderer.onTileData\", {\n          tileKey: e.id,\n          data: t\n        }, r);\n      }\n\n      const n = [];\n\n      for (const t of s) {\n        let s = !1;\n        const r = t.message.bufferIds,\n              i = e.key.id,\n              a = t.message.tileKey;\n\n        if (i !== a && o(r)) {\n          if (!this.tileStore.get(a)) {\n            this._addBufferData(i, t), n.push(t);\n            continue;\n          }\n\n          let e = this._bufferIds.get(a);\n\n          e || (e = new Set(), this._bufferIds.set(a, e));\n          const o = Array.from(r);\n\n          for (const t of o) {\n            if (e.has(t)) {\n              s = !0;\n              break;\n            }\n\n            e.add(t);\n          }\n        }\n\n        s || (this._addBufferData(i, t), n.push(t));\n      }\n\n      await d(n.map(s => {\n        const a = e.key.id === s.message.tileKey,\n              o = a ? t.remove : [],\n              n = a && t.end;\n        return this._updateTileMesh(i, e, s, o, n, t.clear, r.signal);\n      }));\n    } catch (m) {\n      this._handleError(e, m, r);\n    }\n  }\n\n  async _updateTileMesh(e, t, s, r, a, o, n) {\n    const d = e,\n          f = s.message.tileKey,\n          h = !!this._schema.mesh.sortKey;\n    f !== t.key.id && (a = !1);\n    const u = i(s, e => e.message),\n          m = i(s, e => e.transferList) || [],\n          p = {\n      type: d,\n      addOrUpdate: u,\n      remove: r,\n      clear: !1,\n      end: a,\n      sort: h\n    },\n          g = {\n      transferList: l(m) || [],\n      signal: n\n    };\n    return c(g), this.remoteClient.invoke(\"tileRenderer.onTileData\", {\n      tileKey: f,\n      data: p\n    }, g);\n  }\n\n  async _processFeatures(e, t, s, r) {\n    if (a(t) || !t.hasFeatures) return null;\n    const i = {\n      transform: e.transform,\n      hasZ: !1,\n      hasM: !1\n    },\n          o = this._factory,\n          n = {\n      viewingMode: \"\",\n      scale: e.scale\n    },\n          l = await this._matchers.feature,\n          d = await this._matchers.aggregate;\n    c(r);\n\n    const f = this._getLabelInfos(e, t);\n\n    return await o.analyze(t.getCursor(), this._resourceManagerProxy, l, d, i, n), c(r), this._writeFeatureSet(e, t, i, f, o, s);\n  }\n\n  _writeFeatureSet(e, t, s, r, i, a) {\n    const n = t.getSize(),\n          l = new y(e.key.id, {\n      features: n,\n      records: n,\n      metrics: 0\n    }, this._schema.mesh.matcher.stride, a, !0),\n          c = {\n      viewingMode: \"\",\n      scale: e.scale\n    },\n          d = t.getCursor();\n\n    for (; d.next();) try {\n      const t = d.getDisplayId(),\n            a = o(r) ? r.get(t) : null;\n      i.writeCursor(l, d, s, c, e.level, a, this._resourceManagerProxy);\n    } catch (h) {}\n\n    const f = e.tileInfoView.tileInfo.isWrappable;\n    return l.serialize(f);\n  }\n\n  _handleError(e, t, s) {\n    if (!f(t)) {\n      const r = {\n        tileKey: e.id,\n        error: t.message\n      };\n      return this.remoteClient.invoke(\"tileRenderer.onTileError\", r, {\n        signal: s.signal\n      });\n    }\n  }\n\n  _getLabelingSchemaForScale(e) {\n    const t = this._schema.mesh.labels;\n    if (a(t)) return null;\n\n    if (\"subtype\" === t.type) {\n      const s = {\n        type: \"subtype\",\n        classes: {}\n      };\n      let r = !1;\n\n      for (const i in t.classes) {\n        const a = t.classes[i].filter(t => v(t, e.scale));\n        r = r || !!a.length, s.classes[i] = a;\n      }\n\n      return r ? s : null;\n    }\n\n    const s = t.classes.filter(t => v(t, e.scale));\n    return s.length ? {\n      type: \"simple\",\n      classes: s\n    } : null;\n  }\n\n  _getLabels(e, t) {\n    if (\"subtype\" === t.type) {\n      var s;\n      const r = this.service.subtypeField,\n            i = n(r, \"Expected to find subtype Field\"),\n            a = e.readAttribute(i);\n      return null == a ? [] : null != (s = t.classes[a]) ? s : [];\n    }\n\n    return t.classes;\n  }\n\n  _getLabelInfos(e, s) {\n    const r = this._getLabelingSchemaForScale(e);\n\n    if (a(r)) return null;\n    const i = new Map(),\n          o = s.getCursor();\n\n    for (; o.next();) {\n      const e = o.getDisplayId(),\n            s = [],\n            a = g(e),\n            n = a && 1 !== o.readAttribute(\"cluster_count\") ? \"aggregate\" : \"feature\",\n            l = this._getLabels(o, r);\n\n      for (const r of l) {\n        if (r.target !== n) continue;\n        const i = o.getStorage(),\n              l = a && \"feature\" === n ? i.getComputedStringAtIndex(o.readAttribute(\"referenceId\"), r.fieldIndex) : i.getComputedStringAtIndex(e, r.fieldIndex);\n        if (!l) continue;\n        const c = t(l.toString()),\n              d = c[0],\n              f = c[1];\n\n        this._store.getMosaicItem(r.symbol, w(d)).then(e => {\n          s[r.index] = {\n            glyphs: e.glyphMosaicItems,\n            rtl: f,\n            index: r.index\n          };\n        });\n      }\n\n      i.set(e, s);\n    }\n\n    return i;\n  }\n\n};\nj = e([h(\"esri.views.2d.layers.features.processors.SymbolProcessor\")], j);\nconst T = j;\nexport { T as default };","map":{"version":3,"sources":["D:/Github/CUSP_DataBase/CUSP_DB/src/main/gis/node_modules/@arcgis/core/views/2d/layers/features/processors/SymbolProcessor.js"],"names":["_","e","bidiText","t","s","r","applySome","i","isNone","a","isSome","o","unwrapOrThrow","n","unwrap","l","throwIfAborted","c","all","d","isAbortError","f","subclass","h","diff","u","hasDiff","m","p","isAggregateId","g","MeshData","y","WGLMeshFactory","WGLTemplateStore","b","createMatcher","S","codepoints","w","I","M","v","minScale","maxScale","x","message","data","tileKey","tileKeyOrigin","transferList","Array","stride","indices","slice","vertices","records","metrics","push","getLogger","j","constructor","arguments","type","_matchers","feature","aggregate","_bufferData","Map","_bufferIds","initialize","handles","add","tileStore","on","onTileUpdate","bind","_resourceManagerProxy","remoteClient","destroy","supportsTileUpdates","forEachBufferId","forEach","update","schema","processors","_schema","console","debug","mesh","why","_factory","_createFactory","tileScheme","tileInfo","onTileMessage","_onTileData","onTileClear","clear","delete","key","id","invoke","onTileError","signal","error","removed","has","added","_updateTileMesh","_addBufferData","set","get","geometryType","objectIdField","fields","service","spatialReference","fromJSON","matcher","aggregateMatcher","_store","addOrUpdate","remove","end","sortKey","sort","_processFeatures","bufferIds","Set","from","map","_handleError","hasFeatures","transform","hasZ","hasM","viewingMode","scale","_getLabelInfos","analyze","getCursor","_writeFeatureSet","getSize","features","next","getDisplayId","writeCursor","level","tileInfoView","isWrappable","serialize","_getLabelingSchemaForScale","labels","classes","filter","length","_getLabels","subtypeField","readAttribute","target","getStorage","getComputedStringAtIndex","fieldIndex","toString","getMosaicItem","symbol","then","index","glyphs","glyphMosaicItems","rtl","T","default"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../../../chunks/tslib.es6.js\";import{bidiText as t}from\"../../../../../core/BidiText.js\";import\"../../../../../core/Error.js\";import s from\"../../../../../core/has.js\";import r from\"../../../../../core/Logger.js\";import{applySome as i,isNone as a,isSome as o,unwrapOrThrow as n,unwrap as l}from\"../../../../../core/maybe.js\";import{throwIfAborted as c,all as d,isAbortError as f}from\"../../../../../core/promiseUtils.js\";import\"../../../../../core/accessorSupport/ensureType.js\";import\"../../../../../core/arrayUtils.js\";import\"../../../../../core/accessorSupport/set.js\";import{subclass as h}from\"../../../../../core/accessorSupport/decorators/subclass.js\";import{diff as u,hasDiff as m}from\"../../../../../core/accessorSupport/diffUtils.js\";import p from\"../../../../../geometry/SpatialReference.js\";import{isAggregateId as g}from\"../../../engine/webgl/DisplayId.js\";import{MeshData as y}from\"../../../engine/webgl/mesh/MeshData.js\";import{WGLMeshFactory as _}from\"../../../engine/webgl/mesh/factories/WGLMeshFactory.js\";import{WGLTemplateStore as b}from\"../../../engine/webgl/mesh/templates/WGLTemplateStore.js\";import{createMatcher as S}from\"../../../engine/webgl/util/Matcher.js\";import{codepoints as w}from\"../textUtils.js\";import I from\"./BaseProcessor.js\";import M from\"../support/ResourceManagerProxy.js\";function v(e,t){return(!e.minScale||e.minScale>=t)&&(!e.maxScale||e.maxScale<=t)}function x(e){const t=e.message,s={message:{data:{},tileKey:t.tileKey,tileKeyOrigin:t.tileKeyOrigin},transferList:new Array};for(const r in t.data){const e=t.data[r];if(s.message.data[r]=null,o(e)){const t=e.stride,a=e.indices.slice(0),o=e.vertices.slice(0),n=e.records.slice(0),l={stride:t,indices:a,vertices:o,records:n,metrics:i(e.metrics,(e=>e.slice(0)))};s.transferList.push(a,o,n),s.message.data[r]=l}}return s}r.getLogger(\"esri.views.2d.layers.features.processors.SymbolProcessor\");let j=class extends I{constructor(){super(...arguments),this.type=\"symbol\",this._matchers={feature:null,aggregate:null},this._bufferData=new Map,this._bufferIds=new Map}initialize(){this.handles.add([this.tileStore.on(\"update\",this.onTileUpdate.bind(this))]),this._resourceManagerProxy=new M(this.remoteClient)}destroy(){this._resourceManagerProxy.destroy()}get supportsTileUpdates(){return!0}forEachBufferId(e){this._bufferIds.forEach((t=>{t.forEach(e)}))}async update(e,t){const r=t.schema.processors[0];if(\"symbol\"!==r.type)return;const i=u(this._schema,r);m(i,\"mesh\")&&(s(\"esri-2d-update-debug\")&&console.debug(\"Applying Update - Processor:\",i),e.mesh=!0,e.why.mesh.push(\"Symbology changed\"),this._schema=r,this._factory=this._createFactory(r),this._factory.update(r,this.tileStore.tileScheme.tileInfo))}onTileMessage(e,t,s,r){return c(r),this._onTileData(e,t,s,r)}onTileClear(e){const t={clear:!0};return this._bufferData.delete(e.key.id),this._bufferIds.delete(e.key.id),this.remoteClient.invoke(\"tileRenderer.onTileData\",{tileKey:e.id,data:t})}onTileError(e,t,s){const r=s.signal,i={tileKey:e.id,error:t};return this.remoteClient.invoke(\"tileRenderer.onTileError\",i,{signal:r})}onTileUpdate(e){for(const t of e.removed)this._bufferData.has(t.key.id)&&this._bufferData.delete(t.key.id),this._bufferIds.has(t.key.id)&&this._bufferIds.delete(t.key.id);for(const t of e.added)this._bufferData.forEach((e=>{for(const s of e)s.message.tileKey===t.id&&this._updateTileMesh(\"append\",t,x(s),[],!1,!1,null)}))}_addBufferData(e,t){this._bufferData.has(e)||this._bufferData.set(e,[]),this._bufferData.get(e).push(x(t))}_createFactory(e){const{geometryType:t,objectIdField:s,fields:r}=this.service,a=(e,t)=>this.remoteClient.invoke(\"tileRenderer.getMaterialItems\",e,t),o={geometryType:t,fields:r,spatialReference:p.fromJSON(this.spatialReference)},n=new b(a,this.tileStore.tileScheme.tileInfo),{matcher:l,aggregateMatcher:c}=e.mesh;return this._store=n,this._matchers.feature=S(l,n,o,this._resourceManagerProxy),this._matchers.aggregate=i(c,(e=>S(e,n,o,this._resourceManagerProxy))),new _(t,s,n)}async _onTileData(e,t,s,r){c(r);const{type:i,addOrUpdate:n,remove:l}=t,f=t.end,h=!!this._schema.mesh.sortKey;if(!n){const t={type:i,addOrUpdate:null,remove:l,clear:!1,end:f,sort:h};return this.remoteClient.invoke(\"tileRenderer.onTileData\",{tileKey:e.id,data:t},r)}const u=this._processFeatures(e,n,s,r);try{const s=await u;if(a(s)){const t={type:i,addOrUpdate:null,remove:l,clear:!1,end:f,sort:h};return this.remoteClient.invoke(\"tileRenderer.onTileData\",{tileKey:e.id,data:t},r)}const n=[];for(const t of s){let s=!1;const r=t.message.bufferIds,i=e.key.id,a=t.message.tileKey;if(i!==a&&o(r)){if(!this.tileStore.get(a)){this._addBufferData(i,t),n.push(t);continue}let e=this._bufferIds.get(a);e||(e=new Set,this._bufferIds.set(a,e));const o=Array.from(r);for(const t of o){if(e.has(t)){s=!0;break}e.add(t)}}s||(this._addBufferData(i,t),n.push(t))}await d(n.map((s=>{const a=e.key.id===s.message.tileKey,o=a?t.remove:[],n=a&&t.end;return this._updateTileMesh(i,e,s,o,n,t.clear,r.signal)})))}catch(m){this._handleError(e,m,r)}}async _updateTileMesh(e,t,s,r,a,o,n){const d=e,f=s.message.tileKey,h=!!this._schema.mesh.sortKey;f!==t.key.id&&(a=!1);const u=i(s,(e=>e.message)),m=i(s,(e=>e.transferList))||[],p={type:d,addOrUpdate:u,remove:r,clear:!1,end:a,sort:h},g={transferList:l(m)||[],signal:n};return c(g),this.remoteClient.invoke(\"tileRenderer.onTileData\",{tileKey:f,data:p},g)}async _processFeatures(e,t,s,r){if(a(t)||!t.hasFeatures)return null;const i={transform:e.transform,hasZ:!1,hasM:!1},o=this._factory,n={viewingMode:\"\",scale:e.scale},l=await this._matchers.feature,d=await this._matchers.aggregate;c(r);const f=this._getLabelInfos(e,t);return await o.analyze(t.getCursor(),this._resourceManagerProxy,l,d,i,n),c(r),this._writeFeatureSet(e,t,i,f,o,s)}_writeFeatureSet(e,t,s,r,i,a){const n=t.getSize(),l=new y(e.key.id,{features:n,records:n,metrics:0},this._schema.mesh.matcher.stride,a,!0),c={viewingMode:\"\",scale:e.scale},d=t.getCursor();for(;d.next();)try{const t=d.getDisplayId(),a=o(r)?r.get(t):null;i.writeCursor(l,d,s,c,e.level,a,this._resourceManagerProxy)}catch(h){}const f=e.tileInfoView.tileInfo.isWrappable;return l.serialize(f)}_handleError(e,t,s){if(!f(t)){const r={tileKey:e.id,error:t.message};return this.remoteClient.invoke(\"tileRenderer.onTileError\",r,{signal:s.signal})}}_getLabelingSchemaForScale(e){const t=this._schema.mesh.labels;if(a(t))return null;if(\"subtype\"===t.type){const s={type:\"subtype\",classes:{}};let r=!1;for(const i in t.classes){const a=t.classes[i].filter((t=>v(t,e.scale)));r=r||!!a.length,s.classes[i]=a}return r?s:null}const s=t.classes.filter((t=>v(t,e.scale)));return s.length?{type:\"simple\",classes:s}:null}_getLabels(e,t){if(\"subtype\"===t.type){var s;const r=this.service.subtypeField,i=n(r,\"Expected to find subtype Field\"),a=e.readAttribute(i);return null==a?[]:null!=(s=t.classes[a])?s:[]}return t.classes}_getLabelInfos(e,s){const r=this._getLabelingSchemaForScale(e);if(a(r))return null;const i=new Map,o=s.getCursor();for(;o.next();){const e=o.getDisplayId(),s=[],a=g(e),n=a&&1!==o.readAttribute(\"cluster_count\")?\"aggregate\":\"feature\",l=this._getLabels(o,r);for(const r of l){if(r.target!==n)continue;const i=o.getStorage(),l=a&&\"feature\"===n?i.getComputedStringAtIndex(o.readAttribute(\"referenceId\"),r.fieldIndex):i.getComputedStringAtIndex(e,r.fieldIndex);if(!l)continue;const c=t(l.toString()),d=c[0],f=c[1];this._store.getMosaicItem(r.symbol,w(d)).then((e=>{s[r.index]={glyphs:e.glyphMosaicItems,rtl:f,index:r.index}}))}i.set(e,s)}return i}};j=e([h(\"esri.views.2d.layers.features.processors.SymbolProcessor\")],j);const T=j;export{T as default};\n"]},"metadata":{},"sourceType":"module"}