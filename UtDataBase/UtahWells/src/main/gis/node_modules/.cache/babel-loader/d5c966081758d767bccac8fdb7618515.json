{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport { isSome as e, isNone as t } from \"../../../../../core/maybe.js\";\nimport { pt2px as i } from \"../../../../../core/screenUtils.js\";\nimport { FILTER_FLAG_0 as o, EFFECT_FLAG_0 as r } from \"../definitions.js\";\nimport { CollisionBitsetGrid as n, NONE as s, HAS_COLLISION as a, OUTSIDE_EXTENT as l } from \"./CollisionGrid.js\";\nimport { getSizeForValueSimple as d } from \"./visualVariableSimpleUtils.js\";\nconst c = 254,\n      u = 255,\n      f = 0;\n\nfunction b(t, i) {\n  const o = [];\n  t.forEachTile(e => o.push(e)), o.sort((e, t) => e.instanceId - t.instanceId), o.forEach(t => {\n    e(t.labelMetrics) && t.isReady && i(t, t.labelMetrics.getCursor());\n  });\n}\n\nfunction p(e) {\n  return \"feature\" === e.layer.type || \"csv\" === e.layer.type || \"geojson\" === e.layer.type || \"ogc-feature\" === e.layer.type || \"stream\" === e.layer.type || \"subtype-group\" === e.layer.type || \"wfs\" === e.layer.type;\n}\n\nfunction y(e) {\n  return t => i(d(t, e));\n}\n\nfunction m(e) {\n  const t = \"visualVariables\" in e && e.visualVariables;\n  if (!t) return null;\n\n  for (const i of t) if (\"size\" === i.type) return y(i);\n\n  return null;\n}\n\nfunction h(e) {\n  for (const i of e) {\n    var t;\n    const e = \"featureReduction\" in i && \"cluster\" === (null == (t = i.featureReduction) ? void 0 : t.type) && i.featureReduction,\n          o = [...(i.labelingInfo || []), ...(e.labelingInfo || [])];\n    if (!i.labelsVisible || !o.length) continue;\n    if (o.some(e => \"none\" === e.deconflictionStrategy)) return !0;\n  }\n\n  return !1;\n}\n\nfunction M(e, i) {\n  if (!p(i)) return;\n  const o = \"subtype-group\" === i.layer.type ? i.layer.sublayers.items : [i.layer],\n        r = i.layer.geometryType,\n        n = !h(o),\n        s = {};\n\n  if (\"subtype-group\" !== i.layer.type) {\n    if (\"heatmap\" === i.layer.renderer.type) return;\n    const e = m(i.layer.renderer);\n    s[0] = e;\n  }\n\n  const a = i.tileRenderer;\n  if (t(a)) return;\n  const l = i.layer.visible && !i.suspended;\n  e.push({\n    tileRenderer: a,\n    vvEvaluators: s,\n    deconflictionEnabled: n,\n    geometryType: r,\n    visible: l\n  });\n}\n\nclass g {\n  run(e, t, i) {\n    const o = [];\n\n    for (let r = e.length - 1; r >= 0; r--) {\n      M(o, e[r]);\n    }\n\n    this._transformMetrics(o, t), this._runCollision(o, t, i);\n  }\n\n  _runCollision(e, t, i) {\n    const [o, r] = t.state.size,\n          s = new n(o * t.pixelRatio, r * t.pixelRatio);\n\n    for (const {\n      tileRenderer: n,\n      deconflictionEnabled: a,\n      visible: l\n    } of e) {\n      const e = n.featuresView.attributeView;\n      a ? l ? (this._prepare(n), this._collideVisible(s, n, i), this._collideInvisible(s, n)) : b(n, (t, i) => {\n        for (; i.nextId();) e.setLabelMinZoom(i.id, u);\n      }) : b(n, (t, i) => {\n        for (; i.nextId();) e.setLabelMinZoom(i.id, f);\n      });\n    }\n  }\n\n  _isFiltered(t, i, n) {\n    const s = i.getFilterFlags(t),\n          a = !n.hasFilter || !!(s & o),\n          l = !e(n.featureEffect) || n.featureEffect.excludedLabelsVisible || !!(s & r);\n    return !(a && l);\n  }\n\n  _prepare(e) {\n    const t = e.featuresView.attributeView,\n          i = new Set();\n    b(e, (o, r) => {\n      for (; r.nextId();) {\n        if (i.has(r.id)) continue;\n\n        if (i.add(r.id), this._isFiltered(r.id, t, e.layerView)) {\n          t.setLabelMinZoom(r.id, c);\n          continue;\n        }\n\n        t.getLabelMinZoom(r.id) !== f ? t.setLabelMinZoom(r.id, u) : t.setLabelMinZoom(r.id, f);\n      }\n    });\n  }\n\n  _collideVisible(e, t, i) {\n    const o = t.featuresView.attributeView,\n          r = new Set();\n    b(t, (t, n) => {\n      for (; n.nextId();) if (!r.has(n.id)) if (t.key.level === i) {\n        if (0 === o.getLabelMinZoom(n.id)) {\n          switch (e.insertMetrics(n)) {\n            case l:\n              break;\n\n            case a:\n              o.setLabelMinZoom(n.id, c), r.add(n.id);\n              break;\n\n            case s:\n              o.setLabelMinZoom(n.id, f), r.add(n.id);\n          }\n        }\n      } else o.setLabelMinZoom(n.id, c);\n    });\n  }\n\n  _collideInvisible(e, t) {\n    const i = t.featuresView.attributeView,\n          o = new Set();\n    b(t, (t, r) => {\n      for (; r.nextId();) if (!o.has(r.id) && i.getLabelMinZoom(r.id) === u) {\n        switch (e.insertMetrics(r)) {\n          case l:\n            break;\n\n          case a:\n            i.setLabelMinZoom(r.id, u), o.add(r.id);\n            break;\n\n          case s:\n            i.setLabelMinZoom(r.id, f), o.add(r.id);\n        }\n      }\n    });\n  }\n\n  _transformMetrics(t, i) {\n    for (const {\n      tileRenderer: o,\n      geometryType: r,\n      vvEvaluators: n\n    } of t) b(o, (t, s) => {\n      const a = o.featuresView.attributeView,\n            l = t.transforms.labelMat2d;\n      l[4] = Math.round(l[4]), l[5] = Math.round(l[5]);\n      const d = l[4],\n            c = l[5],\n            u = \"polyline\" === r;\n\n      for (; s.next();) {\n        const t = s.boundsCount,\n              o = s.anchorX,\n              r = s.anchorY;\n        let f = s.size;\n        const b = n[0];\n\n        if (e(b)) {\n          const e = b(a.getVVSize(s.id));\n          f = isNaN(e) || null == e || e === 1 / 0 ? f : e;\n        }\n\n        const p = s.directionX * (f / 2),\n              y = s.directionY * (f / 2);\n\n        for (let e = 0; e < t; e++) {\n          let t = o,\n              n = s.anchorY;\n\n          if (u) {\n            let o = t + s.boundsX(e) + p,\n                r = n + s.boundsY(e) + y;\n            i.state.rotation ? (o = l[0] * o + l[2] * r + l[4], r = l[1] * o + l[3] * r + l[5]) : (o += d, r += c), s.setBoundsComputedAnchorX(e, Math.floor(o)), s.setBoundsComputedAnchorY(e, Math.floor(r));\n          } else {\n            i.state.rotation ? (t = l[0] * o + l[2] * r + l[4], n = l[1] * o + l[3] * r + l[5]) : (t += d, n += c);\n            const a = t + s.boundsX(e) + p,\n                  u = n + s.boundsY(e) + y;\n            s.setBoundsComputedAnchorX(e, a), s.setBoundsComputedAnchorY(e, u);\n          }\n        }\n      }\n    });\n  }\n\n}\n\nexport { g as CollisionEngine };","map":{"version":3,"sources":["D:/Github/CUSP_DataBase/CUSP_DB/src/main/gis/node_modules/@arcgis/core/views/2d/engine/webgl/collisions/CollisionEngine.js"],"names":["isSome","e","isNone","t","pt2px","i","FILTER_FLAG_0","o","EFFECT_FLAG_0","r","CollisionBitsetGrid","n","NONE","s","HAS_COLLISION","a","OUTSIDE_EXTENT","l","getSizeForValueSimple","d","c","u","f","b","forEachTile","push","sort","instanceId","forEach","labelMetrics","isReady","getCursor","p","layer","type","y","m","visualVariables","h","featureReduction","labelingInfo","labelsVisible","length","some","deconflictionStrategy","M","sublayers","items","geometryType","renderer","tileRenderer","visible","suspended","vvEvaluators","deconflictionEnabled","g","run","_transformMetrics","_runCollision","state","size","pixelRatio","featuresView","attributeView","_prepare","_collideVisible","_collideInvisible","nextId","setLabelMinZoom","id","_isFiltered","getFilterFlags","hasFilter","featureEffect","excludedLabelsVisible","Set","has","add","layerView","getLabelMinZoom","key","level","insertMetrics","transforms","labelMat2d","Math","round","next","boundsCount","anchorX","anchorY","getVVSize","isNaN","directionX","directionY","boundsX","boundsY","rotation","setBoundsComputedAnchorX","floor","setBoundsComputedAnchorY","CollisionEngine"],"mappings":"AAAA;AACA;AACA;AACA;AACA,SAAOA,MAAM,IAAIC,CAAjB,EAAmBC,MAAM,IAAIC,CAA7B,QAAmC,8BAAnC;AAAkE,SAAOC,KAAK,IAAIC,CAAhB,QAAsB,oCAAtB;AAA2D,SAAOC,aAAa,IAAIC,CAAxB,EAA0BC,aAAa,IAAIC,CAA3C,QAAiD,mBAAjD;AAAqE,SAAOC,mBAAmB,IAAIC,CAA9B,EAAgCC,IAAI,IAAIC,CAAxC,EAA0CC,aAAa,IAAIC,CAA3D,EAA6DC,cAAc,IAAIC,CAA/E,QAAqF,oBAArF;AAA0G,SAAOC,qBAAqB,IAAIC,CAAhC,QAAsC,gCAAtC;AAAuE,MAAMC,CAAC,GAAC,GAAR;AAAA,MAAYC,CAAC,GAAC,GAAd;AAAA,MAAkBC,CAAC,GAAC,CAApB;;AAAsB,SAASC,CAAT,CAAWpB,CAAX,EAAaE,CAAb,EAAe;AAAC,QAAME,CAAC,GAAC,EAAR;AAAWJ,EAAAA,CAAC,CAACqB,WAAF,CAAevB,CAAC,IAAEM,CAAC,CAACkB,IAAF,CAAOxB,CAAP,CAAlB,GAA8BM,CAAC,CAACmB,IAAF,CAAQ,CAACzB,CAAD,EAAGE,CAAH,KAAOF,CAAC,CAAC0B,UAAF,GAAaxB,CAAC,CAACwB,UAA9B,CAA9B,EAAyEpB,CAAC,CAACqB,OAAF,CAAWzB,CAAC,IAAE;AAACF,IAAAA,CAAC,CAACE,CAAC,CAAC0B,YAAH,CAAD,IAAmB1B,CAAC,CAAC2B,OAArB,IAA8BzB,CAAC,CAACF,CAAD,EAAGA,CAAC,CAAC0B,YAAF,CAAeE,SAAf,EAAH,CAA/B;AAA8D,GAA7E,CAAzE;AAAyJ;;AAAA,SAASC,CAAT,CAAW/B,CAAX,EAAa;AAAC,SAAM,cAAYA,CAAC,CAACgC,KAAF,CAAQC,IAApB,IAA0B,UAAQjC,CAAC,CAACgC,KAAF,CAAQC,IAA1C,IAAgD,cAAYjC,CAAC,CAACgC,KAAF,CAAQC,IAApE,IAA0E,kBAAgBjC,CAAC,CAACgC,KAAF,CAAQC,IAAlG,IAAwG,aAAWjC,CAAC,CAACgC,KAAF,CAAQC,IAA3H,IAAiI,oBAAkBjC,CAAC,CAACgC,KAAF,CAAQC,IAA3J,IAAiK,UAAQjC,CAAC,CAACgC,KAAF,CAAQC,IAAvL;AAA4L;;AAAA,SAASC,CAAT,CAAWlC,CAAX,EAAa;AAAC,SAAOE,CAAC,IAAEE,CAAC,CAACc,CAAC,CAAChB,CAAD,EAAGF,CAAH,CAAF,CAAX;AAAoB;;AAAA,SAASmC,CAAT,CAAWnC,CAAX,EAAa;AAAC,QAAME,CAAC,GAAC,qBAAoBF,CAApB,IAAuBA,CAAC,CAACoC,eAAjC;AAAiD,MAAG,CAAClC,CAAJ,EAAM,OAAO,IAAP;;AAAY,OAAI,MAAME,CAAV,IAAeF,CAAf,EAAiB,IAAG,WAASE,CAAC,CAAC6B,IAAd,EAAmB,OAAOC,CAAC,CAAC9B,CAAD,CAAR;;AAAY,SAAO,IAAP;AAAY;;AAAA,SAASiC,CAAT,CAAWrC,CAAX,EAAa;AAAC,OAAI,MAAMI,CAAV,IAAeJ,CAAf,EAAiB;AAAC,QAAIE,CAAJ;AAAM,UAAMF,CAAC,GAAC,sBAAqBI,CAArB,IAAwB,eAAa,SAAOF,CAAC,GAACE,CAAC,CAACkC,gBAAX,IAA6B,KAAK,CAAlC,GAAoCpC,CAAC,CAAC+B,IAAnD,CAAxB,IAAkF7B,CAAC,CAACkC,gBAA5F;AAAA,UAA6GhC,CAAC,GAAC,CAAC,IAAGF,CAAC,CAACmC,YAAF,IAAgB,EAAnB,CAAD,EAAuB,IAAGvC,CAAC,CAACuC,YAAF,IAAgB,EAAnB,CAAvB,CAA/G;AAA6J,QAAG,CAACnC,CAAC,CAACoC,aAAH,IAAkB,CAAClC,CAAC,CAACmC,MAAxB,EAA+B;AAAS,QAAGnC,CAAC,CAACoC,IAAF,CAAQ1C,CAAC,IAAE,WAASA,CAAC,CAAC2C,qBAAtB,CAAH,EAAiD,OAAM,CAAC,CAAP;AAAS;;AAAA,SAAM,CAAC,CAAP;AAAS;;AAAA,SAASC,CAAT,CAAW5C,CAAX,EAAaI,CAAb,EAAe;AAAC,MAAG,CAAC2B,CAAC,CAAC3B,CAAD,CAAL,EAAS;AAAO,QAAME,CAAC,GAAC,oBAAkBF,CAAC,CAAC4B,KAAF,CAAQC,IAA1B,GAA+B7B,CAAC,CAAC4B,KAAF,CAAQa,SAAR,CAAkBC,KAAjD,GAAuD,CAAC1C,CAAC,CAAC4B,KAAH,CAA/D;AAAA,QAAyExB,CAAC,GAACJ,CAAC,CAAC4B,KAAF,CAAQe,YAAnF;AAAA,QAAgGrC,CAAC,GAAC,CAAC2B,CAAC,CAAC/B,CAAD,CAApG;AAAA,QAAwGM,CAAC,GAAC,EAA1G;;AAA6G,MAAG,oBAAkBR,CAAC,CAAC4B,KAAF,CAAQC,IAA7B,EAAkC;AAAC,QAAG,cAAY7B,CAAC,CAAC4B,KAAF,CAAQgB,QAAR,CAAiBf,IAAhC,EAAqC;AAAO,UAAMjC,CAAC,GAACmC,CAAC,CAAC/B,CAAC,CAAC4B,KAAF,CAAQgB,QAAT,CAAT;AAA4BpC,IAAAA,CAAC,CAAC,CAAD,CAAD,GAAKZ,CAAL;AAAO;;AAAA,QAAMc,CAAC,GAACV,CAAC,CAAC6C,YAAV;AAAuB,MAAG/C,CAAC,CAACY,CAAD,CAAJ,EAAQ;AAAO,QAAME,CAAC,GAACZ,CAAC,CAAC4B,KAAF,CAAQkB,OAAR,IAAiB,CAAC9C,CAAC,CAAC+C,SAA5B;AAAsCnD,EAAAA,CAAC,CAACwB,IAAF,CAAO;AAACyB,IAAAA,YAAY,EAACnC,CAAd;AAAgBsC,IAAAA,YAAY,EAACxC,CAA7B;AAA+ByC,IAAAA,oBAAoB,EAAC3C,CAApD;AAAsDqC,IAAAA,YAAY,EAACvC,CAAnE;AAAqE0C,IAAAA,OAAO,EAAClC;AAA7E,GAAP;AAAwF;;AAAA,MAAMsC,CAAN,CAAO;AAACC,EAAAA,GAAG,CAACvD,CAAD,EAAGE,CAAH,EAAKE,CAAL,EAAO;AAAC,UAAME,CAAC,GAAC,EAAR;;AAAW,SAAI,IAAIE,CAAC,GAACR,CAAC,CAACyC,MAAF,GAAS,CAAnB,EAAqBjC,CAAC,IAAE,CAAxB,EAA0BA,CAAC,EAA3B,EAA8B;AAACoC,MAAAA,CAAC,CAACtC,CAAD,EAAGN,CAAC,CAACQ,CAAD,CAAJ,CAAD;AAAU;;AAAA,SAAKgD,iBAAL,CAAuBlD,CAAvB,EAAyBJ,CAAzB,GAA4B,KAAKuD,aAAL,CAAmBnD,CAAnB,EAAqBJ,CAArB,EAAuBE,CAAvB,CAA5B;AAAsD;;AAAAqD,EAAAA,aAAa,CAACzD,CAAD,EAAGE,CAAH,EAAKE,CAAL,EAAO;AAAC,UAAK,CAACE,CAAD,EAAGE,CAAH,IAAMN,CAAC,CAACwD,KAAF,CAAQC,IAAnB;AAAA,UAAwB/C,CAAC,GAAC,IAAIF,CAAJ,CAAMJ,CAAC,GAACJ,CAAC,CAAC0D,UAAV,EAAqBpD,CAAC,GAACN,CAAC,CAAC0D,UAAzB,CAA1B;;AAA+D,SAAI,MAAK;AAACX,MAAAA,YAAY,EAACvC,CAAd;AAAgB2C,MAAAA,oBAAoB,EAACvC,CAArC;AAAuCoC,MAAAA,OAAO,EAAClC;AAA/C,KAAT,IAA6DhB,CAA7D,EAA+D;AAAC,YAAMA,CAAC,GAACU,CAAC,CAACmD,YAAF,CAAeC,aAAvB;AAAqChD,MAAAA,CAAC,GAACE,CAAC,IAAE,KAAK+C,QAAL,CAAcrD,CAAd,GAAiB,KAAKsD,eAAL,CAAqBpD,CAArB,EAAuBF,CAAvB,EAAyBN,CAAzB,CAAjB,EAA6C,KAAK6D,iBAAL,CAAuBrD,CAAvB,EAAyBF,CAAzB,CAA/C,IAA4EY,CAAC,CAACZ,CAAD,EAAI,CAACR,CAAD,EAAGE,CAAH,KAAO;AAAC,eAAKA,CAAC,CAAC8D,MAAF,EAAL,GAAiBlE,CAAC,CAACmE,eAAF,CAAkB/D,CAAC,CAACgE,EAApB,EAAuBhD,CAAvB;AAA0B,OAAvD,CAA/E,GAAyIE,CAAC,CAACZ,CAAD,EAAI,CAACR,CAAD,EAAGE,CAAH,KAAO;AAAC,eAAKA,CAAC,CAAC8D,MAAF,EAAL,GAAiBlE,CAAC,CAACmE,eAAF,CAAkB/D,CAAC,CAACgE,EAApB,EAAuB/C,CAAvB;AAA0B,OAAvD,CAA3I;AAAqM;AAAC;;AAAAgD,EAAAA,WAAW,CAACnE,CAAD,EAAGE,CAAH,EAAKM,CAAL,EAAO;AAAC,UAAME,CAAC,GAACR,CAAC,CAACkE,cAAF,CAAiBpE,CAAjB,CAAR;AAAA,UAA4BY,CAAC,GAAC,CAACJ,CAAC,CAAC6D,SAAH,IAAc,CAAC,EAAE3D,CAAC,GAACN,CAAJ,CAA7C;AAAA,UAAoDU,CAAC,GAAC,CAAChB,CAAC,CAACU,CAAC,CAAC8D,aAAH,CAAF,IAAqB9D,CAAC,CAAC8D,aAAF,CAAgBC,qBAArC,IAA4D,CAAC,EAAE7D,CAAC,GAACJ,CAAJ,CAAnH;AAA0H,WAAM,EAAEM,CAAC,IAAEE,CAAL,CAAN;AAAc;;AAAA+C,EAAAA,QAAQ,CAAC/D,CAAD,EAAG;AAAC,UAAME,CAAC,GAACF,CAAC,CAAC6D,YAAF,CAAeC,aAAvB;AAAA,UAAqC1D,CAAC,GAAC,IAAIsE,GAAJ,EAAvC;AAA+CpD,IAAAA,CAAC,CAACtB,CAAD,EAAI,CAACM,CAAD,EAAGE,CAAH,KAAO;AAAC,aAAKA,CAAC,CAAC0D,MAAF,EAAL,GAAiB;AAAC,YAAG9D,CAAC,CAACuE,GAAF,CAAMnE,CAAC,CAAC4D,EAAR,CAAH,EAAe;;AAAS,YAAGhE,CAAC,CAACwE,GAAF,CAAMpE,CAAC,CAAC4D,EAAR,GAAY,KAAKC,WAAL,CAAiB7D,CAAC,CAAC4D,EAAnB,EAAsBlE,CAAtB,EAAwBF,CAAC,CAAC6E,SAA1B,CAAf,EAAoD;AAAC3E,UAAAA,CAAC,CAACiE,eAAF,CAAkB3D,CAAC,CAAC4D,EAApB,EAAuBjD,CAAvB;AAA0B;AAAS;;AAAAjB,QAAAA,CAAC,CAAC4E,eAAF,CAAkBtE,CAAC,CAAC4D,EAApB,MAA0B/C,CAA1B,GAA4BnB,CAAC,CAACiE,eAAF,CAAkB3D,CAAC,CAAC4D,EAApB,EAAuBhD,CAAvB,CAA5B,GAAsDlB,CAAC,CAACiE,eAAF,CAAkB3D,CAAC,CAAC4D,EAApB,EAAuB/C,CAAvB,CAAtD;AAAgF;AAAC,KAA/N,CAAD;AAAmO;;AAAA2C,EAAAA,eAAe,CAAChE,CAAD,EAAGE,CAAH,EAAKE,CAAL,EAAO;AAAC,UAAME,CAAC,GAACJ,CAAC,CAAC2D,YAAF,CAAeC,aAAvB;AAAA,UAAqCtD,CAAC,GAAC,IAAIkE,GAAJ,EAAvC;AAA+CpD,IAAAA,CAAC,CAACpB,CAAD,EAAI,CAACA,CAAD,EAAGQ,CAAH,KAAO;AAAC,aAAKA,CAAC,CAACwD,MAAF,EAAL,GAAiB,IAAG,CAAC1D,CAAC,CAACmE,GAAF,CAAMjE,CAAC,CAAC0D,EAAR,CAAJ,EAAgB,IAAGlE,CAAC,CAAC6E,GAAF,CAAMC,KAAN,KAAc5E,CAAjB,EAAmB;AAAC,YAAG,MAAIE,CAAC,CAACwE,eAAF,CAAkBpE,CAAC,CAAC0D,EAApB,CAAP,EAA+B;AAAC,kBAAOpE,CAAC,CAACiF,aAAF,CAAgBvE,CAAhB,CAAP;AAA2B,iBAAKM,CAAL;AAAO;;AAAM,iBAAKF,CAAL;AAAOR,cAAAA,CAAC,CAAC6D,eAAF,CAAkBzD,CAAC,CAAC0D,EAApB,EAAuBjD,CAAvB,GAA0BX,CAAC,CAACoE,GAAF,CAAMlE,CAAC,CAAC0D,EAAR,CAA1B;AAAsC;;AAAM,iBAAKxD,CAAL;AAAON,cAAAA,CAAC,CAAC6D,eAAF,CAAkBzD,CAAC,CAAC0D,EAApB,EAAuB/C,CAAvB,GAA0Bb,CAAC,CAACoE,GAAF,CAAMlE,CAAC,CAAC0D,EAAR,CAA1B;AAAlG;AAAyI;AAAC,OAA9L,MAAmM9D,CAAC,CAAC6D,eAAF,CAAkBzD,CAAC,CAAC0D,EAApB,EAAuBjD,CAAvB;AAA0B,KAA1Q,CAAD;AAA8Q;;AAAA8C,EAAAA,iBAAiB,CAACjE,CAAD,EAAGE,CAAH,EAAK;AAAC,UAAME,CAAC,GAACF,CAAC,CAAC2D,YAAF,CAAeC,aAAvB;AAAA,UAAqCxD,CAAC,GAAC,IAAIoE,GAAJ,EAAvC;AAA+CpD,IAAAA,CAAC,CAACpB,CAAD,EAAI,CAACA,CAAD,EAAGM,CAAH,KAAO;AAAC,aAAKA,CAAC,CAAC0D,MAAF,EAAL,GAAiB,IAAG,CAAC5D,CAAC,CAACqE,GAAF,CAAMnE,CAAC,CAAC4D,EAAR,CAAD,IAAchE,CAAC,CAAC0E,eAAF,CAAkBtE,CAAC,CAAC4D,EAApB,MAA0BhD,CAA3C,EAA6C;AAAC,gBAAOpB,CAAC,CAACiF,aAAF,CAAgBzE,CAAhB,CAAP;AAA2B,eAAKQ,CAAL;AAAO;;AAAM,eAAKF,CAAL;AAAOV,YAAAA,CAAC,CAAC+D,eAAF,CAAkB3D,CAAC,CAAC4D,EAApB,EAAuBhD,CAAvB,GAA0Bd,CAAC,CAACsE,GAAF,CAAMpE,CAAC,CAAC4D,EAAR,CAA1B;AAAsC;;AAAM,eAAKxD,CAAL;AAAOR,YAAAA,CAAC,CAAC+D,eAAF,CAAkB3D,CAAC,CAAC4D,EAApB,EAAuB/C,CAAvB,GAA0Bf,CAAC,CAACsE,GAAF,CAAMpE,CAAC,CAAC4D,EAAR,CAA1B;AAAlG;AAAyI;AAAC,KAArN,CAAD;AAAyN;;AAAAZ,EAAAA,iBAAiB,CAACtD,CAAD,EAAGE,CAAH,EAAK;AAAC,SAAI,MAAK;AAAC6C,MAAAA,YAAY,EAAC3C,CAAd;AAAgByC,MAAAA,YAAY,EAACvC,CAA7B;AAA+B4C,MAAAA,YAAY,EAAC1C;AAA5C,KAAT,IAA0DR,CAA1D,EAA4DoB,CAAC,CAAChB,CAAD,EAAI,CAACJ,CAAD,EAAGU,CAAH,KAAO;AAAC,YAAME,CAAC,GAACR,CAAC,CAACuD,YAAF,CAAeC,aAAvB;AAAA,YAAqC9C,CAAC,GAACd,CAAC,CAACgF,UAAF,CAAaC,UAApD;AAA+DnE,MAAAA,CAAC,CAAC,CAAD,CAAD,GAAKoE,IAAI,CAACC,KAAL,CAAWrE,CAAC,CAAC,CAAD,CAAZ,CAAL,EAAsBA,CAAC,CAAC,CAAD,CAAD,GAAKoE,IAAI,CAACC,KAAL,CAAWrE,CAAC,CAAC,CAAD,CAAZ,CAA3B;AAA4C,YAAME,CAAC,GAACF,CAAC,CAAC,CAAD,CAAT;AAAA,YAAaG,CAAC,GAACH,CAAC,CAAC,CAAD,CAAhB;AAAA,YAAoBI,CAAC,GAAC,eAAaZ,CAAnC;;AAAqC,aAAKI,CAAC,CAAC0E,IAAF,EAAL,GAAe;AAAC,cAAMpF,CAAC,GAACU,CAAC,CAAC2E,WAAV;AAAA,cAAsBjF,CAAC,GAACM,CAAC,CAAC4E,OAA1B;AAAA,cAAkChF,CAAC,GAACI,CAAC,CAAC6E,OAAtC;AAA8C,YAAIpE,CAAC,GAACT,CAAC,CAAC+C,IAAR;AAAa,cAAMrC,CAAC,GAACZ,CAAC,CAAC,CAAD,CAAT;;AAAa,YAAGV,CAAC,CAACsB,CAAD,CAAJ,EAAQ;AAAC,gBAAMtB,CAAC,GAACsB,CAAC,CAACR,CAAC,CAAC4E,SAAF,CAAY9E,CAAC,CAACwD,EAAd,CAAD,CAAT;AAA6B/C,UAAAA,CAAC,GAACsE,KAAK,CAAC3F,CAAD,CAAL,IAAU,QAAMA,CAAhB,IAAmBA,CAAC,KAAG,IAAE,CAAzB,GAA2BqB,CAA3B,GAA6BrB,CAA/B;AAAiC;;AAAA,cAAM+B,CAAC,GAACnB,CAAC,CAACgF,UAAF,IAAcvE,CAAC,GAAC,CAAhB,CAAR;AAAA,cAA2Ba,CAAC,GAACtB,CAAC,CAACiF,UAAF,IAAcxE,CAAC,GAAC,CAAhB,CAA7B;;AAAgD,aAAI,IAAIrB,CAAC,GAAC,CAAV,EAAYA,CAAC,GAACE,CAAd,EAAgBF,CAAC,EAAjB,EAAoB;AAAC,cAAIE,CAAC,GAACI,CAAN;AAAA,cAAQI,CAAC,GAACE,CAAC,CAAC6E,OAAZ;;AAAoB,cAAGrE,CAAH,EAAK;AAAC,gBAAId,CAAC,GAACJ,CAAC,GAACU,CAAC,CAACkF,OAAF,CAAU9F,CAAV,CAAF,GAAe+B,CAArB;AAAA,gBAAuBvB,CAAC,GAACE,CAAC,GAACE,CAAC,CAACmF,OAAF,CAAU/F,CAAV,CAAF,GAAekC,CAAxC;AAA0C9B,YAAAA,CAAC,CAACsD,KAAF,CAAQsC,QAAR,IAAkB1F,CAAC,GAACU,CAAC,CAAC,CAAD,CAAD,GAAKV,CAAL,GAAOU,CAAC,CAAC,CAAD,CAAD,GAAKR,CAAZ,GAAcQ,CAAC,CAAC,CAAD,CAAjB,EAAqBR,CAAC,GAACQ,CAAC,CAAC,CAAD,CAAD,GAAKV,CAAL,GAAOU,CAAC,CAAC,CAAD,CAAD,GAAKR,CAAZ,GAAcQ,CAAC,CAAC,CAAD,CAAxD,KAA8DV,CAAC,IAAEY,CAAH,EAAKV,CAAC,IAAEW,CAAtE,GAAyEP,CAAC,CAACqF,wBAAF,CAA2BjG,CAA3B,EAA6BoF,IAAI,CAACc,KAAL,CAAW5F,CAAX,CAA7B,CAAzE,EAAqHM,CAAC,CAACuF,wBAAF,CAA2BnG,CAA3B,EAA6BoF,IAAI,CAACc,KAAL,CAAW1F,CAAX,CAA7B,CAArH;AAAiK,WAAjN,MAAqN;AAACJ,YAAAA,CAAC,CAACsD,KAAF,CAAQsC,QAAR,IAAkB9F,CAAC,GAACc,CAAC,CAAC,CAAD,CAAD,GAAKV,CAAL,GAAOU,CAAC,CAAC,CAAD,CAAD,GAAKR,CAAZ,GAAcQ,CAAC,CAAC,CAAD,CAAjB,EAAqBN,CAAC,GAACM,CAAC,CAAC,CAAD,CAAD,GAAKV,CAAL,GAAOU,CAAC,CAAC,CAAD,CAAD,GAAKR,CAAZ,GAAcQ,CAAC,CAAC,CAAD,CAAxD,KAA8Dd,CAAC,IAAEgB,CAAH,EAAKR,CAAC,IAAES,CAAtE;AAAyE,kBAAML,CAAC,GAACZ,CAAC,GAACU,CAAC,CAACkF,OAAF,CAAU9F,CAAV,CAAF,GAAe+B,CAAvB;AAAA,kBAAyBX,CAAC,GAACV,CAAC,GAACE,CAAC,CAACmF,OAAF,CAAU/F,CAAV,CAAF,GAAekC,CAA1C;AAA4CtB,YAAAA,CAAC,CAACqF,wBAAF,CAA2BjG,CAA3B,EAA6Bc,CAA7B,GAAgCF,CAAC,CAACuF,wBAAF,CAA2BnG,CAA3B,EAA6BoB,CAA7B,CAAhC;AAAgE;AAAC;AAAC;AAAC,KAAlyB,CAAD;AAAsyB;;AAA15E;;AAA25E,SAAOkC,CAAC,IAAI8C,eAAZ","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.23/esri/copyright.txt for details.\n*/\nimport{isSome as e,isNone as t}from\"../../../../../core/maybe.js\";import{pt2px as i}from\"../../../../../core/screenUtils.js\";import{FILTER_FLAG_0 as o,EFFECT_FLAG_0 as r}from\"../definitions.js\";import{CollisionBitsetGrid as n,NONE as s,HAS_COLLISION as a,OUTSIDE_EXTENT as l}from\"./CollisionGrid.js\";import{getSizeForValueSimple as d}from\"./visualVariableSimpleUtils.js\";const c=254,u=255,f=0;function b(t,i){const o=[];t.forEachTile((e=>o.push(e))),o.sort(((e,t)=>e.instanceId-t.instanceId)),o.forEach((t=>{e(t.labelMetrics)&&t.isReady&&i(t,t.labelMetrics.getCursor())}))}function p(e){return\"feature\"===e.layer.type||\"csv\"===e.layer.type||\"geojson\"===e.layer.type||\"ogc-feature\"===e.layer.type||\"stream\"===e.layer.type||\"subtype-group\"===e.layer.type||\"wfs\"===e.layer.type}function y(e){return t=>i(d(t,e))}function m(e){const t=\"visualVariables\"in e&&e.visualVariables;if(!t)return null;for(const i of t)if(\"size\"===i.type)return y(i);return null}function h(e){for(const i of e){var t;const e=\"featureReduction\"in i&&\"cluster\"===(null==(t=i.featureReduction)?void 0:t.type)&&i.featureReduction,o=[...i.labelingInfo||[],...e.labelingInfo||[]];if(!i.labelsVisible||!o.length)continue;if(o.some((e=>\"none\"===e.deconflictionStrategy)))return!0}return!1}function M(e,i){if(!p(i))return;const o=\"subtype-group\"===i.layer.type?i.layer.sublayers.items:[i.layer],r=i.layer.geometryType,n=!h(o),s={};if(\"subtype-group\"!==i.layer.type){if(\"heatmap\"===i.layer.renderer.type)return;const e=m(i.layer.renderer);s[0]=e}const a=i.tileRenderer;if(t(a))return;const l=i.layer.visible&&!i.suspended;e.push({tileRenderer:a,vvEvaluators:s,deconflictionEnabled:n,geometryType:r,visible:l})}class g{run(e,t,i){const o=[];for(let r=e.length-1;r>=0;r--){M(o,e[r])}this._transformMetrics(o,t),this._runCollision(o,t,i)}_runCollision(e,t,i){const[o,r]=t.state.size,s=new n(o*t.pixelRatio,r*t.pixelRatio);for(const{tileRenderer:n,deconflictionEnabled:a,visible:l}of e){const e=n.featuresView.attributeView;a?l?(this._prepare(n),this._collideVisible(s,n,i),this._collideInvisible(s,n)):b(n,((t,i)=>{for(;i.nextId();)e.setLabelMinZoom(i.id,u)})):b(n,((t,i)=>{for(;i.nextId();)e.setLabelMinZoom(i.id,f)}))}}_isFiltered(t,i,n){const s=i.getFilterFlags(t),a=!n.hasFilter||!!(s&o),l=!e(n.featureEffect)||n.featureEffect.excludedLabelsVisible||!!(s&r);return!(a&&l)}_prepare(e){const t=e.featuresView.attributeView,i=new Set;b(e,((o,r)=>{for(;r.nextId();){if(i.has(r.id))continue;if(i.add(r.id),this._isFiltered(r.id,t,e.layerView)){t.setLabelMinZoom(r.id,c);continue}t.getLabelMinZoom(r.id)!==f?t.setLabelMinZoom(r.id,u):t.setLabelMinZoom(r.id,f)}}))}_collideVisible(e,t,i){const o=t.featuresView.attributeView,r=new Set;b(t,((t,n)=>{for(;n.nextId();)if(!r.has(n.id))if(t.key.level===i){if(0===o.getLabelMinZoom(n.id)){switch(e.insertMetrics(n)){case l:break;case a:o.setLabelMinZoom(n.id,c),r.add(n.id);break;case s:o.setLabelMinZoom(n.id,f),r.add(n.id)}}}else o.setLabelMinZoom(n.id,c)}))}_collideInvisible(e,t){const i=t.featuresView.attributeView,o=new Set;b(t,((t,r)=>{for(;r.nextId();)if(!o.has(r.id)&&i.getLabelMinZoom(r.id)===u){switch(e.insertMetrics(r)){case l:break;case a:i.setLabelMinZoom(r.id,u),o.add(r.id);break;case s:i.setLabelMinZoom(r.id,f),o.add(r.id)}}}))}_transformMetrics(t,i){for(const{tileRenderer:o,geometryType:r,vvEvaluators:n}of t)b(o,((t,s)=>{const a=o.featuresView.attributeView,l=t.transforms.labelMat2d;l[4]=Math.round(l[4]),l[5]=Math.round(l[5]);const d=l[4],c=l[5],u=\"polyline\"===r;for(;s.next();){const t=s.boundsCount,o=s.anchorX,r=s.anchorY;let f=s.size;const b=n[0];if(e(b)){const e=b(a.getVVSize(s.id));f=isNaN(e)||null==e||e===1/0?f:e}const p=s.directionX*(f/2),y=s.directionY*(f/2);for(let e=0;e<t;e++){let t=o,n=s.anchorY;if(u){let o=t+s.boundsX(e)+p,r=n+s.boundsY(e)+y;i.state.rotation?(o=l[0]*o+l[2]*r+l[4],r=l[1]*o+l[3]*r+l[5]):(o+=d,r+=c),s.setBoundsComputedAnchorX(e,Math.floor(o)),s.setBoundsComputedAnchorY(e,Math.floor(r))}else{i.state.rotation?(t=l[0]*o+l[2]*r+l[4],n=l[1]*o+l[3]*r+l[5]):(t+=d,n+=c);const a=t+s.boundsX(e)+p,u=n+s.boundsY(e)+y;s.setBoundsComputedAnchorX(e,a),s.setBoundsComputedAnchorY(e,u)}}}}))}}export{g as CollisionEngine};\n"]},"metadata":{},"sourceType":"module"}